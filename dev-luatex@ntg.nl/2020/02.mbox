From preining at logic.at  Fri Feb  7 01:39:02 2020
From: preining at logic.at (Norbert Preining)
Date: Fri, 7 Feb 2020 09:39:02 +0900
Subject: [Dev-luatex] Disappearing quoteleft in luatex
Message-ID: <20200207003902.oelvdhh2wdzlqjjj@bulldog.preining.info>

Dear all,

I see a strange thing happening with the following document all with
uptodate TeX Live:

\documentclass{article}
\usepackage{fontspec}
\setmainfont{Gaultier}
\begin{document}
Hello `World'
\end{document}

xelatex: ok
lualatex: quoteleft character is missing
lualatex-dev with [RawFeature={mode=harf;}]: ok

So it seems that the lualatex font loader seems to be broken here.

The character is present in the font
	325 (0x145) U+2018 "quoteleft" LEFT SINGLE QUOTATION MARK
and separate from the quoteright.

Any suggestions how to fix these kind of errors?

Best

Norbert

--
PREINING Norbert                               http://www.preining.info
Accelia Inc. + IFMGA ProGuide + TU Wien + JAIST + TeX Live + Debian Dev
GPG: 0x860CDC13   fp: F7D8 A928 26E3 16A1 9FA0 ACF0 6CAC A448 860C DC13

From tex at 2krueger.de  Fri Feb  7 02:33:03 2020
From: tex at 2krueger.de (Marcel Fabian =?utf-8?Q?Kr=C3=BCger?=)
Date: Fri, 7 Feb 2020 02:33:03 +0100
Subject: [Dev-luatex] Disappearing quoteleft in luatex
In-Reply-To: <20200207003902.oelvdhh2wdzlqjjj@bulldog.preining.info>
References: <20200207003902.oelvdhh2wdzlqjjj@bulldog.preining.info>
Message-ID: <20200207013303.izoflxvjheok6eew@yoga>

On Fri, Feb 07, 2020 at 09:39:02AM +0900, Norbert Preining wrote:
> Dear all,
> 
> I see a strange thing happening with the following document all with
> uptodate TeX Live:
> 
> \documentclass{article}
> \usepackage{fontspec}
> \setmainfont{Gaultier}
> \begin{document}
> Hello `World'
> \end{document}
> 
> xelatex: ok
> lualatex: quoteleft character is missing
> lualatex-dev with [RawFeature={mode=harf;}]: ok
> 
> So it seems that the lualatex font loader seems to be broken here.
> 
> The character is present in the font
> 	325 (0x145) U+2018 "quoteleft" LEFT SINGLE QUOTATION MARK
> and separate from the quoteright.

The "quoteleft" is present, but you are dealing with an odd font which
does not have a ASCII "grave" (U+0060). Given that the replacement is
implemented as a glyph substitution it only works if the original glyph
exists.

> 
> Any suggestions how to fix these kind of errors?

Use a proper font or input â directly. You can probably also manually
add a lookup to the fontloader which includes these replacement without
checking if the original characters exists, but I'm currently not sure
if that might break something.

Best,
Marcel

From preining at logic.at  Fri Feb  7 03:31:57 2020
From: preining at logic.at (Norbert Preining)
Date: Fri, 7 Feb 2020 11:31:57 +0900
Subject: [Dev-luatex] Disappearing quoteleft in luatex
In-Reply-To: <20200207013303.izoflxvjheok6eew@yoga>
References: <20200207003902.oelvdhh2wdzlqjjj@bulldog.preining.info>
 <20200207013303.izoflxvjheok6eew@yoga>
Message-ID: <20200207023157.yexf3bfhf6h6zxi5@bulldog.preining.info>

Hi Marcel,

thanks for your answer.

On Fri, 07 Feb 2020, Marcel Fabian KrÃ¼ger wrote:
> The "quoteleft" is present, but you are dealing with an odd font which
> does not have a ASCII "grave" (U+0060). Given that the replacement is
> implemented as a glyph substitution it only works if the original glyph
> exists.

Indeed, it is not there, only U+0300 gravecomb. Strange.

So does that mean that the luatex fontloader uses U+0060 instead of the
quoteleft for ` ?

And harfbuzz (xetex, lualatex-dev with harf) uses the quoteleft for `?

Best

Norbert

--
PREINING Norbert                               http://www.preining.info
Accelia Inc. + IFMGA ProGuide + TU Wien + JAIST + TeX Live + Debian Dev
GPG: 0x860CDC13   fp: F7D8 A928 26E3 16A1 9FA0 ACF0 6CAC A448 860C DC13

From dbmiller at dbmiller.org  Tue Feb 18 07:55:59 2020
From: dbmiller at dbmiller.org (Daniel Benjamin Miller)
Date: Tue, 18 Feb 2020 01:55:59 -0500
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
Message-ID: <0a86d34c-3848-ab54-4115-60bc845c89e2@dbmiller.org>

There is an issue with lualatex which comes about when using a document 
such as this (based on a discussion here 
https://tex.stackexchange.com/questions/525898/combining-french-and-greek-babel-does-not-work-in-dvilualatex/526020?noredirect=1#comment1331448_526020).

Try running lualatex on the following document, and an error will be 
returned. This seems to apply for all fonts whose packages were 
generated by autoinst (step is just an example).

\documentclass[12pt]{article}

\usepackage[utf8]{luainputenc}\usepackage[LGR,T1]{fontenc}\input{lgrenc.dfu}

\usepackage{step} \usepackage[greek.ancient,main=french]{babel}

\title{Ãa marche?} %\date{} \author{me}

\begin{document} \maketitle un, deux, trois 
\foreignlanguage{greek}{á¼Î³Î±Î³Îµá¿Î½} \end{document}

According to Marcel KrÃ¼ger, this is related to an issue which was 
reported over a year ago: 
https://mailman.ntg.nl/pipermail/dev-luatex/2018-November/006138.html.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://mailman.ntg.nl/pipermail/dev-luatex/attachments/20200218/035e7d82/attachment.htm>

From tex at 2krueger.de  Tue Feb 18 12:53:49 2020
From: tex at 2krueger.de (Marcel Fabian =?utf-8?Q?Kr=C3=BCger?=)
Date: Tue, 18 Feb 2020 12:53:49 +0100
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
In-Reply-To: <0a86d34c-3848-ab54-4115-60bc845c89e2@dbmiller.org>
References: <0a86d34c-3848-ab54-4115-60bc845c89e2@dbmiller.org>
Message-ID: <20200218115349.p2lcsbidw25dofp3@yoga>

On Tue, Feb 18, 2020 at 01:55:59AM -0500, Daniel Benjamin Miller wrote:
> There is an issue with lualatex which comes about when using a document such
> as this (based on a discussion here https://tex.stackexchange.com/questions/525898/combining-french-and-greek-babel-does-not-work-in-dvilualatex/526020?noredirect=1#comment1331448_526020).
> 
> Try running lualatex on the following document, and an error will be
> returned. This seems to apply for all fonts whose packages were generated by
> autoinst (step is just an example).
> 
> \documentclass[12pt]{article}
> 
> \usepackage[utf8]{luainputenc}\usepackage[LGR,T1]{fontenc}\input{lgrenc.dfu}
> 
> \usepackage{step} \usepackage[greek.ancient,main=french]{babel}
> 
> \title{Ãa marche?} %\date{} \author{me}
> 
> \begin{document} \maketitle un, deux, trois \foreignlanguage{greek}{á¼Î³Î±Î³Îµá¿Î½}
> \end{document}
> 
> According to Marcel KrÃ¼ger, this is related to an issue which was reported
> over a year ago:
> https://mailman.ntg.nl/pipermail/dev-luatex/2018-November/006138.html.
> 

A plain LuaTeX example for this would be 

\directlua{
  callback.register('kerning', node.kerning)

  font.current(font.define {
    name = "dummy",
    type = "virtual",
    characters = {
      {
        width = 655360,
        height = 655360,
        depth = 655360,
        commands = {},
      },
      right_boundary = {
        width = 655360,
        height = 655360,
        depth = 655360,
      },
    },
  })
}
\char1
\bye

The issue appears for fonts with a right boundary char if they appear at
the end of a paragraph and the kerning callback is overwritten. Then the
right boundary is passed as tail  to the callback which will then remove
the boundary from the node list. As discussed in the earlier thread,
the callback currently can't pass the new tail to LuaTeX (and LuaTeX
does not recalculate the tail in contrast to the documentation) so
LuaTeX adds the end of paragraph glue etc. after the no longer existing
old tail, leading to the error because the new list does not end with
these required nodes.

Best regards,
Marcel

From luigi.scarso at gmail.com  Tue Feb 18 12:57:48 2020
From: luigi.scarso at gmail.com (luigi scarso)
Date: Tue, 18 Feb 2020 12:57:48 +0100
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
In-Reply-To: <20200218115349.p2lcsbidw25dofp3@yoga>
References: <0a86d34c-3848-ab54-4115-60bc845c89e2@dbmiller.org>
 <20200218115349.p2lcsbidw25dofp3@yoga>
Message-ID: <CAG5iGsCkw2fd5T_WK1S2JZt-9_KsTsqhDc7fcGqMxPTqE9VCLQ@mail.gmail.com>

On Tue, Feb 18, 2020 at 12:54 PM Marcel Fabian KrÃ¼ger <tex at 2krueger.de>
wrote:

> On Tue, Feb 18, 2020 at 01:55:59AM -0500, Daniel Benjamin Miller wrote:
> > There is an issue with lualatex which comes about when using a document
> such
> > as this (based on a discussion here
> https://tex.stackexchange.com/questions/525898/combining-french-and-greek-babel-does-not-work-in-dvilualatex/526020?noredirect=1#comment1331448_526020
> ).
> >
> > Try running lualatex on the following document, and an error will be
> > returned. This seems to apply for all fonts whose packages were
> generated by
> > autoinst (step is just an example).
> >
> > \documentclass[12pt]{article}
> >
> >
> \usepackage[utf8]{luainputenc}\usepackage[LGR,T1]{fontenc}\input{lgrenc.dfu}
> >
> > \usepackage{step} \usepackage[greek.ancient,main=french]{babel}
> >
> > \title{Ãa marche?} %\date{} \author{me}
> >
> > \begin{document} \maketitle un, deux, trois
> \foreignlanguage{greek}{á¼Î³Î±Î³Îµá¿Î½}
> > \end{document}
> >
> > According to Marcel KrÃ¼ger, this is related to an issue which was
> reported
> > over a year ago:
> > https://mailman.ntg.nl/pipermail/dev-luatex/2018-November/006138.html.
> >
>
> A plain LuaTeX example for this would be
>
> \directlua{
>   callback.register('kerning', node.kerning)
>
>   font.current(font.define {
>     name = "dummy",
>     type = "virtual",
>     characters = {
>       {
>         width = 655360,
>         height = 655360,
>         depth = 655360,
>         commands = {},
>       },
>       right_boundary = {
>         width = 655360,
>         height = 655360,
>         depth = 655360,
>       },
>     },
>   })
> }
> \char1
> \bye
>
> The issue appears for fonts with a right boundary char if they appear at
> the end of a paragraph and the kerning callback is overwritten. Then the
> right boundary is passed as tail  to the callback which will then remove
> the boundary from the node list. As discussed in the earlier thread,
> the callback currently can't pass the new tail to LuaTeX (and LuaTeX
> does not recalculate the tail in contrast to the documentation) so
> LuaTeX adds the end of paragraph glue etc. after the no longer existing
> old tail, leading to the error because the new list does not end with
> these required nodes.
>

ok, thank you. I will see it together with the old thread.

-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://mailman.ntg.nl/pipermail/dev-luatex/attachments/20200218/cc744258/attachment.htm>

From luigi.scarso at gmail.com  Tue Feb 18 23:44:37 2020
From: luigi.scarso at gmail.com (luigi scarso)
Date: Tue, 18 Feb 2020 23:44:37 +0100
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
In-Reply-To: <20200218115349.p2lcsbidw25dofp3@yoga>
References: <0a86d34c-3848-ab54-4115-60bc845c89e2@dbmiller.org>
 <20200218115349.p2lcsbidw25dofp3@yoga>
Message-ID: <CAG5iGsBK_WjBPxMQuK4wD=WddCpKOun15TTq56doQQXJjwUZ5w@mail.gmail.com>

On Tue, Feb 18, 2020 at 12:54 PM Marcel Fabian KrÃ¼ger <tex at 2krueger.de>
wrote:

>
> A plain LuaTeX example for this would be
>
> \directlua{
>   callback.register('kerning', node.kerning)
>
>   font.current(font.define {
>     name = "dummy",
>     type = "virtual",
>     characters = {
>       {
>         width = 655360,
>         height = 655360,
>         depth = 655360,
>         commands = {},
>       },
>       right_boundary = {
>         width = 655360,
>         height = 655360,
>         depth = 655360,
>       },
>     },
>   })
> }
> \char1
> \bye
>
>
this fails with

(see the transcript file for additional
information)</opt/luatex/mkvi-experimen
tal-53/tex/texmf/fonts/opentype/public/lm/lmroman10-regular.otf>
! error:  (file dummy) (type 3): font dummy at 72 not found

-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://mailman.ntg.nl/pipermail/dev-luatex/attachments/20200218/42f027e9/attachment.htm>

From tex at 2krueger.de  Wed Feb 19 09:55:41 2020
From: tex at 2krueger.de (Marcel Fabian =?utf-8?Q?Kr=C3=BCger?=)
Date: Wed, 19 Feb 2020 09:55:41 +0100
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
In-Reply-To: <CAG5iGsBK_WjBPxMQuK4wD=WddCpKOun15TTq56doQQXJjwUZ5w@mail.gmail.com>
References: <0a86d34c-3848-ab54-4115-60bc845c89e2@dbmiller.org>
 <20200218115349.p2lcsbidw25dofp3@yoga>
 <CAG5iGsBK_WjBPxMQuK4wD=WddCpKOun15TTq56doQQXJjwUZ5w@mail.gmail.com>
Message-ID: <20200219085541.ypn4ii3xs3oqemgh@yoga>

On Tue, Feb 18, 2020 at 11:44:37PM +0100, luigi scarso wrote:
> On Tue, Feb 18, 2020 at 12:54 PM Marcel Fabian KrÃ¼ger <tex at 2krueger.de>
> wrote:
> 
> >
> > A plain LuaTeX example for this would be
> >
> > \directlua{
> >   callback.register('kerning', node.kerning)
> >
> >   font.current(font.define {
> >     name = "dummy",
> >     type = "virtual",
> >     characters = {
> >       {
> >         width = 655360,
> >         height = 655360,
> >         depth = 655360,
> >         commands = {},
> >       },
> >       right_boundary = {
> >         width = 655360,
> >         height = 655360,
> >         depth = 655360,
> >       },
> >     },
> >   })
> > }
> > \char1
> > \bye
> >
> >
> this fails with
> 
> (see the transcript file for additional
> information)</opt/luatex/mkvi-experimen
> tal-53/tex/texmf/fonts/opentype/public/lm/lmroman10-regular.otf>
> ! error:  (file dummy) (type 3): font dummy at 72 not found
> 
> -- 
> luigi

Right, I forgot that LuaTeX is not particularly happy about empty
commandds tables. But after replacing

  commands = {}

by

  commands = {{"right", 0}}

and adding some f.fonts table the not found error disappears. But I am
surprised that it even got that far for you: On my system (vanilla
TeXLive 2019 on (Arch) Linux, both with the regular LuaTeX 1.10 and the
current head of "experimental") the actual issue "invalid list tail,
probably missing glue" appears long before LuaTeX reaches the font embedding stage.

Best regards,
Marcel

From luigi.scarso at gmail.com  Wed Feb 19 10:15:08 2020
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 19 Feb 2020 10:15:08 +0100
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
In-Reply-To: <20200219085541.ypn4ii3xs3oqemgh@yoga>
References: <0a86d34c-3848-ab54-4115-60bc845c89e2@dbmiller.org>
 <20200218115349.p2lcsbidw25dofp3@yoga>
 <CAG5iGsBK_WjBPxMQuK4wD=WddCpKOun15TTq56doQQXJjwUZ5w@mail.gmail.com>
 <20200219085541.ypn4ii3xs3oqemgh@yoga>
Message-ID: <CAG5iGsAP2aM4yt32kxFCvWoJi1X2dD=fse2K_nqNxjact=OtfA@mail.gmail.com>

On Wed, Feb 19, 2020 at 9:55 AM Marcel Fabian KrÃ¼ger <tex at 2krueger.de>
wrote:

> On Tue, Feb 18, 2020 at 11:44:37PM +0100, luigi scarso wrote:
> > On Tue, Feb 18, 2020 at 12:54 PM Marcel Fabian KrÃ¼ger <tex at 2krueger.de>
> > wrote:
> >
> > >
> > > A plain LuaTeX example for this would be
> > >
> > > \directlua{
> > >   callback.register('kerning', node.kerning)
> > >
> > >   font.current(font.define {
> > >     name = "dummy",
> > >     type = "virtual",
> > >     characters = {
> > >       {
> > >         width = 655360,
> > >         height = 655360,
> > >         depth = 655360,
> > >         commands = {},
> > >       },
> > >       right_boundary = {
> > >         width = 655360,
> > >         height = 655360,
> > >         depth = 655360,
> > >       },
> > >     },
> > >   })
> > > }
> > > \char1
> > > \bye
> > >
> > >
> > this fails with
> >
> > (see the transcript file for additional
> > information)</opt/luatex/mkvi-experimen
> > tal-53/tex/texmf/fonts/opentype/public/lm/lmroman10-regular.otf>
> > ! error:  (file dummy) (type 3): font dummy at 72 not found
> >
> > --
> > luigi
>
> Right, I forgot that LuaTeX is not particularly happy about empty
> commandds tables. But after replacing
>
>   commands = {}
>
> by
>
>   commands = {{"right", 0}}
>
> and adding some f.fonts table the not found error disappears. But I am
> surprised that it even got that far for you: On my system (vanilla
> TeXLive 2019 on (Arch) Linux, both with the regular LuaTeX 1.10 and the
> current head of "experimental") the actual issue "invalid list tail,
> probably missing glue" appears long before LuaTeX reaches the font
> embedding stage.
>
>
not surprise, could be that I am testing a local version  not yet pushed.
For this reason is better to have a minimal and complete example, otherwise
we waste time .

With my local version
\directlua{
  callback.register('kerning', node.kerning)
  font.current(font.define{
    name = "dummy",
    type = "virtual",
    characters = {
      {
        width = 655360,
        height = 655360,
        depth = 655360,
        commands = {{"right", 0}},
      },
      right_boundary = {
        width = 655360,
        height = 655360,
        depth = 655360,
      },
    },
  })
}
\char1
\bye

$ luatex --fmt=luatex-plain test-tail.tex
doesn't complain .

-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://mailman.ntg.nl/pipermail/dev-luatex/attachments/20200219/79dc3b85/attachment-0001.htm>

From dbmiller at dbmiller.org  Wed Feb 19 04:15:17 2020
From: dbmiller at dbmiller.org (Daniel Benjamin Miller)
Date: Tue, 18 Feb 2020 22:15:17 -0500
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
In-Reply-To: <CAG5iGsBK_WjBPxMQuK4wD=WddCpKOun15TTq56doQQXJjwUZ5w@mail.gmail.com>
References: <CAG5iGsBK_WjBPxMQuK4wD=WddCpKOun15TTq56doQQXJjwUZ5w@mail.gmail.com>
Message-ID: <3287f1dd-71e0-17c2-0397-e69b74314575@dbmiller.org>

Presumably this is an issue with Marcel's dummy example. Now, what about 
the original example I presented? Yes, it is a lualatex example, but 
maybe dvilualatex will work with it now. I can't built the experimental 
branch tonight but maybe you can test it.


From luigi.scarso at gmail.com  Thu Feb 20 07:44:32 2020
From: luigi.scarso at gmail.com (luigi scarso)
Date: Thu, 20 Feb 2020 07:44:32 +0100
Subject: [Dev-luatex] Some legacy fonts cause "invalid list tail,
 probably missing glue"
In-Reply-To: <3287f1dd-71e0-17c2-0397-e69b74314575@dbmiller.org>
References: <CAG5iGsBK_WjBPxMQuK4wD=WddCpKOun15TTq56doQQXJjwUZ5w@mail.gmail.com>
 <3287f1dd-71e0-17c2-0397-e69b74314575@dbmiller.org>
Message-ID: <CAG5iGsDT8o10n-X3c=hr-oAaBNmWPYGQZxEuVdYE296Zrs5-DA@mail.gmail.com>

On Thu, Feb 20, 2020 at 7:31 AM Daniel Benjamin Miller <
dbmiller at dbmiller.org> wrote:

> Presumably this is an issue with Marcel's dummy example. Now, what about
> the original example I presented? Yes, it is a lualatex example, but
> maybe dvilualatex will work with it now. I can't built the experimental
> branch tonight but maybe you can test it.
>


both dvi/pdf seems  to be ok. I will push my local copy this week end.


-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://mailman.ntg.nl/pipermail/dev-luatex/attachments/20200220/a3b929f8/attachment.htm>

From reinhard.kotucha at web.de  Fri Feb 21 22:45:22 2020
From: reinhard.kotucha at web.de (Reinhard Kotucha)
Date: Fri, 21 Feb 2020 22:45:22 +0100
Subject: [Dev-luatex] os.setenv()
Message-ID: <24144.20338.172488.587332@gargle.gargle.HOWL>

Hi,
I just tried this with texlua 1.10.0:

--------------------------------------------
  local function time_of_day (TZ)
    os.setenv('TZ', TZ)
    local time = os.gettimeofday()
    print(os.date('%c', math.floor(time)))
  end

  time_of_day ('America/New_York')
  time_of_day ('Europe/Paris')
  time_of_day ('Asia/Tokyo')
--------------------------------------------

It seems that os.setenv() is only executed once and all results are
in Eastern Standard Time:

  Fri Feb 21 16:37:13 2020
  Fri Feb 21 16:37:13 2020
  Fri Feb 21 16:37:13 2020

When I call "time_of_day ('Asia/Tokyo')" first I get

  Sat Feb 22 06:39:46 2020
  Sat Feb 22 06:39:46 2020
  Sat Feb 22 06:39:46 2020

Is it possible to fix this behavior?

Regards,
  Reinhard

--
------------------------------------------------------------------
Reinhard Kotucha                            Phone: +49-511-3373112
Marschnerstr. 25
D-30167 Hannover                    mailto:reinhard.kotucha at web.de
------------------------------------------------------------------

From luigi.scarso at gmail.com  Fri Feb 21 23:00:58 2020
From: luigi.scarso at gmail.com (luigi scarso)
Date: Fri, 21 Feb 2020 23:00:58 +0100
Subject: [Dev-luatex] os.setenv()
In-Reply-To: <24144.20338.172488.587332@gargle.gargle.HOWL>
References: <24144.20338.172488.587332@gargle.gargle.HOWL>
Message-ID: <CAG5iGsCn3UrLU60zx-qhxdA6cEAtMNh4q33-hAeu7ftMEjf95w@mail.gmail.com>

On Fri, Feb 21, 2020 at 10:50 PM Reinhard Kotucha <reinhard.kotucha at web.de>
wrote:

> Hi,
> I just tried this with texlua 1.10.0:
>
> --------------------------------------------
>   local function time_of_day (TZ)
>     os.setenv('TZ', TZ)
>     local time = os.gettimeofday()
>     print(os.date('%c', math.floor(time)))
>   end
>
>   time_of_day ('America/New_York')
>   time_of_day ('Europe/Paris')
>   time_of_day ('Asia/Tokyo')
> --------------------------------------------
>
> It seems that os.setenv() is only executed once and all results are
> in Eastern Standard Time:
>
>   Fri Feb 21 16:37:13 2020
>   Fri Feb 21 16:37:13 2020
>   Fri Feb 21 16:37:13 2020
>
> When I call "time_of_day ('Asia/Tokyo')" first I get
>
>   Sat Feb 22 06:39:46 2020
>   Sat Feb 22 06:39:46 2020
>   Sat Feb 22 06:39:46 2020
>
> Is it possible to fix this behavior?
>


hm, just to be sure...  how do you run your example ?


-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://mailman.ntg.nl/pipermail/dev-luatex/attachments/20200221/7ca8404d/attachment.htm>

From reinhard.kotucha at web.de  Fri Feb 21 23:11:42 2020
From: reinhard.kotucha at web.de (Reinhard Kotucha)
Date: Fri, 21 Feb 2020 23:11:42 +0100
Subject: [Dev-luatex] os.setenv()
In-Reply-To: <CAG5iGsCn3UrLU60zx-qhxdA6cEAtMNh4q33-hAeu7ftMEjf95w@mail.gmail.com>
References: <24144.20338.172488.587332@gargle.gargle.HOWL>
 <CAG5iGsCn3UrLU60zx-qhxdA6cEAtMNh4q33-hAeu7ftMEjf95w@mail.gmail.com>
Message-ID: <24144.21918.475500.579500@gargle.gargle.HOWL>

On 2020-02-21 at 23:00:58 +0100, luigi scarso wrote:

 > On Fri, Feb 21, 2020 at 10:50 PM Reinhard Kotucha <reinhard.kotucha at web.de>
 > wrote:
 >
 > > Hi,
 > > I just tried this with texlua 1.10.0:
 > >
 > > --------------------------------------------
 > >   local function time_of_day (TZ)
 > >     os.setenv('TZ', TZ)
 > >     local time = os.gettimeofday()
 > >     print(os.date('%c', math.floor(time)))
 > >   end
 > >
 > >   time_of_day ('America/New_York')
 > >   time_of_day ('Europe/Paris')
 > >   time_of_day ('Asia/Tokyo')
 > > --------------------------------------------
 > >
 > > It seems that os.setenv() is only executed once and all results are
 > > in Eastern Standard Time:
 > >
 > >   Fri Feb 21 16:37:13 2020
 > >   Fri Feb 21 16:37:13 2020
 > >   Fri Feb 21 16:37:13 2020
 > >
 > > When I call "time_of_day ('Asia/Tokyo')" first I get
 > >
 > >   Sat Feb 22 06:39:46 2020
 > >   Sat Feb 22 06:39:46 2020
 > >   Sat Feb 22 06:39:46 2020
 > >
 > > Is it possible to fix this behavior?
 > >
 >
 >
 > hm, just to be sure...  how do you run your example ?


  texlua ./timeofday.lua

I also tried

  texlua --shell-escape ./timeofday.lua

Same result.

Regards,
  Reinhard

--
------------------------------------------------------------------
Reinhard Kotucha                            Phone: +49-511-3373112
Marschnerstr. 25
D-30167 Hannover                    mailto:reinhard.kotucha at web.de
------------------------------------------------------------------

From luigi.scarso at gmail.com  Sat Feb 22 00:54:28 2020
From: luigi.scarso at gmail.com (luigi scarso)
Date: Sat, 22 Feb 2020 00:54:28 +0100
Subject: [Dev-luatex] os.setenv()
In-Reply-To: <24144.21918.475500.579500@gargle.gargle.HOWL>
References: <24144.20338.172488.587332@gargle.gargle.HOWL>
 <CAG5iGsCn3UrLU60zx-qhxdA6cEAtMNh4q33-hAeu7ftMEjf95w@mail.gmail.com>
 <24144.21918.475500.579500@gargle.gargle.HOWL>
Message-ID: <CAG5iGsCnPOU_Yzf+dHWLmTR6sf7Hn1jd1eQ2AuL79A5_hOj31A@mail.gmail.com>

On Fri, Feb 21, 2020 at 11:11 PM Reinhard Kotucha <reinhard.kotucha at web.de>
wrote:

>
>   texlua ./timeofday.lua
>
> I also tried
>
>   texlua --shell-escape ./timeofday.lua
>
> Same result.
>
> Regards,
>   Reinhard
>

TZ is passed to the env.:

local function time_of_day (TZ)
    os.setenv('TZ', TZ)
    local time = os.gettimeofday();
    print(os.date('%c %p', math.floor(time)))
    print(TZ); os.execute("date +%c") ;
    print()
    os.setenv('TZ', nil)
  end

under linux os.date calls localtime_r  (if the string format doesn't start
with '!')
and localtime_r
 "need not set tzname, timezone, and daylight"
I think that this means that the tz info are read only the first time
See e.g.
https://jianewyork.blogspot.com/2018/03/use-of-localtime-localtimer-and-their.html


-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://mailman.ntg.nl/pipermail/dev-luatex/attachments/20200222/8d98e7b7/attachment.htm>

