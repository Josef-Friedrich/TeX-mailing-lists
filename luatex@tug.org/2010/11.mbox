From oinos at web.de  Thu Nov  4 17:20:22 2010
From: oinos at web.de (=?UTF-8?B?UGFibG8gUm9kcsOtZ3Vleg==?=)
Date: Thu, 04 Nov 2010 17:20:22 +0100
Subject: [luatex] \pdfannot in LuaLaTeX
Message-ID: <4CD2DD46.9090503@web.de>

Hi there,

compiling the following document with an annotation

\documentclass[12pt]{minimal}
\usepackage{fontspec}
\setmainfont{FreeSans}
\usepackage[pdfencoding=auto,pdftitle={?????? ?? ????}]{hyperref}
\pdfstringdef{\octalcr}{\015}
\begin{document}
\pdfannot{/Subtype /Text /Name (Help) /T (Pablo Rodr?guez) /C [1 0 0] 
/Subj (Tama?os de p?gina y hoja) /Open true /Contents (El tama?o de 
p?gina es carta con la p?gina original centrada y marcas de corte en las 
p?ginas impares.\octalcr{}Las versiones en tama?o original y carta se 
encuentran en http://www.rosa-varela.tk</a>.)}?????? ?? ????.
\end{document}

everything has its right encoding, but the text in the annotation is 
wrong encoded. Text is in utf-8.

How can I fix this?

Thanks for your help,


Pablo
-- 
http://www.ousia.tk

From mpg at elzevir.fr  Fri Nov  5 03:04:08 2010
From: mpg at elzevir.fr (=?UTF-8?B?TWFudWVsIFDDqWdvdXJpw6ktR29ubmFyZA==?=)
Date: Fri, 05 Nov 2010 03:04:08 +0100
Subject: [luatex] Hyphenation in plain TeX
In-Reply-To: <AANLkTimQGeFAvuqOS6MzsJrR=w4_kMN6gawO3dO=T6Hy@mail.gmail.com>
References: <AANLkTikk5HmxhbZnkEQvdXdyh67Qnkj4TeEjoHOafxzU@mail.gmail.com>
 <3569.1286528658@cl.cam.ac.uk>
 <AANLkTik-MhrYLZTAF7moBWZLwDKTMJ3xYMp+WFdY4fC8@mail.gmail.com>
 <20101008131403.GM17803@smoon> <4CAF2281.9060307@elzevir.fr>
 <lm5xkc2jea24.dlg@nililand.de>
 <AANLkTimQGeFAvuqOS6MzsJrR=w4_kMN6gawO3dO=T6Hy@mail.gmail.com>
Message-ID: <4CD36618.6060209@elzevir.fr>

Le 22/10/2010 17:05, Mojca Miklavec a ?crit :
> It is quite possible that it doesn't exist on CTAN since it was added
> ad-hoc to TeX Live's SVN as a temporary solution until something
> better comes up.
> 
You're right. It also explains why we put the file in texmf as opposed to
texmf-dist, ad Reinhard mentioned.

Manuel.

From mpg at elzevir.fr  Fri Nov  5 03:13:01 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Fri, 05 Nov 2010 03:13:01 +0100
Subject: [luatex] luainputenc and inputenc
In-Reply-To: <A2F0C686-2951-47A9-AE5E-5752BCDE20B5@yahoo.de>
References: <4CB98F3A.30204@free.fr>
 <A2F0C686-2951-47A9-AE5E-5752BCDE20B5@yahoo.de>
Message-ID: <4CD3682D.6090005@elzevir.fr>

Hi,

Sorry I'm replying so lately...

Le 16/10/2010 14:37, Philipp Stephani a ?crit :
> luainputenc is only for lualatex. If you want to compile with pdflatex, use inputenc instead.

As ?lie mentioned, the documentation says otherwise. I'll try Ulrike's fix.

> When compiling with lualatex, however, \usepackage[utf8]{luainputenc} is
> unnecessary because UTF-8 is already the default. If you want to be
> compatible with all three major engines, use a switch like the following:
> 
It's a common misconception: despite the name, luainputenc is also related to
the output (ie font) encoding. If you want to use 8-bit fonts (which may be the
case for legacy documents), you *do* need it, of fontenc won't work properly.

So, you (currently) need luainputenc if :
- your input encoding isn't UTF-8
OR (inclusive)
-your font encoding isn't allways Unicode.

Manuel.

From mpg at elzevir.fr  Fri Nov  5 03:23:22 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Fri, 05 Nov 2010 03:23:22 +0100
Subject: [luatex] luainputenc and inputenc
In-Reply-To: <dc9dnn68bq47.dlg@nililand.de>
References: <9560.1287233049@cl.cam.ac.uk>
 <4CB9A37B.7080304@telecom-bretagne.eu> <dc9dnn68bq47.dlg@nililand.de>
Message-ID: <4CD36A9A.10909@elzevir.fr>

Le 17/10/2010 15:26, Ulrike Fischer a ?crit :
> Well it would be certainly a good idea to declare the options utf8
> etc *before* actually loading inputenc (or xetex-inputenc) if you
> want inputenc to acually use this options.  
> 
Right. I applied your fixed, checked that it works, and uploaded to CTAN.

Thanks a lot!

Manuel.

From heiko.oberdiek at googlemail.com  Fri Nov  5 05:11:32 2010
From: heiko.oberdiek at googlemail.com (Heiko Oberdiek)
Date: Fri, 5 Nov 2010 05:11:32 +0100
Subject: [luatex] \pdfannot in LuaLaTeX
In-Reply-To: <4CD2DD46.9090503@web.de>
References: <4CD2DD46.9090503@web.de>
Message-ID: <20101105041131.GA8715@oberdiek.my-fqdn.de>

On Thu, Nov 04, 2010 at 05:20:22PM +0100, Pablo Rodr?guez wrote:

> \documentclass[12pt]{minimal}
> \usepackage{fontspec}
> \setmainfont{FreeSans}
> \usepackage[pdfencoding=auto,pdftitle={????????????? ????? ????????}]{hyperref}
> \pdfstringdef{\octalcr}{\015}
> \begin{document}
> \pdfannot{/Subtype /Text /Name (Help) /T (Pablo Rodr?guez) /C [1 0
> 0] /Subj (Tama?os de p?gina y hoja) /Open true /Contents (El tama?o
> de p?gina es carta con la p?gina original centrada y marcas de corte
> en las p?ginas impares.\octalcr{}Las versiones en tama?o original y
> carta se encuentran en http://www.rosa-varela.tk</a>.)}?????????????
> ????? ????????.
> \end{document}
> 
> everything has its right encoding, but the text in the annotation is
> wrong encoded. Text is in utf-8.

The PDF specification doesn't know UTF-8.
You can use \pdfstringdef:

\pdfstringdef\TText{Pablo ...}
\pdfstringdef\SubjText{Tam...}
\pdfstringdef\ContentsText{El tam...\textCR Las versiones ...}
\pdfannot{%
  /Subtype/Text
  /Name(Help)
  /T(\TText)
  /Subj(\SubjText)
  /Contents(\ContentsText)
  ...
}

Yours sincerely 
  Heiko Oberdiek

From oinos at web.de  Fri Nov  5 06:45:17 2010
From: oinos at web.de (=?ISO-8859-1?Q?Pablo_Rodr=EDguez?=)
Date: Fri, 05 Nov 2010 06:45:17 +0100
Subject: [luatex] \pdfannot in LuaLaTeX
In-Reply-To: <20101105041131.GA8715@oberdiek.my-fqdn.de>
References: <4CD2DD46.9090503@web.de>
 <20101105041131.GA8715@oberdiek.my-fqdn.de>
Message-ID: <4CD399ED.3080207@web.de>

On 11/05/2010 05:11 AM, Heiko Oberdiek wrote:
> On Thu, Nov 04, 2010 at 05:20:22PM +0100, Pablo Rodr?guez wrote:
>
>> [...]
>>
>> everything has its right encoding, but the text in the annotation is
>> wrong encoded. Text is in utf-8.
>
> The PDF specification doesn't know UTF-8.
> You can use \pdfstringdef:

Thanks, Heiko, for your help.

How do I introduce a carriage return in the \Contents?

I mean if i use

\pdfstringdef{\CText}{El tama?o \015 Las versiones}

no carriage return is introduced and the text after \015 is displayed as 
CJK (I guess it is Chinese).

How can I fix this?

Thanks for your help again,

Pablo
-- 
http://www.ousia.tk

From luigi.scarso at gmail.com  Fri Nov  5 06:48:45 2010
From: luigi.scarso at gmail.com (luigi scarso)
Date: Fri, 5 Nov 2010 06:48:45 +0100
Subject: [luatex] \pdfannot in LuaLaTeX
In-Reply-To: <4CD399ED.3080207@web.de>
References: <4CD2DD46.9090503@web.de>
 <20101105041131.GA8715@oberdiek.my-fqdn.de>
 <4CD399ED.3080207@web.de>
Message-ID: <AANLkTik8P0zecEKNyWezETNgBc4x_yyXoYtHWUFa6MXQ@mail.gmail.com>

2010/11/5 Pablo Rodr?guez <oinos at web.de>:
> On 11/05/2010 05:11 AM, Heiko Oberdiek wrote:
>>
>> On Thu, Nov 04, 2010 at 05:20:22PM +0100, Pablo Rodr?guez wrote:
>>
>>> [...]
>>>
>>> everything has its right encoding, but the text in the annotation is
>>> wrong encoded. Text is in utf-8.
>>
>> The PDF specification doesn't know UTF-8.
>> You can use \pdfstringdef:
>
> Thanks, Heiko, for your help.
>
> How do I introduce a carriage return in the \Contents?
>
> I mean if i use
>
> \pdfstringdef{\CText}{El tama?o \015 Las versiones}
>
> no carriage return is introduced and the text after \015 is displayed as CJK
> (I guess it is Chinese).
>
> How can I fix this?
Maybe
\pdfstringdef\ContentsText{El tam...\textCR Las versiones ...}
?
-- 
luigi


From heiko.oberdiek at googlemail.com  Fri Nov  5 12:50:26 2010
From: heiko.oberdiek at googlemail.com (Heiko Oberdiek)
Date: Fri, 5 Nov 2010 12:50:26 +0100
Subject: [luatex] \pdfannot in LuaLaTeX
In-Reply-To: <4CD399ED.3080207@web.de>
References: <4CD2DD46.9090503@web.de>
 <20101105041131.GA8715@oberdiek.my-fqdn.de>
 <4CD399ED.3080207@web.de>
Message-ID: <20101105115026.GA11284@oberdiek.my-fqdn.de>

On Fri, Nov 05, 2010 at 06:45:17AM +0100, Pablo Rodr?guez wrote:

> On 11/05/2010 05:11 AM, Heiko Oberdiek wrote:
> >On Thu, Nov 04, 2010 at 05:20:22PM +0100, Pablo Rodr?guez wrote:
> >
> >>[...]
> >>
> >>everything has its right encoding, but the text in the annotation is
> >>wrong encoded. Text is in utf-8.
> >
> >The PDF specification doesn't know UTF-8.
> >You can use \pdfstringdef:
> 
> Thanks, Heiko, for your help.
> 
> How do I introduce a carriage return in the \Contents?

Reread my example.

> \pdfstringdef{\CText}{El tama?o \015 Las versiones}
> 
> no carriage return is introduced and the text after \015 is
> displayed as CJK (I guess it is Chinese).

\textCR that works in both encodings PDFDocEncoding (PD1) and
Unicode (PU).

Yours sincerely
  Heiko Oberdiek

From oinos at web.de  Fri Nov  5 22:33:27 2010
From: oinos at web.de (=?UTF-8?B?UGFibG8gUm9kcsOtZ3Vleg==?=)
Date: Fri, 05 Nov 2010 22:33:27 +0100
Subject: [luatex] \pdfannot in LuaLaTeX
In-Reply-To: <AANLkTik8P0zecEKNyWezETNgBc4x_yyXoYtHWUFa6MXQ@mail.gmail.com>
References: <4CD2DD46.9090503@web.de>
 <20101105041131.GA8715@oberdiek.my-fqdn.de> <4CD399ED.3080207@web.de>
 <AANLkTik8P0zecEKNyWezETNgBc4x_yyXoYtHWUFa6MXQ@mail.gmail.com>
Message-ID: <4CD47827.5070403@web.de>

On 11/05/2010 06:48 AM, luigi scarso wrote:
> 2010/11/5 Pablo Rodr?guez<oinos at web.de>:
>> On 11/05/2010 05:11 AM, Heiko Oberdiek wrote:
>>>
>>> On Thu, Nov 04, 2010 at 05:20:22PM +0100, Pablo Rodr?guez wrote:
>>>
>>>> [...]
>>>>
>>>> everything has its right encoding, but the text in the annotation is
>>>> wrong encoded. Text is in utf-8.
>>>
>>> The PDF specification doesn't know UTF-8.
>>> You can use \pdfstringdef:
>>
>> Thanks, Heiko, for your help.
>>
>> How do I introduce a carriage return in the \Contents?
>>
>> I mean if i use
>>
>> \pdfstringdef{\CText}{El tama?o \015 Las versiones}
>>
>> no carriage return is introduced and the text after \015 is displayed as CJK
>> (I guess it is Chinese).
>>
>> How can I fix this?
> Maybe
> \pdfstringdef\ContentsText{El tam...\textCR Las versiones ...}
> ?

Thanks for your help, Luigi.


Pablo
-- 
http://www.ousia.tk

From oinos at web.de  Fri Nov  5 22:35:14 2010
From: oinos at web.de (=?ISO-8859-1?Q?Pablo_Rodr=EDguez?=)
Date: Fri, 05 Nov 2010 22:35:14 +0100
Subject: [luatex] \pdfannot in LuaLaTeX
In-Reply-To: <20101105115026.GA11284@oberdiek.my-fqdn.de>
References: <4CD2DD46.9090503@web.de>
 <20101105041131.GA8715@oberdiek.my-fqdn.de> <4CD399ED.3080207@web.de>
 <20101105115026.GA11284@oberdiek.my-fqdn.de>
Message-ID: <4CD47892.5040801@web.de>

On 11/05/2010 12:50 PM, Heiko Oberdiek wrote:
> On Fri, Nov 05, 2010 at 06:45:17AM +0100, Pablo Rodr?guez wrote:
>> [...]
>> How do I introduce a carriage return in the \Contents?
>
> Reread my example.

Sorry, I overlooked it this morning (I was almost asleep).

Thanks for your help,


Pablo
-- 
http://www.ousia.tk

From mpg at elzevir.fr  Mon Nov  8 03:40:45 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Mon, 08 Nov 2010 03:40:45 +0100
Subject: [luatex] announcing lualatex-doc
Message-ID: <4CD7632D.7060403@elzevir.fr>

Hi,

I'd like to announce that I commited a tentative guide to the current state of
LuaLaTeX. From the readme:

> This document is a map, or touristic guide, for the new world of LuaLaTeX.
> Though focusing on LuaLaTeX, it includes relevant information about LuaTeX
> with the Plain format, too.
> 
> The intended audience ranges from complete newcomers (with a working
> knowledge of conventional LaTeX) to package developers. This guide is
> intended to be comprehensive in the following sense: it contains pointers to
> all relevant sources, gathers information that is otherwise scattered, and
> adds introductory material.
> 
> Feedback and suggestions for improvement are most welcome.

The document is on its way to CTAN, hence your favourite (La)TeX distribution.
The impatients can also find it at http://tug.org/~mpg/lualatex-doc.pdf

Happy reading,
Manuel.

From martin at oneiros.de  Mon Nov  8 11:59:39 2010
From: martin at oneiros.de (=?ISO-8859-1?Q?Martin_Schr=F6der?=)
Date: Mon, 8 Nov 2010 11:59:39 +0100
Subject: [luatex] [lltx] announcing lualatex-doc
In-Reply-To: <4CD7632D.7060403@elzevir.fr>
References: <4CD7632D.7060403@elzevir.fr>
Message-ID: <AANLkTi=9c-a51JWZ8QsL-xiueGPGrWwko0sDPFyVdB3u@mail.gmail.com>

2010/11/8 Manuel P?gouri?-Gonnard <mpg at elzevir.fr>:
>> Feedback and suggestions for improvement are most welcome.

Great!

Best
   Martin


From taco at elvenkind.com  Mon Nov  8 12:19:21 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Mon, 08 Nov 2010 12:19:21 +0100
Subject: [luatex] announcing lualatex-doc
In-Reply-To: <4CD7632D.7060403@elzevir.fr>
References: <4CD7632D.7060403@elzevir.fr>
Message-ID: <4CD7DCB9.2020009@elvenkind.com>

On 11/08/2010 03:40 AM, Manuel P?gouri?-Gonnard wrote:
> Hi,
>
> I'd like to announce that I commited a tentative guide to the current state of
> LuaLaTeX. From the readme:
>
>> This document is a map, or touristic guide, for the new world of LuaLaTeX.
>> Though focusing on LuaLaTeX, it includes relevant information about LuaTeX
>> with the Plain format, too.
>>
>> The intended audience ranges from complete newcomers (with a working
>> knowledge of conventional LaTeX) to package developers. This guide is
>> intended to be comprehensive in the following sense: it contains pointers to
>> all relevant sources, gathers information that is otherwise scattered, and
>> adds introductory material.
>>
>> Feedback and suggestions for improvement are most welcome.
>
> The document is on its way to CTAN, hence your favourite (La)TeX distribution.
> The impatients can also find it at http://tug.org/~mpg/lualatex-doc.pdf

Thanks!

From vafakhlgh at gmail.com  Thu Nov 11 00:53:48 2010
From: vafakhlgh at gmail.com (Vafa Khalighi)
Date: Thu, 11 Nov 2010 10:53:48 +1100
Subject: [luatex] luatex bug (the bug that was fixed before,
	now exists again in v0.62)
Message-ID: <AANLkTinjdx6HmFN26vOJn8HfzxpBUbtqfc8XZ6zTH21v@mail.gmail.com>

If you rember there was a bug that shifted display math to the left or right
and it was fixed but in v0.62, this bug still exists. Minimal attached.
-- 
I prefer the most bloodcurdling death to living with humility. The only
country I am faithful to, is IRAN. Do not denigrate my last moments...
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20101111/65db2a04/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: test.pdf
Type: application/pdf
Size: 9781 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101111/65db2a04/attachment.pdf>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: test.tex
Type: application/x-tex
Size: 83 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101111/65db2a04/attachment.tex>

From taco at elvenkind.com  Thu Nov 11 08:26:30 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Thu, 11 Nov 2010 08:26:30 +0100
Subject: [luatex] luatex bug (the bug that was fixed before,
 now exists again in v0.62)
In-Reply-To: <AANLkTinjdx6HmFN26vOJn8HfzxpBUbtqfc8XZ6zTH21v@mail.gmail.com>
References: <AANLkTinjdx6HmFN26vOJn8HfzxpBUbtqfc8XZ6zTH21v@mail.gmail.com>
Message-ID: <4CDB9AA6.4010400@elvenkind.com>

On 11/11/2010 12:53 AM, Vafa Khalighi wrote:
> If you rember there was a bug that shifted display math to the left or
> right and it was fixed but in v0.62, this bug still exists. Minimal
> attached.

Thanks for the report, I reopened the original tracker:

   http://tracker.luatex.org/view.php?id=250

Best wishes,
Taco

From taco at elvenkind.com  Fri Nov 12 14:50:45 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 12 Nov 2010 14:50:45 +0100
Subject: [luatex] Luatex 0.64.0 announcement
Message-ID: <4CDD4635.8080109@elvenkind.com>

Hi,

I have just uploaded the archives for a new luatex release, 0.64.0.
This is a development release, but it also fixes a few rather
annoying bugs in 0.63.0.


News:

* New lua functions pdf.refobj(), pdf.maxobjnum() and pdf.objtype()

* New lua function node.is_node()

* The max_strings configuration variable's maximum value is
   raised to be identical to texlive's maximum (2097151), and
   same for param_size (32767).

* The embedded mplib is now 1.503.

* Minor cleanups in the output of fontloader.to_table():

   - removed out-of-range altuni's from the output
   - don't dump the extra encodings, just the actual font encoding
   - export the encoding's name also as 'enc_name' at one level up
   - no longer exporting unset macstyles, nor zero uniqueids
   - fix creationtime and modification time

* Ongoing work on the epdf library

Bugfixes:

* Fix a bug where an explicit hyphen prevented hyphenation for the
   whole rest of the paragraph

* Internal font copying forgot to copy the last font dimen

* os.selfdir() is now documented

* patch quad (\fontdimen6) in \letterspacefont to be compatible
   with pdftex

* Multi-page pdf inclusion was very slow in 0.63.0

* Some extra checks added to the handling of glue_spec node
   objects in lua code.

* Some node.prev pointers have been corrected (but this is not
   quite finished).

* A small fix to lpeg 0.9.


The archives can be downloaded from supelec as usual:

         http://foundry.supelec.fr/gf/project/luatex/

You could also check out the sources via anonymous svn:

   svn co http://foundry.supelec.fr/svn/luatex/tags/beta-0.64.0

Bugs and feature requests can be added to the issue tracker at

        http://tracker.luatex.org

Have fun,
Taco




From luatex at nililand.de  Tue Nov 16 15:48:08 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Tue, 16 Nov 2010 15:48:08 +0100
Subject: [luatex] questions about the "reader" in open_read_file callback
Message-ID: <1gt83epeim59e$.dlg@nililand.de>

I'm trying to write some code to handle the input of 8-bit-encoded
files. I'm using the ideas I found in an old posting
(http://www.ntg.nl/pipermail/dev-luatex/2006-December/000276.html)

In short with the open_read_file callback I open the file, scan the
first lines for an encoding setting (e.g. %encoding=ansinew) and
then change the reader so that it converts the ansinew to utf8.

To my suprise my code even worked in this setup

%encoding=ansinew
??? %read as ansinew

\input{utf8-file} %read as utf8

??? %read again in ansinew

1. Does that mean that each file has its own "reader" instance? Or
is there some scoping involved? 

2. Currently my code affects only files input later. How could I
change the processing of (only) the main document? 



-- 
Ulrike Fischer 


From mpg at elzevir.fr  Tue Nov 16 18:06:26 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Tue, 16 Nov 2010 18:06:26 +0100
Subject: [luatex] questions about the "reader" in open_read_file callback
In-Reply-To: <1gt83epeim59e$.dlg@nililand.de>
References: <1gt83epeim59e$.dlg@nililand.de>
Message-ID: <4CE2BA12.3060307@elzevir.fr>

Le 16/11/2010 15:48, Ulrike Fischer a ?crit :
> 1. Does that mean that each file has its own "reader" instance? Or
> is there some scoping involved? 
> 
Each file *has* to have its own reader, since the reader needs to keep track of,
eg, the current line of the file.

> 2. Currently my code affects only files input later. How could I
> change the processing of (only) the main document? 
> 
I'm under the impression the only way to specify a reader for the main file is
to install a function in the open_read_file callback before the main file is
opened, which may be tricky.

You could use process_input_buffer to transcode the individual lines of the main
file (as luainputenc does), but it doesn't have the nice feature of being
file-specific.

Manuel.

From taco at elvenkind.com  Wed Nov 17 10:38:27 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Wed, 17 Nov 2010 10:38:27 +0100
Subject: [luatex] questions about the "reader" in open_read_file callback
In-Reply-To: <4CE2BA12.3060307@elzevir.fr>
References: <1gt83epeim59e$.dlg@nililand.de> <4CE2BA12.3060307@elzevir.fr>
Message-ID: <4CE3A293.3030607@elvenkind.com>

On 11/16/2010 06:06 PM, Manuel P?gouri?-Gonnard wrote:
> Le 16/11/2010 15:48, Ulrike Fischer a ?crit :
>> 1. Does that mean that each file has its own "reader" instance? Or
>> is there some scoping involved?
>>
> Each file *has* to have its own reader, since the reader needs to keep track of,
> eg, the current line of the file.

Right.

>> 2. Currently my code affects only files input later. How could I
>> change the processing of (only) the main document?
>>
> I'm under the impression the only way to specify a reader for the main file is
> to install a function in the open_read_file callback before the main file is
> opened, which may be tricky.

Yes, it is a little tricky to set this up properly: you need to define
the callbacks in the lua startup script.

Best wishes,
Taco

From luatex at nililand.de  Wed Nov 17 17:39:31 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 17 Nov 2010 17:39:31 +0100
Subject: [luatex] questions about the "reader" in open_read_file callback
References: <1gt83epeim59e$.dlg@nililand.de> <4CE2BA12.3060307@elzevir.fr>
Message-ID: <16zno0vmsztaa$.dlg@nililand.de>

Am Tue, 16 Nov 2010 18:06:26 +0100 schrieb Manuel P?gouri?-Gonnard:

> Le 16/11/2010 15:48, Ulrike Fischer a ?crit :
>> 1. Does that mean that each file has its own "reader" instance? Or
>> is there some scoping involved? 
>> 
> Each file *has* to have its own reader, since the reader needs to keep track of,
> eg, the current line of the file.

Makes sense (and I don't complain, it makes things much easier)

 
>> 2. Currently my code affects only files input later. How could I
>> change the processing of (only) the main document? 
 
> I'm under the impression the only way to specify a reader for the main file is
> to install a function in the open_read_file callback before the main file is
> opened, which may be tricky.
 
> You could use process_input_buffer to transcode the individual lines of the main
> file (as luainputenc does), but it doesn't have the nice feature of being
> file-specific.

Well one could perhaps reset the callback at \input/end-of-file, but
it doesn't feel right to use this callback. At least not when more
than one encoding is involved. In such cases files should declare
their encoding and this declaration should be used. 

On-the-whole I think the initialization script is the correct place.
There is only the problem that it isn't found which kpathsea. One
has to set the environment variable LUATEXDIR. Has this variable in
TeXLive a standard value? 

And if I register a callback in the script with callback.register
will this give trouble with the callback code in luatexbase?  



-- 
Ulrike Fischer 


From mpg at elzevir.fr  Wed Nov 17 18:34:26 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Wed, 17 Nov 2010 18:34:26 +0100
Subject: [luatex] questions about the "reader" in open_read_file callback
In-Reply-To: <16zno0vmsztaa$.dlg@nililand.de>
References: <1gt83epeim59e$.dlg@nililand.de> <4CE2BA12.3060307@elzevir.fr>
 <16zno0vmsztaa$.dlg@nililand.de>
Message-ID: <4CE41222.7000102@elzevir.fr>

Le 17/11/2010 17:39, Ulrike Fischer a ?crit :
> Am Tue, 16 Nov 2010 18:06:26 +0100 schrieb Manuel P?gouri?-Gonnard:
> 
>> You could use process_input_buffer to transcode the individual lines of the main
>> file (as luainputenc does), but it doesn't have the nice feature of being
>> file-specific.
> 
> Well one could perhaps reset the callback at \input/end-of-file, but
> it doesn't feel right to use this callback. At least not when more
> than one encoding is involved. In such cases files should declare
> their encoding and this declaration should be used. 
> 
I fully agree.

> On-the-whole I think the initialization script is the correct place.
> There is only the problem that it isn't found which kpathsea. One
> has to set the environment variable LUATEXDIR. Has this variable in
> TeXLive a standard value? 
> 
Nope. But, afaiu, this variable is only a path, not a set of path for searching.
I mean, it seems to me that

LUATEXDIR=/some/path luatex --lua=script

is equivalent to

luatex --lua=/some/path/script

> And if I register a callback in the script with callback.register
> will this give trouble with the callback code in luatexbase?  
> 
It will, if someone tries to add another function in this callback, i'm afraid
your function will be silently overridden. (I'll probably add a test so that at
least a warning is issued in this case.)

But you can perfectly do

kpse.set_program_name(arg[0])
require('luatexbase.mcb')

in your startup script and then use luatexbase to register your function in the
callback. (I think you need to explicitly initialise kpse in the startup script
if you want it to be used by require(), but Taco will correct me if I'm wrong.)
(This assumes a recent luatex, obviously.)

Manuel.

From taco at elvenkind.com  Wed Nov 17 20:39:49 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Wed, 17 Nov 2010 20:39:49 +0100
Subject: [luatex] questions about the "reader" in open_read_file callback
In-Reply-To: <4CE41222.7000102@elzevir.fr>
References: <1gt83epeim59e$.dlg@nililand.de> <4CE2BA12.3060307@elzevir.fr>
 <16zno0vmsztaa$.dlg@nililand.de> <4CE41222.7000102@elzevir.fr>
Message-ID: <4CE42F85.9050100@elvenkind.com>

On 11/17/2010 06:34 PM, Manuel P?gouri?-Gonnard wrote:
>>
> Nope. But, afaiu, this variable is only a path, not a set of path for searching.
>[...]
>
> But you can perfectly do
>
> kpse.set_program_name(arg[0])
> require('luatexbase.mcb')
>
> in your startup script and then use luatexbase to register your function in the
> callback. (I think you need to explicitly initialise kpse in the startup script
> if you want it to be used by require(),

Yes, all that is correct. And it sounds like a good solution.

Best wishes,
Taco

From taco at boekplan.nl  Wed Nov 17 17:08:20 2010
From: taco at boekplan.nl (Taco Hoekwater)
Date: Wed, 17 Nov 2010 17:08:20 +0100
Subject: [luatex] buggy bug handling apology
Message-ID: <4CE3FDF4.3000300@boekplan.nl>

Hi,

Lately, I have been so busy doing other (not unimportant) stuff that I
never seemed to be able to find the time to fix any of the reported
luatex bugs, and I am sorry about that. I realize that some quite 
annoying bugs have been reported way back (even before the summer) and
still have not been looked at at all.

The good news is that it looks like my schedule is opening up now,
so I should be able to spend a few days next week fixing luatex
bugs, and hopefully there will be a 0.65 in two weeks.

Best wishes,
Taco

From kaz.rag at gmail.com  Thu Nov 18 15:30:08 2010
From: kaz.rag at gmail.com (Kazuo Teramoto)
Date: Thu, 18 Nov 2010 12:30:08 -0200
Subject: [luatex] buggy bug handling apology
In-Reply-To: <4CE3FDF4.3000300@boekplan.nl>
References: <4CE3FDF4.3000300@boekplan.nl>
Message-ID: <AANLkTimWTr6oSfKRfxhj51RJ27RbkKTHr5LYLMBnBSDC@mail.gmail.com>

On Wed, Nov 17, 2010 at 2:08 PM, Taco Hoekwater <taco at boekplan.nl> wrote:
> Hi,
>
> Lately, I have been so busy doing other (not unimportant) stuff that I
> never seemed to be able to find the time to fix any of the reported
> luatex bugs, and I am sorry about that. I realize that some quite annoying
> bugs have been reported way back (even before the summer) and
> still have not been looked at at all.
>
> The good news is that it looks like my schedule is opening up now,
> so I should be able to spend a few days next week fixing luatex
> bugs, and hopefully there will be a 0.65 in two weeks.
>

Take your time! You and the luatex team are doing (and already did) a
great job. I'm very thankful for this, and I'm sure that I speak for
whole TeX community in this matter.

Best regards,
Kazuo
-- 
?The journey is more important than the destination?that?s part of
life, if you only live for getting to the end, you?re almost always
disappointed.?

Donald E. Knuth


From zappathustra at free.fr  Thu Nov 18 18:36:42 2010
From: zappathustra at free.fr (Paul Isambert)
Date: Thu, 18 Nov 2010 18:36:42 +0100
Subject: [luatex] buggy bug handling apology
In-Reply-To: <AANLkTimWTr6oSfKRfxhj51RJ27RbkKTHr5LYLMBnBSDC@mail.gmail.com>
References: <4CE3FDF4.3000300@boekplan.nl>
 <AANLkTimWTr6oSfKRfxhj51RJ27RbkKTHr5LYLMBnBSDC@mail.gmail.com>
Message-ID: <1290101802.4ce5642a9efce@imp.free.fr>

Selon Kazuo Teramoto <kaz.rag at gmail.com>:

> On Wed, Nov 17, 2010 at 2:08 PM, Taco Hoekwater <taco at boekplan.nl> wrote:
> > Hi,
> >
> > Lately, I have been so busy doing other (not unimportant) stuff that I
> > never seemed to be able to find the time to fix any of the reported
> > luatex bugs, and I am sorry about that. I realize that some quite annoying
> > bugs have been reported way back (even before the summer) and
> > still have not been looked at at all.
> >
> > The good news is that it looks like my schedule is opening up now,
> > so I should be able to spend a few days next week fixing luatex
> > bugs, and hopefully there will be a 0.65 in two weeks.
> >
>
> Take your time! You and the luatex team are doing (and already did) a
> great job. I'm very thankful for this, and I'm sure that I speak for
> whole TeX community in this matter.

At least you speak for me. All the more as most (if not all) of the bugs I've
reported have been fixed quite quickly (not to mention many questions answered).
I can imagine that working on a job as awaited as LuaTeX might be stressful, and
perhaps you sometimes hallucinate the sound of eager users rasping at your front
door, or wake up at night screaming "That node list isn't right!", but I
honestly think nobody's blaming you for anything, Taco, quite the contrary.

Best,
Paul

From zappathustra at free.fr  Thu Nov 18 21:52:10 2010
From: zappathustra at free.fr (Paul Isambert)
Date: Thu, 18 Nov 2010 21:52:10 +0100
Subject: [luatex] Turning a string into a list of nodes.
Message-ID: <1290113530.4ce591fa41f2e@imp.free.fr>

Hello all,

I've been trying to devise a Lua function which, when fed a string, returns a
list of nodes. The application I have in mind is line numbering, counting lines
in the post_linebreak_filter and adding an \hbox with the number to lines that
are a multiple of a given number. Everything should be done in Lua, and thus the
counter must be converted to a list of nodes. I.e. the following should be
possible:

mylist = string_tolist(tostring(linecounter))

And more generally (there might be other applications beside line numbering):

mylist = string_tolist("Blah blah.")

I've come up with the code below. It does exactly that (given it's fed ASCII,
for it's not supposed to be complete now), but I find it quite convoluted: it
analyzes the string and turns each character into a node. And discretionaries
can't be inserted.

And here come the questions: Have I missed a definitely simpler way to do what I
want? If not, any suggestion on the code below? Do you think I should
feature-request Taco for a hard-coded function, capitalizing on his upcoming
available time and bad conscience? :)

Best,
Paul

-- Turns a character into a node.
local function create_glyph (char, fnt)
  local glyph = font.getfont(fnt).characters[string.byte(char)]
  local glyph_node = node.new(37, 0)
  -- Could use glyph.name with PS fonts.
  glyph_node.char = string.byte(char)
  glyph_node.font = fnt
  glyph_node.lang = tex.language
  glyph_node.left, glyph_node.right = tex.lefthyphenmin, tex.righthyphenmin
  glyph_node.uchyph = tex.uchyph
  glyph_node.xoffset, glyph_node.yoffset = 0, 0
-- These produce an error message if one tries to set them.
--  glyph_node.width = glyph.width
--  glyph_node.height = glyph.height
--  glyph_node.depth = glyph.depth
  glyph_node.expansion_factor = glyph.expansion_factor
  return glyph_node
end

-- Creates a skip node.
local function create_skip (fnt)
  local skip = node.new(10, 0)
  local spec = node.new(47)
  spec.width = font.getfont(fnt).parameters.space
  spec.stretch = font.getfont(fnt).parameters.space_stretch
  spec.shrink = font.getfont(fnt).parameters.space_shrink
  spec.stretch_order = 0
  spec.shrink_order = 0
  skip.spec = spec
  return skip
end

-- Returns the first character of a string and
-- the rest of the string.
local function string_pop(str)
  	local first_char
  	local new_string = string.gsub(str, "(.)",
  	  function (match)
  	    first_char = match
  	    return ""
  	  end, 1)
  	return first_char, new_string
end

function string_tolist (str, fnt)
  -- The font is optional, the current one is used if none is given.
  local Font = fnt or font.current()
  local head, prev
  local char, str = string_pop(str)
  while char do
    local glyph
    if char == " " then
      glyph = create_skip(Font)
    else
      glyph = create_glyph(char, Font)
    end
    glyph.prev = prev
    if prev then
      prev.next = glyph
    else
      head = glyph
    end
    prev = glyph
    char, str = string_pop(str)
  end
  -- How can one insert discretionaries in the list?
  for item in node.traverse(head) do
    node.ligaturing(item)
  end
  for item in node.traverse(head) do
    if item.next then
      -- If the second argument isn't there, LuaTeX crashes.
      node.kerning(item, item.next)
    end
  end
  return head
end

From patrick at gundla.ch  Thu Nov 18 22:49:15 2010
From: patrick at gundla.ch (Patrick Gundlach)
Date: Thu, 18 Nov 2010 22:49:15 +0100
Subject: [luatex] Turning a string into a list of nodes.
In-Reply-To: <1290113530.4ce591fa41f2e@imp.free.fr>
References: <1290113530.4ce591fa41f2e@imp.free.fr>
Message-ID: <519756C4-B83A-4415-8DD2-7E0E70801CC3@gundla.ch>

Hi Paul,

i do something like this (pseudo code): 

  local match = unicode.utf8.match

  for s in string.utfvalues(str) do
    char = unicode.utf8.char(s)
    if match(char,"%s") and last and last.id == 10 then -- is it 10, the glue node?? 
      -- double whitespace, \relax
    elseif match(char,"%s") then -- ws
      n = node.new("glue")
      n.spec = node.new("glue_spec")
      n.spec.width   = space -- calculated somewhere else
      n.spec.shrink  = shrink 
      n.spec.stretch = stretch

      if head then
        last.next = n
      else
        head = n
      end
      last = n

    else
      n = node.new("glyph")
      n.font = ... (set somewhere else)
      n.char = s
      n.lang = 0
      n.left = tex.lefthyphenmin
      n.right = tex.righthyphenmin

      if head then
        last.next = n
      else
        head = n
      end
      last = n
    end
  end


and then I use node.kerning() for kerning and lang.hyphenate() for inserting disc nodes.


Patrick



From pander at users.sourceforge.net  Fri Nov 19 10:00:24 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 10:00:24 +0100
Subject: [luatex] Still an error with soulutf8
Message-ID: <4CE63CA8.6090708@users.sourceforge.net>

Hi all,

I'm new to LuaLaTeX and also ran into this problem:
  http://www.mail-archive.com/luatex at tug.org/msg01676.html

$ lualatex --version
This is LuaTeX, Version beta-0.60.2-2010071218 (TeX Live 2010) (rev 3736)

I use
...
\usepackage{soulutf8}
...
\ul{bla}

and the result is:
! Package soul Error: Reconstruction failed.

See the soul package documentation for explanation.
Type  H <return>  for immediate help.
 ...

Can this be fixed or what is a workaround?

Thanks,

Pander

From taco at elvenkind.com  Fri Nov 19 10:05:17 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 19 Nov 2010 10:05:17 +0100
Subject: [luatex] Still an error with soulutf8
In-Reply-To: <4CE63CA8.6090708@users.sourceforge.net>
References: <4CE63CA8.6090708@users.sourceforge.net>
Message-ID: <CCF1F058-760D-4CD9-A2DB-A11C36D30B4F@elvenkind.com>


On Nov 19, 2010, at 10:00 AM, Pander wrote:

> ! Package soul Error: Reconstruction failed.
> 
> See the soul package documentation for explanation.
> Type  H <return>  for immediate help.
> ...
> 
> Can this be fixed or what is a workaround?

Updating to the luatex binary from tlcontrib should fix this. 

http://tlcontrib.metatex.org

Best wishes,
Taco


From taco at elvenkind.com  Fri Nov 19 10:33:12 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 19 Nov 2010 10:33:12 +0100
Subject: [luatex] Turning a string into a list of nodes.
In-Reply-To: <1290113530.4ce591fa41f2e@imp.free.fr>
References: <1290113530.4ce591fa41f2e@imp.free.fr>
Message-ID: <4CE64458.6080602@elvenkind.com>

On 11/18/2010 09:52 PM, Paul Isambert wrote:
> Hello all,
>
> I've been trying to devise a Lua function which, when fed a string, returns a
> list of nodes. The application I have in mind is line numbering, counting lines
> in the post_linebreak_filter and adding an \hbox with the number to lines that
> are a multiple of a given number. Everything should be done in Lua, and thus the
> counter must be converted to a list of nodes. I.e. the following should be
> possible:
>
> mylist = string_tolist(tostring(linecounter))

This case is fairly straightforward, you could even prepare the 10
needed nodes in advance and then use node.copy() to chain them.

> And here come the questions: Have I missed a definitely simpler way to do what I
> want?

No, there is not. The simple reason for that is that it is an
exceedingly tricky function to write in the general case: the
luatex main control function has numerous side-effects and global
state variables at the moment, making it unsuitable for general use
on 'tex input', while on the other hand it seemed a shame to write a
'copy' of main control just for this.

The 'pure ascii input' is simple enough to do in pure lua, as seen from
your own code and Patrick's.

>    for item in node.traverse(head) do
>      if item.next then
>        -- If the second argument isn't there, LuaTeX crashes.
>        node.kerning(item, item.next)
>      end
>    end

This is overdoing it, there is no need for a loop here. In fact,
the reason for it crashing in the lacking .next case is probably
because the list is getting modified inside of the loop.

You should be able to simply run

    node.kerning(head)

Best wishes,
Taco

From zappathustra at free.fr  Fri Nov 19 10:37:08 2010
From: zappathustra at free.fr (Paul Isambert)
Date: Fri, 19 Nov 2010 10:37:08 +0100
Subject: [luatex] Turning a string into a list of nodes.
In-Reply-To: <519756C4-B83A-4415-8DD2-7E0E70801CC3@gundla.ch>
References: <1290113530.4ce591fa41f2e@imp.free.fr>
 <519756C4-B83A-4415-8DD2-7E0E70801CC3@gundla.ch>
Message-ID: <4CE64544.3090108@free.fr>

Thanks Patrick for your code.

Apparently we do the same things (except your code is simply better), so 
there is no simple hard-coded function to do that. Which function I 
think might be a good idea, especially if it can process real TeX input, 
e.g. string_tolist("a\kern1em b"), perhaps with catcodes declared 
beforehand. So I'm kind of feature-requesting here, yes, yes, can't deny.

Patrick, is it on purpose you don't set "n.prev = last"? Is it useless 
or are you sure you'll simply never manipulate those node lists?

Thanks for lang.hyphenate() -- I realize there are areas of the manual I 
still haven't laid an eye on.

Best,
Paul

Le 18/11/2010 22:49, Patrick Gundlach a ?crit :
> Hi Paul,
>
> i do something like this (pseudo code):
>
>    local match = unicode.utf8.match
>
>    for s in string.utfvalues(str) do
>      char = unicode.utf8.char(s)
>      if match(char,"%s") and last and last.id == 10 then -- is it 10, the glue node??
>        -- double whitespace, \relax
>      elseif match(char,"%s") then -- ws
>        n = node.new("glue")
>        n.spec = node.new("glue_spec")
>        n.spec.width   = space -- calculated somewhere else
>        n.spec.shrink  = shrink
>        n.spec.stretch = stretch
>
>        if head then
>          last.next = n
>        else
>          head = n
>        end
>        last = n
>
>      else
>        n = node.new("glyph")
>        n.font = ... (set somewhere else)
>        n.char = s
>        n.lang = 0
>        n.left = tex.lefthyphenmin
>        n.right = tex.righthyphenmin
>
>        if head then
>          last.next = n
>        else
>          head = n
>        end
>        last = n
>      end
>    end
>
>
> and then I use node.kerning() for kerning and lang.hyphenate() for inserting disc nodes.
>
>
> Patrick
>
>

From zappathustra at free.fr  Fri Nov 19 10:51:07 2010
From: zappathustra at free.fr (Paul Isambert)
Date: Fri, 19 Nov 2010 10:51:07 +0100
Subject: [luatex] Turning a string into a list of nodes.
In-Reply-To: <4CE64458.6080602@elvenkind.com>
References: <1290113530.4ce591fa41f2e@imp.free.fr>
 <4CE64458.6080602@elvenkind.com>
Message-ID: <4CE6488B.1060005@free.fr>

Le 19/11/2010 10:33, Taco Hoekwater a ?crit :
>  On 11/18/2010 09:52 PM, Paul Isambert wrote:
>>  Hello all,
>>
>>  I've been trying to devise a Lua function which, when fed a string,
>>  returns a
>>  list of nodes. The application I have in mind is line numbering,
>>  counting lines
>>  in the post_linebreak_filter and adding an \hbox with the number to
>>  lines that
>>  are a multiple of a given number. Everything should be done in Lua,
>>  and thus the
>>  counter must be converted to a list of nodes. I.e. the following
>>  should be
>>  possible:
>>
>>  mylist = string_tolist(tostring(linecounter))
>
>  This case is fairly straightforward, you could even prepare the 10
>  needed nodes in advance and then use node.copy() to chain them.
>
>>  And here come the questions: Have I missed a definitely simpler way
>>  to do what I
>>  want?
>
>  No, there is not. The simple reason for that is that it is an
>  exceedingly tricky function to write in the general case: the
>  luatex main control function has numerous side-effects and global
>  state variables at the moment, making it unsuitable for general use
>  on 'tex input', while on the other hand it seemed a shame to write a
>  'copy' of main control just for this.
>

So ignore my previous message. I'd thought it might be quite tricky indeed.

>  The 'pure ascii input' is simple enough to do in pure lua, as seen from
>  your own code and Patrick's.
>
>>     for item in node.traverse(head) do
>>       if item.next then
>>         -- If the second argument isn't there, LuaTeX crashes.
>>         node.kerning(item, item.next)
>>       end
>>     end
>
>  This is overdoing it, there is no need for a loop here. In fact,
>  the reason for it crashing in the lacking .next case is probably
>  because the list is getting modified inside of the loop.
>
>  You should be able to simply run
>
>     node.kerning(head)

Yes, the manual is quite clear, but for some reason I'd understood that
the function applied to its argument only instead of the entire nodelist.

Best,
Paul


From pander at users.sourceforge.net  Fri Nov 19 11:05:53 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 11:05:53 +0100
Subject: [luatex] Beginner's question on mkluatexfontdb
Message-ID: <4CE64C01.8040402@users.sourceforge.net>

Hi all,

With XeLaTeX and fontspec, I could inquire at fc-list and fc-cat about
font name details. How can I do this for LuaLaTeX on its font database
because I ran into some differences in font names?

Thanks,

Pander

From khaledhosny at eglug.org  Fri Nov 19 12:16:11 2010
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Fri, 19 Nov 2010 13:16:11 +0200
Subject: [luatex] Beginner's question on mkluatexfontdb
In-Reply-To: <4CE64C01.8040402@users.sourceforge.net>
References: <4CE64C01.8040402@users.sourceforge.net>
Message-ID: <20101119111611.GA2032@khaled-laptop>

On Fri, Nov 19, 2010 at 11:05:53AM +0100, Pander wrote:
> Hi all,
> 
> With XeLaTeX and fontspec, I could inquire at fc-list and fc-cat about
> font name details. How can I do this for LuaLaTeX on its font database
> because I ran into some differences in font names?

Open the font database file (otfl-names.lua) in a text editor and search
for the fonts you want, it is the only possible way currently.

Anyway, such differences are usually a bug somewhere (most likely in my
code), so it is generally good idea to report it.

Regards,
 Khaled

-- 
 Khaled Hosny
 Arabic localiser and member of Arabeyes.org team
 Free font developer

From patrick at gundla.ch  Fri Nov 19 12:41:42 2010
From: patrick at gundla.ch (Patrick Gundlach)
Date: Fri, 19 Nov 2010 12:41:42 +0100
Subject: [luatex] Turning a string into a list of nodes.
In-Reply-To: <4CE64544.3090108@free.fr>
References: <1290113530.4ce591fa41f2e@imp.free.fr>
 <519756C4-B83A-4415-8DD2-7E0E70801CC3@gundla.ch> <4CE64544.3090108@free.fr>
Message-ID: <A0986B13-A43C-4DFA-95BF-5BBFEBE68F72@gundla.ch>

Hi Paul,

> Patrick, is it on purpose you don't set "n.prev = last"? Is it useless or are you sure you'll simply never manipulate those node lists?

I omitted node.slide() in my pseudo code :) I use node.slide() just before node.kerning() to set the prev pointer. Maybe one day I'll clean up my code and use .prev = ... instead of node.slide().

Patrick



From pander at users.sourceforge.net  Fri Nov 19 13:19:19 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 13:19:19 +0100
Subject: [luatex] Beginner's question on mkluatexfontdb
In-Reply-To: <20101119111611.GA2032@khaled-laptop>
References: <4CE64C01.8040402@users.sourceforge.net>
 <20101119111611.GA2032@khaled-laptop>
Message-ID: <4CE66B47.5070609@users.sourceforge.net>

On 2010-11-19 12:16, Khaled Hosny wrote:
> On Fri, Nov 19, 2010 at 11:05:53AM +0100, Pander wrote:
>> Hi all,
>>
>> With XeLaTeX and fontspec, I could inquire at fc-list and fc-cat about
>> font name details. How can I do this for LuaLaTeX on its font database
>> because I ran into some differences in font names?
> 
> Open the font database file (otfl-names.lua) in a text editor and search
> for the fonts you want, it is the only possible way currently.
> 
> Anyway, such differences are usually a bug somewhere (most likely in my
> code), so it is generally good idea to report it.

\documentclass{article}
\usepackage{fontspec}
\begin{document}
\fontspec{Antykwa Torunska Condensed Light}
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
\end{document}

results in

luaotfload | Updating the font names database:
luaotfload | Scanning TEXMF fonts...
luaotfload | Scanning OS fonts...
! Font \zf at basefont=name:AntykwaTorunskaCondensedLight at 10pt not
loadable: me
tric data not found or bad.
<to be read again>
                   \scan_stop:
l.4 \fontspec{Antykwa Torunska Condensed Light}

?

> Regards,
>  Khaled
> 


From pander at users.sourceforge.net  Fri Nov 19 13:24:00 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 13:24:00 +0100
Subject: [luatex] Beginner's question on mkluatexfontdb
In-Reply-To: <4CE66B47.5070609@users.sourceforge.net>
References: <4CE64C01.8040402@users.sourceforge.net>
 <20101119111611.GA2032@khaled-laptop>
 <4CE66B47.5070609@users.sourceforge.net>
Message-ID: <4CE66C60.90001@users.sourceforge.net>

On 2010-11-19 13:19, Pander wrote:
> On 2010-11-19 12:16, Khaled Hosny wrote:
>> On Fri, Nov 19, 2010 at 11:05:53AM +0100, Pander wrote:
>>> Hi all,
>>>
>>> With XeLaTeX and fontspec, I could inquire at fc-list and fc-cat about
>>> font name details. How can I do this for LuaLaTeX on its font database
>>> because I ran into some differences in font names?
>>
>> Open the font database file (otfl-names.lua) in a text editor and search
>> for the fonts you want, it is the only possible way currently.
>>
>> Anyway, such differences are usually a bug somewhere (most likely in my
>> code), so it is generally good idea to report it.
> 
> \documentclass{article}
> \usepackage{fontspec}
> \begin{document}
> \fontspec{Antykwa Torunska Condensed Light}
> ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
> \end{document}
> 
> results in
> 
> luaotfload | Updating the font names database:
> luaotfload | Scanning TEXMF fonts...
> luaotfload | Scanning OS fonts...
> ! Font \zf at basefont=name:AntykwaTorunskaCondensedLight at 10pt not
> loadable: me
> tric data not found or bad.
> <to be read again>
>                    \scan_stop:
> l.4 \fontspec{Antykwa Torunska Condensed Light}
> 
> ?

fc-list says:
Antykwa Torunska Condensed,AntykwaTorunskaCond Light:style=Light,Regular
Antykwa Torunska Condensed,AntykwaTorunskaCond Light:style=Light
Italic,Italic

With fontspec XeLaTeX, it works for Antykwa Torunska Condensed Light in
both normal and \itshape style. I suppose this one needs more
alternative for LuaLaTeX which cannot be derived easily automatically
from fontconfig.

>> Regards,
>>  Khaled
>>
> 


From zappathustra at free.fr  Fri Nov 19 13:32:47 2010
From: zappathustra at free.fr (Paul Isambert)
Date: Fri, 19 Nov 2010 13:32:47 +0100
Subject: [luatex] Turning a string into a list of nodes.
In-Reply-To: <A0986B13-A43C-4DFA-95BF-5BBFEBE68F72@gundla.ch>
References: <1290113530.4ce591fa41f2e@imp.free.fr>
 <519756C4-B83A-4415-8DD2-7E0E70801CC3@gundla.ch> <4CE64544.3090108@free.fr>
 <A0986B13-A43C-4DFA-95BF-5BBFEBE68F72@gundla.ch>
Message-ID: <4CE66E6F.9000702@free.fr>



Le 19/11/2010 12:41, Patrick Gundlach a ?crit :
> Hi Paul,
>
>> Patrick, is it on purpose you don't set "n.prev = last"? Is it useless or are you sure you'll simply never manipulate those node lists?
> I omitted node.slide() in my pseudo code :) I use node.slide() just before node.kerning() to set the prev pointer. Maybe one day I'll clean up my code and use .prev = ... instead of node.slide().

I'd never tried to parse the remark "As a side-effect, [node.slide] also 
creates a reverse chain of prev pointers between nodes". Now I 
understand it :)

Paul

From pander at users.sourceforge.net  Fri Nov 19 13:33:55 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 13:33:55 +0100
Subject: [luatex] Beginner's question on mkluatexfontdb
In-Reply-To: <4CE66C60.90001@users.sourceforge.net>
References: <4CE64C01.8040402@users.sourceforge.net>
 <20101119111611.GA2032@khaled-laptop>
 <4CE66B47.5070609@users.sourceforge.net>
 <4CE66C60.90001@users.sourceforge.net>
Message-ID: <4CE66EB3.60705@users.sourceforge.net>

On 2010-11-19 13:24, Pander wrote:
> On 2010-11-19 13:19, Pander wrote:
>> On 2010-11-19 12:16, Khaled Hosny wrote:
>>> On Fri, Nov 19, 2010 at 11:05:53AM +0100, Pander wrote:
>>>> Hi all,
>>>>
>>>> With XeLaTeX and fontspec, I could inquire at fc-list and fc-cat about
>>>> font name details. How can I do this for LuaLaTeX on its font database
>>>> because I ran into some differences in font names?
>>>
>>> Open the font database file (otfl-names.lua) in a text editor and search
>>> for the fonts you want, it is the only possible way currently.
>>>
>>> Anyway, such differences are usually a bug somewhere (most likely in my
>>> code), so it is generally good idea to report it.
>>
>> \documentclass{article}
>> \usepackage{fontspec}
>> \begin{document}
>> \fontspec{Antykwa Torunska Condensed Light}
>> ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
>> \end{document}
>>
>> results in
>>
>> luaotfload | Updating the font names database:
>> luaotfload | Scanning TEXMF fonts...
>> luaotfload | Scanning OS fonts...
>> ! Font \zf at basefont=name:AntykwaTorunskaCondensedLight at 10pt not
>> loadable: me
>> tric data not found or bad.
>> <to be read again>
>>                    \scan_stop:
>> l.4 \fontspec{Antykwa Torunska Condensed Light}
>>
>> ?
> 
> fc-list says:
> Antykwa Torunska Condensed,AntykwaTorunskaCond Light:style=Light,Regular
> Antykwa Torunska Condensed,AntykwaTorunskaCond Light:style=Light
> Italic,Italic
> 
> With fontspec XeLaTeX, it works for Antykwa Torunska Condensed Light in
> both normal and \itshape style. I suppose this one needs more
> alternative for LuaLaTeX which cannot be derived easily automatically
> from fontconfig.

Same problem with
  Antykwa Torunska Condensed Medium
  Antykwa Torunska Light
  Antykwa Torunska Medium

>>> Regards,
>>>  Khaled
>>>
>>
> 


From mpg at elzevir.fr  Fri Nov 19 14:39:30 2010
From: mpg at elzevir.fr (=?UTF-8?B?TWFudWVsIFDDqWdvdXJpw6ktR29ubmFyZA==?=)
Date: Fri, 19 Nov 2010 14:39:30 +0100
Subject: [luatex] Beginner's question on mkluatexfontdb
In-Reply-To: <4CE66EB3.60705@users.sourceforge.net>
References: <4CE64C01.8040402@users.sourceforge.net>
 <20101119111611.GA2032@khaled-laptop>
 <4CE66B47.5070609@users.sourceforge.net>
 <4CE66C60.90001@users.sourceforge.net> <4CE66EB3.60705@users.sourceforge.net>
Message-ID: <4CE67E12.9090903@elzevir.fr>

Le 19/11/2010 13:33, Pander a ?crit :
>>> ! Font \zf at basefont=name:AntykwaTorunskaCondensedLight at 10pt not
>>> loadable: me
>>> tric data not found or bad.
>>> <to be read again>
>>>                    \scan_stop:
>>> l.4 \fontspec{Antykwa Torunska Condensed Light}
>>>
>>> ?
>>
>> fc-list says:
>> Antykwa Torunska Condensed,AntykwaTorunskaCond Light:style=Light,Regular
>> Antykwa Torunska Condensed,AntykwaTorunskaCond Light:style=Light
>> Italic,Italic
>>
> Same problem with
>   Antykwa Torunska Condensed Medium
>   Antykwa Torunska Light
>   Antykwa Torunska Medium
> 
It might help if you join your font database file (zipped). It should be located
here:

~/.texlive2010/texmf-var/luatex-cache/generic/names/otfl-names.lua

(~ is your home directory on Unix and %USERPROFILE% on windows).

Manuel.

From pander at users.sourceforge.net  Fri Nov 19 20:52:39 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 20:52:39 +0100
Subject: [luatex] LuaLaTeX's performance
Message-ID: <4CE6D587.4080906@users.sourceforge.net>

Hi all,

I'm new here so please forgive my lacking knowledge of LuaLaTeX.

I'm compiling a font catalogue in XeLaTeX but am more and more compelled
to switch over to LuaLaTeX because of better font support.

At the moment, only two things are obstructing this. First is missing
support for polyglossia, but as I gathered, people are working on this.

The other thing is the performance. Now it could be that the current
executable is not optimised and is doing loads of debug logging.
However, my font catalogue is a good test case.

XeLaTeX can process it in two parts because other it runs out of memory.
However, LuaLaTeX is hitting some sort of performance barrier halfway my
document and after using up almost 6 GB of memory I have to kill off the
process. Please see attached screenshots of memory usage.

How can LuaLaTeX's performance be improved? Is the current executable in
TLContrib a debug build with maximum logging?

Best regards,

Pander
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-0.jpg
Type: image/jpeg
Size: 143164 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0010.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-1.jpg
Type: image/jpeg
Size: 145785 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0011.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-2.jpg
Type: image/jpeg
Size: 146100 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0012.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-3.jpg
Type: image/jpeg
Size: 144791 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0013.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-4.jpg
Type: image/jpeg
Size: 145906 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0014.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-5.jpg
Type: image/jpeg
Size: 145269 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0015.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-6.jpg
Type: image/jpeg
Size: 144094 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0016.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-7.jpg
Type: image/jpeg
Size: 145294 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0017.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-8.jpg
Type: image/jpeg
Size: 146148 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0018.jpg>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screenshot-9.jpg
Type: image/jpeg
Size: 146588 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101119/70f92c94/attachment-0019.jpg>

From khaledhosny at eglug.org  Fri Nov 19 21:15:47 2010
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Fri, 19 Nov 2010 22:15:47 +0200
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <4CE6D587.4080906@users.sourceforge.net>
References: <4CE6D587.4080906@users.sourceforge.net>
Message-ID: <20101119201547.GA28889@khaled-laptop>

On Fri, Nov 19, 2010 at 08:52:39PM +0100, Pander wrote:
> Hi all,
> 
> I'm new here so please forgive my lacking knowledge of LuaLaTeX.
> 
> I'm compiling a font catalogue in XeLaTeX but am more and more compelled
> to switch over to LuaLaTeX because of better font support.
> 
> At the moment, only two things are obstructing this. First is missing
> support for polyglossia, but as I gathered, people are working on this.

AFAIK no one is actually working on that.

> The other thing is the performance. Now it could be that the current
> executable is not optimised and is doing loads of debug logging.
> However, my font catalogue is a good test case.
> 
> XeLaTeX can process it in two parts because other it runs out of memory.
> However, LuaLaTeX is hitting some sort of performance barrier halfway my
> document and after using up almost 6 GB of memory I have to kill off the
> process. Please see attached screenshots of memory usage.

LuaTeX will happily use all memory available to it (unlike most other
TeX engines which have hard-coded memory limit, IIUC). The current font
loading code is not very memory efficient and for certain fonts e.g.
fonts with huge kerning tables (some font developers like to say their
fonts have tens of thousands of kerning pairs, like if it is a feature
or something). I think post-texlive2010 releases of luatex made some
progress in this area, but I'm not sure if Hans started making use of it
or not.

> How can LuaLaTeX's performance be improved? Is the current executable in
> TLContrib a debug build with maximum logging?

I don't think so, I don't think it would be that relevant either. If you
can isolate the most offending fonts it might help in identifying and
possibly fixing the cause.

Regards,
 Khaled

-- 
 Khaled Hosny
 Arabic localiser and member of Arabeyes.org team
 Free font developer

From pander at users.sourceforge.net  Fri Nov 19 21:23:46 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 21:23:46 +0100
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <20101119201547.GA28889@khaled-laptop>
References: <4CE6D587.4080906@users.sourceforge.net>
 <20101119201547.GA28889@khaled-laptop>
Message-ID: <4CE6DCD2.6080803@users.sourceforge.net>

On 2010-11-19 21:15, Khaled Hosny wrote:
> On Fri, Nov 19, 2010 at 08:52:39PM +0100, Pander wrote:
>> Hi all,
>>
>> I'm new here so please forgive my lacking knowledge of LuaLaTeX.
>>
>> I'm compiling a font catalogue in XeLaTeX but am more and more compelled
>> to switch over to LuaLaTeX because of better font support.
>>
>> At the moment, only two things are obstructing this. First is missing
>> support for polyglossia, but as I gathered, people are working on this.
> 
> AFAIK no one is actually working on that.

Some German and some French developer were/are/planning to work on this
I read on comp.text.tex and de.comp.text.tex

>> The other thing is the performance. Now it could be that the current
>> executable is not optimised and is doing loads of debug logging.
>> However, my font catalogue is a good test case.
>>
>> XeLaTeX can process it in two parts because other it runs out of memory.
>> However, LuaLaTeX is hitting some sort of performance barrier halfway my
>> document and after using up almost 6 GB of memory I have to kill off the
>> process. Please see attached screenshots of memory usage.
> 
> LuaTeX will happily use all memory available to it (unlike most other
> TeX engines which have hard-coded memory limit, IIUC). The current font
> loading code is not very memory efficient and for certain fonts e.g.
> fonts with huge kerning tables (some font developers like to say their
> fonts have tens of thousands of kerning pairs, like if it is a feature
> or something). I think post-texlive2010 releases of luatex made some
> progress in this area, but I'm not sure if Hans started making use of it
> or not.
> 
>> How can LuaLaTeX's performance be improved? Is the current executable in
>> TLContrib a debug build with maximum logging?
> 
> I don't think so, I don't think it would be that relevant either. If you
> can isolate the most offending fonts it might help in identifying and
> possibly fixing the cause.

It it difficult to isolate since gradually memory gets eaten. Can I run
it with profiling or logging to report which font is using how much memory?

Regards,

Pander

> Regards,
>  Khaled
> 


From jfine at pytex.org  Fri Nov 19 21:57:11 2010
From: jfine at pytex.org (Jonathan Fine)
Date: Fri, 19 Nov 2010 20:57:11 +0000
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <4CE6D587.4080906@users.sourceforge.net>
References: <4CE6D587.4080906@users.sourceforge.net>
Message-ID: <4CE6E4A7.4040503@pytex.org>

For what it is worth:

$ time tex '\end'
This is TeX, Version 3.1415926 (TeX Live 2009)
No pages of output.
Transcript written on texput.log.

real	0m0.083s
user	0m0.068s
sys	0m0.008s

$ time xetex '\end'
This is XeTeX, Version 3.1415926-2.2-0.9995.2 (TeX Live 2009)
entering extended mode
No pages of output.
Transcript written on texput.log.

real	0m0.337s
user	0m0.232s
sys	0m0.104s

$ time luatex '\end'
This is LuaTeX, Version beta-0.40.6-2009100509 (TeX Live 2009)
No pages of output.
Transcript written on texput.log.

real	0m2.554s
user	0m2.428s
sys	0m0.124s


2.6 GHz AMD 64 bit running without any power saving.


-- 
Jonathan


From pander at users.sourceforge.net  Fri Nov 19 22:02:00 2010
From: pander at users.sourceforge.net (Pander)
Date: Fri, 19 Nov 2010 22:02:00 +0100
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <4CE6E4A7.4040503@pytex.org>
References: <4CE6D587.4080906@users.sourceforge.net>
 <4CE6E4A7.4040503@pytex.org>
Message-ID: <4CE6E5C8.7020308@users.sourceforge.net>

On 2010-11-19 21:57, Jonathan Fine wrote:
> For what it is worth:
> 
> $ time tex '\end'
> This is TeX, Version 3.1415926 (TeX Live 2009)
> No pages of output.
> Transcript written on texput.log.
> 
> real    0m0.083s
> user    0m0.068s
> sys    0m0.008s
> 
> $ time xetex '\end'
> This is XeTeX, Version 3.1415926-2.2-0.9995.2 (TeX Live 2009)
> entering extended mode
> No pages of output.
> Transcript written on texput.log.
> 
> real    0m0.337s
> user    0m0.232s
> sys    0m0.104s
> 
> $ time luatex '\end'
> This is LuaTeX, Version beta-0.40.6-2009100509 (TeX Live 2009)
> No pages of output.
> Transcript written on texput.log.
> 
> real    0m2.554s
> user    0m2.428s
> sys    0m0.124s
> 
> 
> 2.6 GHz AMD 64 bit running without any power saving.
> 
> 

Today's version:

$ time tex '\end'
This is TeX, Version 3.1415926 (TeX Live 2010)
No pages of output.
Transcript written on texput.log.

real	0m0.149s
user	0m0.050s
sys	0m0.030s

$ time xetex '\end'
This is XeTeX, Version 3.1415926-2.2-0.9997.4 (TeX Live 2010)
 restricted \write18 enabled.
entering extended mode
No pages of output.
Transcript written on texput.log.

real	0m0.555s
user	0m0.130s
sys	0m0.280s

$ time luatex '\end'
This is LuaTeX, Version beta-0.64.0-2010111216
 restricted \write18 enabled.
No pages of output.
Transcript written on texput.log.

real	0m0.222s
user	0m0.180s
sys	0m0.030s


From khaledhosny at eglug.org  Fri Nov 19 22:03:14 2010
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Fri, 19 Nov 2010 23:03:14 +0200
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <4CE6E4A7.4040503@pytex.org>
References: <4CE6D587.4080906@users.sourceforge.net>
 <4CE6E4A7.4040503@pytex.org>
Message-ID: <20101119210314.GA14520@khaled-laptop>

On Fri, Nov 19, 2010 at 08:57:11PM +0000, Jonathan Fine wrote:
> For what it is worth:
> 
> $ time tex '\end'
> This is TeX, Version 3.1415926 (TeX Live 2009)
> No pages of output.
> Transcript written on texput.log.
> 
> real	0m0.083s
> user	0m0.068s
> sys	0m0.008s
> 
> $ time xetex '\end'
> This is XeTeX, Version 3.1415926-2.2-0.9995.2 (TeX Live 2009)
> entering extended mode
> No pages of output.
> Transcript written on texput.log.
> 
> real	0m0.337s
> user	0m0.232s
> sys	0m0.104s
> 
> $ time luatex '\end'
> This is LuaTeX, Version beta-0.40.6-2009100509 (TeX Live 2009)
> No pages of output.
> Transcript written on texput.log.
> 
> real	0m2.554s
> user	0m2.428s
> sys	0m0.124s

This is caused by texlive2009's luatex.ini (and lualatex.ini) loading
all hyphenation patterns in the format which is discouraged when using
luatex, texlive2010 fixed that.

Regards,
 Khaled

-- 
 Khaled Hosny
 Arabic localiser and member of Arabeyes.org team
 Free font developer

From jfine at pytex.org  Fri Nov 19 22:17:25 2010
From: jfine at pytex.org (Jonathan Fine)
Date: Fri, 19 Nov 2010 21:17:25 +0000
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <4CE6E5C8.7020308@users.sourceforge.net>
References: <4CE6D587.4080906@users.sourceforge.net>
 <4CE6E4A7.4040503@pytex.org> <4CE6E5C8.7020308@users.sourceforge.net>
Message-ID: <4CE6E965.6020901@pytex.org>

Pander wrote:

> Today's version:
> 
> $ time tex '\end'
> This is TeX, Version 3.1415926 (TeX Live 2010)
> No pages of output.
> Transcript written on texput.log.
> 
> real	0m0.149s
> user	0m0.050s
> sys	0m0.030s

[snip]

Just a cautionary note.  The top line (real) can be quite variable, due 
to disk caching.  Notice that the user and sys times don't add to the 
real time.

> $ time luatex '\end'
> This is LuaTeX, Version beta-0.64.0-2010111216
>  restricted \write18 enabled.
> No pages of output.
> Transcript written on texput.log.
> 
> real	0m0.222s
> user	0m0.180s
> sys	0m0.030s

And here they do (almost).

I offer this explanation.  The files that luatex needs were in cache but 
not those needed by tex.  Run tex a few times and the real time will 
come down to 0.080 or so I think.  Whereas luatex will always be about 
0.210.

-- 
Jonathan


From khaledhosny at eglug.org  Fri Nov 19 23:03:30 2010
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Sat, 20 Nov 2010 00:03:30 +0200
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <4CE6DCD2.6080803@users.sourceforge.net>
References: <4CE6D587.4080906@users.sourceforge.net>
 <20101119201547.GA28889@khaled-laptop>
 <4CE6DCD2.6080803@users.sourceforge.net>
Message-ID: <20101119220330.GA25485@khaled-laptop>

On Fri, Nov 19, 2010 at 09:23:46PM +0100, Pander wrote:
> On 2010-11-19 21:15, Khaled Hosny wrote:
> >> The other thing is the performance. Now it could be that the current
> >> executable is not optimised and is doing loads of debug logging.
> >> However, my font catalogue is a good test case.
> >>
> >> XeLaTeX can process it in two parts because other it runs out of memory.
> >> However, LuaLaTeX is hitting some sort of performance barrier halfway my
> >> document and after using up almost 6 GB of memory I have to kill off the
> >> process. Please see attached screenshots of memory usage.
> > 
> > LuaTeX will happily use all memory available to it (unlike most other
> > TeX engines which have hard-coded memory limit, IIUC). The current font
> > loading code is not very memory efficient and for certain fonts e.g.
> > fonts with huge kerning tables (some font developers like to say their
> > fonts have tens of thousands of kerning pairs, like if it is a feature
> > or something). I think post-texlive2010 releases of luatex made some
> > progress in this area, but I'm not sure if Hans started making use of it
> > or not.
> > 
> >> How can LuaLaTeX's performance be improved? Is the current executable in
> >> TLContrib a debug build with maximum logging?
> > 
> > I don't think so, I don't think it would be that relevant either. If you
> > can isolate the most offending fonts it might help in identifying and
> > possibly fixing the cause.
> 
> It it difficult to isolate since gradually memory gets eaten. Can I run
> it with profiling or logging to report which font is using how much memory?

Here is a quickly hacked script that takes a list of fonts and reports,
in kb, the memory used for each:

for _,v in ipairs(arg) do
    local b, m, f, t
    b = string.explode(v, "/")
    b = b[#b]
    m = collectgarbage("count")
    f = fontloader.open(v)
    if f then
        t = fontloader.to_table(f)
        fontloader.close(f)
        print(math.floor(collectgarbage("count") - m), b)
        t = nil
        collectgarbage('collect')
    end
end

Save it to some file and cal it something like:

$ texlua foo.lua `find /path/to/fonts`

Regards,
 Khaled

-- 
 Khaled Hosny
 Arabic localiser and member of Arabeyes.org team
 Free font developer

From ulrich.voosholz at gmx.de  Sat Nov 20 11:48:34 2010
From: ulrich.voosholz at gmx.de (Ulrich Voosholz)
Date: Sat, 20 Nov 2010 11:48:34 +0100
Subject: [luatex] LuaTeX and MySQL
Message-ID: <op.vmgtm70ccs9tah@knox>

Hello erverybody!

I want to produce reports with LuaLaTex und MySql. But neither LuaLaTeX  
nor LuaTeX are able to load the required module "luasql.mysql" on my  
system. Lua itself does:

   ulvo at knox:~$ lua -e 'require "luasql.mysql"'
   ulvo at knox:~$

The connection to mysql works without problems. The following code

   \directlua{require("luasql.mysql")}
   \end

returns:

   This is LuaTeX, Version beta-0.60.2-2010071218 (TeX Live 2010) (rev 3736)
    restricted \write18 enabled.
   (./plainluatex.tex
   ! LuaTeX error <\directlua >:1: module 'luasql.mysql' not found:
	no field package.preload['luasql.mysql']
	[kpse lua searcher] file not found: 'luasql.mysql'
	[kpse C searcher] file not found: 'luasql.mysql'
	[kpse All-in-one searcher] file not found: 'luasql'
   stack traceback:
	[C]: in function 'require'
	<\directlua >:1: in main chunk.
   l.1 \directlua{require("luasql.mysql")}


I have already searched but cannot get a hint how to handle this. I have  
tried
the following code:

   \directlua{print(package.cpath)}
   \end

which gave

    ./plainluatex.tex./?.so;/usr/local/lib/lua/5.1/?.so;/usr/local/lib/lua/5.1/loadall.so

   ulvo at knox:~$ lua -e 'print(package.cpath)'

returned

    ./?.so;/usr/local/lib/lua/5.1/?.so;/usr/lib/lua/5.1/?.so;/usr/local/lib/lua/5.1/loadall.so

Therefore I tried

    \directlua{package.cpath="./plainluatex.tex./?.so;/usr/local/lib/lua/5.1/?.so;/usr/lib/lua/5.1/?.so;/usr/local/lib/lua/5.1/loadall.so"
    require "luasql.mysql"}
    \end

but the error was the same as shown above.

Does anybody have any idea or workaround?

My system is Ubuntu 10.4 LTS with Texlive 2010.

Thank you

Ulrich Voosholz

==============================
www: www.tanztraeume.de

From taco at elvenkind.com  Sat Nov 20 12:00:49 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sat, 20 Nov 2010 12:00:49 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <op.vmgtm70ccs9tah@knox>
References: <op.vmgtm70ccs9tah@knox>
Message-ID: <4CE7AA61.20806@elvenkind.com>

On 11/20/2010 11:48 AM, Ulrich Voosholz wrote:
> Hello erverybody!
>
> I want to produce reports with LuaLaTex und MySql. But neither LuaLaTeX
> nor LuaTeX are able to load the required module "luasql.mysql" on my
> system. Lua itself does:
>
> ulvo at knox:~$ lua -e 'require "luasql.mysql"'
> ulvo at knox:~$
>
> The connection to mysql works without problems. The following code

You will have to tell us where luasql.mysql(.so) actually is on your
harddisk.


From taco at elvenkind.com  Sat Nov 20 14:03:28 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sat, 20 Nov 2010 14:03:28 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <op.vmgyvpt9cs9tah@knox>
References: <op.vmgtm70ccs9tah@knox> <4CE7AA61.20806@elvenkind.com>
 <op.vmgyvpt9cs9tah@knox>
Message-ID: <4CE7C720.5070902@elvenkind.com>

On 11/20/2010 01:41 PM, Ulrich Voosholz wrote:
> Thank you for your attention!
>
> The library is:
>
> /usr/lib/lua/5.1/luasql/mysql.so

The reason it fails: luatex (as opposed to texlua) by default
uses kpathsea to find require files, not the package.cpath.
Unless your format is set up for that from the start, it is
not that easy to stop using kpathsea, so a better solution
is to make sure that kpathsea can actually find the files.

Therefore, the solution is to copy or symlink the libraries from

   /usr/lib/lua/5.1/<stuff>

to

   <luatex-bin-dir>/lib/lua/<stuff>

Best wishes,
Taco

From ulrich.voosholz at gmx.de  Sat Nov 20 17:27:35 2010
From: ulrich.voosholz at gmx.de (Ulrich Voosholz)
Date: Sat, 20 Nov 2010 17:27:35 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <4CE7F27B.7070703@elvenkind.com>
References: <op.vmgtm70ccs9tah@knox> <4CE7AA61.20806@elvenkind.com>
 <op.vmgyvpt9cs9tah@knox> <4CE7C720.5070902@elvenkind.com>
 <op.vmg1uuobcs9tah@knox> <4CE7F27B.7070703@elvenkind.com>
Message-ID: <op.vmg9b9mmcs9tah@knox>

My LuaTeX is Version beta-0.60.2-2010071218 (TeX Live 2010) (rev 3736).

    kpsewhich --expand-var \$CLUAINPUTS
gives:
     .:/usr/local/texlive/2009/bin/x86_64-linux/lib/{kpsewhich,unsetengine,}/lua//

I tried

    luatex -kpathsea-debug=2 plainluatex.tex 2>/tmp/luatex-mysql_err.log  
>/tmp/luatex-mysql_out.log

The results are appended.

Mit freundlichem Gru?
Ulrich




Am 20.11.2010, 17:08 Uhr, schrieb Taco Hoekwater <taco at elvenkind.com>:

> On 11/20/2010 02:45 PM, Ulrich Voosholz wrote:
>> Now I have copied as you proposed:
>>
>> cp -lR /usr/lib/lua/5.1/*  
>> /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/
>>
>> (It is Texlive 2010 although it is in the "2009" directory. It was
>> updated there automatically).
>>
>> Then I ran :
>> ulvo at knox:~$ sudo mktexlsr
>
> There should be no need to do that (bin/x86_64-linux does not
> have a ls-R file anyway).
>
> But I just realized that your texmf.cnf may be missing a variable,
> or even your luatex may be too old.
>
> The variable first:
>
>   $ kpsewhich --expand-var \$CLUAINPUTS
>
> My output is:
>
> .:/home/taco/texlive/2010/bin/x86_64-linux/lib/{kpsewhich,unsetengine,}/lua//
>
> If do you get some output, then either the path is wrong, or there is
> a problem with luatex itself. In that case, try to run
>
>    luatex -kpathsea-debug=2  <yourfile>
>
> as the debugging output may give some help.
>
> I just tried a simple test file on my machine (also using a distro-
> supplied luasql) and here it actually works, but I am running the
> latest luatex, so there could be a bugfix I have forgotten about.
>
> Best wishes,
> Taco


-- 




E-Mail:     ulrich.voosholz at gmx.de


Homepage: www.tanztraeume.de

-------------- next part --------------
A non-text attachment was scrubbed...
Name: luatex-mysql_err.log
Type: application/octet-stream
Size: 40835 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101120/79b18641/attachment-0002.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: luatex-mysql_out.log
Type: application/octet-stream
Size: 709 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101120/79b18641/attachment-0003.obj>

From taco at elvenkind.com  Sat Nov 20 17:30:19 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sat, 20 Nov 2010 17:30:19 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <op.vmg9b9mmcs9tah@knox>
References: <op.vmgtm70ccs9tah@knox> <4CE7AA61.20806@elvenkind.com>
 <op.vmgyvpt9cs9tah@knox> <4CE7C720.5070902@elvenkind.com>
 <op.vmg1uuobcs9tah@knox> <4CE7F27B.7070703@elvenkind.com>
 <op.vmg9b9mmcs9tah@knox>
Message-ID: <4CE7F79B.8070002@elvenkind.com>

On 11/20/2010 05:27 PM, Ulrich Voosholz wrote:
> My LuaTeX is Version beta-0.60.2-2010071218 (TeX Live 2010) (rev 3736).
>
> kpsewhich --expand-var \$CLUAINPUTS
> gives:
> .:/usr/local/texlive/2009/bin/x86_64-linux/lib/{kpsewhich,unsetengine,}/lua//
>
> I tried
>
> luatex -kpathsea-debug=2 plainluatex.tex 2>/tmp/luatex-mysql_err.log
>> /tmp/luatex-mysql_out.log
>
> The results are appended.

In that case, I think you have to update luatex from tlcontrib. See

   http://tlcontrib.metatex.org/usage.html

Best wishes,
Taco


From ulrich.voosholz at gmx.de  Sat Nov 20 18:16:09 2010
From: ulrich.voosholz at gmx.de (Ulrich Voosholz)
Date: Sat, 20 Nov 2010 18:16:09 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <4CE7F79B.8070002@elvenkind.com>
References: <op.vmgtm70ccs9tah@knox> <4CE7AA61.20806@elvenkind.com>
 <op.vmgyvpt9cs9tah@knox> <4CE7C720.5070902@elvenkind.com>
 <op.vmg1uuobcs9tah@knox> <4CE7F27B.7070703@elvenkind.com>
 <op.vmg9b9mmcs9tah@knox> <4CE7F79B.8070002@elvenkind.com>
Message-ID: <op.vmhbk7vdcs9tah@knox>

I have done so with

   sudo tlmgr --repository http://tlcontrib.metatex.org/2010 update luatex

which did not change the error, and with


   sudo tlmgr --repository http://tlcontrib.metatex.org/2010 update --all


Now I have:
    $ luatex --version
    This is LuaTeX, Version beta-0.64.0-2010111216

Running the test gives the messages I append.

Uli

Am 20.11.2010, 17:30 Uhr, schrieb Taco Hoekwater <taco at elvenkind.com>:

> In that case, I think you have to update luatex from tlcontrib. See
>
>    http://tlcontrib.metatex.org/usage.html
>
> Best wishes,
> Taco
>


-- 




E-Mail:     ulrich.voosholz at gmx.de


Homepage: www.tanztraeume.de

-------------- next part --------------
A non-text attachment was scrubbed...
Name: luatex-mysql_err_2.log
Type: application/octet-stream
Size: 40453 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101120/c1352780/attachment-0002.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: luatex-mysql_out_2.log
Type: application/octet-stream
Size: 682 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101120/c1352780/attachment-0003.obj>

From taco at elvenkind.com  Sat Nov 20 18:52:40 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sat, 20 Nov 2010 18:52:40 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <op.vmhbk7vdcs9tah@knox>
References: <op.vmgtm70ccs9tah@knox> <4CE7AA61.20806@elvenkind.com>
 <op.vmgyvpt9cs9tah@knox> <4CE7C720.5070902@elvenkind.com>
 <op.vmg1uuobcs9tah@knox> <4CE7F27B.7070703@elvenkind.com>
 <op.vmg9b9mmcs9tah@knox> <4CE7F79B.8070002@elvenkind.com>
 <op.vmhbk7vdcs9tah@knox>
Message-ID: <4CE80AE8.9090602@elvenkind.com>

On 11/20/2010 06:16 PM, Ulrich Voosholz wrote:
> I have done so with
>
> sudo tlmgr --repository http://tlcontrib.metatex.org/2010 update luatex
>
> which did not change the error, and with
>
>
> sudo tlmgr --repository http://tlcontrib.metatex.org/2010 update --all
>
>
> Now I have:
> $ luatex --version
> This is LuaTeX, Version beta-0.64.0-2010111216
>
> Running the test gives the messages I append.

Weird, as it works for me. Granted, I am on x86_64, but that should not
really make a difference. Are you absolutely sure that you now have:

   /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so

and that it is readable?

Best wishesm
Taco

From ulrich.voosholz at gmx.de  Sat Nov 20 20:01:26 2010
From: ulrich.voosholz at gmx.de (Ulrich Voosholz)
Date: Sat, 20 Nov 2010 20:01:26 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <4CE80AE8.9090602@elvenkind.com>
References: <op.vmgtm70ccs9tah@knox> <4CE7AA61.20806@elvenkind.com>
 <op.vmgyvpt9cs9tah@knox> <4CE7C720.5070902@elvenkind.com>
 <op.vmg1uuobcs9tah@knox> <4CE7F27B.7070703@elvenkind.com>
 <op.vmg9b9mmcs9tah@knox> <4CE7F79B.8070002@elvenkind.com>
 <op.vmhbk7vdcs9tah@knox> <4CE80AE8.9090602@elvenkind.com>
Message-ID: <op.vmhggouucs9tah@knox>

I know it's weird. Philipp Gesang, from the "Dante" mailing list, who  
tried to help me some days ago, did not have the problem either:

   $ ls -la /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so
   lrwxrwxrwx 2 root root 37 2010-11-11 16:11  
/usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so ->  
../../../liblua5.1-sql-mysql.so.2.0.0

On my machine I am using  Ubuntu 10.04 LTS - Lucid Lynx. I did not install  
Texlive from the repository but manually using the Texlive 2009  
installation, which updated to 2010 meanwhile.

The error messages are the same on my laptop with Ubuntu Lucid and Texlive  
 from the Ubuntu repository (LuaTeX Version beta-0.50.0-2010010505). But

	$ kpsewhich --expand-var \$CLUAINPUTS

on the laptop returns
	$CLUAINPUTS

I did not find a place where to copy the mysql.so there because I don't  
understand where the Ubuntu installs the libs form Texlive.


Uli




Am 20.11.2010, 18:52 Uhr, schrieb Taco Hoekwater <taco at elvenkind.com>:

> On 11/20/2010 06:16 PM, Ulrich Voosholz wrote:
>> I have done so with
>>
>> sudo tlmgr --repository http://tlcontrib.metatex.org/2010 update luatex
>>
>> which did not change the error, and with
>>
>>
>> sudo tlmgr --repository http://tlcontrib.metatex.org/2010 update --all
>>
>>
>> Now I have:
>> $ luatex --version
>> This is LuaTeX, Version beta-0.64.0-2010111216
>>
>> Running the test gives the messages I append.
>
> Weird, as it works for me. Granted, I am on x86_64, but that should not
> really make a difference. Are you absolutely sure that you now have:
>
>    /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so
>
> and that it is readable?
>
> Best wishesm
> Taco


-- 




E-Mail:     ulrich.voosholz at gmx.de


Homepage: www.tanztraeume.de



From taco at elvenkind.com  Sat Nov 20 21:11:27 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sat, 20 Nov 2010 21:11:27 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <20101120190716.GA928@phare.normalesup.org>
References: <4CE7AA61.20806@elvenkind.com> <op.vmgyvpt9cs9tah@knox>
 <4CE7C720.5070902@elvenkind.com> <op.vmg1uuobcs9tah@knox>
 <4CE7F27B.7070703@elvenkind.com> <op.vmg9b9mmcs9tah@knox>
 <4CE7F79B.8070002@elvenkind.com> <op.vmhbk7vdcs9tah@knox>
 <4CE80AE8.9090602@elvenkind.com> <op.vmhggouucs9tah@knox>
 <20101120190716.GA928@phare.normalesup.org>
Message-ID: <4CE82B6F.1060509@elvenkind.com>

On 11/20/2010 08:07 PM, Arthur Reutenauer wrote:
>>    $ ls -la /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so
>>    lrwxrwxrwx 2 root root 37 2010-11-11 16:11
>> /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so ->
>> ../../../liblua5.1-sql-mysql.so.2.0.0
>
>    Sorry to insist, but does
>
> 	/usr/local/texlive/2009/bin/x86_64-linux/liblua5.1-sql-mysql.so.2.0.0
>
> actually exist?  All you're showing us here is a link.

Head meets nail, I think. When you copied the stuff from /usr/lib/,
it looks like it only copied a symlink, but the actual .so file was
altogether elsewhere. Result: a broken symlink, which of course will
not work at all.

Best wishes,
Taco




From ulrich.voosholz at gmx.de  Sat Nov 20 21:56:05 2010
From: ulrich.voosholz at gmx.de (Ulrich Voosholz)
Date: Sat, 20 Nov 2010 21:56:05 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <4CE82B6F.1060509@elvenkind.com>
References: <4CE7AA61.20806@elvenkind.com> <op.vmgyvpt9cs9tah@knox>
 <4CE7C720.5070902@elvenkind.com> <op.vmg1uuobcs9tah@knox>
 <4CE7F27B.7070703@elvenkind.com> <op.vmg9b9mmcs9tah@knox>
 <4CE7F79B.8070002@elvenkind.com> <op.vmhbk7vdcs9tah@knox>
 <4CE80AE8.9090602@elvenkind.com> <op.vmhggouucs9tah@knox>
 <20101120190716.GA928@phare.normalesup.org> <4CE82B6F.1060509@elvenkind.com>
Message-ID: <op.vmhlrrwfcs9tah@knox>

Thank you very much for spending your time for me!

This hint worked. Everything is fine for me!

I have (hard-)linked the libs	
    cp -l /usr/lib/liblua5* /usr/local/texlive/2009/bin/x86_64-linux/
and now it is working.

Thank you for your time, knowledge and patience.

Uli

Am 20.11.2010, 21:11 Uhr, schrieb Taco Hoekwater <taco at elvenkind.com>:

> On 11/20/2010 08:07 PM, Arthur Reutenauer wrote:
>>>    $ ls -la  
>>> /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so
>>>    lrwxrwxrwx 2 root root 37 2010-11-11 16:11
>>> /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so ->
>>> ../../../liblua5.1-sql-mysql.so.2.0.0
>>
>>    Sorry to insist, but does
>>
>> 	/usr/local/texlive/2009/bin/x86_64-linux/liblua5.1-sql-mysql.so.2.0.0
>>
>> actually exist?  All you're showing us here is a link.
>
> Head meets nail, I think. When you copied the stuff from /usr/lib/,
> it looks like it only copied a symlink, but the actual .so file was
> altogether elsewhere. Result: a broken symlink, which of course will
> not work at all.
>
> Best wishes,
> Taco
>
>
>


-- 




E-Mail:     ulrich.voosholz at gmx.de


Homepage: www.tanztraeume.de



From arthur.reutenauer at normalesup.org  Sat Nov 20 20:07:16 2010
From: arthur.reutenauer at normalesup.org (Arthur Reutenauer)
Date: Sat, 20 Nov 2010 20:07:16 +0100
Subject: [luatex] LuaTeX and MySQL
In-Reply-To: <op.vmhggouucs9tah@knox>
References: <4CE7AA61.20806@elvenkind.com> <op.vmgyvpt9cs9tah@knox>
 <4CE7C720.5070902@elvenkind.com> <op.vmg1uuobcs9tah@knox>
 <4CE7F27B.7070703@elvenkind.com> <op.vmg9b9mmcs9tah@knox>
 <4CE7F79B.8070002@elvenkind.com> <op.vmhbk7vdcs9tah@knox>
 <4CE80AE8.9090602@elvenkind.com> <op.vmhggouucs9tah@knox>
Message-ID: <20101120190716.GA928@phare.normalesup.org>

>   $ ls -la /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so
>   lrwxrwxrwx 2 root root 37 2010-11-11 16:11  
> /usr/local/texlive/2009/bin/x86_64-linux/lib/lua/luasql/mysql.so ->  
> ../../../liblua5.1-sql-mysql.so.2.0.0

  Sorry to insist, but does

	/usr/local/texlive/2009/bin/x86_64-linux/liblua5.1-sql-mysql.so.2.0.0

actually exist?  All you're showing us here is a link.

	Arthur

From pander at users.sourceforge.net  Sun Nov 21 20:52:22 2010
From: pander at users.sourceforge.net (Pander)
Date: Sun, 21 Nov 2010 20:52:22 +0100
Subject: [luatex] LuaLaTeX's performance
In-Reply-To: <20101119220330.GA25485@khaled-laptop>
References: <4CE6D587.4080906@users.sourceforge.net>
 <20101119201547.GA28889@khaled-laptop>
 <4CE6DCD2.6080803@users.sourceforge.net>
 <20101119220330.GA25485@khaled-laptop>
Message-ID: <4CE97876.4010201@users.sourceforge.net>

On 2010-11-19 23:03, Khaled Hosny wrote:
> On Fri, Nov 19, 2010 at 09:23:46PM +0100, Pander wrote:
>> On 2010-11-19 21:15, Khaled Hosny wrote:
>>>> The other thing is the performance. Now it could be that the current
>>>> executable is not optimised and is doing loads of debug logging.
>>>> However, my font catalogue is a good test case.
>>>>
>>>> XeLaTeX can process it in two parts because other it runs out of memory.
>>>> However, LuaLaTeX is hitting some sort of performance barrier halfway my
>>>> document and after using up almost 6 GB of memory I have to kill off the
>>>> process. Please see attached screenshots of memory usage.
>>>
>>> LuaTeX will happily use all memory available to it (unlike most other
>>> TeX engines which have hard-coded memory limit, IIUC). The current font
>>> loading code is not very memory efficient and for certain fonts e.g.
>>> fonts with huge kerning tables (some font developers like to say their
>>> fonts have tens of thousands of kerning pairs, like if it is a feature
>>> or something). I think post-texlive2010 releases of luatex made some
>>> progress in this area, but I'm not sure if Hans started making use of it
>>> or not.
>>>
>>>> How can LuaLaTeX's performance be improved? Is the current executable in
>>>> TLContrib a debug build with maximum logging?
>>>
>>> I don't think so, I don't think it would be that relevant either. If you
>>> can isolate the most offending fonts it might help in identifying and
>>> possibly fixing the cause.
>>
>> It it difficult to isolate since gradually memory gets eaten. Can I run
>> it with profiling or logging to report which font is using how much memory?
> 
> Here is a quickly hacked script that takes a list of fonts and reports,
> in kb, the memory used for each:
> 
> for _,v in ipairs(arg) do
>     local b, m, f, t
>     b = string.explode(v, "/")
>     b = b[#b]
>     m = collectgarbage("count")
>     f = fontloader.open(v)
>     if f then
>         t = fontloader.to_table(f)
>         fontloader.close(f)
>         print(math.floor(collectgarbage("count") - m), b)
>         t = nil
>         collectgarbage('collect')
>     end
> end
> 
> Save it to some file and cal it something like:
> 
> $ texlua foo.lua `find /path/to/fonts`

There are some pretty big ones:

20208	CODE2001.ttf
37006	DoulosSILCR.ttf
37122	DoulosSILR.ttf

20479	DejaVuSerif-Bold.ttf
20479	DejaVuSerifCondensed-Bold.ttf
20480	DejaVuSerif-BoldItalic.ttf
20480	DejaVuSerifCondensed-BoldItalic.ttf
20550	DejaVuSerifCondensed.ttf
20550	DejaVuSerif.ttf
20558	DejaVuSerifCondensed-Italic.ttf
20558	DejaVuSerif-Italic.ttf
21014	DejaVuSansMono.ttf
21014	mplus-1m-bold.ttf
21014	mplus-1m-light.ttf
21014	mplus-1m-medium.ttf
21014	mplus-1mn-bold.ttf
21014	mplus-1mn-light.ttf
21014	mplus-1mn-medium.ttf
21014	mplus-1mn-regular.ttf
21014	mplus-1mn-thin.ttf
21014	mplus-1m-regular.ttf
21014	mplus-1m-thin.ttf
21014	mplus-2m-bold.ttf
21014	mplus-2m-light.ttf
21014	mplus-2m-medium.ttf
21014	mplus-2m-regular.ttf
21014	mplus-2m-thin.ttf
22583	DejaVuSans-BoldOblique.ttf
22583	DejaVuSansCondensed-BoldOblique.ttf
22638	DejaVuSans-Oblique.ttf
22639	DejaVuSansCondensed-Oblique.ttf
22657	mplus-1c-black.ttf
22657	mplus-1c-bold.ttf
22657	mplus-1c-heavy.ttf
22657	mplus-1c-light.ttf
22657	mplus-1c-medium.ttf
22657	mplus-1c-regular.ttf
22657	mplus-1c-thin.ttf
22657	mplus-1p-black.ttf
22657	mplus-1p-bold.ttf
22657	mplus-1p-heavy.ttf
22657	mplus-1p-light.ttf
22657	mplus-1p-medium.ttf
22657	mplus-1p-regular.ttf
22657	mplus-1p-thin.ttf
22687	mplus-2c-regular.ttf
22687	mplus-2p-black.ttf
22687	mplus-2p-bold.ttf
22687	mplus-2p-heavy.ttf
22687	mplus-2p-light.ttf
22687	mplus-2p-medium.ttf
22687	mplus-2p-regular.ttf
22687	mplus-2p-thin.ttf
22688	mplus-2c-black.ttf
22688	mplus-2c-bold.ttf
22688	mplus-2c-heavy.ttf
22688	mplus-2c-light.ttf
22688	mplus-2c-medium.ttf
22688	mplus-2c-thin.ttf
23970	DejaVuSans-Bold.ttf
24004	DejaVuSansCondensed-Bold.ttf
24175	DejaVuSansCondensed.ttf
24175	DejaVuSans.ttf
37110	CharisSILB.ttf
37110	CharisSILR.ttf
38445	CharisSILI.ttf
38447	CharisSILBI.ttf

18546	UMTypewriter-Regular.otf
18646	STIXGeneralItalic.otf
18689	STIXGeneralBolIta.otf
19196	STIXGeneralBol.otf
19266	cmunit.otf
19308	cmuntx.otf
19311	cmunbtl.otf
19311	cmunbto.otf
19316	cmuntb.otf
19481	OldStandard-Italic.otf
19520	OldStandard-Bold.otf
19569	OldStandard-Regular.otf
19675	cmunst.otf
19830	cmuntt.otf
20339	FreeSerifBoldItalic.otf
20628	STIXGeneral.otf
20771	FreeSerifBold.otf
21101	FreeSerifItalic.otf
21667	xits-math.otf
22912	cmunssdc.otf
22917	cmunso.otf
23083	cmunbso.otf
23087	cmunbmo.otf
23087	cmunbsr.otf
23088	cmunbmr.otf
23302	cmunbxo.otf
23303	cmunbbx.otf
23303	cmunsi.otf
23455	cmunsx.otf
23456	cmunss.otf
23614	cmunoti.otf
23615	cmunobi.otf
23643	FreeSans.otf
23665	cmunobx.otf
24009	cmunci.otf
24072	cmunui.otf
24076	cmunbi.otf
24118	cmunti.otf
24761	cmunbl.otf
24761	cmunsl.otf
24784	cmunorm.otf
24919	cmunbx.otf
25018	cmunrm.otf
28229	FreeSerif.otf

20341	FreeSerifBoldItalic.ttf
20772	FreeSerifBold.ttf
21070	FreeSerifItalic.ttf
23580	FreeSans.ttf
28262	FreeSerif.ttf

But can I run a profiler because the way memory is eaten and is not
being released is the limiting factor.

When I run XeLaTeX of LuaLaTeX on my font catalogue, the first one
reports to run out of memeory but the second just continues to eat up
all my real and virtual memory and eventually I have to kill it.

When I split my document in two parts, each about 135 fonts almost all
in regular, bold, bolditalic and italic, XeLaTeX is able to process it
and write about 10MB for each part. It takes my Ubuntu system to use 900
MB RAM and 200 MB swap to process one part (1/2). (Memory use increases
over time, does XeLaTeX use dynamic allocation?)

LuaLaTeX is unable to process one of these parts as it needs much much
more memory to do the job, so I have to kill it off again. When I split
it in 4 parts with each 65 fonts, it works. Each PDF is about 4 or 5 MB.
It takes my Ubuntu system to use 3500 MB RAM and 200 MB swap to process
this part (1/4). (That dynamic memory allocation occurs here is expected.)

In short, LuaLaTeX uses (for this font intensive document on this system
etc etc) approximately (2*(3500+200))/(900+200) = 6.7 times more space
in memory then XeLaTeX.

Regards,

Pander

> Regards,
>  Khaled
> 


From oinos at web.de  Mon Nov 22 12:17:08 2010
From: oinos at web.de (=?ISO-8859-1?Q?Pablo_Rodr=EDguez?=)
Date: Mon, 22 Nov 2010 12:17:08 +0100
Subject: [luatex] fontspec prevents hyphenation
Message-ID: <4CEA5134.6070006@web.de>

Hi Taco,

I have already reported that fontspec prevents hyphenation in:

\documentclass{book}
\usepackage{fontspec}
\usepackage[german,spanish]{babel}
\newcommand{\getext}[1]{\foreignlanguage{german}{#1}}
\newcommand{\geit}[1]{\foreignlanguage{german}{\emph{#1}}}
\begin{document}
\showhyphens{documento (documento)}
\showhyphens{\emph{documento (documento)}}
\showhyphens{(\getext{Umwelterlebnis}) (\getext{Andenken})}
\showhyphens{(\geit{Umwelterlebnis}) (\geit{Andenken})}
\end{document}

Sorry, I don't know what isn't working here, but you told that there was 
something to fix in luatex.

After upgrading to luatex-0.64, the hyphenation doesn't work when 
(\emph{example}) occurs.

Would you be so kind to fix this?

Many thanks for your help,


Pablo
-- 
http://www.ousia.tk

From taco at elvenkind.com  Mon Nov 22 13:22:23 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Mon, 22 Nov 2010 13:22:23 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA5134.6070006@web.de>
References: <4CEA5134.6070006@web.de>
Message-ID: <4CEA607F.8070307@elvenkind.com>

On 11/22/2010 12:17 PM, Pablo Rodr?guez wrote:
> Hi Taco,
>
> I have already reported that fontspec prevents hyphenation in:
>
> \documentclass{book}
> \usepackage{fontspec}
> \usepackage[german,spanish]{babel}
> \newcommand{\getext}[1]{\foreignlanguage{german}{#1}}
> \newcommand{\geit}[1]{\foreignlanguage{german}{\emph{#1}}}
> \begin{document}
> \showhyphens{documento (documento)}
> \showhyphens{\emph{documento (documento)}}
> \showhyphens{(\getext{Umwelterlebnis}) (\getext{Andenken})}
> \showhyphens{(\geit{Umwelterlebnis}) (\geit{Andenken})}
> \end{document}
>
> Sorry, I don't know what isn't working here, but you told that there was
> something to fix in luatex.
>
> After upgrading to luatex-0.64, the hyphenation doesn't work when
> (\emph{example}) occurs.
>
> Would you be so kind to fix this?

The problematic case seems to be: a combination of a non-letter in one
font, followed by a letter in another font. LuaTeX does not consider
that a valid word start. I will add an item to the tracker database.

Best wishes,
Taco

From mailing_list at arcor.de  Mon Nov 22 14:02:31 2010
From: mailing_list at arcor.de (Stephan Hennig)
Date: Mon, 22 Nov 2010 14:02:31 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA607F.8070307@elvenkind.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
Message-ID: <4CEA69E7.5000102@arcor.de>

Am 22.11.2010 13:22, schrieb Taco Hoekwater:

> The problematic case seems to be: a combination of a non-letter in one
> font, followed by a letter in another font. LuaTeX does not consider
> that a valid word start. I will add an item to the tracker database.

There's another problem with fontspec and hyphenation involving only 
letters, but font switching, too.  You can find the (short) discussion 
on lualatex-dev at 
<URL:http://permalink.gmane.org/gmane.comp.tex.lualatex.devel/556>.

Best regards,
Stephan Hennig

\documentclass[draft]{article}
\usepackage{fontspec}
\usepackage[width=2cm]{geometry}
\begin{document}
An  intere\textit{st}ing word.% no hyphenation

An intere{\itshape st\/}ing word.% hyphenated
\end{document}

From oinos at web.de  Mon Nov 22 16:20:22 2010
From: oinos at web.de (=?ISO-8859-1?Q?Pablo_Rodr=EDguez?=)
Date: Mon, 22 Nov 2010 16:20:22 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA69E7.5000102@arcor.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEA69E7.5000102@arcor.de>
Message-ID: <4CEA8A36.1000803@web.de>

On 11/22/2010 02:02 PM, Stephan Hennig wrote:
> Am 22.11.2010 13:22, schrieb Taco Hoekwater:
>
>> The problematic case seems to be: a combination of a non-letter in one
>> font, followed by a letter in another font. LuaTeX does not consider
>> that a valid word start. I will add an item to the tracker database.
>
> There's another problem with fontspec and hyphenation involving only
> letters, but font switching, too. You can find the (short) discussion on
> lualatex-dev at
> <URL:http://permalink.gmane.org/gmane.comp.tex.lualatex.devel/556>.

Thanks for pointing this out, Stephan.

I guess that the problem might be the same (or very similar).

(\emph{hyphenation)} won't be hyphenated, but (\itshape{hyphenation}) 
will be.

Just in case it helps,


Pablo
-- 
http://www.ousia.tk

From mpg at elzevir.fr  Mon Nov 22 16:38:02 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Mon, 22 Nov 2010 16:38:02 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA8A36.1000803@web.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEA69E7.5000102@arcor.de> <4CEA8A36.1000803@web.de>
Message-ID: <4CEA8E5A.4050500@elzevir.fr>

Le 22/11/2010 16:20, Pablo Rodr?guez a ?crit :
> I guess that the problem might be the same (or very similar).
> 
> (\emph{hyphenation)} won't be hyphenated, but (\itshape{hyphenation}) 
> will be.
> 
You mean {\itshape hyphenation}, don't you?


Manuel.


From oinos at web.de  Mon Nov 22 21:19:04 2010
From: oinos at web.de (=?ISO-8859-1?Q?Pablo_Rodr=EDguez?=)
Date: Mon, 22 Nov 2010 21:19:04 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA8E5A.4050500@elzevir.fr>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEA69E7.5000102@arcor.de> <4CEA8A36.1000803@web.de>
 <4CEA8E5A.4050500@elzevir.fr>
Message-ID: <4CEAD038.4060901@web.de>

On 11/22/2010 04:38 PM, Manuel P?gouri?-Gonnard wrote:
> Le 22/11/2010 16:20, Pablo Rodr?guez a ?crit :
>> I guess that the problem might be the same (or very similar).
>>
>> (\emph{hyphenation)} won't be hyphenated, but (\itshape{hyphenation})
>> will be.
>
> You mean {\itshape hyphenation}, don't you?

Yes, I do.

Thanks,


Pablo
-- 
http://www.ousia.tk

From mailing_list at arcor.de  Mon Nov 22 22:20:10 2010
From: mailing_list at arcor.de (Stephan Hennig)
Date: Mon, 22 Nov 2010 22:20:10 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA607F.8070307@elvenkind.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
Message-ID: <4CEADE8A.5060900@arcor.de>

Am 22.11.2010 13:22, schrieb Taco Hoekwater:

> The problematic case seems to be: a combination of a non-letter in one
> font, followed by a letter in another font. LuaTeX does not consider
> that a valid word start. I will add an item to the tracker database.

And another one posted today on de.comp.text.tex (without replies so 
far).  This time, there's no font switching, but non-letters are involved.

In the attached example, the word 'Deutschland' is hyphenated before the 
last letter when wrapped-up in guillemots.  For German patterns 
\righthyphenmin is 2, but that shouldn't include guillemots. 
Hyphenation is correct when there are German quotes or no quotes at all. 
  The error happens with or without fontspec.

Best regards,
Stephan Hennig


\documentclass{article}
%\usepackage[T1]{fontenc}
\usepackage[german]{babel}
\usepackage{fontspec}
\begin{document}
\showhyphens{Deutschland}
\showhyphens{?Deutschland?}
\showhyphens{?Deutschland?}
\end{document}

From mailing_list at arcor.de  Tue Nov 23 00:37:54 2010
From: mailing_list at arcor.de (Stephan Hennig)
Date: Tue, 23 Nov 2010 00:37:54 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEADE8A.5060900@arcor.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
Message-ID: <4CEAFED2.4090406@arcor.de>

Re-posting example with UTF-8 encoding (hopefully).

\documentclass{article}
%\usepackage[T1]{fontenc}
\usepackage[german]{babel}
\usepackage{fontspec}
\begin{document}
\showhyphens{Deutschland}
\showhyphens{?Deutschland?}
\showhyphens{?Deutschland?}
\end{document}

From taco at elvenkind.com  Tue Nov 23 08:06:29 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Tue, 23 Nov 2010 08:06:29 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEADE8A.5060900@arcor.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
Message-ID: <4CEB67F5.5050609@elvenkind.com>

On 11/22/2010 10:20 PM, Stephan Hennig wrote:
>
> And another one posted today on de.comp.text.tex (without replies so
> far). This time, there's no font switching, but non-letters are involved.
>
> In the attached example, the word 'Deutschland' is hyphenated before the
> last letter when wrapped-up in guillemots. For German patterns
> \righthyphenmin is 2, but that shouldn't include guillemots. Hyphenation
> is correct when there are German quotes or no quotes at all. The error
> happens with or without fontspec.

Added to the tracker just in case, but I initially suspect this
particular problem is due to luatex-unicode-letters.tex

Best wishes,
Taco

From mojca.miklavec.lists at gmail.com  Tue Nov 23 10:22:48 2010
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Tue, 23 Nov 2010 10:22:48 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEADE8A.5060900@arcor.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
Message-ID: <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>

On Mon, Nov 22, 2010 at 22:20, Stephan Hennig wrote:
> Am 22.11.2010 13:22, schrieb Taco Hoekwater:
>
>> The problematic case seems to be: a combination of a non-letter in one
>> font, followed by a letter in another font. LuaTeX does not consider
>> that a valid word start. I will add an item to the tracker database.
>
> And another one posted today on de.comp.text.tex (without replies so far).
> ?This time, there's no font switching, but non-letters are involved.
>
> In the attached example, the word 'Deutschland' is hyphenated before the
> last letter when wrapped-up in guillemots. ?For German patterns
> \righthyphenmin is 2, but that shouldn't include guillemots. Hyphenation is
> correct when there are German quotes or no quotes at all. ?The error happens
> with or without fontspec.
>
> Best regards,
> Stephan Hennig
>
>
> \documentclass{article}
> %\usepackage[T1]{fontenc}
> \usepackage[german]{babel}
> \usepackage{fontspec}
> \begin{document}
> \showhyphens{Deutschland}
> \showhyphens{?Deutschland?}
> \showhyphens{?Deutschland?}
> \end{document}

You should not complain about wrong hyphenation if you are loading a
black box of macros (also known as babel). I have no idea how to
switch to an OpenType font in plain LuaTeX (please add that command)
and try to test the following in plain LuaTeX:

\uselanguage{ngerman}

\newdimen\savehsize
\savehsize\hsize
\def\test#1{\endgraf\hsize=3pt\noindent #1\endgraf\hsize=\savehsize}

\test{x ?Deutschland?}
\test{x ?Deutschland?}

\bye

There also exists a "plain command" to switch to particular language
in LaTeX without babel or polyglossia, but I need some time to find
out how exactly to do it (help welcome). You need to test that before
a bug in LuaTeX is confirmed.

Polyglossia needs to be ported to LuaTeX at some point ... using Babel
is only calling for troubles.

Mojca


From luatex at nililand.de  Tue Nov 23 10:40:31 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Tue, 23 Nov 2010 10:40:31 +0100
Subject: [luatex] fontspec prevents hyphenation
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de> <4CEB67F5.5050609@elvenkind.com>
Message-ID: <1pc3945ui7srk$.dlg@nililand.de>

Am Tue, 23 Nov 2010 08:06:29 +0100 schrieb Taco Hoekwater:


>> And another one posted today on de.comp.text.tex (without replies so
>> far). This time, there's no font switching, but non-letters are involved.
>>
>> In the attached example, the word 'Deutschland' is hyphenated before the
>> last letter when wrapped-up in guillemots. For German patterns
>> \righthyphenmin is 2, but that shouldn't include guillemots. Hyphenation
>> is correct when there are German quotes or no quotes at all. The error
>> happens with or without fontspec.
> 
> Added to the tracker just in case, but I initially suspect this
> particular problem is due to luatex-unicode-letters.tex

I tried without luatex-unicode-letters and the wrong hyphenation
didn't disappear. 

And I tried with various unicode chars and the wrong hyphenation
always (at least in all cases I tested ;-)) appears when the char
begins with 00, e.g.:

\showhyphens{Deutschland^^^^00f2}

-- 
Ulrike Fischer 


From mailing_list at arcor.de  Tue Nov 23 11:10:58 2010
From: mailing_list at arcor.de (Stephan Hennig)
Date: Tue, 23 Nov 2010 11:10:58 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
Message-ID: <4CEB9332.60302@arcor.de>

Am 23.11.2010 10:22, schrieb Mojca Miklavec:

> There also exists a "plain command" to switch to particular language
> in LaTeX without babel or polyglossia, but I need some time to find
> out how exactly to do it (help welcome). You need to test that before
> a bug in LuaTeX is confirmed.

I haven't been able to strip the example further down, because low-level 
font and language support in plain TeX and LuaTeX is pretty much blurred 
to me.  Sorry for that!

Best regards,
Stephan Hennig

From luatex at nililand.de  Tue Nov 23 16:08:21 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Tue, 23 Nov 2010 16:08:21 +0100
Subject: [luatex] fontspec prevents hyphenation
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
Message-ID: <1kzze2b2oypwk.dlg@nililand.de>

Am Tue, 23 Nov 2010 10:22:48 +0100 schrieb Mojca Miklavec:


>> In the attached example, the word 'Deutschland' is hyphenated before the
>> last letter when wrapped-up in guillemots. ?For German patterns
>> \righthyphenmin is 2, but that shouldn't include guillemots. Hyphenation is
>> correct when there are German quotes or no quotes at all. ?The error happens
>> with or without fontspec.

> You should not complain about wrong hyphenation if you are loading a
> black box of macros (also known as babel).
> I have no idea how to
> switch to an OpenType font in plain LuaTeX (please add that command)
> and try to test the following in plain LuaTeX:
> 
> \uselanguage{ngerman}
> 
> \newdimen\savehsize
> \savehsize\hsize
> \def\test#1{\endgraf\hsize=3pt\noindent #1\endgraf\hsize=\savehsize}
> 
> \test{x ?Deutschland?}
> \test{x ?Deutschland?}
> 
> \bye

I can't test this as ngerman is unknown to plain luatex (and I have
no idea how to enable it).

> 
> There also exists a "plain command" to switch to particular language
> in LaTeX without babel or polyglossia, but I need some time to find
> out how exactly to do it (help welcome). You need to test that before
> a bug in LuaTeX is confirmed.

I tested this example

\documentclass{article}
%\usepackage{fontspec}
\begin{document}
\makeatletter \bbl at patterns{ngerman}

\showhyphens{Deutschland^^^^00bb}

\righthyphenmin=2

\showhyphens{Deutschland^^^^00bb}

\end{document}

It uses internally the hyphen.cfg from luatex/hyph-utf8. 

LuaTeX adaptation of babel <v3.8l-luatex-1.4> and hyphenation
patterns for english, loaded.

It doesn't matter if I load fontspec or not. In also didn't matter
if luatex-unicode-letters.tex was loaded or not. In all cases the
second \showhyphen (with \righthyphenmin = 2) is wrong:

[][] \OT1/cmr/m/n/10 Deutsch-lan-d??

I also looped through quite a lot "end chars". As far as I can say
only chars in the range up to position 255 are problematic. 

 
> Polyglossia needs to be ported to LuaTeX at some point ... using Babel
> is only calling for troubles.

Well for the current question there is not much difference between
both packages. Both use the same hyphen.cfg and I get the same
hyphenation (if I ignore the error messages about unknown commands).  

-- 
Ulrike Fischer 


From mojca.miklavec.lists at gmail.com  Tue Nov 23 18:43:55 2010
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Tue, 23 Nov 2010 18:43:55 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <1kzze2b2oypwk.dlg@nililand.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
Message-ID: <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>

On Tue, Nov 23, 2010 at 16:08, Ulrike Fischer wrote:
>
> I can't test this as ngerman is unknown to plain luatex (and I have
> no idea how to enable it).

You could just as well use "german" instead (I wasn't paying
attention), but do you want to say that "ngerman" works in lualatex,
but not in plain luatex? Since that would be weird.

Also, I didn't manage to reproduce the behaviour in plain luatex
earlier, but I think that I understand now why this was the case.

> I also looped through quite a lot "end chars". As far as I can say
> only chars in the range up to position 255 are problematic.

Thanks a lot. This rings a bell. I was trying hard to find the
original email (probably discussed by me, Jonathan Kew and others,
probably on xetex mailing list, but maybe privately), but without any
success. Anyhow ... does the following code from xelatex.ini ring a
bell to anyone else?

It sounds like a bit more work to do for Manuel :)

% Because latex.ltx sets up character code tables for T1 encoding by default,
% we need to reset values from unicode-letters that may have been overridden
\begingroup
\catcode`\@=11 \count@=128 % reset chars "80-"FF to category "other",
no case mapping
\loop \ifnum\count@<256
  \global\uccode\count@=0 \global\lccode\count@=0
  \global\catcode\count@=12 \global\sfcode\count@=1000
  \advance\count@ by 1 \repeat
\def\C #1 #2 #3 {\global\uccode"#1="#2 \global\lccode"#1="#3 } % case
mappings (non-letter)
\def\L #1 #2 #3 {\global\catcode"#1=11 % category: letter
  \C #1 #2 #3 % with case mappings
  \ifnum"#1="#3 \else \global\sfcode"#1=999 \fi % uppercase letters
have sfcode=999
  \global\XeTeXmathcode"#1="7"01"#1 % BMP letters default to class 7
(var), fam 1
  }
\def\l #1 {\L #1 #1 #1 } % letter without case mappings
\l 00AA
\L 00B5 039C 00B5
\l 00BA
\L 00C0 00C0 00E0
\L 00C1 00C1 00E1
\L 00C2 00C2 00E2
...

Mojca

From mpg at elzevir.fr  Tue Nov 23 19:05:00 2010
From: mpg at elzevir.fr (=?UTF-8?B?TWFudWVsIFDDqWdvdXJpw6ktR29ubmFyZA==?=)
Date: Tue, 23 Nov 2010 19:05:00 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
Message-ID: <4CEC024C.6070804@elzevir.fr>

Le 23/11/2010 18:43, Mojca Miklavec a ?crit :
> On Tue, Nov 23, 2010 at 16:08, Ulrike Fischer wrote:
>>
>> I can't test this as ngerman is unknown to plain luatex (and I have
>> no idea how to enable it).
> 
> You could just as well use "german" instead (I wasn't paying
> attention), but do you want to say that "ngerman" works in lualatex,
> but not in plain luatex? Since that would be weird.
> 
\uselanguage{ngerman} should work in Plain LuaTeX.

>> I also looped through quite a lot "end chars". As far as I can say
>> only chars in the range up to position 255 are problematic.
> 
> Thanks a lot. This rings a bell. I was trying hard to find the
> original email (probably discussed by me, Jonathan Kew and others,
> probably on xetex mailing list, but maybe privately), but without any
> success. Anyhow ... does the following code from xelatex.ini ring a
> bell to anyone else?
> 
Actually, I was thinking about T1 too, but forgot it was somewhat hard-coded in
the LaTeX kernel...

> It sounds like a bit more work to do for Manuel :)
> 
Yep.

> % Because latex.ltx sets up character code tables for T1 encoding by default,
> % we need to reset values from unicode-letters that may have been overridden

Sorry if I'm asking a very stupid question, but why not simply input
unicode-letters *after* latex.ltx, then? It would avoid duplicating this part of
the code.

Thanks,
Manuel.

From mojca.miklavec.lists at gmail.com  Tue Nov 23 19:06:11 2010
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Tue, 23 Nov 2010 19:06:11 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
Message-ID: <AANLkTi=9yw23iQ2gzkk=eemigNuj0uzQ+M4uPhWfeEo9@mail.gmail.com>

On Tue, Nov 23, 2010 at 18:43, Mojca Miklavec wrote:
>
> This rings a bell. I was trying hard to find the
> original email (probably discussed by me, Jonathan Kew and others,
> probably on xetex mailing list, but maybe privately), but without any
> success.

I have found the private email dated mid-June 2008. The problem has
probably been fixed in XeLaTeX at that time.

To overcome the problem and to disable the latest breakpoint in
\showhyphens{Deutschland^^^^00bb}, all you need to do is:
    \lccode187=0

However this should be fixed in format. LaTeX happens to blindly
assign lccode to all the characters in certain range which is fine for
T1 encoding, but not for XeLaTeX or LuaLaTeX.

Mojca

From mojca.miklavec.lists at gmail.com  Tue Nov 23 19:14:28 2010
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Tue, 23 Nov 2010 19:14:28 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEC024C.6070804@elzevir.fr>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <4CEC024C.6070804@elzevir.fr>
Message-ID: <AANLkTin0q+V2=zFZ2qpz9TxnA5AVE3E3jUc+JMeP=P2B@mail.gmail.com>

Dear Manuel,

On Tue, Nov 23, 2010 at 19:05, Manuel P?gouri?-Gonnard wrote:
>
>> % Because latex.ltx sets up character code tables for T1 encoding by default,
>> % we need to reset values from unicode-letters that may have been overridden
>
> Sorry if I'm asking a very stupid question, but why not simply input
> unicode-letters *after* latex.ltx, then? It would avoid duplicating this part of
> the code.

Don't ask me - it is you who has written the patch with
unicode-letters. It may be that XeTeX needs some magic and proper
catcodes/lccodes before loading latex.ltx and/or other macros.

I'm CC-ing Jonathan. Maybe he can explain you better why lccodes are
set twice in xelatex - before and after loading latex.ltx. You can
probably move unicode-letters for lualatex to the end of lualatex.ini
without any consequences. You just need to make sure that you not only
set the codes for letters, but also unset them for non-letters in the
"80-"FF range.

Mojca


From mpg at elzevir.fr  Tue Nov 23 19:43:49 2010
From: mpg at elzevir.fr (=?UTF-8?B?TWFudWVsIFDDqWdvdXJpw6ktR29ubmFyZA==?=)
Date: Tue, 23 Nov 2010 19:43:49 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <AANLkTin0q+V2=zFZ2qpz9TxnA5AVE3E3jUc+JMeP=P2B@mail.gmail.com>
References: <4CEA5134.6070006@web.de>	<4CEA607F.8070307@elvenkind.com>	<4CEADE8A.5060900@arcor.de>	<AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>	<1kzze2b2oypwk.dlg@nililand.de>	<AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>	<4CEC024C.6070804@elzevir.fr>
 <AANLkTin0q+V2=zFZ2qpz9TxnA5AVE3E3jUc+JMeP=P2B@mail.gmail.com>
Message-ID: <4CEC0B65.5070102@elzevir.fr>

Le 23/11/2010 19:14, Mojca Miklavec a ?crit :
> On Tue, Nov 23, 2010 at 19:05, Manuel P?gouri?-Gonnard wrote:
>>
>>> % Because latex.ltx sets up character code tables for T1 encoding by default,
>>> % we need to reset values from unicode-letters that may have been overridden
>>
>> Sorry if I'm asking a very stupid question, but why not simply input
>> unicode-letters *after* latex.ltx, then? It would avoid duplicating this part of
>> the code.
> 
> Don't ask me - it is you who has written the patch with
> unicode-letters. It may be that XeTeX needs some magic and proper
> catcodes/lccodes before loading latex.ltx and/or other macros.
> 
Ok, I got it. latex.ltx inputs hyphen.cfg which load patterns using \patterns.
At this point, everything inside the "argument" of \patterns needs to have a
non-zero \lccode or TeX will complain that "Nonletter." For characters in the
0-255 range, this is taken care of by the latex kernel (which is precisely the
cause of the problem). For Unicode characters outside this range, \lccodes have
to be set (by unicode-letters) before patterns are loaded.

Since patterns are not really loaded at this point in LuaTeX, we don't really
need to load luatex-unidoe-letters before latex.ltx.

(Which reminds me, I should reread section 6 of the luatex manual, I guess
LuaTeX handles lccodes in a more clever way than other *TeXs, but I'm not
exactly sure.)

> I'm CC-ing Jonathan. Maybe he can explain you better why lccodes are
> set twice in xelatex - before and after loading latex.ltx. You can
> probably move unicode-letters for lualatex to the end of lualatex.ini
> without any consequences. You just need to make sure that you not only
> set the codes for letters, but also unset them for non-letters in the
> "80-"FF range.
> 
Yep, I think I'll do that, after some testing.

Thanks,
Manuel.

From mpg at elzevir.fr  Tue Nov 23 20:22:13 2010
From: mpg at elzevir.fr (=?UTF-8?B?TWFudWVsIFDDqWdvdXJpw6ktR29ubmFyZA==?=)
Date: Tue, 23 Nov 2010 20:22:13 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEC0B65.5070102@elzevir.fr>
References: <4CEA5134.6070006@web.de>	<4CEA607F.8070307@elvenkind.com>	<4CEADE8A.5060900@arcor.de>	<AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>	<1kzze2b2oypwk.dlg@nililand.de>	<AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>	<4CEC024C.6070804@elzevir.fr>
 <AANLkTin0q+V2=zFZ2qpz9TxnA5AVE3E3jUc+JMeP=P2B@mail.gmail.com>
 <4CEC0B65.5070102@elzevir.fr>
Message-ID: <4CEC1465.10304@elzevir.fr>

Le 23/11/2010 19:43, Manuel P?gouri?-Gonnard a ?crit :
> Since patterns are not really loaded at this point in LuaTeX, we don't really
> need to load luatex-unidoe-letters before latex.ltx.
> 
> (Which reminds me, I should reread section 6 of the luatex manual, I guess
> LuaTeX handles lccodes in a more clever way than other *TeXs, but I'm not
> exactly sure.)
> 
Well, just checked: LuaTeX doesn't insist that the characters in the "argument"
of \patterns has non-zero \lccode, it is apparently satisfied with it being
proper utf-8. Which is more reasonable IMO.

(Also, I was wrong to think \lccodes were handled differently: I was apparently
confusing them with \(pre|post)(ex)hyphenchar which is language-specific.)

Manuel.

From mojca.miklavec.lists at gmail.com  Tue Nov 23 20:29:45 2010
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Tue, 23 Nov 2010 20:29:45 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEC1465.10304@elzevir.fr>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <4CEC024C.6070804@elzevir.fr>
 <AANLkTin0q+V2=zFZ2qpz9TxnA5AVE3E3jUc+JMeP=P2B@mail.gmail.com>
 <4CEC0B65.5070102@elzevir.fr> <4CEC1465.10304@elzevir.fr>
Message-ID: <AANLkTins8oygxbzq3=JbXR67Efc7JMa_Su1gBDdunmw9@mail.gmail.com>

On Tue, Nov 23, 2010 at 20:22, Manuel P?gouri?-Gonnard wrote:
>
> Well, just checked: LuaTeX doesn't insist that the characters in the "argument"
> of \patterns has non-zero \lccode, it is apparently satisfied with it being
> proper utf-8. Which is more reasonable IMO.

But you are reading from plain text files anyway ... when you do that
you don't care about lccodes. Precisely that was one the main
arguments for using plain text files instead of loadhyph (apart from
speed).

Mojca


From mpg at elzevir.fr  Tue Nov 23 20:45:46 2010
From: mpg at elzevir.fr (=?UTF-8?B?TWFudWVsIFDDqWdvdXJpw6ktR29ubmFyZA==?=)
Date: Tue, 23 Nov 2010 20:45:46 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <AANLkTins8oygxbzq3=JbXR67Efc7JMa_Su1gBDdunmw9@mail.gmail.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <4CEC024C.6070804@elzevir.fr>
 <AANLkTin0q+V2=zFZ2qpz9TxnA5AVE3E3jUc+JMeP=P2B@mail.gmail.com>
 <4CEC0B65.5070102@elzevir.fr> <4CEC1465.10304@elzevir.fr>
 <AANLkTins8oygxbzq3=JbXR67Efc7JMa_Su1gBDdunmw9@mail.gmail.com>
Message-ID: <4CEC19EA.8000505@elzevir.fr>

Le 23/11/2010 20:29, Mojca Miklavec a ?crit :
> On Tue, Nov 23, 2010 at 20:22, Manuel P?gouri?-Gonnard wrote:
>>
>> Well, just checked: LuaTeX doesn't insist that the characters in the "argument"
>> of \patterns has non-zero \lccode, it is apparently satisfied with it being
>> proper utf-8. Which is more reasonable IMO.
> 
> But you are reading from plain text files anyway ...

Yep, but lang.patterns could check the lccodes just as \patterns does (or more
precisely, doesn't, with LuaTeX).

> when you do that
> you don't care about lccodes. Precisely that was one the main
> arguments for using plain text files instead of loadhyph (apart from
> speed).
> 
Nope, the primary concern was category codes: this is not really related to
hyphenation, but a general robustness problem for macros executed at an
arbitrary time form a latex document.

Manuel.

From luatex at nililand.de  Tue Nov 23 20:57:57 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Tue, 23 Nov 2010 20:57:57 +0100
Subject: [luatex] fontspec prevents hyphenation
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
Message-ID: <9iu4kio2o0da.dlg@nililand.de>

Am Tue, 23 Nov 2010 18:43:55 +0100 schrieb Mojca Miklavec:

> On Tue, Nov 23, 2010 at 16:08, Ulrike Fischer wrote:

>> I can't test this as ngerman is unknown to plain luatex (and I have
>> no idea how to enable it).
 
> You could just as well use "german" instead (I wasn't paying
> attention), but do you want to say that "ngerman" works in lualatex,
> but not in plain luatex? Since that would be weird.

Well I never cared for hyphenation in plain. But now I looked: plain
inputs a hyphen.tex. This hyphen.tex contains some pattern and
that's all. Language.dat is not used and there is also no
luatex-adapted version of hyphen.tex. So luatex and etex both
complain for every language:

! e-TeX error: language german undefined..
\et at xmsg ...lines =0 \errmessage {e-TeX error: #2}


-- 
Ulrike Fischer 


From luatex at nililand.de  Tue Nov 23 20:59:40 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Tue, 23 Nov 2010 20:59:40 +0100
Subject: [luatex] fontspec prevents hyphenation
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <4CEC024C.6070804@elzevir.fr>
Message-ID: <1bm4u1p39ocrc.dlg@nililand.de>

Am Tue, 23 Nov 2010 19:05:00 +0100 schrieb Manuel P?gouri?-Gonnard:

> Sorry if I'm asking a very stupid question, but why not simply input
> unicode-letters *after* latex.ltx, then? It would avoid duplicating this part of
> the code.

I don't know why. But I actually tried it and it didn't work - no
error but no effect. 


-- 
Ulrike Fischer 


From mpg at elzevir.fr  Tue Nov 23 21:08:38 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Tue, 23 Nov 2010 21:08:38 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <9iu4kio2o0da.dlg@nililand.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <9iu4kio2o0da.dlg@nililand.de>
Message-ID: <4CEC1F46.5010808@elzevir.fr>

Le 23/11/2010 20:57, Ulrike Fischer a ?crit :
> Am Tue, 23 Nov 2010 18:43:55 +0100 schrieb Mojca Miklavec:
> 
>> On Tue, Nov 23, 2010 at 16:08, Ulrike Fischer wrote:
> 
>>> I can't test this as ngerman is unknown to plain luatex (and I have
>>> no idea how to enable it).
>  
>> You could just as well use "german" instead (I wasn't paying
>> attention), but do you want to say that "ngerman" works in lualatex,
>> but not in plain luatex? Since that would be weird.
> 
> Well I never cared for hyphenation in plain. But now I looked: plain
> inputs a hyphen.tex. This hyphen.tex contains some pattern and
> that's all. Language.dat is not used and there is also no
> luatex-adapted version of hyphen.tex. So luatex and etex both
> complain for every language:
> 
> ! e-TeX error: language german undefined..
> \et at xmsg ...lines =0 \errmessage {e-TeX error: #2}
> 
This may be dependant on the distribution, but in TeX Live, Plain-based formats
for any engine but TeX82 all are based on etex.src, which expands on plain.tex
and in particular, overrides its loading of hyphenation patterns and implements
an extended scheme for language loading and switching, using language.def.

For LuaTeX, a modified version of etex.src is used, and a specific
language.def.lua file is generated with language.def (and language.dat(.lua)),
so patterns are dynamically loaded (but languages are still statically
allocated), just as with latex/babel.

Manuel.

From luatex at nililand.de  Tue Nov 23 21:24:24 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Tue, 23 Nov 2010 21:24:24 +0100
Subject: [luatex] fontspec prevents hyphenation
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <9iu4kio2o0da.dlg@nililand.de> <4CEC1F46.5010808@elzevir.fr>
Message-ID: <1p9k1c9dks05g.dlg@nililand.de>

Am Tue, 23 Nov 2010 21:08:38 +0100 schrieb Manuel P?gouri?-Gonnard:


>>>> I can't test this as ngerman is unknown to plain luatex (and I have
>>>> no idea how to enable it).
>>  
>>> You could just as well use "german" instead (I wasn't paying
>>> attention), but do you want to say that "ngerman" works in lualatex,
>>> but not in plain luatex? Since that would be weird.
>> 
>> Well I never cared for hyphenation in plain. But now I looked: plain
>> inputs a hyphen.tex. This hyphen.tex contains some pattern and
>> that's all. Language.dat is not used and there is also no
>> luatex-adapted version of hyphen.tex. So luatex and etex both
>> complain for every language:
>> 
>> ! e-TeX error: language german undefined..
>> \et at xmsg ...lines =0 \errmessage {e-TeX error: #2}
>> 
> This may be dependant on the distribution, but in TeX Live, Plain-based formats
> for any engine but TeX82 all are based on etex.src, which expands on plain.tex
> and in particular, overrides its loading of hyphenation patterns and implements
> an extended scheme for language loading and switching, using language.def.

I overlooked the call to language.def. But I found the source of the
problem: There is a default language.def in the main texmf-tree in
tex/plain and the generated language.def with the language entries
is in tex/generic and so was never found. I will make a bug report.
Where is language.def in TeXLive? tex/plain or tex/generic?



-- 
Ulrike Fischer 


From mpg at elzevir.fr  Tue Nov 23 21:34:56 2010
From: mpg at elzevir.fr (=?ISO-8859-1?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Tue, 23 Nov 2010 21:34:56 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <1p9k1c9dks05g.dlg@nililand.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <9iu4kio2o0da.dlg@nililand.de> <4CEC1F46.5010808@elzevir.fr>
 <1p9k1c9dks05g.dlg@nililand.de>
Message-ID: <4CEC2570.4020807@elzevir.fr>

Le 23/11/2010 21:24, Ulrike Fischer a ?crit :
> I overlooked the call to language.def. But I found the source of the
> problem: There is a default language.def in the main texmf-tree in
> tex/plain and the generated language.def with the language entries
> is in tex/generic and so was never found. I will make a bug report.
> Where is language.def in TeXLive? tex/plain or tex/generic?
> 
The generated one is in TEXMFSYSVAR/tex/generic, while the default one is in
TEXMFDIST/tex/generic. By the way, I just checked, the default file we ship
lists all languages, which might not be very reasonable. Anyway, the generated
file should always be there and take precedence.

Manuel.


From mpg at elzevir.fr  Wed Nov 24 00:35:23 2010
From: mpg at elzevir.fr (=?windows-1252?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Wed, 24 Nov 2010 00:35:23 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEADE8A.5060900@arcor.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
Message-ID: <4CEC4FBB.3070401@elzevir.fr>

Le 22/11/2010 22:20, Stephan Hennig a ?crit :
> In the attached example, the word 'Deutschland' is hyphenated before the 
> last letter when wrapped-up in guillemots.  For German patterns 
> \righthyphenmin is 2, but that shouldn't include guillemots. 
> Hyphenation is correct when there are German quotes or no quotes at all. 
>   The error happens with or without fontspec.
> 
> \documentclass{article}
> %\usepackage[T1]{fontenc}
> \usepackage[german]{babel}
> \usepackage{fontspec}
> \begin{document}
> \showhyphens{Deutschland}
> \showhyphens{?Deutschland?}
> \showhyphens{?Deutschland?}
> \end{document}

This one is fixed (according to my tests) by the new version of lualatex.ini,
thanks to Mojca's remark. Look for version 20544 of package "latexconfig" in the
next round of updates via tlmgr.

Manuel.

From luatex at nililand.de  Wed Nov 24 09:49:46 2010
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 24 Nov 2010 09:49:46 +0100
Subject: [luatex] fontspec prevents hyphenation
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de>
 <AANLkTik4X1QwWM2hUmYoH-1sKpzM8QBxPnBsNRMB89WA@mail.gmail.com>
 <1kzze2b2oypwk.dlg@nililand.de>
 <AANLkTimMra+wt_rwxZQusQHszPkdzsenesMzGgHu0xAp@mail.gmail.com>
 <9iu4kio2o0da.dlg@nililand.de> <4CEC1F46.5010808@elzevir.fr>
 <1p9k1c9dks05g.dlg@nililand.de> <4CEC2570.4020807@elzevir.fr>
Message-ID: <8sjmhihf9emf$.dlg@nililand.de>

Am Tue, 23 Nov 2010 21:34:56 +0100 schrieb Manuel P?gouri?-Gonnard:


>> I overlooked the call to language.def. But I found the source of the
>> problem: There is a default language.def in the main texmf-tree in
>> tex/plain and the generated language.def with the language entries
>> is in tex/generic and so was never found. I will make a bug report.
>> Where is language.def in TeXLive? tex/plain or tex/generic?

> The generated one is in TEXMFSYSVAR/tex/generic, while the default one is in
> TEXMFDIST/tex/generic. By the way, I just checked, the default file we ship
> lists all languages, which might not be very reasonable. Anyway, the generated
> file should always be there and take precedence.

I have added a bug report in the miktex tracker and suggested to
move the default language.def to tex/generic. 


-- 
Ulrike Fischer 


From mailing_list at arcor.de  Wed Nov 24 11:52:19 2010
From: mailing_list at arcor.de (Stephan Hennig)
Date: Wed, 24 Nov 2010 11:52:19 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEC4FBB.3070401@elzevir.fr>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de> <4CEC4FBB.3070401@elzevir.fr>
Message-ID: <4CECEE63.4020804@arcor.de>

Am 24.11.2010 00:35, schrieb Manuel P?gouri?-Gonnard:

> This one is fixed (according to my tests) by the new version of lualatex.ini,
> thanks to Mojca's remark. Look for version 20544 of package "latexconfig" in the
> next round of updates via tlmgr.

After running

   tlmgr update --all

today, I noticed that no formats were regenerated here.  In a quick test 
I could still observe the wrong hyphenation.  Running

   tlmgr generate fmtutil

told me to run

   fmtutil-sys --all

instead.  And indeed, after running that command, I cannot observe the 
wrong hyphenation any more.  But I had expected formats to be 
regenerated automatically.

Best regards,
Stephan Hennig

From mpg at elzevir.fr  Wed Nov 24 13:38:53 2010
From: mpg at elzevir.fr (=?windows-1252?Q?Manuel_P=E9gouri=E9-Gonnard?=)
Date: Wed, 24 Nov 2010 13:38:53 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CECEE63.4020804@arcor.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEADE8A.5060900@arcor.de> <4CEC4FBB.3070401@elzevir.fr>
 <4CECEE63.4020804@arcor.de>
Message-ID: <4CED075D.1090309@elzevir.fr>

Le 24/11/2010 11:52, Stephan Hennig a ?crit :
> Am 24.11.2010 00:35, schrieb Manuel P?gouri?-Gonnard:
> 
>> This one is fixed (according to my tests) by the new version of lualatex.ini,
>> thanks to Mojca's remark. Look for version 20544 of package "latexconfig" in the
>> next round of updates via tlmgr.
> 
> After running
> 
>    tlmgr update --all
> 
> today, I noticed that no formats were regenerated here.

Darn. The files used to build the formats are split in several packages, but
only the main package triggers format rebuilding. I manually bumped the version
number of the appropriate packages so that luatex-based formats should be
automatically rebuilt in the next update.

>    tlmgr generate fmtutil
> 
By the way, this wasn't necessary: it only updates the list of formats.

>    fmtutil-sys --all
> 
--byengine luatex was enough too, but anyway.

> instead.  And indeed, after running that command, I cannot observe the 
> wrong hyphenation any more.

Good to know.

Thanks,
Manuel.

From st_philipp at yahoo.de  Fri Nov 26 13:34:57 2010
From: st_philipp at yahoo.de (Philipp Stephani)
Date: Fri, 26 Nov 2010 12:34:57 +0000 (GMT)
Subject: [luatex] New over/under delimiter primitives
Message-ID: <502694.60840.qm@web28614.mail.ukl.yahoo.com>

Hello,

I have a general question about the primitives \Uoverdelimiter, 
\Uunderdelimiter, \Udelimiterover and \Udelimiterunder. ConTeXt seems to use the 
two former in math-ini.lua:

local function mathtopdelimiter(class,family,slot)
    return format('\\Uoverdelimiter "%X "%X ',0,family,slot) -- no class
end
local function mathbotdelimiter(class,family,slot)
    return format('\\Uunderdelimiter "%X "%X ',0,family,slot) -- no class
end

where the slot argument is unused?!
I also tried to play around with them in plain LuaTeX:

\input luaotfload.sty
\font\cambria={name:Cambria Math:script=math} at 11pt
\textfont0=\cambria
\def\overrightarrow{\Uoverdelimiter 0 "2192 }
\def\underrightarrow{\Uunderdelimiter 0 "2192 }
\def\xoverrightarrow{\Udelimiterover 0 "2192 }
\def\xunderrightarrow{\Udelimiterunder 0 "2192 }
\def\abc{\Umathchar 0 0 "1D44E \Umathchar 0 0 "1D44F \Umathchar 0 0 "1D450 }
$$ \abc \quad \overrightarrow{\abc} \quad \underrightarrow{\abc} $$
\bye

That results in "abc ? ?", without any subscripts or superscripts. So what do 
these primitives actually do, and how should we use them?

Regards,
Philipp





From taco at elvenkind.com  Fri Nov 26 13:48:44 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 26 Nov 2010 13:48:44 +0100
Subject: [luatex] New over/under delimiter primitives
In-Reply-To: <502694.60840.qm@web28614.mail.ukl.yahoo.com>
References: <502694.60840.qm@web28614.mail.ukl.yahoo.com>
Message-ID: <4CEFACAC.2060801@elvenkind.com>

On 11/26/2010 01:34 PM, Philipp Stephani wrote:
> Hello,
>
> I have a general question about the primitives \Uoverdelimiter,
> \Uunderdelimiter, \Udelimiterover and \Udelimiterunder. ConTeXt seems to use the
> two former in math-ini.lua:
>
> local function mathtopdelimiter(class,family,slot)
>      return format('\\Uoverdelimiter "%X "%X ',0,family,slot) -- no class
> end
> local function mathbotdelimiter(class,family,slot)
>      return format('\\Uunderdelimiter "%X "%X ',0,family,slot) -- no class
> end
>
> where the slot argument is unused?!

The extra ",0" format argument 	was a bug that has since been corrected.

> I also tried to play around with them in plain LuaTeX:
>
> \input luaotfload.sty
> \font\cambria={name:Cambria Math:script=math} at 11pt
> \textfont0=\cambria

This definition is not complete. You also need:

   \font\cambriax={name:Cambria Math:script=math} at 8pt
   \scriptfont0=\cambriax

because "1D44E etc. are not available in cmr7.

Best wishes,
Taco

From mailing_list at arcor.de  Fri Nov 26 14:26:39 2010
From: mailing_list at arcor.de (Stephan Hennig)
Date: Fri, 26 Nov 2010 14:26:39 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA607F.8070307@elvenkind.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
Message-ID: <4CEFB58F.9060708@arcor.de>

Am 22.11.2010 13:22, schrieb Taco Hoekwater:

> I will add an item to the tracker database.

Is there a way to browse the bug database without creating an account at 
<URL:http://tracker.luatex.org/>?

Best regards,
Stephan Hennig

From taco at elvenkind.com  Fri Nov 26 14:49:38 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 26 Nov 2010 14:49:38 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEFB58F.9060708@arcor.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEFB58F.9060708@arcor.de>
Message-ID: <4CEFBAF2.7000900@elvenkind.com>

On 11/26/2010 02:26 PM, Stephan Hennig wrote:
> Am 22.11.2010 13:22, schrieb Taco Hoekwater:
>
>> I will add an item to the tracker database.
>
> Is there a way to browse the bug database without creating an account at
> <URL:http://tracker.luatex.org/>?

It should be possible now to log in anonymously. Somehow I thought
that this was already possible, maybe something has changed in a
Mantis upgrade.

Best wishes,
Taco

From pgesang at ix.urz.uni-heidelberg.de  Fri Nov 26 14:51:22 2010
From: pgesang at ix.urz.uni-heidelberg.de (Philipp Gesang)
Date: Fri, 26 Nov 2010 14:51:22 +0100
Subject: [luatex] unicode.utf8.format + unicode.utf8.len?
Message-ID: <20101126135122.GA1382@aides>

Hi Taco & the Rest of the List,

I?m sorry if this question sounds stupid, but I?m wondering for
what reason the ?format()? of slnunicode uses Lua?s string length
mechanism instead of ?utf8_count()??

???8<????????????????????????????????????????????????????????????

local utf = unicode.utf8

local hello_world = "?????, ? ?????"
io.write(string.format(">%28s < [Length: %s]\n", hello_world, #hello_world))
io.write(   utf.format(">%15s < [Length: %s]\n", hello_world, utf.len(hello_world)))

???8<????????????????????????????????????????????????????????????

Could ?utf8.format()? be extended to check for multibyte strings
like ?unic_len()? at least for ?%s? and act accordingly?

Thanks for your time, Philipp

-- 
()  ascii ribbon campaign - against html e-mail
/\  www.asciiribbon.org   - against proprietary attachments
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101126/0a16586d/attachment.bin>

From luigi.scarso at gmail.com  Fri Nov 26 14:54:15 2010
From: luigi.scarso at gmail.com (luigi scarso)
Date: Fri, 26 Nov 2010 14:54:15 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEFBAF2.7000900@elvenkind.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEFB58F.9060708@arcor.de> <4CEFBAF2.7000900@elvenkind.com>
Message-ID: <AANLkTi=iCAMA7rvXTnwCy477uANeD8aUXXMH4sC7ifzu@mail.gmail.com>

On Fri, Nov 26, 2010 at 2:49 PM, Taco Hoekwater <taco at elvenkind.com> wrote:
> On 11/26/2010 02:26 PM, Stephan Hennig wrote:
>>
>> Am 22.11.2010 13:22, schrieb Taco Hoekwater:
>>
>>> I will add an item to the tracker database.
>>
>> Is there a way to browse the bug database without creating an account at
>> <URL:http://tracker.luatex.org/>?
>
> It should be possible now to log in anonymously. Somehow I thought
> that this was already possible, maybe something has changed in a
> Mantis upgrade.
No, it was always needed to register see the logs.


-- 
luigi

From taco at elvenkind.com  Fri Nov 26 14:55:51 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 26 Nov 2010 14:55:51 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <AANLkTi=iCAMA7rvXTnwCy477uANeD8aUXXMH4sC7ifzu@mail.gmail.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEFB58F.9060708@arcor.de> <4CEFBAF2.7000900@elvenkind.com>
 <AANLkTi=iCAMA7rvXTnwCy477uANeD8aUXXMH4sC7ifzu@mail.gmail.com>
Message-ID: <4CEFBC67.5040602@elvenkind.com>

On 11/26/2010 02:54 PM, luigi scarso wrote:
> On Fri, Nov 26, 2010 at 2:49 PM, Taco Hoekwater<taco at elvenkind.com>  wrote:
>> On 11/26/2010 02:26 PM, Stephan Hennig wrote:
>>>
>>> Am 22.11.2010 13:22, schrieb Taco Hoekwater:
>>>
>>>> I will add an item to the tracker database.
>>>
>>> Is there a way to browse the bug database without creating an account at
>>> <URL:http://tracker.luatex.org/>?
>>
>> It should be possible now to log in anonymously. Somehow I thought
>> that this was already possible, maybe something has changed in a
>> Mantis upgrade.
> No, it was always needed to register see the logs.

Ok. Well, it seems to work now.




From taco at elvenkind.com  Fri Nov 26 15:46:24 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 26 Nov 2010 15:46:24 +0100
Subject: [luatex] unicode.utf8.format + unicode.utf8.len?
In-Reply-To: <20101126135122.GA1382@aides>
References: <20101126135122.GA1382@aides>
Message-ID: <4CEFC840.30301@elvenkind.com>

On 11/26/2010 02:51 PM, Philipp Gesang wrote:
> Hi Taco&  the Rest of the List,
>
> I?m sorry if this question sounds stupid, but I?m wondering for
> what reason the ?format()? of slnunicode uses Lua?s string length
> mechanism instead of ?utf8_count()??

Luatex is repackaging the existing selene unicode library:

   http://luaforge.net/projects/sln/

so can you please report the issue there? I am not eager
to include local patches.

Best wishes,
Taco

From taco at elvenkind.com  Fri Nov 26 15:53:47 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Fri, 26 Nov 2010 15:53:47 +0100
Subject: [luatex] unicode.utf8.format + unicode.utf8.len?
In-Reply-To: <4CEFC840.30301@elvenkind.com>
References: <20101126135122.GA1382@aides> <4CEFC840.30301@elvenkind.com>
Message-ID: <4CEFC9FB.6090701@elvenkind.com>

On 11/26/2010 03:46 PM, Taco Hoekwater wrote:
> On 11/26/2010 02:51 PM, Philipp Gesang wrote:
>> Hi Taco& the Rest of the List,
>>
>> I?m sorry if this question sounds stupid, but I?m wondering for
>> what reason the ?format()? of slnunicode uses Lua?s string length
>> mechanism instead of ?utf8_count()??
>
> Luatex is repackaging the existing selene unicode library:
>
> http://luaforge.net/projects/sln/
>
> so can you please report the issue there? I am not eager
> to include local patches.

OTOH, I already have a local patch it seems, so adding another
would not be that big a deal. It would still be better if the fix
was created upstream, though.

Best wishes,
Taco

From pgesang at ix.urz.uni-heidelberg.de  Fri Nov 26 16:06:30 2010
From: pgesang at ix.urz.uni-heidelberg.de (Philipp Gesang)
Date: Fri, 26 Nov 2010 16:06:30 +0100
Subject: [luatex] unicode.utf8.format + unicode.utf8.len?
In-Reply-To: <4CEFC840.30301@elvenkind.com>
References: <20101126135122.GA1382@aides>
 <4CEFC840.30301@elvenkind.com>
Message-ID: <20101126150630.GA1645@aides>

On 2010-11-26 <15:46:24>, Taco Hoekwater wrote:
> On 11/26/2010 02:51 PM, Philipp Gesang wrote:
> >Hi Taco&  the Rest of the List,
> >
> >I?m sorry if this question sounds stupid, but I?m wondering for
> >what reason the ?format()? of slnunicode uses Lua?s string length
> >mechanism instead of ?utf8_count()??
> 
> Luatex is repackaging the existing selene unicode library:
> 
>   http://luaforge.net/projects/sln/
> 
> so can you please report the issue there? I am not eager
> to include local patches.

I understand. I just checked: according to the file ?unitest? the
issue seems to be known:

  --  TODO: use char count with %s in format? (sub does the job)

Does not appear to have top priority after all these years, but
anyways, there?s now a feature request on their tracker.

Philipp

> 
> Best wishes,
> Taco

-- 
()  ascii ribbon campaign - against html e-mail
/\  www.asciiribbon.org   - against proprietary attachments
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20101126/4aefd3a0/attachment.bin>

From mailing_list at arcor.de  Fri Nov 26 15:13:05 2010
From: mailing_list at arcor.de (Stephan Hennig)
Date: Fri, 26 Nov 2010 15:13:05 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEFBC67.5040602@elvenkind.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CEFB58F.9060708@arcor.de> <4CEFBAF2.7000900@elvenkind.com>
 <AANLkTi=iCAMA7rvXTnwCy477uANeD8aUXXMH4sC7ifzu@mail.gmail.com>
 <4CEFBC67.5040602@elvenkind.com>
Message-ID: <4CEFC071.304@arcor.de>

Am 26.11.2010 14:55, schrieb Taco Hoekwater:

> Ok. Well, it seems to work now.

Yes, it works.  Thanks!

Best regards,
Stephan Hennig

From taco at elvenkind.com  Sun Nov 28 12:05:01 2010
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sun, 28 Nov 2010 12:05:01 +0100
Subject: [luatex] fontspec prevents hyphenation
In-Reply-To: <4CEA607F.8070307@elvenkind.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
Message-ID: <4CF2375D.7080802@elvenkind.com>

Hi,

On 11/22/2010 01:22 PM, Taco Hoekwater wrote:
>>
>> Would you be so kind to fix this?
>
> The problematic case seems to be: a combination of a non-letter in one
> font, followed by a letter in another font. LuaTeX does not consider
> that a valid word start. I will add an item to the tracker database.

That was a bad analysis. The bug is not in luatex at all, it is a bug
in fontspec.  Some input like

   (\emph{hyphenation})

in fontspec produces the following low-level node list

   ( \/ h y p h e n a t i o n \/ )

and the "\/ h" combination is not a valid word start (the second italic
correction is fine, the first one is the problem).

In this, luatex is compatible with TeX itself, you can try

   \showhyphens{(\/hyphenation\/)}

in plain TeX to see the thing happening (same lack of hyphenation).

Closing the luatex tracker item,

Taco




From khaledhosny at eglug.org  Sun Nov 28 12:40:37 2010
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Sun, 28 Nov 2010 13:40:37 +0200
Subject: [luatex] [lltx]  fontspec prevents hyphenation
In-Reply-To: <4CF2375D.7080802@elvenkind.com>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CF2375D.7080802@elvenkind.com>
Message-ID: <20101128114037.GA3404@khaled-laptop>

On Sun, Nov 28, 2010 at 12:05:01PM +0100, Taco Hoekwater wrote:
> Hi,
> 
> On 11/22/2010 01:22 PM, Taco Hoekwater wrote:
> >>
> >>Would you be so kind to fix this?
> >
> >The problematic case seems to be: a combination of a non-letter in one
> >font, followed by a letter in another font. LuaTeX does not consider
> >that a valid word start. I will add an item to the tracker database.
> 
> That was a bad analysis. The bug is not in luatex at all, it is a bug
> in fontspec.  Some input like
> 
>   (\emph{hyphenation})
> 
> in fontspec produces the following low-level node list
> 
>   ( \/ h y p h e n a t i o n \/ )
> 
> and the "\/ h" combination is not a valid word start (the second italic
> correction is fine, the first one is the problem).
> 
> In this, luatex is compatible with TeX itself, you can try
> 
>   \showhyphens{(\/hyphenation\/)}
> 
> in plain TeX to see the thing happening (same lack of hyphenation).
> 
> Closing the luatex tracker item,

It seems deeper than fontspec, either in luaotfload or something deeper
inside latex. This gives the same result:

\documentclass{article}
\usepackage{luaotfload}
\usepackage[EU2]{fontenc}
\usepackage[width=2cm]{geometry}

\begin{document}
An intere\textit{st}ing word.

An intere{\itshape st}ing word
\end{document}

-- 
 Khaled Hosny
 Arabic localiser and member of Arabeyes.org team
 Free font developer

From st_philipp at yahoo.de  Sun Nov 28 14:13:21 2010
From: st_philipp at yahoo.de (Philipp Stephani)
Date: Sun, 28 Nov 2010 14:13:21 +0100
Subject: [luatex] [lltx]  fontspec prevents hyphenation
In-Reply-To: <20101128114037.GA3404@khaled-laptop>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CF2375D.7080802@elvenkind.com> <20101128114037.GA3404@khaled-laptop>
Message-ID: <C380AE8B-5291-444C-B6A2-B753B5993367@yahoo.de>

Am 28.11.2010 um 12:40 schrieb Khaled Hosny:

> It seems deeper than fontspec, either in luaotfload or something deeper
> inside latex. This gives the same result:
> 
> \documentclass{article}
> \usepackage{luaotfload}
> \usepackage[EU2]{fontenc}
> \usepackage[width=2cm]{geometry}
> 
> \begin{document}
> An intere\textit{st}ing word.
> 
> An intere{\itshape st}ing word
> \end{document}

LaTeX uses the first font dimension in the italic correction code. This number must be strictly positive for italic fonts.

\documentclass{article}
\begin{document}
\textit{\the\fontdimen1\font}
\end{document}

compiled with pdfLaTeX results in 0.25pt, but

\documentclass{article}
\usepackage{luaotfload}
\usepackage{lmodern}
\usepackage[EU2]{fontenc}
\begin{document}
\textit{\the\fontdimen1\font}
\end{document}

compiled with LuaLaTeX results in 0.0pt.

From khaledhosny at eglug.org  Sun Nov 28 15:46:32 2010
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Sun, 28 Nov 2010 16:46:32 +0200
Subject: [luatex] [lltx]    fontspec prevents hyphenation
In-Reply-To: <C380AE8B-5291-444C-B6A2-B753B5993367@yahoo.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CF2375D.7080802@elvenkind.com>
 <20101128114037.GA3404@khaled-laptop>
 <C380AE8B-5291-444C-B6A2-B753B5993367@yahoo.de>
Message-ID: <20101128144632.GA4234@khaled-laptop>

On Sun, Nov 28, 2010 at 02:13:21PM +0100, Philipp Stephani wrote:
> Am 28.11.2010 um 12:40 schrieb Khaled Hosny:
> 
> > It seems deeper than fontspec, either in luaotfload or something deeper
> > inside latex. This gives the same result:
> > 
> > \documentclass{article}
> > \usepackage{luaotfload}
> > \usepackage[EU2]{fontenc}
> > \usepackage[width=2cm]{geometry}
> > 
> > \begin{document}
> > An intere\textit{st}ing word.
> > 
> > An intere{\itshape st}ing word
> > \end{document}
> 
> LaTeX uses the first font dimension in the italic correction code. This number must be strictly positive for italic fonts.
> 
> \documentclass{article}
> \begin{document}
> \textit{\the\fontdimen1\font}
> \end{document}
> 
> compiled with pdfLaTeX results in 0.25pt, but
> 
> \documentclass{article}
> \usepackage{luaotfload}
> \usepackage{lmodern}
> \usepackage[EU2]{fontenc}
> \begin{document}
> \textit{\the\fontdimen1\font}
> \end{document}
> 
> compiled with LuaLaTeX results in 0.0pt.

I though italic correction is handled internally by the engine, it is a
character not a font property AFAIK. Since OpenType has no support for
italic correction (except in MATH table), luaotfload (read ConTeXt) has
a pseudo feature, 'itlc', that guesses italic correction value but
neither fontspec nor EU2 .fd files are using it currently. The file
bellow is hyphenated just fine and italic correction is applied, though
I'm getting more confused and I actually lost track of what the original
issue was.

\documentclass{article}
\usepackage{fontspec}
\setmainfont[
    ItalicFeatures={RawFeature={+itlc}}
]{Latin Modern Roman}
\usepackage[width=2cm]{geometry}

\begin{document}
An inter\textit{est}ing word.

An inter{\itshape est\/}ing word.
\end{document}


Regards,
 Khaled

-- 
 Khaled Hosny
 Arabic localiser and member of Arabeyes.org team
 Free font developer

From khaledhosny at eglug.org  Sun Nov 28 16:36:14 2010
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Sun, 28 Nov 2010 17:36:14 +0200
Subject: [luatex] [lltx]    fontspec prevents hyphenation
In-Reply-To: <59E2E2CB-98FE-48DB-8888-978BDD01E83F@yahoo.de>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CF2375D.7080802@elvenkind.com>
 <20101128114037.GA3404@khaled-laptop>
 <C380AE8B-5291-444C-B6A2-B753B5993367@yahoo.de>
 <20101128144632.GA4234@khaled-laptop>
 <59E2E2CB-98FE-48DB-8888-978BDD01E83F@yahoo.de>
Message-ID: <20101128153614.GA14578@khaled-laptop>

On Sun, Nov 28, 2010 at 04:21:56PM +0100, Philipp Stephani wrote:
> 
> Am 28.11.2010 um 15:46 schrieb Khaled Hosny:
> 
> > The file
> > bellow is hyphenated just fine and italic correction is applied, though
> > I'm getting more confused and I actually lost track of what the original
> > issue was.
> > 
> > \documentclass{article}
> > \usepackage{fontspec}
> > \setmainfont[
> >    ItalicFeatures={RawFeature={+itlc}}
> > ]{Latin Modern Roman}
> > \usepackage[width=2cm]{geometry}
> > 
> > \begin{document}
> > An inter\textit{est}ing word.
> 
> This doesn't work because LaTeX inserts \/ before "est" since the first font dimension is zero.

That is why I'm confused, it works. Ah, wait, I was experimenting with
setting \fontdimen1 and I though I deleted that code but I just found it
was still their, that is why it is working for me.

> > 
> > An inter{\itshape est\/}ing word.
> > \end{document}
> 
> This works because LaTeX doesn't insert \/ here.
> Either fontspec has to patch the LaTeX kernel, or the first font dimension for italic fonts must be set to a positive value by luaotfload.

I can confirm that, thanks for explanation. We can test if the font has
italic angle and set \fondimen1 accordingly, I just don't know how to
map the former to the later and don't want to set some seriously broken
value that would break something else.

Regards,
 Khaled

-- 
 Khaled Hosny
 Arabic localiser and member of Arabeyes.org team
 Free font developer

From zappathustra at free.fr  Sun Nov 28 16:51:55 2010
From: zappathustra at free.fr (Paul Isambert)
Date: Sun, 28 Nov 2010 16:51:55 +0100
Subject: [luatex] PDF strings.
Message-ID: <4CF27A9B.6060807@free.fr>

Hello all,

As you may know, PDF reads strings encoded in either its own scheme, or 
in UTF-16.
My problem is I want accented characters in bookmarks, e.g:

\pdfoutline goto name {there}{H?h?}

I can't feed PDF-encoded strings directly (LuaTeX would complain), but 
PDF also understands \nnn-encoded characters, where \nnn is a number in 
base-8, so I actually do

\pdfoutline goto name {there}{\octal{H?h?}}

where \octal calls Lua to convert each character into \nnn, so that 
LuaTeX actually reads (the backslash has catcode 12):

\pdfoutline goto name {there}{\110\351\150\351}

which works fine, except the number are Unicode, which the PDF encoding 
doesn't follow exactly, so that I also need a mapping from Unicode to 
PDF encoding, and then octal.

Even though \nnn is able to represent a number up to 512, only the first 
256 are understood (beyond, the encoding seems to repeat itself, i.e. 
\nnn is understood modulo 256), because PDF encoding represents only 
latin1. For my purpose (French), it's ok, but I guess some people must 
be somewhat annoyed...

The other solution is UTF-16BE, which can't be fed directly to LuaTeX 
(you can't use \nnn to represent bytes). I.e you can't have:

\pdfoutline goto name {there}{\sixteen{H?h?}}

where \sixteen would return a string encoded in UTF-16BE, because LuaTeX 
will complain about non-utf-8 characters. You can do that directly in 
Lua, though, but there's no pdf.outline primitive:

pdf.outline(to_utf16("H?h?"))

(See http://www.ntg.nl/pipermail/dev-luatex/2007-December/001175.html 
for a three-year old discussion.)
Anyway that would solve a symptom rather than the problem.

A solution is

function outline_title(str)
   tex.sprint(pdf.immediateobj("(" .. to_utf16(str) .. ")"))
end

and then

\pdfoutline attr {/Title \directlua{outline_title("H?h?")} 0 R } goto 
name {there}{}


It works, but it produces a bookmark with two /Title fields; the second 
one (the one we want) is selected, but that's no good PDF. (Anyway we 
can't use \pdfoutline as is.)


Ok, if you've read up to here and aren't too bored, congratulations, and 
then: any suggestions?
And to our dear developpers: any plan to make LuaTeX writes everthing in 
UTF-16 when necessary?

Best,
Paul

From st_philipp at yahoo.de  Sun Nov 28 17:03:41 2010
From: st_philipp at yahoo.de (Philipp Stephani)
Date: Sun, 28 Nov 2010 17:03:41 +0100
Subject: [luatex] New over/under delimiter primitives
In-Reply-To: <4CEFACAC.2060801@elvenkind.com>
References: <502694.60840.qm@web28614.mail.ukl.yahoo.com>
 <4CEFACAC.2060801@elvenkind.com>
Message-ID: <3374B4F5-C10E-4EE0-871D-D96AACB481BD@yahoo.de>

Am 26.11.2010 um 13:48 schrieb Taco Hoekwater:

>> I also tried to play around with them in plain LuaTeX:
>> 
>> \input luaotfload.sty
>> \font\cambria={name:Cambria Math:script=math} at 11pt
>> \textfont0=\cambria
> 
> This definition is not complete. You also need:
> 
>  \font\cambriax={name:Cambria Math:script=math} at 8pt
>  \scriptfont0=\cambriax
> 
> because "1D44E etc. are not available in cmr7.

I see, stupid me. Thanks.

From st_philipp at yahoo.de  Sun Nov 28 16:21:56 2010
From: st_philipp at yahoo.de (Philipp Stephani)
Date: Sun, 28 Nov 2010 16:21:56 +0100
Subject: [luatex] [lltx]    fontspec prevents hyphenation
In-Reply-To: <20101128144632.GA4234@khaled-laptop>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CF2375D.7080802@elvenkind.com> <20101128114037.GA3404@khaled-laptop>
 <C380AE8B-5291-444C-B6A2-B753B5993367@yahoo.de>
 <20101128144632.GA4234@khaled-laptop>
Message-ID: <59E2E2CB-98FE-48DB-8888-978BDD01E83F@yahoo.de>


Am 28.11.2010 um 15:46 schrieb Khaled Hosny:

> The file
> bellow is hyphenated just fine and italic correction is applied, though
> I'm getting more confused and I actually lost track of what the original
> issue was.
> 
> \documentclass{article}
> \usepackage{fontspec}
> \setmainfont[
>    ItalicFeatures={RawFeature={+itlc}}
> ]{Latin Modern Roman}
> \usepackage[width=2cm]{geometry}
> 
> \begin{document}
> An inter\textit{est}ing word.

This doesn't work because LaTeX inserts \/ before "est" since the first font dimension is zero.

> 
> An inter{\itshape est\/}ing word.
> \end{document}

This works because LaTeX doesn't insert \/ here.
Either fontspec has to patch the LaTeX kernel, or the first font dimension for italic fonts must be set to a positive value by luaotfload.

From st_philipp at yahoo.de  Sun Nov 28 17:37:23 2010
From: st_philipp at yahoo.de (Philipp Stephani)
Date: Sun, 28 Nov 2010 17:37:23 +0100
Subject: [luatex] [lltx]    fontspec prevents hyphenation
In-Reply-To: <20101128153614.GA14578@khaled-laptop>
References: <4CEA5134.6070006@web.de> <4CEA607F.8070307@elvenkind.com>
 <4CF2375D.7080802@elvenkind.com> <20101128114037.GA3404@khaled-laptop>
 <C380AE8B-5291-444C-B6A2-B753B5993367@yahoo.de>
 <20101128144632.GA4234@khaled-laptop>
 <59E2E2CB-98FE-48DB-8888-978BDD01E83F@yahoo.de>
 <20101128153614.GA14578@khaled-laptop>
Message-ID: <E33DCDB2-5157-458F-8527-C5C98F46F99D@yahoo.de>

Am 28.11.2010 um 16:36 schrieb Khaled Hosny:

> We can test if the font has
> italic angle and set \fondimen1 accordingly, I just don't know how to
> map the former to the later and don't want to set some seriously broken
> value that would break something else.

The italic angle in the "post" table is a number that measures the angle in degrees between the geometrical vertical and the font glyph vertical. The first font dimension is the slant per point, i.e., the arctangent of the additive inverse of the italic angle. For Latin Modern Roman Italic 10, this gives 0.24, which is very close to the table value of 0.242. Original TeX uses the slant per point for accent placement, while LuaTeX uses the OpenType tables.

From heiko.oberdiek at googlemail.com  Sun Nov 28 18:47:05 2010
From: heiko.oberdiek at googlemail.com (Heiko Oberdiek)
Date: Sun, 28 Nov 2010 18:47:05 +0100
Subject: [luatex] PDF strings.
In-Reply-To: <4CF27A9B.6060807@free.fr>
References: <4CF27A9B.6060807@free.fr>
Message-ID: <20101128174705.GA15477@oberdiek.my-fqdn.de>

On Sun, Nov 28, 2010 at 04:51:55PM +0100, Paul Isambert wrote:

> As you may know, PDF reads strings encoded in either its own scheme,
> or in UTF-16.
> My problem is I want accented characters in bookmarks, e.g:
> 
> \pdfoutline goto name {there}{H?h?}
> 
> I can't feed PDF-encoded strings directly (LuaTeX would complain),
> but PDF also understands \nnn-encoded characters, where \nnn is a
> number in base-8, so I actually do
> 
> \pdfoutline goto name {there}{\octal{H?h?}}
> 
> where \octal calls Lua to convert each character into \nnn, so that
> LuaTeX actually reads (the backslash has catcode 12):
> 
> \pdfoutline goto name {there}{\110\351\150\351}
> 
> which works fine, except the number are Unicode, which the PDF
> encoding doesn't follow exactly, so that I also need a mapping from
> Unicode to PDF encoding, and then octal.

If hyperref is loaded, you can use \pdfstringdef.
Otherwise package `stringenc' might help, PDFDocEncoding
and UTF-16 are supported. But I think I haven't
implemented big char support (chars with character code > 255
for LuaTeX and XeTeX) yet (it's done in hyperref). If this is
true, then the package might still help you at some conversion
steps.

> The other solution is UTF-16BE, which can't be fed directly to
> LuaTeX (you can't use \nnn to represent bytes). I.e you can't have:
> 
> \pdfoutline goto name {there}{\sixteen{H?h?}}
> 
> where \sixteen would return a string encoded in UTF-16BE, because
> LuaTeX will complain about non-utf-8 characters. You can do that
> directly in Lua, though, but there's no pdf.outline primitive:
> 
> pdf.outline(to_utf16("H?h?"))

You can still use \nnn, because this notation is restricted
to plain ASCII ('\', '0', ... '9'). Of course the \nnn are
used for bytes only.

Yours sincerely
  Heiko Oberdiek

From zappathustra at free.fr  Sun Nov 28 19:22:48 2010
From: zappathustra at free.fr (Paul Isambert)
Date: Sun, 28 Nov 2010 19:22:48 +0100
Subject: [luatex] PDF strings.
In-Reply-To: <20101128174705.GA15477@oberdiek.my-fqdn.de>
References: <4CF27A9B.6060807@free.fr>
 <20101128174705.GA15477@oberdiek.my-fqdn.de>
Message-ID: <4CF29DF8.6030403@free.fr>



Le 28/11/2010 18:47, Heiko Oberdiek a ?crit :
> On Sun, Nov 28, 2010 at 04:51:55PM +0100, Paul Isambert wrote:
>
>> As you may know, PDF reads strings encoded in either its own scheme,
>> or in UTF-16.
>> My problem is I want accented characters in bookmarks, e.g:
>>
>> \pdfoutline goto name {there}{H?h?}
>>
>> I can't feed PDF-encoded strings directly (LuaTeX would complain),
>> but PDF also understands \nnn-encoded characters, where \nnn is a
>> number in base-8, so I actually do
>>
>> \pdfoutline goto name {there}{\octal{H?h?}}
>>
>> where \octal calls Lua to convert each character into \nnn, so that
>> LuaTeX actually reads (the backslash has catcode 12):
>>
>> \pdfoutline goto name {there}{\110\351\150\351}
>>
>> which works fine, except the number are Unicode, which the PDF
>> encoding doesn't follow exactly, so that I also need a mapping from
>> Unicode to PDF encoding, and then octal.
> If hyperref is loaded, you can use \pdfstringdef.
> Otherwise package `stringenc' might help, PDFDocEncoding
> and UTF-16 are supported. But I think I haven't
> implemented big char support (chars with character code>  255
> for LuaTeX and XeTeX) yet (it's done in hyperref). If this is
> true, then the package might still help you at some conversion
> steps.

I do not load hyperref; as for stringenc, I might have used it, except 
it doesn't work. strings more than one letter produce the non-utf8 
character error (even if they don't contain any), as in:

\StringEncodingConvert\outlinetitle{aa}{utf8}{utf16}

and if I try with just one letter, bookmarks show nothing:

\StringEncodingConvert\outlinetitle{a}{utf8}{utf16}
\pdfoutline goto name {there}{\outlinetitle}


>> The other solution is UTF-16BE, which can't be fed directly to
>> LuaTeX (you can't use \nnn to represent bytes). I.e you can't have:
>>
>> \pdfoutline goto name {there}{\sixteen{H?h?}}
>>
>> where \sixteen would return a string encoded in UTF-16BE, because
>> LuaTeX will complain about non-utf-8 characters. You can do that
>> directly in Lua, though, but there's no pdf.outline primitive:
>>
>> pdf.outline(to_utf16("H?h?"))
> You can still use \nnn, because this notation is restricted
> to plain ASCII ('\', '0', ... '9'). Of course the \nnn are
> used for bytes only.

Meaning \nnn can denote bytes? [... TeXing ... TeXing ...] Oh yes! I 
thought \nnn only denoted characters. So the solution is really simple 
and works! Thanks Heiko.

Best,
Paul

