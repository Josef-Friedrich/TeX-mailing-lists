From zappathustra at free.fr  Tue Apr  2 11:49:12 2013
From: zappathustra at free.fr (Paul Isambert)
Date: Tue, 2 Apr 2013 11:49:12 +0200
Subject: [luatex] Loading fonts in a format.
Message-ID: <1364896152.515aa99854646@imp.free.fr>

Hello all,

Following the previous discussion on fonts and formats, I've come to
the following. Suppose I create this dummy format:

    %%% run "luatex --ini format.tex" %%%
    \catcode`\{=1
    \catcode`\}=2

    \directlua{
    callback.register("define_font",
      function (_, _, id)
        local f = font.read_tfm("cmr10", -1000)
        font.setfont(id, f)
        return f
      end)
    }

    \font\test=cmr10

    \dump
    %%%%%%%%%%%%%%%%%%

(Note that the line "font.setfont(id, f)" doesn't change anything when
removed.)

The font is properly loaded, however in:

    %%% run "luatex --fmt=format test.tex" %%%
    \test hello

    \directlua{local x = font.getfont(1)}
    \end
    %%%%%%%%%%%%%%%%

the "\directlua" line produces the error (verbatim):

    ! LuaTeX error attempt to index a nil value

This looks like a bug to me, because at the very least
"font.getfont(n)" returns "nil" if no font has id "n" (and the error
doesn't look properly formatted to me); and anyway since the font
works ("hello" is printed), then the font should exist.

(Replacing "font.setfont/getfont" with "font.fonts[n]" doesn't change
anything.)

However, I'm not quite sure how LuaTeX code is supposed to be
remembered from an IniTeX run to a normal run, so maybe I've
encountered a normal behavior, albeit somewhat puzzling. So...?

Best,
Paul


From gnurser at gmail.com  Thu Apr  4 13:20:38 2013
From: gnurser at gmail.com (George Nurser)
Date: Thu, 4 Apr 2013 12:20:38 +0100
Subject: [luatex] Downloaded compiled version of luatex 0.75 for MacOSX,
 am getting error related to luatex-loader.sty and
 oberdiek.luatex.lua
In-Reply-To: <514F524C.1070705@FU-Berlin.DE>
References: <mailman.9.1364122801.32321.luatex@tug.org>
 <2D6C4181-6DB0-48E6-BD6E-31879B44BFBD@mac.com>
 <514F524C.1070705@FU-Berlin.DE>
Message-ID: <CAAyCRnQkuMRbVGDqhdfWhuPbs7Q5bjQ3ZLVVkjwFyK4GPNSzaw@mail.gmail.com>

Hi,
I just wondered what are the chances of LuaLaTeX getting updated to use
LuaTex 0.75 in TeXlive 2013?

I'm very pleased with LuaLaTeX, and am hoping that it is the way forward.

 Best regards, George Nurser.



On 24 March 2013 19:21, Herbert Voss <Herbert.Voss at fu-berlin.de> wrote:

> On 24.03.2013 19:25, Mico Loretan wrote:
>
>> Herbert Voss wrote:
>>
>>> Reinhard Kotucha wrote:
>>> Herbert Voss wrote:
>>>
>>>  you cannot run the latest version with the current LuaLaTeX packages.
>>>> Only luatex can be used, but not lualatex.
>>>>
>>>
>>> Herbert, do you have an overview which packages are concerned?
>>>
>>> not really. I suppose nearly all packages in $TEXMF/tex/lualatex/
>>> At least all which use the deprecated names like module, etc
>>>
>>
>> I suppose files such as luatex.sty, luatex-loader.sty and
>> oberdiek.luatex.lua -- all in $TEXMF/tex/generic/oberdiek, and all derived
>> from Heiko's luatex.dtx -- should be added to list of files that'll need to
>> be updated as well, right?
>>
>
> all files which are defined by module, which use the
> function package.loaders and which use table.nmax
>
> Herbert
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130404/236ddeb7/attachment.html>

From taco at docwolves.nl  Fri Apr  5 13:09:06 2013
From: taco at docwolves.nl (Taco Hoekwater)
Date: Fri, 5 Apr 2013 13:09:06 +0200
Subject: [luatex] Luatex 0.76.0 announcement
Message-ID: <515EB0D2.1070105@docwolves.nl>

Hi,

I have just uploaded the archives for a new luatex release, 0.76.0,
which has a few fixes for beta 0.75.0, and synchronizes the code
with the development version of TeXLive 2013.

Changes:

* Metapost 1.801.

* Small patches from TeXLive 2013, as well as an update to the
   latest libraries (libpng, poppler, etc.)

* Speed up printing (of TeX strings) to the terminal and log.

* New lua function node.end_of_math().

* Fixed a memory leak in the lua function pdfscanner.scan().



The archives can be downloaded from supelec as usual:

         https://foundry.supelec.fr/projects/luatex/

You could also check out the sources via anonymous svn:

   svn co --username anonsvn --password anonsvn              \
       https://foundry.supelec.fr/svn/luatex/tags/beta-0.76.0

Bugs and feature requests can be added to the issue tracker at

        http://tracker.luatex.org

Have fun,
Taco

From preining at logic.at  Fri Apr  5 14:15:52 2013
From: preining at logic.at (Norbert Preining)
Date: Fri, 5 Apr 2013 21:15:52 +0900
Subject: [luatex] Luatex 0.76.0 announcement
In-Reply-To: <515EB0D2.1070105@docwolves.nl>
References: <515EB0D2.1070105@docwolves.nl>
Message-ID: <20130405121552.GB4558@gamma.logic.tuwien.ac.at>

On Fr, 05 Apr 2013, Taco Hoekwater wrote:
> I have just uploaded the archives for a new luatex release, 0.76.0,
> which has a few fixes for beta 0.75.0, and synchronizes the code
> with the development version of TeXLive 2013.

Is there a -doc tarball coming?

Norbert

------------------------------------------------------------------------
PREINING, Norbert                               http://www.preining.info
JAIST, Japan                                 TeX Live & Debian Developer
DSA: 0x09C5B094   fp: 14DF 2E6C 0307 BE6D AD76  A9C0 D2BF 4AA3 09C5 B094
------------------------------------------------------------------------

From elie.roux at telecom-bretagne.eu  Sat Apr  6 10:17:39 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sat, 6 Apr 2013 10:17:39 +0200
Subject: [luatex] Downloaded compiled version of luatex 0.75 for MacOSX,
 am getting error related to luatex-loader.sty and
 oberdiek.luatex.lua
In-Reply-To: <CAAyCRnQkuMRbVGDqhdfWhuPbs7Q5bjQ3ZLVVkjwFyK4GPNSzaw@mail.gmail.com>
References: <mailman.9.1364122801.32321.luatex@tug.org>
 <2D6C4181-6DB0-48E6-BD6E-31879B44BFBD@mac.com>
 <514F524C.1070705@FU-Berlin.DE>
 <CAAyCRnQkuMRbVGDqhdfWhuPbs7Q5bjQ3ZLVVkjwFyK4GPNSzaw@mail.gmail.com>
Message-ID: <515FDA23.2010605@telecom-bretagne.eu>

On 04/04/2013 13:20, George Nurser wrote:
> I just wondered what are the chances of LuaLaTeX getting updated to 
> use LuaTex 0.75 in TeXlive 2013?

Dear George,

I will be working on an update of the LuaLaTeX packages (mainly 
luaotfload, lualibs and luatebase) for TeXLive 2013, do not hesitate 
(you or anyone on the list) to follow the development on my git 
repositories and to cotribute by patches, advices or bug reports (on 
lualatex-dev at tug.org).

Thank you,

-- 
Elie


From luigi.scarso at gmail.com  Sat Apr  6 17:29:00 2013
From: luigi.scarso at gmail.com (luigi scarso)
Date: Sat, 6 Apr 2013 17:29:00 +0200
Subject: [luatex] Luajittex 0.76.0 announcement
Message-ID: <CAG5iGsB0qwkVmVw6N1dzq8eBAMC-UhUmtcKrmkgUMjjz-1ucWA@mail.gmail.com>

New beta release of luajittex.
Site:
https://foundry.supelec.fr/projects/luajittex/

svn repo.:
svn checkout --username anonsvn
https://foundry.supelec.fr/svn/luajittex/tags/beta-0.76.0


--
luigi

From elie.roux at telecom-bretagne.eu  Sat Apr 13 10:03:43 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sat, 13 Apr 2013 10:03:43 +0200
Subject: [luatex] lua module search behaviour
Message-ID: <5169115F.7010907@telecom-bretagne.eu>

Dear all,

I'm currently updating luatexbase, and I have a few questions:

The first two are related to the behaviour when searching for 
"module.submodule" as "module/submodule.lua":

  - Am I right if I say that package.searchers[2] looks weel for it but
    kpse.find_file("module.submodule", 'lua') doesn't?
  - If it's true, is there a way to make it work with kpse.find_file?

The goal of not just letting packages.searchers[2] do his job quietly 
(which it does well), is just to print the name of the loaded file, 
between brackets... So the third question is:
   - is it possible to make the kpse version of packages.searchers[2]
     return a string containing the file name?
   - as a bonus question, the same would be good for
     packages.searchers[3]!

Thank you,
-- 
Elie

From taco at elvenkind.com  Sat Apr 13 12:13:04 2013
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sat, 13 Apr 2013 12:13:04 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <5169115F.7010907@telecom-bretagne.eu>
References: <5169115F.7010907@telecom-bretagne.eu>
Message-ID: <51692FB0.2040407@elvenkind.com>

On 04/13/2013 10:03 AM, ?lie Roux wrote:
> Dear all,
>
> I'm currently updating luatexbase, and I have a few questions:
>
> The first two are related to the behaviour when searching for
> "module.submodule" as "module/submodule.lua":
>
>   - Am I right if I say that package.searchers[2] looks weel for it but
>     kpse.find_file("module.submodule", 'lua') doesn't?

Yes. But package.searchers[2] is quite trivial. In lua code, it would
look like this:

function search (name)
    altname = string.gsub(file,'.','/')
    filename = kpse.find_file(altname, 'lua')	
    if not filename then
      filename = kpse.find_file(name, 'lua')
    end
    if not filename then
      return string.format("[kpse lua searcher] file not found: %s", name)
    else
      return loadfile(filename)
    end
end


>   - If it's true, is there a way to make it work with kpse.find_file?

Just write a thin wrapper to replace '.' with '/', as above.

> The goal of not just letting packages.searchers[2] do his job quietly
> (which it does well), is just to print the name of the loaded file,
> between brackets... So the third question is:
>    - is it possible to make the kpse version of packages.searchers[2]
>      return a string containing the file name?

That is not possible. It has to return either an error string, or a
loader function (the result of loadfile()).

Best wishes,
Taco


From elie.roux at telecom-bretagne.eu  Sat Apr 13 12:56:45 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sat, 13 Apr 2013 12:56:45 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <51692FB0.2040407@elvenkind.com>
References: <5169115F.7010907@telecom-bretagne.eu>
 <51692FB0.2040407@elvenkind.com>
Message-ID: <516939ED.4010709@telecom-bretagne.eu>

>
> Yes. But package.searchers[2] is quite trivial. In lua code, it would
> look like this:
>
> function search (name)
> altname = string.gsub(file,'.','/')
> filename = kpse.find_file(altname, 'lua')
> if not filename then
> filename = kpse.find_file(name, 'lua')
> end
> if not filename then
> return string.format("[kpse lua searcher] file not found: %s", name)
> else
> return loadfile(filename)
> end
> end

Ok, I see. Just out of curiosity, what would the package.searchers[3] 
look like? Well, a pointer to the source file would be enough (I have to 
say I'm a bit lost in LuaTeX sources)...

> Just write a thin wrapper to replace '.' with '/', as above.

Ok.

> That is not possible. It has to return either an error string, or a
> loader function (the result of loadfile()).

Ok.

Thank you!
-- 
Elie

From taco at elvenkind.com  Sat Apr 13 14:38:59 2013
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sat, 13 Apr 2013 14:38:59 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <516939ED.4010709@telecom-bretagne.eu>
References: <5169115F.7010907@telecom-bretagne.eu>
 <51692FB0.2040407@elvenkind.com> <516939ED.4010709@telecom-bretagne.eu>
Message-ID: <516951E3.5060401@elvenkind.com>

On 04/13/2013 12:56 PM, ?lie Roux wrote:
>>
>> Yes. But package.searchers[2] is quite trivial. In lua code, it would
>> look like this:
>>
>> function search (name)
>> altname = string.gsub(file,'.','/')
>> filename = kpse.find_file(altname, 'lua')
>> if not filename then
>> filename = kpse.find_file(name, 'lua')
>> end
>> if not filename then
>> return string.format("[kpse lua searcher] file not found: %s", name)
>> else
>> return loadfile(filename)
>> end
>> end
>
> Ok, I see. Just out of curiosity, what would the package.searchers[3]
> look like? Well, a pointer to the source file would be enough (I have to
> say I'm a bit lost in LuaTeX sources)...

lua/luainit.w

Best wishes,
Taco


From elie.roux at telecom-bretagne.eu  Sat Apr 13 15:47:19 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sat, 13 Apr 2013 15:47:19 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <516951E3.5060401@elvenkind.com>
References: <5169115F.7010907@telecom-bretagne.eu>
 <51692FB0.2040407@elvenkind.com> <516939ED.4010709@telecom-bretagne.eu>
 <516951E3.5060401@elvenkind.com>
Message-ID: <516961E7.3050005@telecom-bretagne.eu>

>
> lua/luainit.w

Thank you very much!

Also, I just came across what seems to be a bug with ofm fonts with the 
attached file:

$ kpsewhich -progname luatex -format ofm omarab.ofm
/usr/share/texmf-texlive/fonts/ofm/public/omega/omarab.ofm

$ aleph simpletfmofm.tex
This is Aleph, Version 3.1415926-1.15-2.1-0.0-rc4 (TeX Live 2009/Debian)
entering extended mode
(simpletfmofm.tex [1] )
Output written on simpletfmofm.dvi (1 page, 352 bytes).
Transcript written on simpletfmofm.log.

$ dvipdf simpletfmofm.dvi

$ luatex simpletfmofm.tex
This is LuaTeX, Version beta-0.77.0-2013040709 (rev 4629)
(./simpletfmofm.tex 
[1{/home/eroux/.texmf-var/fonts/map/pdftex/updmap/pdftex.map
}]
kpathsea: Running mktexpk --mfmode / --bdpi 600 --mag 1+0/600 --dpi 600 
omarab.ofm
mktexpk: don't know how to create bitmap font for omarab.ofm.
kpathsea: Appending font creation commands to missfont.log.
  )
!LuaTeX error (file omarab.ofm): Font omarab.ofm at 600 not found
  ==> Fatal error occurred, no output PDF file produced!

$ dviluatex simpletfmofm.tex
This is LuaTeX, Version beta-0.77.0-2013040709 (rev 4629)
(./simpletfmofm.tex [1] )
Output written on simpletfmofm.dvi (1 page, 368 bytes).
Transcript written on simpletfmofm.log.

$ dvipdf simpletfmofm.dvi
dvips: Font omarab.ofm not found,  using cmr10 instead.
dvips: Checksum mismatch in font omarab.ofm

Is it really a bug?

As I know only a few people are using these fonts, I would understand if 
you had not time for this, but it would really be extremely useful to me 
for some projects and I would be ready to try to provide a patch (if you 
give me a few pointers)...

Thank you,
-- 
Elie
-------------- next part --------------
A non-text attachment was scrubbed...
Name: simpletfmofm.tex
Type: text/x-tex
Size: 75 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130413/12d01ca4/attachment.bin>

From taco at elvenkind.com  Sun Apr 14 10:10:25 2013
From: taco at elvenkind.com (Taco Hoekwater)
Date: Sun, 14 Apr 2013 10:10:25 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <516961E7.3050005@telecom-bretagne.eu>
References: <5169115F.7010907@telecom-bretagne.eu>
 <51692FB0.2040407@elvenkind.com> <516939ED.4010709@telecom-bretagne.eu>
 <516951E3.5060401@elvenkind.com> <516961E7.3050005@telecom-bretagne.eu>
Message-ID: <516A6471.7070006@elvenkind.com>

On 04/13/2013 03:47 PM, ?lie Roux wrote:
>
> $ luatex simpletfmofm.tex

> !LuaTeX error (file omarab.ofm): Font omarab.ofm at 600 not found
>   ==> Fatal error occurred, no output PDF file produced!

Looks like a search path issue. It works for me, though I still use what
is essentially texlive 2011 for my texmf tree. It may help to do the
luatex runs with an extra --kpathsea-debug= argument.

Best wishes,
Taco

From elie.roux at telecom-bretagne.eu  Sun Apr 14 12:07:38 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sun, 14 Apr 2013 12:07:38 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <516A6471.7070006@elvenkind.com>
References: <5169115F.7010907@telecom-bretagne.eu>
 <51692FB0.2040407@elvenkind.com> <516939ED.4010709@telecom-bretagne.eu>
 <516951E3.5060401@elvenkind.com> <516961E7.3050005@telecom-bretagne.eu>
 <516A6471.7070006@elvenkind.com>
Message-ID: <516A7FEA.8040602@telecom-bretagne.eu>

On 14/04/2013 10:10, Taco Hoekwater wrote:
> On 04/13/2013 03:47 PM, ?lie Roux wrote:
>>
>> $ luatex simpletfmofm.tex
>
>> !LuaTeX error (file omarab.ofm): Font omarab.ofm at 600 not found
>> ==> Fatal error occurred, no output PDF file produced!
>
> Looks like a search path issue. It works for me, though I still use what
> is essentially texlive 2011 for my texmf tree. It may help to do the
> luatex runs with an extra --kpathsea-debug= argument.

In fact, it's a bit strange: omarab works but omarab.ofm doesn't, as 
luatex doesn't find the ovp file for omarab.ofm (looking for 
omarab.ofm.ovp certainly) while alpeh does... well... this is not really 
annoying, let's just ignore it for the moment, I'll test further and 
come back to you if I really spot something looking like a bug.

Thank you,
-- 
Elie

From pragma at wxs.nl  Sun Apr 14 12:38:25 2013
From: pragma at wxs.nl (Hans Hagen)
Date: Sun, 14 Apr 2013 12:38:25 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <516A7FEA.8040602@telecom-bretagne.eu>
References: <5169115F.7010907@telecom-bretagne.eu>
 <51692FB0.2040407@elvenkind.com> <516939ED.4010709@telecom-bretagne.eu>
 <516951E3.5060401@elvenkind.com> <516961E7.3050005@telecom-bretagne.eu>
 <516A6471.7070006@elvenkind.com> <516A7FEA.8040602@telecom-bretagne.eu>
Message-ID: <516A8721.2070309@wxs.nl>

On 4/14/2013 12:07 PM, ?lie Roux wrote:
> On 14/04/2013 10:10, Taco Hoekwater wrote:
>> On 04/13/2013 03:47 PM, ?lie Roux wrote:
>>>
>>> $ luatex simpletfmofm.tex
>>
>>> !LuaTeX error (file omarab.ofm): Font omarab.ofm at 600 not found
>>> ==> Fatal error occurred, no output PDF file produced!
>>
>> Looks like a search path issue. It works for me, though I still use what
>> is essentially texlive 2011 for my texmf tree. It may help to do the
>> luatex runs with an extra --kpathsea-debug= argument.
>
> In fact, it's a bit strange: omarab works but omarab.ofm doesn't, as
> luatex doesn't find the ovp file for omarab.ofm (looking for
> omarab.ofm.ovp certainly) while alpeh does... well... this is not really
> annoying, let's just ignore it for the moment, I'll test further and
> come back to you if I really spot something looking like a bug.

have you configured the variable

OVFFONTS

tfm/ofm nv/ovf both use the o variables

Hans


-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
     tel: 038 477 53 69 | voip: 087 875 68 74 | www.pragma-ade.com
                                              | www.pragma-pod.nl
-----------------------------------------------------------------

From elie.roux at telecom-bretagne.eu  Sun Apr 14 14:25:39 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sun, 14 Apr 2013 14:25:39 +0200
Subject: [luatex] lua module search behaviour
In-Reply-To: <516A8721.2070309@wxs.nl>
References: <5169115F.7010907@telecom-bretagne.eu>
 <51692FB0.2040407@elvenkind.com> <516939ED.4010709@telecom-bretagne.eu>
 <516951E3.5060401@elvenkind.com> <516961E7.3050005@telecom-bretagne.eu>
 <516A6471.7070006@elvenkind.com> <516A7FEA.8040602@telecom-bretagne.eu>
 <516A8721.2070309@wxs.nl>
Message-ID: <516AA043.40804@telecom-bretagne.eu>

>
> have you configured the variable
>
> OVFFONTS
>
> tfm/ofm nv/ovf both use the o variables

Yes I have, with the same value as texmf.cnf from TeXLive 2012... I'll 
keep looking for where it comes from and keep you informed if there is 
something wrong.

Thank you,
-- 
Elie

From elie.roux at telecom-bretagne.eu  Tue Apr 16 11:02:01 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Tue, 16 Apr 2013 11:02:01 +0200
Subject: [luatex] Downloaded compiled version of luatex 0.75 for MacOSX,
 am getting error related to luatex-loader.sty and
 oberdiek.luatex.lua
In-Reply-To: <514F524C.1070705@FU-Berlin.DE>
References: <mailman.9.1364122801.32321.luatex@tug.org>
 <2D6C4181-6DB0-48E6-BD6E-31879B44BFBD@mac.com>
 <514F524C.1070705@FU-Berlin.DE>
Message-ID: <516D1389.6060003@telecom-bretagne.eu>

>
> all files which are defined by module, which use the
> function package.loaders and which use table.nmax

Dear all,

I just spotted something else on this topic: unpack is replaced by 
table.unpack. pdftexcmds.lua makes use of it, this is part of the files 
to be fixed for TeXLive 2013.

A new fixed version of luatexbase and luaotfload will be uploaded on 
CTAN soon, most certainly today.

Thank you,
-- 
Elie

From mico.loretan at mac.com  Sat Apr 20 16:38:50 2013
From: mico.loretan at mac.com (Mico Loretan)
Date: Sat, 20 Apr 2013 10:38:50 -0400
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
Message-ID: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>

Many thanks to everyone involved in coming up with and posting the recent updates and improvements to luaotfload.sty and luatexbase.sty. (About my system: I'm running a fully updated version of MacTeX2013, OS: MacOS X 10.7.5.) Probably unsurprisingly to some, there's still more work to do in order to get TeXLive ready for the masses. For instance, a LaTeX user who wants to use the fontspec package won't get very far as of now. To wit, the following MWE 

    % !TEX TS-program = lualatex
    \documentclass{article}
    \usepackage{fontspec}
    \begin{document}
    Hello World.
    \end{document}

generates this "output":

    This is LuaTeX, Version beta-0.76.0-2013041516 (rev 4627) 
    restricted \write18 enabled.
    (./ld-test.tex
    LaTeX2e <2011/06/27>
    LuaTeX adaptation of babel <v3.8m-luatex-1.5> and hyphenation patterns for engli
    sh, dumylang, nohyphenation, loaded.
    (/usr/local/texlive/2013/texmf-dist/tex/latex/base/article.cls
    Document Class: article 2007/10/19 v1.4h Standard LaTeX document class
    (/usr/local/texlive/2013/texmf-dist/tex/latex/base/size10.clo))
    (/usr/local/texlive/2013/texmf-dist/tex/latex/fontspec/fontspec.sty
    (/usr/local/texlive/2013/texmf-dist/tex/latex/l3kernel/expl3.sty
    (/usr/local/texlive/2013/texmf-dist/tex/latex/l3kernel/l3names.sty
    (/usr/local/texlive/2013/texmf-dist/tex/latex/l3kernel/l3bootstrap.sty
    (/usr/local/texlive/2013/texmf-dist/tex/generic/oberdiek/luatex.sty
    (/usr/local/texlive/2013/texmf-dist/tex/generic/oberdiek/infwarerr.sty)
    (/usr/local/texlive/2013/texmf-dist/tex/generic/oberdiek/ifluatex.sty)
    (/usr/local/texlive/2013/texmf-dist/tex/latex/etex-pkg/etex.sty)
    (/usr/local/texlive/2013/texmf-dist/tex/generic/oberdiek/luatex-loader.sty
    (/usr/local/texlive/2013/texmf-dist/scripts/oberdiek/oberdiek.luatex.lua)
    ! LuaTeX error ...ive/2013/texmf-dist/scripts/oberdiek/oberdiek.luatex.lua:55: b
    ad argument #1 to 'insert' (table expected, got nil)
    stack traceback:
    	[C]: in function 'insert'
    	...ive/2013/texmf-dist/scripts/oberdiek/oberdiek.luatex.lua:55: in main chunk
    	[C]: in function 'dofile'
    	[string "\directlua "]:6: in main chunk.
    l.139   }
           %
    ? 

Put differently, LaTeX doesn't even make it to the \begin{document} instruction. :-(

From elie.roux at telecom-bretagne.eu  Sat Apr 20 17:01:41 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sat, 20 Apr 2013 17:01:41 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
Message-ID: <5172ADD5.5060904@telecom-bretagne.eu>

On 20/04/2013 16:38, Mico Loretan wrote:
> Many thanks to everyone involved in coming up with and posting the
> recent updates and improvements to luaotfload.sty and luatexbase.sty.
> (About my system: I'm running a fully updated version of MacTeX2013,
> OS: MacOS X 10.7.5.) Probably unsurprisingly to some, there's still
> more work to do in order to get TeXLive ready for the masses. For
> instance, a LaTeX user who wants to use the fontspec package won't
> get very far as of now. To wit, the following MWE
>
> (/usr/local/texlive/2013/texmf-dist/scripts/oberdiek/oberdiek.luatex.lua)
>
>
 >! LuaTeX error ...ive/2013/texmf-dist/scripts/oberdiek
 > /oberdiek.luatex.lua:55: b
> ad argument #1 to 'insert' (table expected, got nil)
>
> [...]
>
> Put differently, LaTeX doesn't even make it to the \begin{document}
> instruction. :-(

Dear Mirco,

You can use the two attached files in order to test. oberdiek.luatex.lua 
is an official version, pdftexcmds is adapted by me. These two files 
should indeed be updated for TeXLive 2013, I hope they will be...

Thank you,
-- 
Elie
-------------- next part --------------
A non-text attachment was scrubbed...
Name: oberdiek.luatex.lua
Type: text/x-lua
Size: 1953 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130420/0e669931/attachment.bin>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: pdftexcmds.lua
Type: text/x-lua
Size: 9102 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130420/0e669931/attachment-0001.bin>

From mico.loretan at mac.com  Sat Apr 20 17:58:06 2013
From: mico.loretan at mac.com (Mico Loretan)
Date: Sat, 20 Apr 2013 11:58:06 -0400
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <5172ADD5.5060904@telecom-bretagne.eu>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
Message-ID: <094290A2-79F4-4474-B216-F224B964BD32@mac.com>

Elie,

Many thanks for sending me these two files. The new versions are definitely working (much!!) better. 

Unfortunately, not all is well yet in LuaLaTeX land. The following, slightly augmented form of the previous MWE

    % !TEX TS-program = lualatex
    \documentclass{article}
    \usepackage{fontspec}
    \usepackage[ngerman]{babel}
    \begin{document}
    Hallo Welt!
    \end{document}

now pauses after the following "output":

    ...
    (/usr/local/texlive/2013/texmf-dist/tex/generic/babel/babel.sty 
    (/usr/local/texlive/2013/texmf-dist/tex/generic/babel/ngermanb.ldf
    (/usr/local/texlive/2013/texmf-dist/tex/generic/babel/babel.def)
    ! LuaTeX error [string "\directlua "]:1: invalid escape sequence near '\l'.
    \adddialect ...alect("\string #1", "\string #2") }
                                                      \fi \fi \wlog {\string #1 ...
    l.61 \adddialect\l at naustrian\l at ngerman
                                    
    ?

If I hit "r" at this point to enter nonstop mode, LuaLaTeX will actually finish the compilation without further error messages. However, it would be better not to encounter this error in the first place, right? 

Incidentally, the error reported above doesn't seem to be specific to the "ngerman" language option; it also occurs if the "english", "canadian", etc. language options are provided. 

Many thanks to everyone who wants to look into and solve this additional issue. Hopefully, not many more such issues will crop up. (Famous last words!)

Sincerely, Mico

On 20 Apr, 2013, at 11:01 AM, ?lie Roux wrote:

> <pdftexcmds.lua>



From elie.roux at telecom-bretagne.eu  Sat Apr 20 18:09:04 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sat, 20 Apr 2013 18:09:04 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
Message-ID: <5172BDA0.8040303@telecom-bretagne.eu>

> (/usr/local/texlive/2013/texmf-dist/tex/generic/babel/babel.def) !
> LuaTeX error [string "\directlua "]:1: invalid escape sequence near
> '\l'. \adddialect ...alect("\string #1", "\string #2") } \fi \fi
> \wlog {\string #1 ... l.61 \adddialect\l at naustrian\l at ngerman
>
> ?

Interesting... Is there a simple way to test TeXLive 2013? I'll update 
babel to the latest version, I guess it will be enough for the error to 
be raised...

> If I hit "r" at this point to enter nonstop mode, LuaLaTeX will
> actually finish the compilation without further error messages.
> However, it would be better not to encounter this error in the first
> place, right?

Absolutely.

Thank you,
-- 
Elie

From Herbert.Voss at FU-Berlin.DE  Sat Apr 20 18:23:26 2013
From: Herbert.Voss at FU-Berlin.DE (Herbert Voss)
Date: Sat, 20 Apr 2013 18:23:26 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <5172BDA0.8040303@telecom-bretagne.eu>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
 <5172BDA0.8040303@telecom-bretagne.eu>
Message-ID: <5172C0FE.8030603@FU-Berlin.DE>

On 20.04.2013 18:09, ?lie Roux wrote:
>> (/usr/local/texlive/2013/texmf-dist/tex/generic/babel/babel.def) !
>> LuaTeX error [string "\directlua "]:1: invalid escape sequence near
>> '\l'. \adddialect ...alect("\string #1", "\string #2") } \fi \fi
>> \wlog {\string #1 ... l.61 \adddialect\l at naustrian\l at ngerman
>>
>> ?
>
> Interesting... Is there a simple way to test TeXLive 2013? I'll update
> babel to the latest version, I guess it will be enough for the error to
> be raised...
>
>> If I hit "r" at this point to enter nonstop mode, LuaLaTeX will
>> actually finish the compilation without further error messages.
>> However, it would be better not to encounter this error in the first
>> place, right?

it is the same with TL2012 when using the latest luatex
from TLContrib and your updated files.

HerbertX



From elie.roux at telecom-bretagne.eu  Sat Apr 20 19:09:33 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Sat, 20 Apr 2013 19:09:33 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
Message-ID: <5172CBCD.8080602@telecom-bretagne.eu>

Dear Mico, all,

Can you please test with the attached luababel.def? Herbert, can you 
test with it under TeXLive 2012?

If it works I'll propose it to the Babel team.

Thank you,
-- 
Elie
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: luababel.def
URL: <http://tug.org/pipermail/luatex/attachments/20130420/a7e6f698/attachment.ksh>

From Herbert.Voss at FU-Berlin.DE  Sat Apr 20 19:57:00 2013
From: Herbert.Voss at FU-Berlin.DE (Herbert Voss)
Date: Sat, 20 Apr 2013 19:57:00 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <5172CBCD.8080602@telecom-bretagne.eu>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
 <5172CBCD.8080602@telecom-bretagne.eu>
Message-ID: <5172D6EC.80207@FU-Berlin.DE>

On 20.04.2013 19:09, ?lie Roux wrote:
> Dear Mico, all,
>
> Can you please test with the attached luababel.def? Herbert, can you
> test with it under TeXLive 2012?

yes, it works for me.

Herbert


 > If it works I'll propose it to the Babel team.


From mico.loretan at mac.com  Sun Apr 21 22:33:46 2013
From: mico.loretan at mac.com (Mico Loretan)
Date: Sun, 21 Apr 2013 16:33:46 -0400
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <5172CBCD.8080602@telecom-bretagne.eu>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
 <5172CBCD.8080602@telecom-bretagne.eu>
Message-ID: <86581C2D-72D9-48A5-BC57-BCCF4A7FDD8D@mac.com>

Elie: 

I was able to get it to work after I overwrote all babel-related files that are currently part of the TeXLive2013 pretest distribution (version 3.8 x) with the files that currently reside on the CTAN (version 3.9e).

Let's keep our fingers crossed that this major update to the "babel" package propagates to TeXLive2013-pretest soon. :-)

Best,

Mico

On 20 Apr, 2013, at 1:09 PM, ?lie Roux wrote:

> Dear Mico, all,
> 
> Can you please test with the attached luababel.def? Herbert, can you test with it under TeXLive 2012?
> 
> If it works I'll propose it to the Babel team.
> 
> Thank you,
> -- 
> Elie
> <luababel.def>



From elie.roux at telecom-bretagne.eu  Mon Apr 22 09:23:44 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Mon, 22 Apr 2013 09:23:44 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <86581C2D-72D9-48A5-BC57-BCCF4A7FDD8D@mac.com>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
 <5172CBCD.8080602@telecom-bretagne.eu>
 <86581C2D-72D9-48A5-BC57-BCCF4A7FDD8D@mac.com>
Message-ID: <5174E580.1010604@telecom-bretagne.eu>

Dear All,

> I was able to get it to work after I overwrote all babel-related
> files that are currently part of the TeXLive2013 pretest distribution
> (version 3.8 x) with the files that currently reside on the CTAN
> (version 3.9e).
>
> Let's keep our fingers crossed that this major update to the "babel"
> package propagates to TeXLive2013-pretest soon. :-)

Good news. Did you have to overwrite luababel.def with the file I sent
you or was it Ok without it?

Thank you,
-- 
Elie

From Herbert.Voss at FU-Berlin.DE  Mon Apr 22 09:29:02 2013
From: Herbert.Voss at FU-Berlin.DE (Herbert Voss)
Date: Mon, 22 Apr 2013 09:29:02 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <5174E580.1010604@telecom-bretagne.eu>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
 <5172CBCD.8080602@telecom-bretagne.eu>
 <86581C2D-72D9-48A5-BC57-BCCF4A7FDD8D@mac.com>
 <5174E580.1010604@telecom-bretagne.eu>
Message-ID: <5174E6BE.8080809@FU-Berlin.DE>

On 22.04.2013 09:23, ?lie Roux wrote:

>> I was able to get it to work after I overwrote all babel-related
>> files that are currently part of the TeXLive2013 pretest distribution
>> (version 3.8 x) with the files that currently reside on the CTAN
>> (version 3.9e).
>>
>> Let's keep our fingers crossed that this major update to the "babel"
>> package propagates to TeXLive2013-pretest soon. :-)
>
> Good news. Did you have to overwrite luababel.def with the file I sent
> you or was it Ok without it?

I had to replace it with your version.

Herbert


From elie.roux at telecom-bretagne.eu  Mon Apr 22 09:38:29 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Mon, 22 Apr 2013 09:38:29 +0200
Subject: [luatex] can't run fontspec yet under TeXLive2013 (pre-release)
In-Reply-To: <5174E6BE.8080809@FU-Berlin.DE>
References: <68C3D50F-10EC-4C11-BB2E-D2EC72D35CF6@mac.com>
 <5172ADD5.5060904@telecom-bretagne.eu>
 <094290A2-79F4-4474-B216-F224B964BD32@mac.com>
 <5172CBCD.8080602@telecom-bretagne.eu>
 <86581C2D-72D9-48A5-BC57-BCCF4A7FDD8D@mac.com>
 <5174E580.1010604@telecom-bretagne.eu> <5174E6BE.8080809@FU-Berlin.DE>
Message-ID: <5174E8F5.9070005@telecom-bretagne.eu>

>
> I had to replace it with your version.

Ok. I sent it to Javier Bezos, no answer yet... I hope it will reach 
TeXLive 2013!

Thank you,
-- 
Elie

From elie.roux at telecom-bretagne.eu  Mon Apr 22 11:29:22 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Mon, 22 Apr 2013 11:29:22 +0200
Subject: [luatex] texlua vs. luatex
Message-ID: <517502F2.7090201@telecom-bretagne.eu>

Dear all,

I'm in front of a strange problem: I have a .lua script that can be 
called from both luatex and texlua, and I would like to have a different 
behaviour according to the caller. The problem is that I cannot find a 
reliable way to know if the script is called with texlua or luatex...

I cannot inspect arg[0] because some scripts are just symbolic links to 
texlua or luatex and it's impossible to have information from it.

I cannot try texconfig.formatname nor texconfig.jobname as these are 
never filled in the formats in TeXLive (this is something I would like 
to address soon).

I tried to look into ConTeXt sources, but I did not manage to find a 
clue (especially since I don't know the sources well)...

What would be the best solution?

Thank you,
-- 
Elie

From taco at elvenkind.com  Mon Apr 22 13:27:27 2013
From: taco at elvenkind.com (Taco Hoekwater)
Date: Mon, 22 Apr 2013 13:27:27 +0200
Subject: [luatex] texlua vs. luatex
In-Reply-To: <517502F2.7090201@telecom-bretagne.eu>
References: <517502F2.7090201@telecom-bretagne.eu>
Message-ID: <D0BCA87A-A905-4A38-BDF4-032F26EFD587@elvenkind.com>


On Apr 22, 2013, at 11:29 AM, ?lie Roux <elie.roux at telecom-bretagne.eu> wrote:

> Dear all,
> 
> I'm in front of a strange problem: I have a .lua script that can be called from both luatex and texlua, and I would like to have a different behaviour according to the caller. The problem is that I cannot find a reliable way to know if the script is called with texlua or luatex?
> ...
> What would be the best solution?

There is no 'perfect' solution right now. The best bet is to check for the existence of the 'tex', 'token', 'node', or 'pdf' tables, neither of which exist if texlua or --luaonly is given. Not so nice, but the best one can do right now, I think.

Best wishes,
Taco



From dirk.laurie at gmail.com  Mon Apr 22 15:11:49 2013
From: dirk.laurie at gmail.com (Dirk Laurie)
Date: Mon, 22 Apr 2013 15:11:49 +0200
Subject: [luatex] texlua vs. luatex
In-Reply-To: <517502F2.7090201@telecom-bretagne.eu>
References: <517502F2.7090201@telecom-bretagne.eu>
Message-ID: <CABcj=t=q1Pi4n25BfWjg+R8tLJwWy_L_n+A0vUNn6XtU8fgswg@mail.gmail.com>

2013/4/22 ?lie Roux <elie.roux at telecom-bretagne.eu>:

> I'm in front of a strange problem: I have a .lua script that can be called
> from both luatex and texlua, and I would like to have a different behaviour
> according to the caller. The problem is that I cannot find a reliable way to
> know if the script is called with texlua or luatex...
>
> I cannot inspect arg[0] because some scripts are just symbolic links to
> texlua or luatex and it's impossible to have information from it.

Why arg[0]? That's the script name. The name of the executable is arg[-1].

In many installations texlua and luatex is physically the same executable.
For instance, in Linux TeXLive 2012 texlua is simply a symlink to luatex,
So even in principle you only have the name it was called by to guide you.


From pragma at wxs.nl  Mon Apr 22 15:06:51 2013
From: pragma at wxs.nl (Hans Hagen)
Date: Mon, 22 Apr 2013 15:06:51 +0200
Subject: [luatex] texlua vs. luatex
In-Reply-To: <517502F2.7090201@telecom-bretagne.eu>
References: <517502F2.7090201@telecom-bretagne.eu>
Message-ID: <517535EB.6030002@wxs.nl>

On 4/22/2013 11:29 AM, ?lie Roux wrote:
> Dear all,
>
> I'm in front of a strange problem: I have a .lua script that can be
> called from both luatex and texlua, and I would like to have a different
> behaviour according to the caller. The problem is that I cannot find a
> reliable way to know if the script is called with texlua or luatex...
>
> I cannot inspect arg[0] because some scripts are just symbolic links to
> texlua or luatex and it's impossible to have information from it.
>
> I cannot try texconfig.formatname nor texconfig.jobname as these are
> never filled in the formats in TeXLive (this is something I would like
> to address soon).
>
> I tried to look into ConTeXt sources, but I did not manage to find a
> clue (especially since I don't know the sources well)...
>
> What would be the best solution?

arg[-2] or arg[-1] or arg[0]

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
     tel: 038 477 53 69 | voip: 087 875 68 74 | www.pragma-ade.com
                                              | www.pragma-pod.nl
-----------------------------------------------------------------

From timli2013 at outlook.com  Mon Apr 22 17:20:56 2013
From: timli2013 at outlook.com (Tim Li)
Date: Mon, 22 Apr 2013 15:20:56 +0000
Subject: [luatex] access defined Lua global variables in TeX macros
Message-ID: <BLU152-W19D52E898ED9FEFFB70384A9CB0@phx.gbl>

Hi, I am a newbie in LuaTeX but it's very interesting.  We can define a macro like this: \def\foo#1{%  \directlua{var = [[#1]]; tex.print(var)}  % can I access "var" below?  ...} can I access this global variable "var" in the other part of \foo?  Best regards,Tim 		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130422/a6201455/attachment.html>

From reinhard.kotucha at web.de  Mon Apr 22 20:51:53 2013
From: reinhard.kotucha at web.de (Reinhard Kotucha)
Date: Mon, 22 Apr 2013 20:51:53 +0200
Subject: [luatex] texlua vs. luatex
In-Reply-To: <517502F2.7090201@telecom-bretagne.eu>
References: <517502F2.7090201@telecom-bretagne.eu>
Message-ID: <20853.34505.755014.312533@zaphod.ms25.net>

On 2013-04-22 at 11:29:22 +0200, ?lie Roux wrote:

 > Dear all,
 > 
 > I'm in front of a strange problem: I have a .lua script that can be 
 > called from both luatex and texlua, and I would like to have a different 
 > behaviour according to the caller. The problem is that I cannot find a 
 > reliable way to know if the script is called with texlua or luatex...
 > 
 > I cannot inspect arg[0] because some scripts are just symbolic links to 
 > texlua or luatex and it's impossible to have information from it.
 > 
 > I cannot try texconfig.formatname nor texconfig.jobname as these are 
 > never filled in the formats in TeXLive (this is something I would like 
 > to address soon).
 > 
 > I tried to look into ConTeXt sources, but I did not manage to find a 
 > clue (especially since I don't know the sources well)...
 > 
 > What would be the best solution?

This is what I did in one of my modules:

  local function writemsg (...)
    if token == nil then
      io.write(string.format(...)..'\n')
    else
      texio.write_nl(string.format(...)..'\n')
    end
  end

The token table isn't accessible from texlua.

Regards,
  Reinhard

-- 
----------------------------------------------------------------------------
Reinhard Kotucha                                      Phone: +49-511-3373112
Marschnerstr. 25
D-30167 Hannover                              mailto:reinhard.kotucha at web.de
----------------------------------------------------------------------------
Microsoft isn't the answer. Microsoft is the question, and the answer is NO.
----------------------------------------------------------------------------


From patrick at gundla.ch  Tue Apr 23 14:21:22 2013
From: patrick at gundla.ch (Patrick Gundlach)
Date: Tue, 23 Apr 2013 14:21:22 +0200
Subject: [luatex] LuaTeX warning: Misplaced \pdfrestore by (983040sp, 0sp)
Message-ID: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>

Hi,

when running the following code, I have a problem that subsequent boxes are misplaced. A warning is issued:

LuaTeX warning: Misplaced \pdfrestore by (983040sp, 0sp)

What am I doing wrong?

Patrick



\documentclass{article}

\begin{document}

\directlua{
  local save,restore,set_matrix
  save = node.new("whatsit","pdf_save")
  restore = node.new("whatsit","pdf_restore")
  set_matrix = node.new("whatsit", "pdf_setmatrix")
  set_matrix.data = "5 0 0 5 "

  local rule = node.new("rule")
  rule.width =  15*2^16
  rule.height = 15*2^16
  local hbox = node.hpack(rule)
  hbox.head = node.insert_before(hbox.head,rule,save)
  node.insert_after(hbox.head,save,set_matrix)
  node.insert_after(hbox.head,rule,restore)
  node.write(hbox)
}

\end{document}




From patrick at gundla.ch  Tue Apr 23 14:54:38 2013
From: patrick at gundla.ch (Patrick Gundlach)
Date: Tue, 23 Apr 2013 14:54:38 +0200
Subject: [luatex] LuaTeX warning: Misplaced \pdfrestore by (983040sp,
	0sp)
In-Reply-To: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
References: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
Message-ID: <0098015F-63D4-47F9-A626-0F034680A11D@gundla.ch>



> when running the following code, I have a problem that subsequent boxes are misplaced. A warning is issued:
> 
> LuaTeX warning: Misplaced \pdfrestore by (983040sp, 0sp)
> 
> What am I doing wrong?


I'll better ask this question on the pdftex mailing list, I get the same error with normal \pdf... commands.

Patrick



From evan.cooch at gmail.com  Wed Apr 24 02:17:57 2013
From: evan.cooch at gmail.com (Evan Cooch)
Date: Tue, 23 Apr 2013 20:17:57 -0400
Subject: [luatex] updates to various lua* packages breaks..something.
Message-ID: <517724B5.4070905@gmail.com>

First time posting to this list. Apologies if posts 'like this' should 
go somewhere (or to someone) else.

After most recent (23 Apr) updates (I'm using MikTeX 2.9) to various 
things things related to lualatex (including base), I noticed that 
compilation of anything takes twice as long as it did (say) 10 minutes 
ago (i.e., before I applied the updates). Didn't take long to see why. 
Basically, now, every time I try to compile something, it re-runs 
luaotfload.

luaotfload | Updating the font names database:
luaotfload | Scanning TEXMF and OS fonts..

Every time! - it should only have to do this once, but since the 
updates, it tries to do this every time I compile the same file, which 
is where the added time to compile comes from.

Compilation itself does seem to progress 'correctly', but something that 
takes twice as long (because of what appears to be a bug causing 
luaotfload to run every time a file is compiled, is not an 'update'.

Wonder if its related to the following. If I bring up an admin cmd 
console, and run

mkluatexfontdb -f -vvv

I get an error:

mklualatexdb: Windows API Error 5: Access is denied
mklualatexdb: Data: C://Documents and settings

When I run this on my other machines - which I have not 'updated' - 
mkluatexfontdb runs fine.

Suggestions? Clearly something has been 'broken' during the update - at 
least on Windows machines running MikTeX 2.9.

Thanks in advance.




From Philipp.Gesang at alumni.uni-heidelberg.de  Wed Apr 24 10:49:14 2013
From: Philipp.Gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Wed, 24 Apr 2013 10:49:14 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <517724B5.4070905@gmail.com>
References: <517724B5.4070905@gmail.com>
Message-ID: <20130424084816.GA3193@phlegethon>

Hi Evan!

???<date: 2013-04-23, Tuesday>???<from: Evan Cooch>???

> First time posting to this list. Apologies if posts 'like this'
> should go somewhere (or to someone) else.
> 
> After most recent (23 Apr) updates (I'm using MikTeX 2.9) to various

Which most recent update are you talking about? Could you please
add the output of mkluatexfontdb -V ?

> things things related to lualatex (including base), I noticed that
> compilation of anything takes twice as long as it did (say) 10
> minutes ago (i.e., before I applied the updates). Didn't take long
> to see why. Basically, now, every time I try to compile something,
> it re-runs luaotfload.
> 
> luaotfload | Updating the font names database:
> luaotfload | Scanning TEXMF and OS fonts..
> 
> Every time! - it should only have to do this once, but since the
> updates, it tries to do this every time I compile the same file,
> which is where the added time to compile comes from.

How do you use luaotfload? Plain or Latex? With fontspec? Could
you please post a minimal example that triggers the error with
fonts that are on CTAN? Thank you.

> Compilation itself does seem to progress 'correctly', but something
> that takes twice as long (because of what appears to be a bug
> causing luaotfload to run every time a file is compiled, is not an
> 'update'.

Probably an incorrect ?file:? lookup.

> Wonder if its related to the following. If I bring up an admin cmd
> console, and run
> 
> mkluatexfontdb -f -vvv
> 
> I get an error:
> 
> mklualatexdb: Windows API Error 5: Access is denied
> mklualatexdb: Data: C://Documents and settings

Sorry, no idea. Maybe you need to pass it to texlua?

> When I run this on my other machines - which I have not 'updated' -
> mkluatexfontdb runs fine.

Again, which version?

> Suggestions? Clearly something has been 'broken' during the update -
> at least on Windows machines running MikTeX 2.9.
> 
> Thanks in advance.

Thanks for reporting
Philipp


-- 
()  ascii ribbon campaign - against html e-mail
/\  www.asciiribbon.org   - against proprietary attachments
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130424/e286f2f1/attachment.bin>

From evan.cooch at gmail.com  Wed Apr 24 12:58:27 2013
From: evan.cooch at gmail.com (Evan Cooch)
Date: Wed, 24 Apr 2013 06:58:27 -0400
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <20130424084816.GA3193@phlegethon>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
Message-ID: <5177BAD3.6090303@gmail.com>

Hello!

On 4/24/2013 4:49 AM, Philipp Gesang wrote:
> Hi Evan!
>
> ???<date: 2013-04-23, Tuesday>???<from: Evan Cooch>???
>
>> First time posting to this list. Apologies if posts 'like this'
>> should go somewhere (or to someone) else.
>>
>> After most recent (23 Apr) updates (I'm using MikTeX 2.9) to various
> Which most recent update are you talking about? Could you please
> add the output of mkluatexfontdb -V ?

mkluatexfontdb version 1.07, database version 2.009

This is the *current* version I 'updated' too. Whatever the previous 
version was generated no errors.

>
> How do you use luaotfload? Plain or Latex? With fontspec? Could
> you please post a minimal example that triggers the error with
> fonts that are on CTAN? Thank you.

With fonts that are on CTAN? That sort of defeats the purpose of using 
fontspec in the first place! :-)

But, it doesn't matter. I normally use Minion Pro (which I own), but it 
fails even using XITS  Here is a simple MWE

\documentclass[11pt,letterpaper]{article}

\usepackage{fontspec}
\setmainfont{XITS}
\usepackage{unicode-math}
   \setmathfont{Asana Math}

\begin{document}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent in 
tincidunt nulla. Donec quis laoreet est. Aenean vitae est felis, a 
venenatis magna. Mauris semper bibendum vulputate. Etiam bibendum quam 
ut erat rutrum consequat.

\begin{equation}
\frac{dN}{dt}=rN\left(1-\frac{N}{K}\right)
\end{equation}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi eget 
dolor ac diam interdum volutpat. Cras luctus congue nibh, at dictum 
nulla iaculis quis.


\end{document}


When I try to compile this using lualatex (using MikTeX 2.9),  it 
absolutely refuses to compile. For this MWE, the error message actually 
occurs during liaotfload:

Luaotfload | scanning TEXMF and OS fonts...lualatex: Unexpected condition.

And then it stops.

>> Compilation itself does seem to progress 'correctly', but something
>> that takes twice as long (because of what appears to be a bug
>> causing luaotfload to run every time a file is compiled, is not an
>> 'update'.
> Probably an incorrect "file:" lookup.

Meaning?

>
>> Wonder if its related to the following. If I bring up an admin cmd
>> console, and run
>>
>> mkluatexfontdb -f -vvv
>>
>> I get an error:
>>
>> mklualatexdb: Windows API Error 5: Access is denied
>> mklualatexdb: Data: C://Documents and settings
> Sorry, no idea. Maybe you need to pass it to texlua?


Sorry, but that seems like a stretch.  Everything worked before worked 
before.



>
>> When I run this on my other machines - which I have not 'updated' -
>> mkluatexfontdb runs fine.
> Again, which version?

See above.

>
>> Suggestions? Clearly something has been 'broken' during the update -
>> at least on Windows machines running MikTeX 2.9.
>>
>> Thanks in advance.
> Thanks for reporting
> Philipp
>
>


Sure -- not sure what else to report.

I think the fact that mkluatexfontdb doesn't run - at all really - is 
telling. Could it be a corruption of something on this one - updated - 
system? Suggestions on what to look for?

Thanks.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130424/130b1e02/attachment.html>

From luatex at nililand.de  Wed Apr 24 13:54:21 2013
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 24 Apr 2013 13:54:21 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
Message-ID: <1swt1zenaef1t$.dlg@nililand.de>

Am Wed, 24 Apr 2013 10:49:14 +0200 schrieb Philipp Gesang:


> How do you use luaotfload? Plain or Latex? With fontspec? Could
> you please post a minimal example that triggers the error with
> fonts that are on CTAN? Thank you.

I made a local update of luaotfload and luaotfbase in my miktex 2.9.
I used the files packaged by miktex (in miktex/tm) and did not check
if they are identical to the version in the normal CTAN locations.

G:/Temp/texmf/tex/luatex/luaotfload/luaotfload.sty
Package: luaotfload 2012/05/28 v1.27 OpenType layout system

(G:/Temp/texmf/tex/luatex/luatexbase/luatexbase.sty
Package: luatexbase 2013/04/13 v0.5 Module utilities for LuaTeX

I can confirm the problem: luaotfload is constantly recreating the
font name database:

luaotfload | Updating the font names database:
luaotfload | Scanning TEXMF and OS fonts...

A minimal example that triggers the problem on my system is

\documentclass{article}

\usepackage[no-math]{fontspec}

\begin{document}
Lorem  $a$
\end{document}

The important part is the $a$: Without some math in the document
everything is fine. It doesn't matter if I use the [no-math] option
or not.

The luatex version in miktex is
This is LuaTeX, Version beta-0.70.2-2012060719 (MiKTeX 2.9).



-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From luatex at nililand.de  Wed Apr 24 13:58:00 2013
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 24 Apr 2013 13:58:00 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com>
Message-ID: <p0uurkow17cm$.dlg@nililand.de>

Am Wed, 24 Apr 2013 06:58:27 -0400 schrieb Evan Cooch:


>>> Wonder if its related to the following. If I bring up an admin cmd
>>> console, and run
>>>
>>> mkluatexfontdb -f -vvv
>>>
>>> I get an error:
>>>
>>> mklualatexdb: Windows API Error 5: Access is denied
>>> mklualatexdb: Data: C://Documents and settings
 
> I think the fact that mkluatexfontdb doesn't run - at all really - is 
> telling.

I don't think so. You are trying to run mkluatexfontdb in an admin
cmd - it is not really surprising that it can't write to your user
profile. Use a normal cmd console. 

-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From Philipp.Gesang at alumni.uni-heidelberg.de  Wed Apr 24 20:52:54 2013
From: Philipp.Gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Wed, 24 Apr 2013 20:52:54 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <5177BAD3.6090303@gmail.com>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com>
Message-ID: <20130424185254.GA3225@phlegethon>

???<date: 2013-04-24, Wednesday>???<from: Evan Cooch>???

> On 4/24/2013 4:49 AM, Philipp Gesang wrote:
> >???<date: 2013-04-23, Tuesday>???<from: Evan Cooch>???
> >
> >>First time posting to this list. Apologies if posts 'like this'
> >>should go somewhere (or to someone) else.
> >>
> >>After most recent (23 Apr) updates (I'm using MikTeX 2.9) to various
> >Which most recent update are you talking about? Could you please
> >add the output of mkluatexfontdb -V ?
> 
> mkluatexfontdb version 1.07, database version 2.009

Ok.

> But, it doesn't matter. I normally use Minion Pro (which I own), but
> it fails even using XITS  Here is a simple MWE
> 
> <snip />

Thanks for the example. I can confirm those unwanted updates when
fontspec includes the euenc definitions (lm).

> When I try to compile this using lualatex (using MikTeX 2.9),  it
> absolutely refuses to compile. For this MWE, the error message
> actually occurs during liaotfload:
> 
> Luaotfload | scanning TEXMF and OS fonts...lualatex: Unexpected condition.
> 
> And then it stops.

Afaics this is not a luaotfload error.

> >>Compilation itself does seem to progress 'correctly', but something
> >>that takes twice as long (because of what appears to be a bug
> >>causing luaotfload to run every time a file is compiled, is not an
> >>'update'.
> >Probably an incorrect "file:" lookup.
> 
> Meaning?

It is under investigation:

  https://github.com/eroux/luaotfload/issues/9#issuecomment-16776536

> >>Wonder if its related to the following. If I bring up an admin cmd
> >>console, and run
> >>
> >>mkluatexfontdb -f -vvv
> >>
> >>I get an error:
> >>
> >>mklualatexdb: Windows API Error 5: Access is denied
> >>mklualatexdb: Data: C://Documents and settings
> >Sorry, no idea. Maybe you need to pass it to texlua?
> 
> Sorry, but that seems like a stretch.  Everything worked before
> worked before.

I can?t test with windows but it would appear this is permissions
related. Run mkluatexfondb -h to see where the database is
located. You need write permissions in that directory.

> >>Suggestions? Clearly something has been 'broken' during the update -
> >>at least on Windows machines running MikTeX 2.9.
> >>
> >>Thanks in advance.
> >Thanks for reporting
> >Philipp
> 
> Sure -- not sure what else to report.
> 
> I think the fact that mkluatexfontdb doesn't run - at all really -
> is telling. Could it be a corruption of something on this one -
> updated - system? Suggestions on what to look for?

File permissions. If the database is being rebuilt over and over
again, this might be a clue that it cannot be saved to disk. The
message indicating this would be:

  luaotfload | Font names database not found, generating new one.

If it is only updated, then it?s a problem with the lookup. In
this case, the message is the one you gave in your first post:

  luaotfload | Updating the font names database:

If you are feeling adventurous, you can locate the file
?luaotfload.lua? from your distribution. Make a backup and
then comment out the line:

  fonts.define.resolvers.file = fonts.define.resolvers.name

and see if it helps.

Philipp

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130424/24ba0465/attachment.bin>

From evan.cooch at gmail.com  Thu Apr 25 01:46:21 2013
From: evan.cooch at gmail.com (Evan Cooch)
Date: Wed, 24 Apr 2013 19:46:21 -0400
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <20130424185254.GA3225@phlegethon>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
Message-ID: <51786ECD.4010305@gmail.com>

Thanks -- all good suggestions. I was moving offices today, and didn't 
get back online until an hour or so ago. I'll report in more detail 
tomorrow.


On 4/24/2013 2:52 PM, Philipp Gesang wrote:
> ???<date: 2013-04-24, Wednesday>???<from: Evan Cooch>???
>
>> On 4/24/2013 4:49 AM, Philipp Gesang wrote:
>>> ???<date: 2013-04-23, Tuesday>???<from: Evan Cooch>???
>>>
>>>> First time posting to this list. Apologies if posts 'like this'
>>>> should go somewhere (or to someone) else.
>>>>
>>>> After most recent (23 Apr) updates (I'm using MikTeX 2.9) to various
>>> Which most recent update are you talking about? Could you please
>>> add the output of mkluatexfontdb -V ?
>> mkluatexfontdb version 1.07, database version 2.009
> Ok.
>
>> But, it doesn't matter. I normally use Minion Pro (which I own), but
>> it fails even using XITS  Here is a simple MWE
>>
>> <snip />
> Thanks for the example. I can confirm those unwanted updates when
> fontspec includes the euenc definitions (lm).
>
>> When I try to compile this using lualatex (using MikTeX 2.9),  it
>> absolutely refuses to compile. For this MWE, the error message
>> actually occurs during liaotfload:
>>
>> Luaotfload | scanning TEXMF and OS fonts...lualatex: Unexpected condition.
>>
>> And then it stops.
> Afaics this is not a luaotfload error.
>
>>>> Compilation itself does seem to progress 'correctly', but something
>>>> that takes twice as long (because of what appears to be a bug
>>>> causing luaotfload to run every time a file is compiled, is not an
>>>> 'update'.
>>> Probably an incorrect "file:" lookup.
>> Meaning?
> It is under investigation:
>
>    https://github.com/eroux/luaotfload/issues/9#issuecomment-16776536
>
>>>> Wonder if its related to the following. If I bring up an admin cmd
>>>> console, and run
>>>>
>>>> mkluatexfontdb -f -vvv
>>>>
>>>> I get an error:
>>>>
>>>> mklualatexdb: Windows API Error 5: Access is denied
>>>> mklualatexdb: Data: C://Documents and settings
>>> Sorry, no idea. Maybe you need to pass it to texlua?
>> Sorry, but that seems like a stretch.  Everything worked before
>> worked before.
> I can't test with windows but it would appear this is permissions
> related. Run mkluatexfondb -h to see where the database is
> located. You need write permissions in that directory.
>
>>>> Suggestions? Clearly something has been 'broken' during the update -
>>>> at least on Windows machines running MikTeX 2.9.
>>>>
>>>> Thanks in advance.
>>> Thanks for reporting
>>> Philipp
>> Sure -- not sure what else to report.
>>
>> I think the fact that mkluatexfontdb doesn't run - at all really -
>> is telling. Could it be a corruption of something on this one -
>> updated - system? Suggestions on what to look for?
> File permissions. If the database is being rebuilt over and over
> again, this might be a clue that it cannot be saved to disk. The
> message indicating this would be:
>
>    luaotfload | Font names database not found, generating new one.
>
> If it is only updated, then it's a problem with the lookup. In
> this case, the message is the one you gave in your first post:
>
>    luaotfload | Updating the font names database:
>
> If you are feeling adventurous, you can locate the file
> "luaotfload.lua" from your distribution. Make a backup and
> then comment out the line:
>
>    fonts.define.resolvers.file = fonts.define.resolvers.name
>
> and see if it helps.
>
> Philipp
>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130424/a6df4a26/attachment-0001.html>

From evan.cooch at gmail.com  Thu Apr 25 02:04:21 2013
From: evan.cooch at gmail.com (Evan Cooch)
Date: Wed, 24 Apr 2013 20:04:21 -0400
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <20130424185254.GA3225@phlegethon>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
Message-ID: <51787305.7040905@gmail.com>

<snip>
>>>> Wonder if its related to the following. If I bring up an admin cmd
>>>> console, and run
>>>>
>>>> mkluatexfontdb -f -vvv
>>>>
>>>> I get an error:
>>>>
>>>> mklualatexdb: Windows API Error 5: Access is denied
>>>> mklualatexdb: Data: C://Documents and settings
>>> Sorry, no idea. Maybe you need to pass it to texlua?
>> Sorry, but that seems like a stretch.  Everything worked before
>> worked before.
> I can?t test with windows but it would appear this is permissions
> related. Run mkluatexfondb -h

That directive simply brings up the help screen.

But, I did try

mkluatexfontdb -v

which generated the following:

luaotfload | Updating the font names database:
luaotfload | Font names database loaded: 
C:/Users/my-id/AppData/Local/MiKTeX/2.9/luatex-cache/generic/names/otfl-names.lua
luaotfload | Scanning TEXMF and OS fonts...

which is followed by

luaotfload | scaning TEXMF and OS fonts...mkluatexfontdb: Unexpected 
condition.


This has been so bizarre I did a complete de novo install of MikTeX. If 
I don't update lua* packages, no errors. Once again, the moment I do the 
update, I run into this problem.

I'm the admin account, so in theory, MikTeX (and all its bits) should 
have write permissions.

> to see where the database is
> located. You need write permissions in that directory.
>
>>>> Suggestions? Clearly something has been 'broken' during the update -
>>>> at least on Windows machines running MikTeX 2.9.
>>>>
>>>> Thanks in advance.
>>> Thanks for reporting
>>> Philipp
>> Sure -- not sure what else to report.
>>
>> I think the fact that mkluatexfontdb doesn't run - at all really -
>> is telling. Could it be a corruption of something on this one -
>> updated - system? Suggestions on what to look for?
> File permissions. If the database is being rebuilt over and over
> again, this might be a clue that it cannot be saved to disk. The
> message indicating this would be:
>
>    luaotfload | Font names database not found, generating new one.
>
> If it is only updated, then it?s a problem with the lookup. In
> this case, the message is the one you gave in your first post:
>
>    luaotfload | Updating the font names database:
>
> If you are feeling adventurous, you can locate the file
> ?luaotfload.lua? from your distribution. Make a backup and
> then comment out the line:
>
>    fonts.define.resolvers.file = fonts.define.resolvers.name
>
> and see if it helps.
>

OK, just tried that - and yes, made quite a difference. No more 'scanning'.

Does that indicate anything useful?

From evan.cooch at gmail.com  Thu Apr 25 02:09:30 2013
From: evan.cooch at gmail.com (Evan Cooch)
Date: Wed, 24 Apr 2013 20:09:30 -0400
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <20130424185254.GA3225@phlegethon>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
Message-ID: <5178743A.2010704@gmail.com>

Following from Ulrike Fisher, demigod status on various (La)TeX lists. I 
use the criterion that if it happens to Ulrike, its a real problem. ;-)

Am Wed, 24 Apr 2013 10:49:14 +0200 schrieb Philipp Gesang:


> How do you use luaotfload? Plain or Latex? With fontspec? Could
> you please post a minimal example that triggers the error with
> fonts that are on CTAN? Thank you.

I made a local update of luaotfload and luaotfbase in my miktex 2.9.
I used the files packaged by miktex (in miktex/tm) and did not check
if they are identical to the version in the normal CTAN locations.

G:/Temp/texmf/tex/luatex/luaotfload/luaotfload.sty
Package: luaotfload 2012/05/28 v1.27 OpenType layout system

(G:/Temp/texmf/tex/luatex/luatexbase/luatexbase.sty
Package: luatexbase 2013/04/13 v0.5 Module utilities for LuaTeX

I can confirm the problem: luaotfload is constantly recreating the
font name database:

luaotfload | Updating the font names database:
luaotfload | Scanning TEXMF and OS fonts...

A minimal example that triggers the problem on my system is

\documentclass{article}

\usepackage[no-math]{fontspec}

\begin{document}
Lorem  $a$
\end{document}

The important part is the $a$: Without some math in the document
everything is fine. It doesn't matter if I use the [no-math] option
or not.

The luatex version in miktex is
This is LuaTeX, Version beta-0.70.2-2012060719 (MiKTeX 2.9).



-- Ulrike Fischer http://www.troubleshooting-tex.de/


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130424/8d61135a/attachment.html>

From luatex at nililand.de  Thu Apr 25 09:06:58 2013
From: luatex at nililand.de (Ulrike Fischer)
Date: Thu, 25 Apr 2013 09:06:58 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
Message-ID: <2lsl334vhvh9$.dlg@nililand.de>

Am Wed, 24 Apr 2013 20:52:54 +0200 schrieb Philipp Gesang:

> Thanks for the example. I can confirm those unwanted updates when
> fontspec includes the euenc definitions (lm).

I can't confirm that fontspec/euenc is involved. I get the constant
updates also with this example:

\documentclass{article}
\usepackage{luaotfload}
\font\test=file:arial.ttf
\begin{document}
\test Lorem 
\end{document}

>>>Probably an incorrect "file:" lookup.

This I can confirm. If I use a name lookup instead
(\font\test=name:Arial)  there is no problem. 

> If you are feeling adventurous, you can locate the file
> ?luaotfload.lua? from your distribution. Make a backup and
> then comment out the line:
> 
>   fonts.define.resolvers.file = fonts.define.resolvers.name
> 
> and see if it helps.

This solves the problem for me too.


-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From Philipp.Gesang at alumni.uni-heidelberg.de  Thu Apr 25 09:29:13 2013
From: Philipp.Gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Thu, 25 Apr 2013 09:29:13 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <2lsl334vhvh9$.dlg@nililand.de>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de>
Message-ID: <20130425072913.GA19152@phlegethon>

???<Datum: Thursday, 25. April 2013>???<Von: Ulrike Fischer>???

> Am Wed, 24 Apr 2013 20:52:54 +0200 schrieb Philipp Gesang:
> 
> > Thanks for the example. I can confirm those unwanted updates when
> > fontspec includes the euenc definitions (lm).
> 
> I can't confirm that fontspec/euenc is involved. I get the constant
> updates also with this example:

It was just the first package in line to load fonts by filename,
so it will trigger the database update while loading the Latin
Modern fonts.

> >>>Probably an incorrect "file:" lookup.
> 
> This I can confirm. If I use a name lookup instead
> (\font\test=name:Arial)  there is no problem. 

So you can still load both OS and texmf fonts?

> > If you are feeling adventurous, you can locate the file
> > ?luaotfload.lua? from your distribution. Make a backup and
> > then comment out the line:
> > 
> >   fonts.define.resolvers.file = fonts.define.resolvers.name
> > 
> > and see if it helps.
> 
> This solves the problem for me too.

Thanks for testing.

Philipp

-- 
()  ascii ribbon campaign - against html e-mail
/\  www.asciiribbon.org   - against proprietary attachments
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130425/c533b421/attachment.bin>

From Philipp.Gesang at alumni.uni-heidelberg.de  Thu Apr 25 09:43:22 2013
From: Philipp.Gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Thu, 25 Apr 2013 09:43:22 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <51787305.7040905@gmail.com>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <51787305.7040905@gmail.com>
Message-ID: <20130425074322.GB19152@phlegethon>

???<date: 2013-04-24, Wednesday>???<from: Evan Cooch>???

> >I can?t test with windows but it would appear this is permissions
> >related. Run mkluatexfondb -h
> 
> That directive simply brings up the help screen.

There should be line at the bottom indicating the database path.

> This has been so bizarre I did a complete de novo install of MikTeX.
> If I don't update lua* packages, no errors. Once again, the moment I
> do the update, I run into this problem.

There has been an update to CTAN recently.

> I'm the admin account, so in theory, MikTeX (and all its bits)
> should have write permissions.

These lines suggest you could as well run with normal privileges:

    luaotfload | Font names database loaded: C:/Users/my-id/AppData/Local/MiKTeX/2.9/luatex-cache/generic/names/otfl-names.lua
    luaotfload | Scanning TEXMF and OS fonts...

Shouldn?t ?C:\users\my-id? be writable to user ?my-id?? Of
course, delete the current database first in case it is owned by
root.

> >If you are feeling adventurous, you can locate the file
> >?luaotfload.lua? from your distribution. Make a backup and
> >then comment out the line:
> >
> >   fonts.define.resolvers.file = fonts.define.resolvers.name
> >
> >and see if it helps.
> >
> 
> OK, just tried that - and yes, made quite a difference. No more 'scanning'.
> 
> Does that indicate anything useful?

You can keep it that way if it still finds other fonts.

Philipp

-- 
()  ascii ribbon campaign - against html e-mail
/\  www.asciiribbon.org   - against proprietary attachments
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130425/b7c6715f/attachment.bin>

From luatex at nililand.de  Thu Apr 25 10:39:24 2013
From: luatex at nililand.de (Ulrike Fischer)
Date: Thu, 25 Apr 2013 10:39:24 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
Message-ID: <1eayew7ywoe2z$.dlg@nililand.de>

Am Thu, 25 Apr 2013 09:29:13 +0200 schrieb Philipp Gesang:

>>> Thanks for the example. I can confirm those unwanted updates when
>>> fontspec includes the euenc definitions (lm).

>> I can't confirm that fontspec/euenc is involved. I get the constant
>> updates also with this example:

> It was just the first package in line to load fonts by filename,
> so it will trigger the database update while loading the Latin
> Modern fonts.

But as I wrote in my other post fontspec alone didn't trigger the
update of the font database. I had to add some math. Investigating a
bit I found an additional difference: the extension matters.
euenc loads the fonts without extension:

file:lmroman10-regular:script=latn;+trep;+tlig;

And this works fine (as does \font\test=file:arial). But
\font\test=file:lmroman10-regular.otf:script=latn;+trep;+tlig;
  or 
\font\test=file:arial.ttf

triggers again the recreation of the database.


>>>>>Probably an incorrect "file:" lookup.
>> 
>> This I can confirm. If I use a name lookup instead
>> (\font\test=name:Arial)  there is no problem. 
> 
> So you can still load both OS and texmf fonts?

Yes there is no problem in using the fonts. There are all found in
the end. The only problem is the time delay due to the database
updates.

-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From kakuto at fuk.kindai.ac.jp  Thu Apr 25 12:14:57 2013
From: kakuto at fuk.kindai.ac.jp (Akira Kakuto)
Date: Thu, 25 Apr 2013 19:14:57 +0900
Subject: [luatex]  updates to various lua* packages breaks..something.
Message-ID: <0132AD56855D483A8B127FA7A09C48BD@CJ3001517a>

> Basically, now, every time I try to compile something, it re-runs  luaotfload.

I attach a patch by H. Kitagawa for the latest luaotfload: luaotfload.diff.gz.

Thanks,
Akira
-------------- next part --------------
A non-text attachment was scrubbed...
Name: luaotfload.diff.gz
Type: application/x-gzip
Size: 565 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130425/f234f04b/attachment.gz>

From heiko.oberdiek at googlemail.com  Thu Apr 25 20:03:42 2013
From: heiko.oberdiek at googlemail.com (Heiko Oberdiek)
Date: Thu, 25 Apr 2013 20:03:42 +0200
Subject: [luatex] LuaTeX warning: Misplaced \pdfrestore by (983040sp,
 0sp)
In-Reply-To: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
References: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
Message-ID: <51796FFE.6020103@googlemail.com>

On 23.04.2013 14:21, Patrick Gundlach wrote:
> Hi,
> 
> when running the following code, I have a problem that subsequent boxes are misplaced. A warning is issued:
> 
> LuaTeX warning: Misplaced \pdfrestore by (983040sp, 0sp)
> 
> What am I doing wrong?
> 
> Patrick
> 
> 
> 
> \documentclass{article}
> 
> \begin{document}
> 
> \directlua{
>   local save,restore,set_matrix
>   save = node.new("whatsit","pdf_save")
>   restore = node.new("whatsit","pdf_restore")
>   set_matrix = node.new("whatsit", "pdf_setmatrix")
>   set_matrix.data = "5 0 0 5 "
> 
>   local rule = node.new("rule")
>   rule.width =  15*2^16
>   rule.height = 15*2^16
>   local hbox = node.hpack(rule)
>   hbox.head = node.insert_before(hbox.head,rule,save)
>   node.insert_after(hbox.head,save,set_matrix)
>   node.insert_after(hbox.head,rule,restore)
>   node.write(hbox)
> }

The pair \pdfsave and \pdfrestore must be at the same location. In your
code there is rule inbetween. There are two different coordinate
systems: PDF and TeX, \pdfrestore restores the graphics state including
the current transfer matrix to the state of \pdfsave in the PDF
coordinate system. But if the TeX position has moved away, the
two coordinate systems are out of sync. Therefore you get a warning
that you might shoot yourself in the foot.

There are several ways to do this, pseudo-code, e.g. going back via
\kern or:

  \hbox{%
    \pdfsave
    \pdfsetmatrix ...
    \hbox to 0pt{%
      \rule...
      \hss
    }%
    \pdfrestore
  }


From patrick at gundla.ch  Thu Apr 25 22:08:16 2013
From: patrick at gundla.ch (Patrick Gundlach)
Date: Thu, 25 Apr 2013 22:08:16 +0200
Subject: [luatex] LuaTeX warning: Misplaced \pdfrestore by (983040sp,
	0sp)
In-Reply-To: <51796FFE.6020103@googlemail.com>
References: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
 <51796FFE.6020103@googlemail.com>
Message-ID: <B4991B09-85C5-4770-9C9E-8CF0E60C9EDA@gundla.ch>

Hello Heiko,

>> when running the following code, I have a problem that subsequent boxes are misplaced. A warning is issued:
>> 
>> LuaTeX warning: Misplaced \pdfrestore by (983040sp, 0sp)
>> 
>> What am I doing wrong?


> There are two different coordinate
> systems: PDF and TeX, \pdfrestore restores the graphics state including
> the current transfer matrix to the state of \pdfsave in the PDF
> coordinate system. But if the TeX position has moved away, the
> two coordinate systems are out of sync. Therefore you get a warning
> that you might shoot yourself in the foot.

I my case, I did get garbled output, so the warning was very good.

Thanks for your comment. This is what I have now:

local function scalebox(scalefactor,box)
    local pdf_save, pdf_restore, pdf_setmatrix
    pdf_save = node.new("whatsit","pdf_save")
    pdf_restore = node.new("whatsit","pdf_restore")
    pdf_setmatrix = node.new("whatsit","pdf_setmatrix")
    pdf_setmatrix.data=string.format("%.4g 0 0 %.4g",scalefactor,scalefactor)

    local hbox = node.hpack(box)
    hbox = node.insert_before(hbox,hbox,pdf_setmatrix)
    hbox = node.insert_before(hbox,pdf_setmatrix,pdf_save)

    hbox = node.hpack(hbox)
    hbox.height = box.height * scalefactor
    hbox.width = box.width * scalefactor
    hbox.depth = 0
    node.insert_after(hbox,node.tail(hbox),pdf_restore)

    local newbox = node.vpack(hbox)
    return newbox
end

which seems to work because the box doesn't have any depth. 

Patrick

https://github.com/speedata/publisher/blob/develop/src/lua/barcodes/barcodes.lua#L10



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130425/337fca5f/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: nodes.png
Type: image/png
Size: 69769 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130425/337fca5f/attachment-0001.png>

From heiko.oberdiek at googlemail.com  Thu Apr 25 23:30:20 2013
From: heiko.oberdiek at googlemail.com (Heiko Oberdiek)
Date: Thu, 25 Apr 2013 23:30:20 +0200
Subject: [luatex] LuaTeX warning: Misplaced \pdfrestore by (983040sp,
 0sp)
In-Reply-To: <B4991B09-85C5-4770-9C9E-8CF0E60C9EDA@gundla.ch>
References: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
 <51796FFE.6020103@googlemail.com>
 <B4991B09-85C5-4770-9C9E-8CF0E60C9EDA@gundla.ch>
Message-ID: <5179A06C.6010801@googlemail.com>

On 25.04.2013 22:08, Patrick Gundlach wrote:
> Hello Heiko,
> 
>>> when running the following code, I have a problem that subsequent
>>> boxes are misplaced. A warning is issued:
>>>
>>> LuaTeX warning: Misplaced \pdfrestore by (983040sp, 0sp)
>>>
>>> What am I doing wrong?
> 
> 
>> There are two different coordinate
>> systems: PDF and TeX, \pdfrestore restores the graphics state including
>> the current transfer matrix to the state of \pdfsave in the PDF
>> coordinate system. But if the TeX position has moved away, the
>> two coordinate systems are out of sync. Therefore you get a warning
>> that you might shoot yourself in the foot.
> 
> I my case, I did get garbled output, so the warning was very good.
> 
> Thanks for your comment. This is what I have now:
> 
> local function scalebox(scalefactor,box)
>     local pdf_save, pdf_restore, pdf_setmatrix
>     pdf_save = node.new("whatsit","pdf_save")
>     pdf_restore = node.new("whatsit","pdf_restore")
>     pdf_setmatrix = node.new("whatsit","pdf_setmatrix")
>     pdf_setmatrix.data=string.format("%.4g 0 0
> %.4g",scalefactor,scalefactor)

"%.4g" allows the "e style", you get invalid PDF, if scalefactor
is equal smaller than 0.000099995 (e.g. 0,00009 => 9e-05) or
equal/greater than 9999.5 (e.g. 10000 => 1e+04).
PDF numbers must not be given in exponential notation.

>     local hbox = node.hpack(box)
>     hbox = node.insert_before(hbox,hbox,pdf_setmatrix)
>     hbox = node.insert_before(hbox,pdf_setmatrix,pdf_save)
> 
>     hbox = node.hpack(hbox)
>     hbox.height = box.height * scalefactor
>     hbox.width = box.width * scalefactor
>     hbox.depth = 0
>     node.insert_after(hbox,node.tail(hbox),pdf_restore)
> 
>     local newbox = node.vpack(hbox)
>     return newbox
> end
> 
> which seems to work because the box doesn't have any depth.

The original box might have a depth. The other parameters (width and
height) are recalculated, but the depth is set to zero?

The graphics package uses something like:

  \setbox0=\hbox{<user box content>}
  \setbox2=\hbox{%
    \pdfsave
    \pdfsetmatrix...
    \hbox to 0pt{%
      \copy0
      \hss
    }%
    \pdfrestore
  }
  \wd2=<scale factor>\wd0
  \box2

Yours sincerely
  Heiko Oberdiek

From evan.cooch at gmail.com  Fri Apr 26 02:27:19 2013
From: evan.cooch at gmail.com (Evan Cooch)
Date: Thu, 25 Apr 2013 20:27:19 -0400
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <1eayew7ywoe2z$.dlg@nililand.de>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de>
Message-ID: <5179C9E7.8010702@gmail.com>


> Yes there is no problem in using the fonts. There are all found in
> the end. The only problem is the time delay due to the database
> updates.
>

But, since the time delay can be significant (depending on how many 
fonts you're working with), this is somewhat more than a nuisance. 
Further, there is clearly a 'bug' - perhaps not fatal, but one that 
suggests that something needs a fix.

Commenting out

fonts.define.resolvers.file = fonts.define.resolvers.name

from luaotfload.lua seems to work, but

1\ what exactly does commenting this line out prevent? (Just for my edification)

2\ is this something that is going to be fixed in a more permanent way?

While I'm not entirely uncomfortable with the 'so long as it works' approach to fixes, I'm even more comfortable with a real fix. I'm holding off updating all my other systems until such time.

Note: the preceding isn't intended as a complaint of any sort.



From elie.roux at telecom-bretagne.eu  Fri Apr 26 09:50:25 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Fri, 26 Apr 2013 09:50:25 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <5179C9E7.8010702@gmail.com>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de> <5179C9E7.8010702@gmail.com>
Message-ID: <517A31C1.9080300@telecom-bretagne.eu>

Dear Evan,

> But, since the time delay can be significant (depending on how many
> fonts you're working with), this is somewhat more than a nuisance.
> Further, there is clearly a 'bug' - perhaps not fatal, but one that
> suggests that something needs a fix.

I will upload a new version fixing this (more precisely reverting the 
previous change) today on CTAN.

> Commenting out
>
> fonts.define.resolvers.file = fonts.define.resolvers.name
>
> from luaotfload.lua seems to work, but
>
> 1\ what exactly does commenting this line out prevent? (Just for my
> edification)

It will break fonts that are present in the font name database (which 
includes fonts reachable by fontconfig) but are not reachable by kpse, 
if you call them with the file: lookup. This means less fonts found. But 
if it worked before, it will certainly continue to work with the new 
version (without rebuilding the database too often).

> 2\ is this something that is going to be fixed in a more permanent way?
>
> While I'm not entirely uncomfortable with the 'so long as it works'
> approach to fixes, I'm even more comfortable with a real fix. I'm
> holding off updating all my other systems until such time.

A real fix is present in the development branch, but it cannot reach 
CTAN before an update of several packets (fontspec, unicode-math and 
microtype mainly). Patches have been sent to the maintainers, some 
responded, others not... we hope it will reach TeXLive 2013, but it's 
not entirely depending on us!

Thank you,
-- 
Elie

From khaledhosny at eglug.org  Fri Apr 26 10:17:00 2013
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Fri, 26 Apr 2013 10:17:00 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <517A31C1.9080300@telecom-bretagne.eu>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de> <5179C9E7.8010702@gmail.com>
 <517A31C1.9080300@telecom-bretagne.eu>
Message-ID: <20130426081700.GA2471@khaled-laptop>

On Fri, Apr 26, 2013 at 09:50:25AM +0200, ?lie Roux wrote:
> Dear Evan,
> 
> >But, since the time delay can be significant (depending on how many
> >fonts you're working with), this is somewhat more than a nuisance.
> >Further, there is clearly a 'bug' - perhaps not fatal, but one that
> >suggests that something needs a fix.
> 
> I will upload a new version fixing this (more precisely reverting
> the previous change) today on CTAN.
> 
> >Commenting out
> >
> >fonts.define.resolvers.file = fonts.define.resolvers.name
> >
> >from luaotfload.lua seems to work, but
> >
> >1\ what exactly does commenting this line out prevent? (Just for my
> >edification)
> 
> It will break fonts that are present in the font name database
> (which includes fonts reachable by fontconfig) but are not reachable
> by kpse, if you call them with the file: lookup. This means less
> fonts found. But if it worked before, it will certainly continue to
> work with the new version (without rebuilding the database too
> often).

I think the point of file: was to use kpse to locate the files bypassing
the name database entirely, it might not be clear from the documentation
but it has always been the intent. Fonts outside TEXMF tree have to be
given as full paths, just like any kpse lookup.

Regards,
Khaled

From patrick at gundla.ch  Fri Apr 26 10:21:22 2013
From: patrick at gundla.ch (Patrick Gundlach)
Date: Fri, 26 Apr 2013 10:21:22 +0200
Subject: [luatex] LuaTeX warning: Misplaced \pdfrestore by (983040sp,
	0sp)
In-Reply-To: <5179A06C.6010801@googlemail.com>
References: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
 <51796FFE.6020103@googlemail.com>
 <B4991B09-85C5-4770-9C9E-8CF0E60C9EDA@gundla.ch>
 <5179A06C.6010801@googlemail.com>
Message-ID: <F3D5E509-D826-47C4-A0E2-3AD6E779791E@gundla.ch>


Hello Heiko

> "%.4g" allows the "e style", you get invalid PDF, if scalefactor
> is equal smaller than 0.000099995 (e.g. 0,00009 => 9e-05) or
> equal/greater than 9999.5 (e.g. 10000 => 1e+04).
> PDF numbers must not be given in exponential notation.


Yes thanks! I wonder how many times I will run into that. Now I round the value.


>>    local hbox = node.hpack(box)
>>    hbox = node.insert_before(hbox,hbox,pdf_setmatrix)
>>    hbox = node.insert_before(hbox,pdf_setmatrix,pdf_save)
>> 
>>    hbox = node.hpack(hbox)
>>    hbox.height = box.height * scalefactor
>>    hbox.width = box.width * scalefactor
>>    hbox.depth = 0
>>    node.insert_after(hbox,node.tail(hbox),pdf_restore)
>> 
>>    local newbox = node.vpack(hbox)
>>    return newbox
>> end
>> 
>> which seems to work because the box doesn't have any depth.
> 
> The original box might have a depth. The other parameters (width and
> height) are recalculated, but the depth is set to zero?

yes, explicitly in the code above. 

Now it's a vertical list with hbox dp 0 that has "save, matrix, some material" and then the restore, which ends up at the same place at save.

Patrick




From patrick at gundla.ch  Fri Apr 26 10:27:11 2013
From: patrick at gundla.ch (Patrick Gundlach)
Date: Fri, 26 Apr 2013 10:27:11 +0200
Subject: [luatex] LuaTeX warning: Misplaced \pdfrestore by (983040sp,
	0sp)
In-Reply-To: <F3D5E509-D826-47C4-A0E2-3AD6E779791E@gundla.ch>
References: <B0CD1F76-092B-4511-B404-49A19A092F38@gundla.ch>
 <51796FFE.6020103@googlemail.com>
 <B4991B09-85C5-4770-9C9E-8CF0E60C9EDA@gundla.ch>
 <5179A06C.6010801@googlemail.com>
 <F3D5E509-D826-47C4-A0E2-3AD6E779791E@gundla.ch>
Message-ID: <2846029D-BD00-43FA-A64F-E2DDF9CF6336@gundla.ch>




> Now it's a vertical list with hbox dp 0 that has "save, matrix, some material" and then the restore, which ends up at the same place at save.

BTW: I know that the code changes the depth of the material, but that's OK for my purposes

Patrick




From elie.roux at telecom-bretagne.eu  Fri Apr 26 10:33:47 2013
From: elie.roux at telecom-bretagne.eu (=?UTF-8?B?w4lsaWUgUm91eA==?=)
Date: Fri, 26 Apr 2013 10:33:47 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <20130426081700.GA2471@khaled-laptop>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de> <5179C9E7.8010702@gmail.com>
 <517A31C1.9080300@telecom-bretagne.eu> <20130426081700.GA2471@khaled-laptop>
Message-ID: <517A3BEB.8000803@telecom-bretagne.eu>

Hello Khaled,

> I think the point of file: was to use kpse to locate the files bypassing
> the name database entirely, it might not be clear from the documentation
> but it has always been the intent. Fonts outside TEXMF tree have to be
> given as full paths, just like any kpse lookup.

Sounds consistant... Philipp Gesang is working on the topic (see 
https://github.com/phi-gamma/luaotfload/issues/4#issuecomment-17041960). 
It makes documents less portable though... We have to find the right 
balance between easiness and a correct syntax, close to XeTeX... maybe 
I'm balancing too much on the easiness side? I have to say I've always 
been quite allergic to the new (XeTeX/fontspec) way fonts are called so 
I'm maybe not the best designer for it!

Philipp, what do you think?

Thank you,
-- 
Elie

From luatex at nililand.de  Fri Apr 26 11:31:32 2013
From: luatex at nililand.de (Ulrike Fischer)
Date: Fri, 26 Apr 2013 11:31:32 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de> <5179C9E7.8010702@gmail.com>
 <517A31C1.9080300@telecom-bretagne.eu> <20130426081700.GA2471@khaled-laptop>
Message-ID: <1kllcyo3xq3py.dlg@nililand.de>

Am Fri, 26 Apr 2013 10:17:00 +0200 schrieb Khaled Hosny:

> I think the point of file: was to use kpse to locate the files bypassing
> the name database entirely, it might not be clear from the documentation
> but it has always been the intent. Fonts outside TEXMF tree have to be
> given as full paths, just like any kpse lookup.

On windows fonts in the system font folder are found by kpse -- with
miktex and with texlive2012:

Miktex:
G:\Temp>kpsewhich arial.ttf
C:/Windows/Fonts/arial.ttf

TeXLive2012:
G:\Temp>kpsewhich arial.ttf
c:/Windows/fonts/arial.ttf

So "file:" works fine for this fonts too.

With Miktex some other locations like e.g. the font folder of the
Adobe Reader works too.

-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From evan.cooch at gmail.com  Fri Apr 26 14:51:13 2013
From: evan.cooch at gmail.com (Evan Cooch)
Date: Fri, 26 Apr 2013 08:51:13 -0400
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <517A31C1.9080300@telecom-bretagne.eu>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de> <5179C9E7.8010702@gmail.com>
 <517A31C1.9080300@telecom-bretagne.eu>
Message-ID: <517A7841.5020001@gmail.com>


On 4/26/2013 3:50 AM, ?lie Roux wrote:
> Dear Evan,
>
>> But, since the time delay can be significant (depending on how many
>> fonts you're working with), this is somewhat more than a nuisance.
>> Further, there is clearly a 'bug' - perhaps not fatal, but one that
>> suggests that something needs a fix.
>
> I will upload a new version fixing this (more precisely reverting the 
> previous change) today on CTAN.
>
>> Commenting out
>>
>> fonts.define.resolvers.file = fonts.define.resolvers.name
>>
>> from luaotfload.lua seems to work, but
>>
>> 1\ what exactly does commenting this line out prevent? (Just for my
>> edification)
>
> It will break fonts that are present in the font name database (which 
> includes fonts reachable by fontconfig) but are not reachable by kpse, 
> if you call them with the file: lookup. This means less fonts found. 
> But if it worked before, it will certainly continue to work with the 
> new version (without rebuilding the database too often).
>
>> 2\ is this something that is going to be fixed in a more permanent way?
>>
>> While I'm not entirely uncomfortable with the 'so long as it works'
>> approach to fixes, I'm even more comfortable with a real fix. I'm
>> holding off updating all my other systems until such time.
>
> A real fix is present in the development branch, but it cannot reach 
> CTAN before an update of several packets (fontspec, unicode-math and 
> microtype mainly). Patches have been sent to the maintainers, some 
> responded, others not... we hope it will reach TeXLive 2013, but it's 
> not entirely depending on us!
>
> Thank you,

Indeed - many thanks for the clarification and insights - and all the 
work on the package(s) in the first instance.

Cheers...


From elie.roux at telecom-bretagne.eu  Fri Apr 26 16:37:17 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Fri, 26 Apr 2013 16:37:17 +0200
Subject: [luatex] token_filter
Message-ID: <517A911D.3070305@telecom-bretagne.eu>

Dear all,

I'm currently struggling to get polyglossia working with french 
punctuation[1]. As it is implemented with interchartokens in XeTeX, I 
thought I could achieve something similar with the implementation taken 
here: http://wiki.luatex.org/index.php?title=Token_filter. It works 
quite well for very simple things, but I really cannot understand a few 
things:
  - where is the ouptut of token.command_name documented?
  - how can I know if the token I get is inside a csname? (ex: in a file 
I have \foobar. When, in the token_filter, I get the token b, how can I 
know it's part of a csname name ?)
  - same question for other characters, for example '<' in \ifnum\foo<0

It seems XeTeX handles it well, but it is possible to get this 
fine-grained filtering in the token_filter, without having to expand and 
inspect all tokens "by hand"?

If there is no simple solution, I'll try something with the nodes, I 
think it will be more appropriate...

What do you think?

Thank you,
-- 
Elie

[1] https://github.com/eroux/polyglossia

From micneu at gmail.com  Fri Apr 26 11:14:24 2013
From: micneu at gmail.com (Michael Neubert)
Date: Fri, 26 Apr 2013 09:14:24 +0000
Subject: [luatex] updates to various lua* packages breaks..something.
References: <0132AD56855D483A8B127FA7A09C48BD@CJ3001517a>
Message-ID: <loom.20130426T110501-957@post.gmane.org>

Akira Kakuto <kakuto at ...> writes:

> 
> > Basically, now, every time I try to compile something, it re-runs 
luaotfload.
> 
> I attach a patch by H. Kitagawa for the latest luaotfload: luaotfload.diff.gz.
> 
> Thanks,
> Akira
> 
> Attachment (luaotfload.diff.gz): application/x-gzip, 565 bytes


I had the same problem as the above people. After updating compilation was
impossible. Compilations stopped without warning and without error message.
But I identified the problem.

The update overwrites the "otfl-blacklist.cnf"-file located in my windows
folder c:\Programme\Miktex 2.9b\tex\luatex\luaotfload or where it is on your
texfm

I had blacklisted there Lingoes.ttf, a font of a free Dictionary, url:
http://www.lingoes.net. Located at my system here:
C:\WINDOWS\Fonts\Lingoes.ttf The software seem to be only available for
Windows, so it's a Windows only problem.

I have no clue why making a database, Luatex doesn't like Lingoes.ttf. After
blacklisting this font again in "otfl-blacklist.cnf", compilations works
again without any problem.

Regards to all, hope this helps.




From top at riopress.net  Fri Apr 26 11:50:55 2013
From: top at riopress.net (Michael Neubert)
Date: Fri, 26 Apr 2013 11:50:55 +0200
Subject: [luatex]
	http://blog.gmane.org/gmane.comp.tex.luatex.user/day=20130426
Message-ID: <!&!AAAAAAAAAAAYAAAAAAAAACO2Fw3XhbdOrtMnrc/6HrnCgAAAEAAAAF02tdmfSA5Jry9QS0iwvfIBAAAAAA==@riopress.net>

Akira Kakuto <kakuto at ...> writes:

 

> 

> > Basically, now, every time I try to compile something, it re-runs  luaotfload.

> 

> I attach a patch by H. Kitagawa for the latest luaotfload: luaotfload.diff.gz.

> 

> Thanks,

> Akira

> 

> Attachment (luaotfload.diff.gz): application/x-gzip, 565 bytes

 

 

I had the same problem as the above people. After updating compilation was impossible. Compilations stopped without warning and without error message. But I identified the problem.

 

The update overwrites the "otfl-blacklist.cnf"-file located in my windows folder c:\Programme\Miktex 2.9b\tex\luatex\luaotfload or where it is on your texfm

 

I had blacklisted there Lingoes.ttf, a font of a free Dictionary, url: http://www.lingoes.net. Located at my system here: C:\WINDOWS\Fonts\Lingoes.ttf The software seem to be only available for Windows, so it's a Windows only problem.

 

I have no clue why making a database, Luatex doesn't like Lingoes.ttf. After blacklisting this font again in "otfl-blacklist.cnf", compilations works again without any problem.

 

Regards to all, hope this helps.

 

----------------------------------------------

riopress.net

words connecting the world

 

michael neubert

dorfhauser str. 18

91367 wei?enohe

germany

 

telephone:

+49 9192 99 4840

facsimile:

+49 9192 99 4905            

----------------------------------------------

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130426/b6af8126/attachment.html>

From luatex at nililand.de  Fri Apr 26 19:21:54 2013
From: luatex at nililand.de (Ulrike Fischer)
Date: Fri, 26 Apr 2013 19:21:54 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
References: <0132AD56855D483A8B127FA7A09C48BD@CJ3001517a>
 <loom.20130426T110501-957@post.gmane.org>
Message-ID: <isrnuyr244t2.dlg@nililand.de>

Am Fri, 26 Apr 2013 09:14:24 +0000 schrieb Michael Neubert:


> I had the same problem as the above people. After updating compilation was
> impossible. Compilations stopped without warning and without error message.

Compilation didn't stop for us. We only had a time delay. Your
Problem is different

> But I identified the problem.
 
> The update overwrites the "otfl-blacklist.cnf"-file located in my windows
> folder c:\Programme\Miktex 2.9b\tex\luatex\luaotfload or where it is on your
> texfm

Don't change the original file in the main miktex folder. Put a copy
in a local texmf which is search before the main tree and change
this copy. Then you will not loose your settings at updates. 

-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From mailing_list at arcor.de  Fri Apr 26 18:19:58 2013
From: mailing_list at arcor.de (Stephan Hennig)
Date: Fri, 26 Apr 2013 18:19:58 +0200
Subject: [luatex] getting --output-directory
Message-ID: <517AA92E.3040507@arcor.de>

Hi,

I want to read from and write to a particular file in --output-directory
or in the current directory, if option --output-directory is not used.

What is the preferred way in Lua to get the path set via option
--output-directory?  Is there an alternative to scanning table arg for
that option?  Some kpse library magic perhaps?

Best regards,
Stephan Hennig

From khaledhosny at eglug.org  Fri Apr 26 20:22:28 2013
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Fri, 26 Apr 2013 20:22:28 +0200
Subject: [luatex] token_filter
In-Reply-To: <517A911D.3070305@telecom-bretagne.eu>
References: <517A911D.3070305@telecom-bretagne.eu>
Message-ID: <20130426182228.GA13957@khaled-laptop>

On Fri, Apr 26, 2013 at 04:37:17PM +0200, ?lie Roux wrote:
> If there is no simple solution, I'll try something with the nodes, I
> think it will be more appropriate...

I?d just go with that from start, no need to replicate XeTeX?s
implementation. I believe Arthur was doing some work in this area, so
you may want to check with him.

Regards,
Khaled

From reinhard.kotucha at web.de  Fri Apr 26 20:57:08 2013
From: reinhard.kotucha at web.de (Reinhard Kotucha)
Date: Fri, 26 Apr 2013 20:57:08 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <1kllcyo3xq3py.dlg@nililand.de>
References: <517724B5.4070905@gmail.com> <20130424084816.GA3193@phlegethon>
 <5177BAD3.6090303@gmail.com> <20130424185254.GA3225@phlegethon>
 <2lsl334vhvh9$.dlg@nililand.de> <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de> <5179C9E7.8010702@gmail.com>
 <517A31C1.9080300@telecom-bretagne.eu>
 <20130426081700.GA2471@khaled-laptop>
 <1kllcyo3xq3py.dlg@nililand.de>
Message-ID: <20858.52740.560582.247312@zaphod.ms25.net>

On 2013-04-26 at 11:31:32 +0200, Ulrike Fischer wrote:

 > Am Fri, 26 Apr 2013 10:17:00 +0200 schrieb Khaled Hosny:
 > 
 > > I think the point of file: was to use kpse to locate the files bypassing
 > > the name database entirely, it might not be clear from the documentation
 > > but it has always been the intent. Fonts outside TEXMF tree have to be
 > > given as full paths, just like any kpse lookup.
 > 
 > On windows fonts in the system font folder are found by kpse -- with
 > miktex and with texlive2012:
 > 
 > Miktex:
 > G:\Temp>kpsewhich arial.ttf
 > C:/Windows/Fonts/arial.ttf
 > 
 > TeXLive2012:
 > G:\Temp>kpsewhich arial.ttf
 > c:/Windows/fonts/arial.ttf
 > 
 > So "file:" works fine for this fonts too.

You probably have OSFONTDIR set, either in texmf.cnf or in the
environment.

On Linux I get

  $ kpsewhich -var-value=OSFONTDIR
  /please/set/osfontdir/in/the/environment
 
 > With Miktex some other locations like e.g. the font folder of the
 > Adobe Reader works too.

Strange.  This is the content of the file Reader9/Resource/LICREAD.TXT:
---------------------------------------------------------------------------
The font software contained in this package is being licensed to you solely
for use with the Adobe Reader product ("Adobe Reader") subject to
the terms and conditions of the Electronic End User License Agreement
accompanying the Adobe Reader.
---------------------------------------------------------------------------

Regards,
  Reinhard

-- 
----------------------------------------------------------------------------
Reinhard Kotucha                                      Phone: +49-511-3373112
Marschnerstr. 25
D-30167 Hannover                              mailto:reinhard.kotucha at web.de
----------------------------------------------------------------------------
Microsoft isn't the answer. Microsoft is the question, and the answer is NO.
----------------------------------------------------------------------------

From Philipp.Gesang at alumni.uni-heidelberg.de  Fri Apr 26 22:05:31 2013
From: Philipp.Gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Fri, 26 Apr 2013 22:05:31 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <517A3BEB.8000803@telecom-bretagne.eu>
References: <20130424084816.GA3193@phlegethon> <5177BAD3.6090303@gmail.com>
 <20130424185254.GA3225@phlegethon> <2lsl334vhvh9$.dlg@nililand.de>
 <20130425072913.GA19152@phlegethon>
 <1eayew7ywoe2z$.dlg@nililand.de> <5179C9E7.8010702@gmail.com>
 <517A31C1.9080300@telecom-bretagne.eu>
 <20130426081700.GA2471@khaled-laptop>
 <517A3BEB.8000803@telecom-bretagne.eu>
Message-ID: <20130426200531.GB32236@phlegethon>

???<date: 2013-04-26, Friday>???<from: ?lie Roux>???

> Hello Khaled,
> 
> >I think the point of file: was to use kpse to locate the files bypassing
> >the name database entirely, it might not be clear from the documentation
> >but it has always been the intent. Fonts outside TEXMF tree have to be
> >given as full paths, just like any kpse lookup.
> 
> Sounds consistant... Philipp Gesang is working on the topic (see https://github.com/phi-gamma/luaotfload/issues/4#issuecomment-17041960).
> It makes documents less portable though... We have to find the right
> balance between easiness and a correct syntax, close to XeTeX...
> maybe I'm balancing too much on the easiness side? I have to say
> I've always been quite allergic to the new (XeTeX/fontspec) way
> fonts are called so I'm maybe not the best designer for it!
> 
> Philipp, what do you think?

I think the lookup problem is essentially unrelated to the font
request parser, but if the latter is more modular then we can
distinguish between the two luatex modes (file:, name:) and xetex
compatibility (brackets, unspecified). (Also less expletives.)

In the dev version which still has the old parser, file lookups
use database as well so the problem is avoided (I hope).

Regards
Philipp


-- 
()  ascii ribbon campaign - against html e-mail
/\  www.asciiribbon.org   - against proprietary attachments
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130426/15961ed4/attachment.bin>

From Philipp.Gesang at alumni.uni-heidelberg.de  Fri Apr 26 22:51:46 2013
From: Philipp.Gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Fri, 26 Apr 2013 22:51:46 +0200
Subject: [luatex] updates to various lua* packages breaks..something.
In-Reply-To: <loom.20130426T110501-957@post.gmane.org>
References: <0132AD56855D483A8B127FA7A09C48BD@CJ3001517a>
 <loom.20130426T110501-957@post.gmane.org>
Message-ID: <20130426205146.GA32699@phlegethon>

???<date: 2013-04-26, Friday>???<from: Michael Neubert>???

> Akira Kakuto <kakuto at ...> writes:
> 
> I have no clue why making a database, Luatex doesn't like Lingoes.ttf.

It has nothing to do with the database. Try loading the font:

  \directlua{fontloader.open"lingoes.ttf"}\bye

On my system this fails with:

  This is LuaTeX, Version beta-0.76.0-2013041612 (rev 4627) 
   restricted \write18 enabled.
  (./lingo.texSegmentation fault (core dumped)

Regards
Philipp

-- 
()  ascii ribbon campaign - against html e-mail
/\  www.asciiribbon.org   - against proprietary attachments
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130426/8a186026/attachment.bin>

From arthur.reutenauer at normalesup.org  Fri Apr 26 23:52:08 2013
From: arthur.reutenauer at normalesup.org (Arthur Reutenauer)
Date: Fri, 26 Apr 2013 22:52:08 +0100
Subject: [luatex] token_filter
In-Reply-To: <20130426182228.GA13957@khaled-laptop>
References: <517A911D.3070305@telecom-bretagne.eu>
 <20130426182228.GA13957@khaled-laptop>
Message-ID: <20130426215208.GO10257@phare.normalesup.org>

> I?d just go with that from start, no need to replicate XeTeX?s
> implementation. I believe Arthur was doing some work in this area, so
> you may want to check with him.

  Yes, I already communicated with ?lie about that, but just in case
anyone cares, my experiments from last summer are at
https://github.com/reutenauer/inter-char-node

	Arthur

From zappathustra at free.fr  Sat Apr 27 01:15:03 2013
From: zappathustra at free.fr (Paul Isambert)
Date: Sat, 27 Apr 2013 01:15:03 +0200
Subject: [luatex] token_filter
In-Reply-To: <20130426215208.GO10257@phare.normalesup.org>
Message-ID: <1859159502.37206435.1367018103213.JavaMail.root@zimbra54-e10.priv.proxad.net>

Khaled wrote:
> > I?d just go with that from start, no need to replicate XeTeX?s
> > implementation. I believe Arthur was doing some work in this area, so
> > you may want to check with him.

I second that; going for token_filter will only result in hacks, I?m afraid.
It?s just so easy with nodes. I think Taco?s page on the wiki was just for fun.

Arthur wrote:
>   Yes, I already communicated with ?lie about that, but just in case
> anyone cares, my experiments from last summer are at
> https://github.com/reutenauer/inter-char-node

l.28 of your luaintercharnode.lua, you say:

    Why the hell can?t I index a table with a table?

Well, you can :)

    local t = { [{1, 1}] = emspace }
    t[{a = b}] = c
    ...

Elie?s original questions:
>   - where is the ouptut of token.command_name documented?

Err, in the manual?

>   - how can I know if the token I get is inside a csname? (ex: in a file 
> I have \foobar. When, in the token_filter, I get the token b, how can I 
> know it's part of a csname name ?)

?b? in ?\foobar? isn?t a token; the token is the entire command.

>   - same question for other characters, for example '<' in \ifnum\foo<0

If I understand your question correctly as ?How can I know whether ?<?
is used as an operator in an \ifnum-conditional?, then the answer is:
keep track of what has come before :) (Or, actually, perhaps some
tracing is possible in Lua: ?tex.tracingifs?... ?tex.currentconditional?...?)

Somebody (Patrick, if I remember correctly) once asked on this list
what token_filter was good for; honestly, I don?t know. It?s nice to
have it around when you really don?t know how to spend/waste a few
hours at your computer, but apart from that, I find it neither useful
nor usable.

Best,
Paul


From elie.roux at telecom-bretagne.eu  Sat Apr 27 09:56:45 2013
From: elie.roux at telecom-bretagne.eu (=?UTF-8?B?w4lsaWUgUm91eA==?=)
Date: Sat, 27 Apr 2013 09:56:45 +0200
Subject: [luatex] token_filter
In-Reply-To: <1859159502.37206435.1367018103213.JavaMail.root@zimbra54-e10.priv.proxad.net>
References: <1859159502.37206435.1367018103213.JavaMail.root@zimbra54-e10.priv.proxad.net>
Message-ID: <517B84BD.9080000@telecom-bretagne.eu>

Dear all,

> I second that; going for token_filter will only result in hacks, I?m afraid.
> It?s just so easy with nodes. I think Taco?s page on the wiki was just for fun.

I'll do that then. I think the best is even to hook in the luaotfload 
code, and inspire from what Hans did in ConTeXt.

> Elie?s original questions:
>>    - where is the ouptut of token.command_name documented?
>
> Err, in the manual?

Section 4.17.6 reads:

"
This returns the name associated with the ?command? value of the token 
in LUATEX. There is not always a direct connection between these names 
and primitives. For instance, all \ifxxx tests are grouped under 
if_test, and the ?command modifier? defines which test is to be run.
"

This is good, but where do I get the different possible outputs, and 
what they correspond to? Or is there something I missed in the manual?

>>    - how can I know if the token I get is inside a csname? (ex: in a file
>> I have \foobar. When, in the token_filter, I get the token b, how can I
>> know it's part of a csname name ?)
>
> ?b? in ?\foobar? isn?t a token; the token is the entire command.

Well, that's what I thought at the beginning, but no... if I make a dumb 
print function in the callback in a very simple plain tex file it's 
true, but when it starts to be in a complex LaTeX document, I get *a 
lot* of things coming from csnames, put some prints in my version of 
polyglossia and you'll see very surprising things! Maybe there is 
something I did wrong, but it's quite hard to figure out...

>>    - same question for other characters, for example '<' in \ifnum\foo<0
>
> If I understand your question correctly as ?How can I know whether ?<?
> is used as an operator in an \ifnum-conditional?, then the answer is:
> keep track of what has come before :) (Or, actually, perhaps some
> tracing is possible in Lua: ?tex.tracingifs?... ?tex.currentconditional?...?)

Ok.

> Somebody (Patrick, if I remember correctly) once asked on this list
> what token_filter was good for; honestly, I don?t know. It?s nice to
> have it around when you really don?t know how to spend/waste a few
> hours at your computer, but apart from that, I find it neither useful
> nor usable.

That's what I understood after several hours :)

Thank you,
-- 
Elie

From arthur.reutenauer at normalesup.org  Sat Apr 27 11:39:26 2013
From: arthur.reutenauer at normalesup.org (Arthur Reutenauer)
Date: Sat, 27 Apr 2013 10:39:26 +0100
Subject: [luatex] token_filter
In-Reply-To: <1859159502.37206435.1367018103213.JavaMail.root@zimbra54-e10.priv.proxad.net>
References: <20130426215208.GO10257@phare.normalesup.org>
 <1859159502.37206435.1367018103213.JavaMail.root@zimbra54-e10.priv.proxad.net>
Message-ID: <20130427093926.GP10257@phare.normalesup.org>

> l.28 of your luaintercharnode.lua, you say:
> 
>     Why the hell can?t I index a table with a table?
> 
> Well, you can :)
> 
>     local t = { [{1, 1}] = emspace }
>     t[{a = b}] = c

  Yes, but observe:

---- cut before
\directlua{ 
  local function log(message)
    texio.write_nl("term and log", message)
  end

  local function say_if_node(n, label)
    if node.is_node(n, label) then
      log(label .. " is a node")
    else
      log(label .. " is NOT a node")
    end
  end

  local t = { }
  local emspace = node.new(node.id('kern'), 1)
  t[{ 1, 1 }] = emspace
  t[1] = emspace

  say_if_node(emspace, "emspace")
  say_if_node(t[{ 1, 1 }], "t[{ 1, 1 }]")
  say_if_node(t[1], "t[1]")
}
---- cut after

prints (amongst others):

----
emspace is a node
t[{ 1, 1 }] is NOT a node
t[1] is a node
----

  So something odd is happening when the table index is a table, which
meant that in practice I couldn't use table as indexes there.

  With LuaTeX 0.70.2 from TeX Live 2012, haven't checked with 0.75.

	Arthur

From zappathustra at free.fr  Sat Apr 27 12:40:15 2013
From: zappathustra at free.fr (Paul Isambert)
Date: Sat, 27 Apr 2013 12:40:15 +0200
Subject: [luatex] token_filter
In-Reply-To: <20130427093926.GP10257@phare.normalesup.org>
Message-ID: <2076764701.37828227.1367059215797.JavaMail.root@zimbra54-e10.priv.proxad.net>

Arthur Reutenauer <arthur.reutenauer at normalesup.org> a ?crit:
> > l.28 of your luaintercharnode.lua, you say:
> > 
> >     Why the hell can?t I index a table with a table?
> > 
> > Well, you can :)
> > 
> >     local t = { [{1, 1}] = emspace }
> >     t[{a = b}] = c
> 
>   Yes, but observe:
> 
> ---- cut before
> \directlua{ 
>   local function log(message)
>     texio.write_nl("term and log", message)
>   end
> 
>   local function say_if_node(n, label)
>     if node.is_node(n, label) then
>       log(label .. " is a node")
>     else
>       log(label .. " is NOT a node")
>     end
>   end
> 
>   local t = { }
>   local emspace = node.new(node.id('kern'), 1)
>   t[{ 1, 1 }] = emspace
>   t[1] = emspace
> 
>   say_if_node(emspace, "emspace")
>   say_if_node(t[{ 1, 1 }], "t[{ 1, 1 }]")
>   say_if_node(t[1], "t[1]")
> }
> ---- cut after
> 
> prints (amongst others):
> 
> ----
> emspace is a node
> t[{ 1, 1 }] is NOT a node
> t[1] is a node
> ----
> 
>   So something odd is happening when the table index is a table, which
> meant that in practice I couldn't use table as indexes there.
> 
>   With LuaTeX 0.70.2 from TeX Live 2012, haven't checked with 0.75.

That?s because you?re using two different tables, although they have
the same contents. What should be done is:

    local t, tindex = {}, {1, 1}
    ...
    t[tindex] = emspace
    ...
    say_if_node(t[tindex],  "t[{ 1, 1 }]")
    ...

Of course, that solution might not fit your goal.

Otherwise, I?m sure you could hack some metatable magic to the effect
that t[{1, 1}] always works.

Best,
Paul


From arthur.reutenauer at normalesup.org  Sat Apr 27 19:58:47 2013
From: arthur.reutenauer at normalesup.org (Arthur Reutenauer)
Date: Sat, 27 Apr 2013 18:58:47 +0100
Subject: [luatex] token_filter
In-Reply-To: <2076764701.37828227.1367059215797.JavaMail.root@zimbra54-e10.priv.proxad.net>
References: <20130427093926.GP10257@phare.normalesup.org>
 <2076764701.37828227.1367059215797.JavaMail.root@zimbra54-e10.priv.proxad.net>
Message-ID: <20130427175846.GQ10257@phare.normalesup.org>

> That?s because you?re using two different tables, although they have
> the same contents.

  Oh right, I should have thought of this.

>                    What should be done is:
> [snip]
> Of course, that solution might not fit your goal.

  No, as you can guess that does not really serve a useful purpose.

> Otherwise, I?m sure you could hack some metatable magic to the effect
> that t[{1, 1}] always works.

  I'm sure I could, but since the actual data is hidden from the user
anyway there is little advantage in doing that.  In the current
implementation I just have a function of two arguments that returns the
content of the table (internodes), and I think that's a more sensible
interface.

	Arthur

From mailing_list at arcor.de  Mon Apr 29 18:25:41 2013
From: mailing_list at arcor.de (Stephan Hennig)
Date: Mon, 29 Apr 2013 18:25:41 +0200
Subject: [luatex] LuaTeX 0.76: problem with pdf_colorstack whatsit
Message-ID: <517E9F05.2010507@arcor.de>

Hi,

the attached code creates a whatsit node of subtype pdf_colorstack and
tries to assign a value to field 'cmd'.  This runs fine with LuaTeX
0.70.2 from TL 2012, but gives an error with LuaTeX 0.76.0 from
TL2013pretest.  How should the code be adapted to run with LuaTeX 0.76?

Best regards,
Stephan Hennig


\directlua{
  local WHATSIT = node.id('whatsit')
  local PDF_COLORSTACK = node.subtype('pdf_colorstack')
  texio.write_nl(WHATSIT, PDF_COLORSTACK)

  local push = node.new(WHATSIT, PDF_COLORSTACK)
  push.cmd = 1
}
\bye


> This is LuaTeX, Version beta-0.76.0-2013042406 (rev 4627)  (format=luatex 2013.4.26)  29 APR 2013 18:24
>  restricted \write18 enabled.
> **pdfcolorstack
> (./pdfcolorstack.tex
> 8
> 39
> ! LuaTeX error [string "\directlua "]:1: You cannot set field cmd in a node of t
> ype whatsit
> stack traceback:
> 	[C]: in function '__newindex'
> 	[string "\directlua "]:1: in main chunk.
> l.8 }
>    
> ? 
>  )
> No pages of output.
> 
> PDF statistics: 0 PDF objects out of 1000 (max. 8388607)
>  0 named destinations out of 1000 (max. 131072)
>  1 words of extra memory for PDF output out of 10000 (max. 10000000)
> 

From mailing_list at arcor.de  Mon Apr 29 19:12:18 2013
From: mailing_list at arcor.de (Stephan Hennig)
Date: Mon, 29 Apr 2013 19:12:18 +0200
Subject: [luatex] getting --output-directory
In-Reply-To: <517AA92E.3040507@arcor.de>
References: <517AA92E.3040507@arcor.de>
Message-ID: <517EA9F2.1040601@arcor.de>

Am 26.04.2013 18:19, schrieb Stephan Hennig:

> I want to read from and write to a particular file in --output-directory
> or in the current directory, if option --output-directory is not used.
> 
> What is the preferred way in Lua to get the path set via option
> --output-directory?  Is there an alternative to scanning table arg for
> that option?

Toying a bit with scanning arg, this approach doesn't seem right.
(Lua)TeX understands a variety of option syntaxes, like

  -output-directory=<dir>
  -output-directory <dir>
  --output-directory=<dir>
  --output-directory <dir>

And guess what

  luatex --output-directory= --safer <file>

does?  It writes files to the root directory.  Seems plausible, since
appending / to the empty string (which doesn't end with a slash already)
results in just /.  But

  --output-directory=

is not the same as

  --output-directory=/

At least not in the msysgit bash shell (on Windows), where the former
option writes to the root directory, but the latter to the msysgit
installation directory instead.

So, there seems to be a sophisticated mechanism implemented in (Lua)TeX
for parsing --output-directory and determining the actual output
directory.  It doesn't make sense to re-implement that in Lua just to
obey option --output-directory when reading and writing files from Lua.

Would it be possible to provide means to easily determine the output
directory in LuaTeX, e.g., make it available in one of the status, tex
or texconfig tables?

Giving this another thought, should a user have to mess with the output
directory at all?  Shouldn't io.read and io.write operate in the output
directory instead of the current directory in the first place?  Does
this reasoning make any sense?

Best regards,
Stephan Hennig


From patrick at gundla.ch  Mon Apr 29 19:52:57 2013
From: patrick at gundla.ch (Patrick Gundlach)
Date: Mon, 29 Apr 2013 19:52:57 +0200
Subject: [luatex] LuaTeX 0.76: problem with pdf_colorstack whatsit
In-Reply-To: <517E9F05.2010507@arcor.de>
References: <517E9F05.2010507@arcor.de>
Message-ID: <BEA6584A-E5B2-4693-A0BC-CC876A834C64@gundla.ch>


> the attached code creates a whatsit node of subtype pdf_colorstack and
> tries to assign a value to field 'cmd'.  This runs fine with LuaTeX
> 0.70.2 from TL 2012, but gives an error with LuaTeX 0.76.0 from
> TL2013pretest.  How should the code be adapted to run with LuaTeX 0.76?

just a reference:

http://tracker.luatex.org/view.php?id=822


Patrick

From mailing_list at arcor.de  Mon Apr 29 20:12:18 2013
From: mailing_list at arcor.de (Stephan Hennig)
Date: Mon, 29 Apr 2013 20:12:18 +0200
Subject: [luatex] LuaTeX 0.76: problem with pdf_colorstack whatsit
In-Reply-To: <BEA6584A-E5B2-4693-A0BC-CC876A834C64@gundla.ch>
References: <517E9F05.2010507@arcor.de>
 <BEA6584A-E5B2-4693-A0BC-CC876A834C64@gundla.ch>
Message-ID: <517EB802.9060009@arcor.de>

Am 29.04.2013 19:52, schrieb Patrick Gundlach:
> 
>> the attached code creates a whatsit node of subtype pdf_colorstack and
>> tries to assign a value to field 'cmd'.  This runs fine with LuaTeX
>> 0.70.2 from TL 2012, but gives an error with LuaTeX 0.76.0 from
>> TL2013pretest.
> 
> just a reference:
> 
> http://tracker.luatex.org/view.php?id=822

Thank you!

Taco, is this change intentional?  It hasn't been announced in the
LuaTeX changelog.  Do I have to adapt my code (the change breaks the
spelling package) or will LuaTeX be fixed?

Best regards,
Stephan Hennig


From gnurser at gmail.com  Tue Apr 30 15:54:53 2013
From: gnurser at gmail.com (George Nurser)
Date: Tue, 30 Apr 2013 14:54:53 +0100
Subject: [luatex] oberdiek.luatex.lua still failing for me with MacTeX 2013
Message-ID: <CAAyCRnTcLOv5QngF4+M8NwMTuKFq4h9QYqTK4TQ8BYaejawzCA@mail.gmail.com>

Hi,
I apologize if this is a known problem...
I just today downloaded and installed MacTeX 2013, which I (perhaps
wrongly) assumed has all the fixes in it.

Trying to lualatex my current .tex file, which calls


\usepackage[no-math]{fontspec}
\usepackage{lualatex-math}
\usepackage{unicode-math}

it fails with the same error as in this post:
http://tug.org/pipermail/luatex/2013-January/003987.html

(/usr/local/texlive/2013/texmf-dist/tex/generic/oberdiek/luatex-loader.sty
Package: luatex-loader 2010/03/09 v0.4 Lua module loader (HO)

(/usr/local/texlive/2013/texmf-dist/scripts/oberdiek/oberdiek.luatex.lua)
! LuaTeX error
...ive/2013/texmf-dist/scripts/oberdiek/oberdiek.luatex.lua:55: b

--- TeX said ---
ad argument #1 to 'insert' (table expected, got nil)
stack traceback:
[C]: in function 'insert'
...ive/2013/texmf-dist/scripts/oberdiek/oberdiek.luatex.lua:55: in main
chunk
[C]: in function 'dofile'
[string "\directlua "]:6: in main chunk.
l.139   }
       %
!The lua interpreter ran into a problem, so the
remainder of this lua chunk will be ignored.

--George.


More errors in the log file...


(/usr/local/texlive/2013/texmf-dist/tex/luatex/luaotfload/luaotfload.lua)
Lua module: luaotfload 2012/05/28 1.27 OpenType layout system.
luaotfload: loading file
/usr/local/texlive/2013/texmf-dist/tex/luatex/luaotfloa
d/otfl-luat-dum.lua.
! LuaTeX error
.../2013/texmf-dist/tex/luatex/luaotfload/otfl-luat-dum.lua:65: i
nvalid escape sequence near '\/'
stack traceback:
[C]: in function 'dofile'
...ive/2013/texmf-dist/tex/luatex/luaotfload/luaotfload.lua:46: in function
'lo
admodule'
...ive/2013/texmf-dist/tex/luatex/luaotfload/luaotfload.lua:51: in main
chunk
[C]: in function 'require'
...xlive/2013/texmf-dist/tex/luatex/luatexbase/modutils.lua:49: in function
're
quire_module'
[string "\directlua "]:1: in main chunk.
\lltxb at requirelua ...xluaescapestring {#2}" \fi )}

l.35 \endinput

The lua interpreter ran into a problem, so the
remainder of this lua chunk will be ignored.

)
(/usr/local/texlive/2013/texmf-dist/tex/latex/fontspec/fontspec.lua)
Lua module: fontspec 2009/12/04 2 Advanced font selection for LuaLaTeX.

! LuaTeX error
...al/texlive/2013/texmf-dist/tex/luatex/luatexbase/mcb.lua:141:
Module luatexbase-mcb error: unable to add function:
(luatexbase-mcb)             'luaotfload.patch_font' is not a valid callback

stack traceback:
[C]: in function 'error'
...xlive/2013/texmf-dist/tex/luatex/luatexbase/modutils.lua:23: in function
'mo
dule_error_int'
...xlive/2013/texmf-dist/tex/luatex/luatexbase/modutils.lua:42: in function
'er
r'
...al/texlive/2013/texmf-dist/tex/luatex/luatexbase/mcb.lua:141: in
function 'a
dd_to_callback'
.../texlive/2013/texmf-dist/tex/latex/fontspec/fontspec.lua:153: in main
chunk
[C]: in function 'require'
...xlive/2013/texmf-dist/tex/luatex/luatexbase/modutils.lua:49: in function
're
quire_module'
[string "\directlua "]:1: in main chunk.
\lltxb at requirelua ...xluaescapestring {#2}" \fi )}

l.42 \bool_new:N
               \l_fontspec_firsttime_bool
The lua interpreter ran into a problem, so the
remainder of this lua chunk will be ignored.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130430/79d76161/attachment.html>

From elie.roux at telecom-bretagne.eu  Tue Apr 30 16:09:38 2013
From: elie.roux at telecom-bretagne.eu (=?ISO-8859-1?Q?=C9lie_Roux?=)
Date: Tue, 30 Apr 2013 16:09:38 +0200
Subject: [luatex] oberdiek.luatex.lua still failing for me with MacTeX
 2013
In-Reply-To: <CAAyCRnTcLOv5QngF4+M8NwMTuKFq4h9QYqTK4TQ8BYaejawzCA@mail.gmail.com>
References: <CAAyCRnTcLOv5QngF4+M8NwMTuKFq4h9QYqTK4TQ8BYaejawzCA@mail.gmail.com>
Message-ID: <517FD0A2.9030605@telecom-bretagne.eu>

On 30/04/2013 15:54, George Nurser wrote:
> Hi,
> I apologize if this is a known problem...
> I just today downloaded and installed MacTeX 2013, which I (perhaps
> wrongly) assumed has all the fixes in it.
>
> Trying to lualatex my current .tex file, which calls
>
>
> \usepackage[no-math]{fontspec}
> \usepackage{lualatex-math}
> \usepackage{unicode-math}

Dear George,

It seems, indeed, that your versions of oberdiek.luatex.lua and 
luaotfload are not up-to-date. Attached is the new version of 
oberdiek.luatex.lua, and the fixed luaotfload is on CTAN.

Thank you,
-- 
Elie
-------------- next part --------------
A non-text attachment was scrubbed...
Name: oberdiek.luatex.lua
Type: text/x-lua
Size: 2048 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20130430/8fec0e60/attachment.bin>

From gnurser at gmail.com  Tue Apr 30 16:31:37 2013
From: gnurser at gmail.com (George Nurser)
Date: Tue, 30 Apr 2013 15:31:37 +0100
Subject: [luatex] oberdiek.luatex.lua still failing for me with MacTeX
	2013
In-Reply-To: <517FD0A2.9030605@telecom-bretagne.eu>
References: <CAAyCRnTcLOv5QngF4+M8NwMTuKFq4h9QYqTK4TQ8BYaejawzCA@mail.gmail.com>
 <517FD0A2.9030605@telecom-bretagne.eu>
Message-ID: <CAAyCRnQC5OMi0nDR9-kW4+0spqJF-Nk0beo2G_J6CvDMbii4wQ@mail.gmail.com>

Dear Elie,
Thanks for the very rapid reply!

I'll give it a try later this afternoon.

Thanks, George.


On 30 April 2013 15:09, ?lie Roux <elie.roux at telecom-bretagne.eu> wrote:

> On 30/04/2013 15:54, George Nurser wrote:
>
>> Hi,
>> I apologize if this is a known problem...
>> I just today downloaded and installed MacTeX 2013, which I (perhaps
>> wrongly) assumed has all the fixes in it.
>>
>> Trying to lualatex my current .tex file, which calls
>>
>>
>> \usepackage[no-math]{fontspec}
>> \usepackage{lualatex-math}
>> \usepackage{unicode-math}
>>
>
> Dear George,
>
> It seems, indeed, that your versions of oberdiek.luatex.lua and luaotfload
> are not up-to-date. Attached is the new version of oberdiek.luatex.lua, and
> the fixed luaotfload is on CTAN.
>
> Thank you,
> --
> Elie
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20130430/10135226/attachment.html>

From mailing_list at arcor.de  Tue Apr 30 18:45:36 2013
From: mailing_list at arcor.de (Stephan Hennig)
Date: Tue, 30 Apr 2013 18:45:36 +0200
Subject: [luatex] getting --output-directory
In-Reply-To: <517EA9F2.1040601@arcor.de>
References: <517AA92E.3040507@arcor.de> <517EA9F2.1040601@arcor.de>
Message-ID: <517FF530.9050304@arcor.de>

Am 29.04.2013 19:12, schrieb Stephan Hennig:

> Shouldn't io.read and io.write operate in the output directory
> instead of the current directory in the first place?

Or rather io.open and io.popen.


> Does this reasoning make any sense?

Best regards,
Stephan Hennig


