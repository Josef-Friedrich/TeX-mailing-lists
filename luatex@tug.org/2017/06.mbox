From nomosnomos at gmail.com  Thu Jun  1 14:19:47 2017
From: nomosnomos at gmail.com (Dohyun Kim)
Date: Thu, 1 Jun 2017 21:19:47 +0900
Subject: [luatex] Reusable Code (LuaLaTeX + LuaMPlib)
In-Reply-To: <CAFP+xFKSUx5FQnuXrfxhJYiNZwT8MujQiYo_P88+Kkf2oiR-=g@mail.gmail.com>
References: <CAFP+xF+tk0GqzG3dLZis-fC9wNH5sOQxDEOivqovuTTWzMNRpw@mail.gmail.com>
 <CAFP+xFKSUx5FQnuXrfxhJYiNZwT8MujQiYo_P88+Kkf2oiR-=g@mail.gmail.com>
Message-ID: <CAFzmAm2dCFYqygu5ZTCyiPqVv+f55q6G13wO9q74bo+d-G5Hgg@mail.gmail.com>

2017-05-31 11:37 GMT+09:00 Troy Henderson <thenders at gmail.com>:
> Apologies, but I forgot to paste my code.  Here it is:
>
> \documentclass{article}
> \usepackage{luamplib}
>
> \mplibtextextlabel{enable}
> \mplibcodeinherit{enable}
>
> \begin{document}
>     \begin{center}
>         \begin{mplibcode}
>             picture p;
>             beginfig(0);
>                 draw (-36,0)--(36,0);
>                 label.bot(textext("Hello"),origin);
>                 p:=currentpicture;
>             endfig;
>         \end{mplibcode}
>     \end{center}
>
>     \begin{center}
>         \begin{mplibcode}
>             beginfig(1);
>                 currentpicture:=p;
>             endfig;
>         \end{mplibcode}
>     \end{center}
>
> \end{document}

Please download and unzip:

  https://github.com/lualatex/luamplib/releases/download/v2.12.0/luamplib.tds.zip

Then grab luamplib.{sty,lua} and drop them into current working directory.
Insert the following line in the preamble of source TeX file:

  \mplibglobaltextext{enable}

If no problem found, I will upload the new release to ctan in a few days.

-- 
Dohyun Kim
Seoul, Republic of Korea

From thenders at gmail.com  Thu Jun  1 19:00:26 2017
From: thenders at gmail.com (Troy Henderson)
Date: Thu, 1 Jun 2017 12:00:26 -0500
Subject: [luatex] Reusable Code (LuaLaTeX + LuaMPlib)
In-Reply-To: <CAFzmAm2dCFYqygu5ZTCyiPqVv+f55q6G13wO9q74bo+d-G5Hgg@mail.gmail.com>
References: <CAFP+xF+tk0GqzG3dLZis-fC9wNH5sOQxDEOivqovuTTWzMNRpw@mail.gmail.com>
 <CAFP+xFKSUx5FQnuXrfxhJYiNZwT8MujQiYo_P88+Kkf2oiR-=g@mail.gmail.com>
 <CAFzmAm2dCFYqygu5ZTCyiPqVv+f55q6G13wO9q74bo+d-G5Hgg@mail.gmail.com>
Message-ID: <CAFP+xFJfgoWEnAuAQ5n-NutXdvjqxBeP6Sz=OquXCFoM-9kDHA@mail.gmail.com>

This seems to work beautifully.  Thank you kindly.

Is there a way to "turn off"

\mplibcodeinherit{enable}
and
\mplibglobaltextext{enable}

mid-document?  That is, in order to create frame-by-frame animations,
inheriting code from the previous figure is necessary.  However, once the
animation is complete, it would be nice to be able to "initialize" MetaPost
by no longer inheriting the code.

Perhaps, something like \begin[continue]{mplibcode} ... \end{mplibcode}.

Thoughts?

Thank you in advance,

Troy
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20170601/cd67817e/attachment.html>

From nomosnomos at gmail.com  Fri Jun  2 02:11:10 2017
From: nomosnomos at gmail.com (Dohyun Kim)
Date: Fri, 2 Jun 2017 09:11:10 +0900
Subject: [luatex] Reusable Code (LuaLaTeX + LuaMPlib)
In-Reply-To: <CAFP+xFJfgoWEnAuAQ5n-NutXdvjqxBeP6Sz=OquXCFoM-9kDHA@mail.gmail.com>
References: <CAFP+xF+tk0GqzG3dLZis-fC9wNH5sOQxDEOivqovuTTWzMNRpw@mail.gmail.com>
 <CAFP+xFKSUx5FQnuXrfxhJYiNZwT8MujQiYo_P88+Kkf2oiR-=g@mail.gmail.com>
 <CAFzmAm2dCFYqygu5ZTCyiPqVv+f55q6G13wO9q74bo+d-G5Hgg@mail.gmail.com>
 <CAFP+xFJfgoWEnAuAQ5n-NutXdvjqxBeP6Sz=OquXCFoM-9kDHA@mail.gmail.com>
Message-ID: <CAFzmAm0eQUqxB_cJkG1+cA==Hp=ukx4Oavb1_C+0zmezLWmRZw@mail.gmail.com>

2017-06-02 2:00 GMT+09:00 Troy Henderson <thenders at gmail.com>:
> This seems to work beautifully.  Thank you kindly.
>
> Is there a way to "turn off"
>
> \mplibcodeinherit{enable}
> and
> \mplibglobaltextext{enable}
>
> mid-document?  That is, in order to create frame-by-frame animations,
> inheriting code from the previous figure is necessary.  However, once the
> animation is complete, it would be nice to be able to "initialize" MetaPost
> by no longer inheriting the code.
>
> Perhaps, something like \begin[continue]{mplibcode} ... \end{mplibcode}.
>
> Thoughts?
>

\mplibcodeinherit{disable}
\mplibglobaltextext{disable}
will work in the midst of the document as well as in the preamble.

-- 
Dohyun Kim
Seoul, Republic of Korea

From thenders at gmail.com  Fri Jun  2 02:14:15 2017
From: thenders at gmail.com (Troy Henderson)
Date: Thu, 1 Jun 2017 19:14:15 -0500
Subject: [luatex] Reusable Code (LuaLaTeX + LuaMPlib)
In-Reply-To: <CAFzmAm0eQUqxB_cJkG1+cA==Hp=ukx4Oavb1_C+0zmezLWmRZw@mail.gmail.com>
References: <CAFP+xF+tk0GqzG3dLZis-fC9wNH5sOQxDEOivqovuTTWzMNRpw@mail.gmail.com>
 <CAFP+xFKSUx5FQnuXrfxhJYiNZwT8MujQiYo_P88+Kkf2oiR-=g@mail.gmail.com>
 <CAFzmAm2dCFYqygu5ZTCyiPqVv+f55q6G13wO9q74bo+d-G5Hgg@mail.gmail.com>
 <CAFP+xFJfgoWEnAuAQ5n-NutXdvjqxBeP6Sz=OquXCFoM-9kDHA@mail.gmail.com>
 <CAFzmAm0eQUqxB_cJkG1+cA==Hp=ukx4Oavb1_C+0zmezLWmRZw@mail.gmail.com>
Message-ID: <CAFP+xFJK3OHyihz-d=Tex9CH1O7VMOpZM8xFSgWD7BGzKyHHqQ@mail.gmail.com>

>
> \mplibcodeinherit{disable}
> \mplibglobaltextext{disable}
> will work in the midst of the document as well as in the preamble.
>

Excellent.  Thank you kindly.

Troy
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20170601/8fc6240e/attachment.html>

From jfbu at free.fr  Fri Jun  2 12:10:05 2017
From: jfbu at free.fr (jfbu)
Date: Fri, 2 Jun 2017 12:10:05 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
Message-ID: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>

Hi,

a sample lua script runs twice slower with texlua of TL2017
than with the texlua from TL2016 and bare lua 5.3.3 I also
have on my mac os x 10.9.5

is this expected ?

$ time texlua collatz.lua 1 1000000
837799

real	0m39.053s
user	0m39.034s
sys	0m0.017s

$ time lua collatz.lua 1 1000000
837799

real	0m17.004s
user	0m16.991s
sys	0m0.006s

(actually I had gotten about 20s initially )

and:

$ time /usr/local/texlive/2016/bin/x86_64-darwin/texlua collatz.lua 1 1000000
837799

real	0m21.292s
user	0m21.271s
sys	0m0.012s

Thus the TL2017 texlua executes about 2x slower than the TL2016 one

I am on mac os x 10.9.5, 

$ cd `dirname $(which texlua)` && pwd -P
/usr/local/texlive/2017/bin/x86_64-darwinlegacy

$ lua -v
Lua 5.3.3  Copyright (C) 1994-2016 Lua.org, PUC-Rio

I also have a 
$ /usr/local/bin/lua -v
Lua 5.2.3  Copyright (C) 1994-2013 Lua.org, PUC-Rio

$ which -a lua
/sw/bin/lua
/usr/local/bin/lua

but I guess this is irrelevant to texlua.

This originates in this answer https://tex.stackexchange.com/a/372669/4686
and I copied the code into collatz.lua, for convenience here it is

---- start of lua script
function collatz_count(n, m)
    local function collatz_next(n)
        if ( n % 2 == 0 ) then
            return n / 2
        else
            return 3 * n + 1
        end
    end

    m = m or 1

    if ( n > 1 ) then
        return collatz_count( collatz_next(n), m + 1 )
    else
        return m
    end
end

function collatz_max_range(start, stop, count, len)
    count = count or 1
    len = len or start
    if start > stop then
        return len
    else
        if collatz_count(start) > count then
            return collatz_max_range(start+1, stop, collatz_count(start), start)
        else
            return collatz_max_range(start+1, stop, count, len)
        end
    end
end

print(collatz_max_range(tonumber(arg[1]),tonumber(arg[2])))

-- code de Henri Menke https://tex.stackexchange.com/a/372669/4686
---- end of lua script


I have observed in other occasions that my mac os x 10.9.5. laptop
has a tendency to have worse performances, in proportion, when
computation times run into the minute or so, compared to some
Linux box I access elsewhere. But here the problem is with comparison
of 2016 and 2017 situations and the fact that bare lua 5.3.3 interpreter
is faster.

Thanks,

Jean-Fran?ois








From jfbu at free.fr  Fri Jun  2 14:33:18 2017
From: jfbu at free.fr (jfbu)
Date: Fri, 2 Jun 2017 14:33:18 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
Message-ID: <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>

Hi,

my findings are ont reproduced on a Linux Box:

typically:

$ time /pathto/texlive/2016/bin/x86_64-linux/texlua collatz.lua 1 1000000
837799

real	0m23.755s
user	0m23.720s
sys	0m0.000s


and

$ time /pathto/texlive/2017/bin/x86_64-linux/texlua collatz.lua 1 1000000
837799

real	0m21.094s
user	0m21.080s
sys	0m0.000s


I don't have an independent Lua interpreter installed here.

And although timing varies up to 10%, it seems to the contrary the
TL2017 version is a bit faster here.

(TL2016 fully updated, TL2107 pretest fully updated)

I would be interested to here about other architectures.

Perhaps there is a special problem with x86_64-darwinlegacy ?

Should I move the thread to texlive ?

Best

Jean-Fran?ois



From herbs at wideopenwest.com  Fri Jun  2 14:51:15 2017
From: herbs at wideopenwest.com (Herbert Schulz)
Date: Fri, 2 Jun 2017 07:51:15 -0500
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
Message-ID: <0C716FF9-989F-4BE5-8C1F-FA2B80CD8C4E@wideopenwest.com>


> On Jun 2, 2017, at 5:10 AM, jfbu <jfbu at free.fr> wrote:
> 
> $ time texlua collatz.lua 1 1000000
> 837799
> 
> real	0m39.053s
> user	0m39.034s
> sys	0m0.017s
> 

Howdy,

I'm getting

$ time texlua collatz.lua 1 1000000
837799

real	0m17.333s
user	0m17.119s
sys	0m0.014s

using the x86_64-darwin (for macOS 10.10 and later) and TL 2017 (almost not pretest?).

Is there a reason you can't update to macOS 10.10 (Yosemite) and then use x86_64-darwin?

PS: I get

$ time lua collatz.lua 1 1000000
837799

real	0m19.021s
user	0m19.007s
sys	0m0.008s

with lua 5.3.4 on the same system.

Good Luck,

Herb Schulz
(herbs at wideopenwest dot com)



From jfbu at free.fr  Fri Jun  2 15:07:56 2017
From: jfbu at free.fr (jfbu)
Date: Fri, 2 Jun 2017 15:07:56 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <0C716FF9-989F-4BE5-8C1F-FA2B80CD8C4E@wideopenwest.com>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <0C716FF9-989F-4BE5-8C1F-FA2B80CD8C4E@wideopenwest.com>
Message-ID: <3379b92e-e31d-539c-87f5-442a81577af4@free.fr>

Hi Herb,



Le 02/06/2017 ? 14:51, Herbert Schulz a ?crit :
> 
>> On Jun 2, 2017, at 5:10 AM, jfbu <jfbu at free.fr> wrote:
>>
>> $ time texlua collatz.lua 1 1000000
>> 837799
>>
>> real	0m39.053s
>> user	0m39.034s
>> sys	0m0.017s
>>
> 
> Howdy,
> 
> I'm getting
> 
> $ time texlua collatz.lua 1 1000000
> 837799
> 
> real	0m17.333s
> user	0m17.119s
> sys	0m0.014s
> 
> using the x86_64-darwin (for macOS 10.10 and later) and TL 2017 (almost not pretest?).


ah! thanks! so there is possibly a problem indeed with x86_64-darwinlegacy

> 
> Is there a reason you can't update to macOS 10.10 (Yosemite) and then use x86_64-darwin?

1. I absolutely dislike the smart-phone looks which were introduced at Yosemite

2. my SSD is nearly saturated and I won't engage into risky system upgrade

I can imagining updating to a more recent macOS, but won't do only to
resolve a luatex binary issue.

> 
> PS: I get
> 
> $ time lua collatz.lua 1 1000000
> 837799
> 
> real	0m19.021s
> user	0m19.007s
> sys	0m0.008s
> 
> with lua 5.3.4 on the same system.


OK, thanks.

I had forgotten to say that I had tested with Lua 5.2 on my system
as well (don't remember the minor minor number) and got similar result
as with Lua 5.3.3, which are a bit faster than the TL2016 texlua

I expect other mac os users will be with x86_64-darwinlegacy.
A possibly 100% slow-down of luatex is perhaps not a big deal
if it happens only in directlua code.

Best,

Jean-Fran?ois




From pragma at wxs.nl  Fri Jun  2 15:15:53 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Fri, 2 Jun 2017 15:15:53 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
Message-ID: <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>

On 6/2/2017 2:33 PM, jfbu wrote:

> my findings are ont reproduced on a Linux Box:
> 
> typically:
> 
> $ time /pathto/texlive/2016/bin/x86_64-linux/texlua collatz.lua 1 1000000
> 837799
> 
> real	0m23.755s
> user	0m23.720s
> sys	0m0.000s
> 
> 
> and
> 
> $ time /pathto/texlive/2017/bin/x86_64-linux/texlua collatz.lua 1 1000000
> 837799
> 
> real	0m21.094s
> user	0m21.080s
> sys	0m0.000s
> 
> 
> I don't have an independent Lua interpreter installed here.
> 
> And although timing varies up to 10%, it seems to the contrary the
> TL2017 version is a bit faster here.
> 
> (TL2016 fully updated, TL2107 pretest fully updated)
> 
> I would be interested to here about other architectures.
> 
> Perhaps there is a special problem with x86_64-darwinlegacy ?
> 
> Should I move the thread to texlive ?
Some observations:

luatex mingw windows 64 bit  : 14.1
texlua native windows 64 bit : 13.8 (tex live version)
lua    native windows 64 bit : 13.6 (tex live version)
lua 5.1.4                    : 29.4 (luaforwindows)
lua 5.1.5                    : 38.3 (luaforwindows)

lua 5.2.4 bash on windows    : 15.5
luatex bash on windows       : 15.6

It probably all depends on optimization flags (and cpu cache and such) 
... as I do quite some performance tests I'd immediately notice if there 
was some mess up in the lua embedding in luatex (definitely if it were a 
factor 2). I actualy expect lua 5.3 to be somewhat slower than 5.2.

Now, as you want speed (for that kind of times probably not a good idea 
to do that runtime), you'd better optimize your lua code as without 
knowing what this code does (so i can be wrong), i can gain 40% without 
problem.

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From jfbu at free.fr  Fri Jun  2 15:26:02 2017
From: jfbu at free.fr (jfbu)
Date: Fri, 2 Jun 2017 15:26:02 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
Message-ID: <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>

Le 02/06/2017 ? 15:15, Hans Hagen a ?crit :
> do that runtime), you'd better optimize your lua code as without knowing

Hi Hans,

just to say that I reproduced Henri's code just to have
a stable base for testing, that he contributed the code
in a tex.sx answer I linked to, and that I don't know
if he has time to devote to optimizing the code: the
question was about how to do things in various ways,
how to set up the \directlua etc..., or possibly 
with pythontex or whatever.

on a light note,
I dearly hope Henri does not optimize, or change 
implementation, because 
currently my own plain TeX approach to the same
question on tex.sx is competitive with it.

Best,

Jean-Fran?ois



From pragma at wxs.nl  Fri Jun  2 15:39:22 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Fri, 2 Jun 2017 15:39:22 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
Message-ID: <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>

On 6/2/2017 3:26 PM, jfbu wrote:
> Le 02/06/2017 ? 15:15, Hans Hagen a ?crit :
>> do that runtime), you'd better optimize your lua code as without knowing
> 
> Hi Hans,
> 
> just to say that I reproduced Henri's code just to have
> a stable base for testing, that he contributed the code
> in a tex.sx answer I linked to, and that I don't know
> if he has time to devote to optimizing the code: the
> question was about how to do things in various ways,
> how to set up the \directlua etc..., or possibly
> with pythontex or whatever.
> 
> on a light note,
> I dearly hope Henri does not optimize, or change
> implementation, because
> currently my own plain TeX approach to the same
> question on tex.sx is competitive with it.
So you next challengs is to get the 99+% runtime gain I can get here (no 
big deal if memory is plenty).

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From jfbu at free.fr  Fri Jun  2 15:53:02 2017
From: jfbu at free.fr (jfbu)
Date: Fri, 2 Jun 2017 15:53:02 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
 <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
Message-ID: <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>


> So you next challengs is to get the 99+% runtime gain I can get here (no big deal if memory is plenty).

the challenge was to know if I would ever get interested into using
Luatex and this pretty much clinches it.

Waiting for Pythontex.

Good luck

Jean-Fran?ois



From jfbu at free.fr  Fri Jun  2 16:26:53 2017
From: jfbu at free.fr (jfbu)
Date: Fri, 2 Jun 2017 16:26:53 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
 <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
 <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>
Message-ID: <BA085EA4-FC84-4997-912C-6659FA2F5B29@free.fr>


> the challenge was to know if I would ever get interested into using
> Luatex and this pretty much clinches it.
> 
> Waiting for Pythontex.

and by the way, Hans, the code by Henri was but direct translation
into Lua, to provide an example to tex.sx user, of code by Joseph
which was couched in expl3 language

don't forget transmitting your optimized remarks to Joseph next
time you see him

regards,

Jean-Fran?ois



From pragma at wxs.nl  Fri Jun  2 18:05:28 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Fri, 2 Jun 2017 18:05:28 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <BA085EA4-FC84-4997-912C-6659FA2F5B29@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
 <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
 <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>
 <BA085EA4-FC84-4997-912C-6659FA2F5B29@free.fr>
Message-ID: <b5a6320e-afe3-775e-bde2-1c2da67a9513@wxs.nl>

On 6/2/2017 4:26 PM, jfbu wrote:
> 
>> the challenge was to know if I would ever get interested into using
>> Luatex and this pretty much clinches it.
>>
>> Waiting for Pythontex.
> 
> and by the way, Hans, the code by Henri was but direct translation
> into Lua, to provide an example to tex.sx user, of code by Joseph
> which was couched in expl3 language

Ah, ok, I'm not ok tex.sx. But Henry's posts to lists are always quite 
perfect. My main point was that when speed matters there's more than 
engine speed involved. (BTW, it's a known fact that some of the unix 
binaries on tl 2017 are twice as slow, Harald K noticed that and ran 
tests during BT 2017. It has to do with optimization flags.)

> don't forget transmitting your optimized remarks to Joseph next
> time you see him
I'm not into this expl3 (beyond me which is no problem as I don't need 
it) so I can't improve his code I bet.

Hans


-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From joseph.wright at morningstar2.co.uk  Fri Jun  2 18:10:05 2017
From: joseph.wright at morningstar2.co.uk (Joseph Wright)
Date: Fri, 2 Jun 2017 18:10:05 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <b5a6320e-afe3-775e-bde2-1c2da67a9513@wxs.nl>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
 <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
 <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>
 <BA085EA4-FC84-4997-912C-6659FA2F5B29@free.fr>
 <b5a6320e-afe3-775e-bde2-1c2da67a9513@wxs.nl>
Message-ID: <fc8c9d07-35e6-3409-a90e-87dd43327db4@morningstar2.co.uk>

On 02/06/2017 18:05, Hans Hagen wrote:
>> don't forget transmitting your optimized remarks to Joseph next
>> time you see him
> I'm not into this expl3 (beyond me which is no problem as I don't need
> it) so I can't improve his code I bet.

For raw speed in TeX, you will never do better than well-written
primitive code. The problem is looking after the code or for the
non-expert! (Look at Bruno's FPU or regex code: all as fast as it can
be, all *very* hairy to read.) And of course if one *knows* you are tied
to LuaTeX then some things will be faster/easier in Lua.

Joseph

From pragma at wxs.nl  Fri Jun  2 18:29:36 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Fri, 2 Jun 2017 18:29:36 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <fc8c9d07-35e6-3409-a90e-87dd43327db4@morningstar2.co.uk>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
 <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
 <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>
 <BA085EA4-FC84-4997-912C-6659FA2F5B29@free.fr>
 <b5a6320e-afe3-775e-bde2-1c2da67a9513@wxs.nl>
 <fc8c9d07-35e6-3409-a90e-87dd43327db4@morningstar2.co.uk>
Message-ID: <e0fe1973-6531-e1a8-df37-98e79760270e@wxs.nl>

On 6/2/2017 6:10 PM, Joseph Wright wrote:
> On 02/06/2017 18:05, Hans Hagen wrote:
>>> don't forget transmitting your optimized remarks to Joseph next
>>> time you see him
>> I'm not into this expl3 (beyond me which is no problem as I don't need
>> it) so I can't improve his code I bet.
> 
> For raw speed in TeX, you will never do better than well-written
> primitive code. The problem is looking after the code or for the
> non-expert! (Look at Bruno's FPU or regex code: all as fast as it can
> be, all *very* hairy to read.) And of course if one *knows* you are tied
> to LuaTeX then some things will be faster/easier in Lua.
sure, and i'm pretty well aware of how to optimize primitive code, but 
as yopu say reading someone else's (esp optimized) code is a pain and 
for me it's more fun to write from scratch anyway as that's the only way 
i can make myself understand things

(btw, i'm occasionally surprised that what i thought was 'as fast as can 
be' could be made 'even faster')

(and not all is faster in lua as tex itself is pretty fast; not that i'm 
disappointed by lua)

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From listwatch at moss.in-berlin.de  Sat Jun  3 01:22:33 2017
From: listwatch at moss.in-berlin.de (Martin Wilhelm Leidig)
Date: Sat, 3 Jun 2017 01:22:33 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <e0fe1973-6531-e1a8-df37-98e79760270e@wxs.nl>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
 <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
 <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>
 <BA085EA4-FC84-4997-912C-6659FA2F5B29@free.fr>
 <b5a6320e-afe3-775e-bde2-1c2da67a9513@wxs.nl>
 <fc8c9d07-35e6-3409-a90e-87dd43327db4@morningstar2.co.uk>
 <e0fe1973-6531-e1a8-df37-98e79760270e@wxs.nl>
Message-ID: <A7AC9849-DB61-4996-9DBB-B318D77CFC01@moss.in-berlin.de>


> Am 2017-06-02 um 18.29 schrieb Hans Hagen <pragma at wxs.nl>:
> 
> not all is faster in lua as tex itself is pretty fast; not that i'm disappointed by lua

May I make a t-shirt from that?


? mit freundlichem Gru?:

-Moss-
--
Martin Wilhelm Leidig, SatzTeXnik
Dante e. V. #1580



-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: Message signed with OpenPGP using GPGMail
URL: <http://tug.org/pipermail/luatex/attachments/20170603/1039521d/attachment.sig>

From mojca.miklavec.lists at gmail.com  Sat Jun  3 10:00:02 2017
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Sat, 3 Jun 2017 10:00:02 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <3379b92e-e31d-539c-87f5-442a81577af4@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <0C716FF9-989F-4BE5-8C1F-FA2B80CD8C4E@wideopenwest.com>
 <3379b92e-e31d-539c-87f5-442a81577af4@free.fr>
Message-ID: <CALBOmsYSDjfbR=5Hb9691sRZ9zPFBBNpLwr5z6OT2JdE9RxHkA@mail.gmail.com>

On 2 June 2017 at 15:07, jfbu wrote:
> Hi Herb,
>
> Le 02/06/2017 ? 14:51, Herbert Schulz a ?crit :
>>> On Jun 2, 2017, at 5:10 AM, jfbu wrote:
>>>
>>> $ time texlua collatz.lua 1 1000000
>>> 837799
>>>
>>> real 0m39.053s
>>> user 0m39.034s
>>> sys  0m0.017s
>>>
>>
>> Howdy,
>>
>> I'm getting
>>
>> $ time texlua collatz.lua 1 1000000
>> 837799
>>
>> real  0m17.333s
>> user  0m17.119s
>> sys   0m0.014s
>>
>> using the x86_64-darwin (for macOS 10.10 and later) and TL 2017 (almost not pretest?).
>
> ah! thanks! so there is possibly a problem indeed with x86_64-darwinlegacy

The x86_64-darwinlegacy binaries were compiled with gcc 4.2 on 10.6
and most likely without any substantial audience of testers.

The x86_64-darwin binaries were compiled with clang on 10.10.

We had a similar issue with i386-linux binaries being roughly 100%
slower only due to some optimisation flags, it might be possible that
changing some compiler flags or switching to a more modern compiler
would help.

It would be interesting to compare time of execution of your script on
the same machine using:
- 2016/x86_64-darwin
- 2017/x86_64-darwin
- 2017/x86_64-darwinlegacy
- 2017 luatex that you compile yourself
and then perhaps some or all of these once again with texluajit.

If only 2017/x86_64-darwinlegacy is 2 times slower, I'm sure we'll
find a cure, any help or testing appreciated. It's no problem to
replace the binaries (after TL 17 release) with faster ones if we
figure out what exactly to do.

> I expect other mac os users will be with x86_64-darwinlegacy.
> A possibly 100% slow-down of luatex is perhaps not a big deal
> if it happens only in directlua code.

It should not be a dealbreaker in any case. (It's just a small price
to pay for not upgrading your OS :)

Mojca


From jfbu at free.fr  Sat Jun  3 12:34:53 2017
From: jfbu at free.fr (jfbu)
Date: Sat, 3 Jun 2017 12:34:53 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <CALBOmsYSDjfbR=5Hb9691sRZ9zPFBBNpLwr5z6OT2JdE9RxHkA@mail.gmail.com>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <0C716FF9-989F-4BE5-8C1F-FA2B80CD8C4E@wideopenwest.com>
 <3379b92e-e31d-539c-87f5-442a81577af4@free.fr>
 <CALBOmsYSDjfbR=5Hb9691sRZ9zPFBBNpLwr5z6OT2JdE9RxHkA@mail.gmail.com>
Message-ID: <B6C40ABD-723F-4D0E-8F96-5AF9CEAFE191@free.fr>


Le 3 juin 2017 ? 10:00, Mojca Miklavec <mojca.miklavec.lists at gmail.com> a ?crit :

> It would be interesting to compare time of execution of your script on
> the same machine using:
> - 2016/x86_64-darwin
> - 2017/x86_64-darwin
> - 2017/x86_64-darwinlegacy

I guess I can't run x86_64-darwin binaries on my 10.9.5 ? and I don't have
another machine available

> - 2017 luatex that you compile yourself

Not so interested into devoting the time as I reported the issue
only as an act of goodwill, not being a user of Luatex myself.

> and then perhaps some or all of these once again with texluajit.

According to H. M. at the original tex.sx thread I linked to,
substantial speed gain indeed.

(incidentally his machine is about 2x, 2.5x faster than mine.)

Best,

Jean-Fran?ois

From patrick at gundla.ch  Sat Jun  3 22:11:07 2017
From: patrick at gundla.ch (Patrick Gundlach)
Date: Sat, 3 Jun 2017 22:11:07 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
Message-ID: <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>

Hi,

> a sample lua script runs twice slower with texlua of TL2017
> than with the texlua from TL2016 and bare lua 5.3.3 I also
> have on my mac os x 10.9.5


I am not sure if this is still relevant (I haven't followed the whole discussion). Anyway: on my system (latest Mac Laptop with up to date software) I have the same results with tl2017 and tl2016 (minor differences of course):


$ time texlua collatz.lua 

real	0m14.837s
user	0m14.552s
sys	0m0.106s

$ time texluajit collatz.lua 

real	0m10.231s
user	0m10.205s
sys	0m0.012s

(similar with LuaLaTeX and LuajitLaTeX)

Patrick



From dirk.laurie at gmail.com  Sun Jun  4 13:26:31 2017
From: dirk.laurie at gmail.com (Dirk Laurie)
Date: Sun, 4 Jun 2017 13:26:31 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
Message-ID: <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>

2017-06-03 22:11 GMT+02:00 Patrick Gundlach <patrick at gundla.ch>:

>> a sample lua script runs twice slower with texlua of TL2017
>> than with the texlua from TL2016 and bare lua 5.3.3 I also
>> have on my mac os x 10.9.5
>
>
> I am not sure if this is still relevant (I haven't followed the whole discussion). Anyway: on my system (latest Mac Laptop with up to date software) I have the same results with tl2017 and tl2016 (minor differences of course):
>
>
> $ time texlua collatz.lua
>
> real    0m14.837s
> user    0m14.552s
> sys     0m0.106s
>
> $ time texluajit collatz.lua
>
> real    0m10.231s
> user    0m10.205s
> sys     0m0.012s

I don't think it is a fair or even relevant test of texlua to use it on
a CPU-intensive job involving no string processing whatsover,
especially one that is easy and natural to do directly in C.

texlua is not the reason why luatex exists, it is just a convenient
add-on so that you do not need an independent Lua installation
for the auxiliary scripts you may need to produce a beautiful
document using TeX.

In fact, texlua is not a separate program at all, it is luatex with
certain options deduced from the name by which it is called.
luatex called on a file with extension .lua does exactly the same
job.

Its main attraction over native Lua is that so many batteries are
included ? zip, gzip, mime, socket, unicode etc.

Its main disadvantage is that it does not provide a Lua REPL.
You must save your Lua code in a file. That must have been
a design decision years ago. I wonder what the reasons were,
and whether they are still as cogent now as then.


From eduardoochs at gmail.com  Sun Jun  4 13:59:00 2017
From: eduardoochs at gmail.com (Eduardo Ochs)
Date: Sun, 4 Jun 2017 08:59:00 -0300
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
Message-ID: <CADs++6jWj0EF2H65zCZs7Yf4UqEihN-Q0AvGhzYoYdAhWoOLiA@mail.gmail.com>

One or two years ago I integrated Rob Hoelz's lua-repl

  https://github.com/hoelzro/lua-repl/

with lualatex. It was not trivial, but after doing that I could start
the REPL from any point in a .tex file just by putting a "\repl" at
the right place.

If there's interest I can try to pack and document what I did.

  Cheers,
    Eduardo Ochs
    http://angg.twu.net/
    http://angg.twu.net/luatex.html


On Sun, Jun 4, 2017 at 8:26 AM, Dirk Laurie <dirk.laurie at gmail.com> wrote:
> 2017-06-03 22:11 GMT+02:00 Patrick Gundlach <patrick at gundla.ch>:
>
>>> a sample lua script runs twice slower with texlua of TL2017
>>> than with the texlua from TL2016 and bare lua 5.3.3 I also
>>> have on my mac os x 10.9.5
>>
>>
>> I am not sure if this is still relevant (I haven't followed the whole discussion). Anyway: on my system (latest Mac Laptop with up to date software) I have the same results with tl2017 and tl2016 (minor differences of course):
>>
>>
>> $ time texlua collatz.lua
>>
>> real    0m14.837s
>> user    0m14.552s
>> sys     0m0.106s
>>
>> $ time texluajit collatz.lua
>>
>> real    0m10.231s
>> user    0m10.205s
>> sys     0m0.012s
>
> I don't think it is a fair or even relevant test of texlua to use it on
> a CPU-intensive job involving no string processing whatsover,
> especially one that is easy and natural to do directly in C.
>
> texlua is not the reason why luatex exists, it is just a convenient
> add-on so that you do not need an independent Lua installation
> for the auxiliary scripts you may need to produce a beautiful
> document using TeX.
>
> In fact, texlua is not a separate program at all, it is luatex with
> certain options deduced from the name by which it is called.
> luatex called on a file with extension .lua does exactly the same
> job.
>
> Its main attraction over native Lua is that so many batteries are
> included ? zip, gzip, mime, socket, unicode etc.
>
> Its main disadvantage is that it does not provide a Lua REPL.
> You must save your Lua code in a file. That must have been
> a design decision years ago. I wonder what the reasons were,
> and whether they are still as cogent now as then.
>


From pragma at wxs.nl  Sun Jun  4 14:46:58 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Sun, 4 Jun 2017 14:46:58 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <A7AC9849-DB61-4996-9DBB-B318D77CFC01@moss.in-berlin.de>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <a70fbec7-77ef-2022-3e57-13f8cf986a80@free.fr>
 <92b7390b-6541-e4aa-81bf-76fa929f2029@wxs.nl>
 <8286bcb5-f4ac-44ce-809a-0cad2b44c99b@free.fr>
 <2958a0e5-c4fe-db07-99cc-322d48786cd1@wxs.nl>
 <484c2486-c1d4-4155-3a6d-d0f72e101388@free.fr>
 <BA085EA4-FC84-4997-912C-6659FA2F5B29@free.fr>
 <b5a6320e-afe3-775e-bde2-1c2da67a9513@wxs.nl>
 <fc8c9d07-35e6-3409-a90e-87dd43327db4@morningstar2.co.uk>
 <e0fe1973-6531-e1a8-df37-98e79760270e@wxs.nl>
 <A7AC9849-DB61-4996-9DBB-B318D77CFC01@moss.in-berlin.de>
Message-ID: <f59bae1c-1267-894d-5178-a19d8fbf7d79@wxs.nl>

On 6/3/2017 1:22 AM, Martin Wilhelm Leidig wrote:
> 
>> Am 2017-06-02 um 18.29 schrieb Hans Hagen <pragma at wxs.nl>:
>>
>> not all is faster in lua as tex itself is pretty fast; not that i'm disappointed by lua
> 
> May I make a t-shirt from that?
sure

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From patrick at gundla.ch  Sun Jun  4 20:34:12 2017
From: patrick at gundla.ch (Patrick Gundlach)
Date: Sun, 4 Jun 2017 20:34:12 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
Message-ID: <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>


> Am 04.06.2017 um 13:26 schrieb Dirk Laurie <dirk.laurie at gmail.com>:
> 
> 2017-06-03 22:11 GMT+02:00 Patrick Gundlach <patrick at gundla.ch>:
> 
>>> a sample lua script runs twice slower with texlua of TL2017
>>> than with the texlua from TL2016 and bare lua 5.3.3 I also
>>> have on my mac os x 10.9.5
>> 
>> 
>> I am not sure if this is still relevant (I haven't followed the whole discussion). Anyway: on my system (latest Mac Laptop with up to date software) I have the same results with tl2017 and tl2016 (minor differences of course):
>> 
>> 
>> $ time texlua collatz.lua
>> 
>> real    0m14.837s
>> user    0m14.552s
>> sys     0m0.106s
>> 
>> $ time texluajit collatz.lua
>> 
>> real    0m10.231s
>> user    0m10.205s
>> sys     0m0.012s
> 
> I don't think it is a fair or even relevant test of texlua to use it on
> a CPU-intensive job involving no string processing whatsover,
> especially one that is easy and natural to do directly in C.


...


I don't understand your comment, could you elaborate?

I just wanted to state that tl2016 and tl2017 have the same processing time, with and without jit.


Patrick



From mojca.miklavec.lists at gmail.com  Sun Jun  4 21:02:21 2017
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Sun, 4 Jun 2017 21:02:21 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
Message-ID: <CALBOmsYXFRvUMReLNkn+oe-TFYHE7oOG91MVkDNSc+TieD0uYA@mail.gmail.com>

On 3 June 2017 at 22:11, Patrick Gundlach wrote:
> Hi,
>
>> a sample lua script runs twice slower with texlua of TL2017
>> than with the texlua from TL2016 and bare lua 5.3.3 I also
>> have on my mac os x 10.9.5
>
> I am not sure if this is still relevant (I haven't followed the whole discussion). Anyway: on my system (latest Mac Laptop with up to date software) I have the same results with tl2017 and tl2016 (minor differences of course):
>
> $ time texlua collatz.lua
>
> real    0m14.837s
> user    0m14.552s
> sys     0m0.106s
>
> $ time texluajit collatz.lua
>
> real    0m10.231s
> user    0m10.205s
> sys     0m0.012s
>
> (similar with LuaLaTeX and LuajitLaTeX)

Thank you, so this confirms that it's only a problem of the
darwinlegacy version of the binary.
But Dick compiled luatex with the same compiler on the same OS version
last year, only using slightly different environmental variables (or
perhaps no variables at all; I was setting all the [OBJ]C[XX]FLAGS
with arch flags etc.).

Bonus question: what exactly is so special / what should be changed?

This calls for a bunch of further tests:

- just in case, testing i386-darwin and x86_64-darwin legacy from 2017
and universal-darwin from 2016 on the same machine (> 10.9) as the
tests done above

- compile LuaTeX from TL 2017 on 10.6 in various ways: with clang 4.0,
apple-gcc 4.2, gcc 4.7, gcc 7.1; with and without any flags; compare
the speed

- maybe try to compile lua alone with those same compiler first and
try to figure out if one can reproduce the problem with the bare lua
interpreter (this would simplify testing a lot)

... keeping in mind that we'll probably need a C++11-capable compiler
next year anyway, so any tests with gcc 4.2 will probably be
irrelevant next year anyway.

I'll try to compile with clang 4.0 first just to see what difference
that makes. But I suspect that setting C[XX]FLAGS explicitly most
likely replaces some optimisation flags somewhere.

I probably won't be able to do all that extensive analysis soon, so if
there are any volunteers interested in digging further, your help will
be greatly appreciated.

Mojca

From dirk.laurie at gmail.com  Sun Jun  4 22:19:11 2017
From: dirk.laurie at gmail.com (Dirk Laurie)
Date: Sun, 4 Jun 2017 22:19:11 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
Message-ID: <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>

2017-06-04 20:34 GMT+02:00 Patrick Gundlach <patrick at gundla.ch>:
>
>> Am 04.06.2017 um 13:26 schrieb Dirk Laurie <dirk.laurie at gmail.com>:
>>
>> 2017-06-03 22:11 GMT+02:00 Patrick Gundlach <patrick at gundla.ch>:
>>
>>>> a sample lua script runs twice slower with texlua of TL2017
>>>> than with the texlua from TL2016 and bare lua 5.3.3 I also
>>>> have on my mac os x 10.9.5
>>>
>>>
>>> I am not sure if this is still relevant (I haven't followed the whole discussion). Anyway: on my system (latest Mac Laptop with up to date software) I have the same results with tl2017 and tl2016 (minor differences of course):
>>>
>>>
>>> $ time texlua collatz.lua
>>>
>>> real    0m14.837s
>>> user    0m14.552s
>>> sys     0m0.106s
>>>
>>> $ time texluajit collatz.lua
>>>
>>> real    0m10.231s
>>> user    0m10.205s
>>> sys     0m0.012s
>>
>> I don't think it is a fair or even relevant test of texlua to use it on
>> a CPU-intensive job involving no string processing whatsover,
>> especially one that is easy and natural to do directly in C.
>
> I don't understand your comment, could you elaborate?
>
> I just wanted to state that tl2016 and tl2017 have the same processing
> time, with and without jit.

Sorry, my post was a comment on this whole thread, not
specifically your contribution.

The OP has already stated that he is not a LuaTex user, does not
plan to become one, and only raised the issue "as an act of goodwill".

My point is that to criticize the tl2017 LuaTex implementation on the
grounds that it does not perform as well on collatz.lua as tl2016 did,
is not merely wrong because it is one test on one machine, but more
universally because a CPU-intensive task involving no text processing
whatsoever is not representative of what LuaTex is designed for.

In other words, the issue is a non-issue not worth the time several
respected LuaTex experts are putting into it.

From thenders at gmail.com  Mon Jun  5 23:39:54 2017
From: thenders at gmail.com (Troy Henderson)
Date: Mon, 5 Jun 2017 16:39:54 -0500
Subject: [luatex] Reusable Code (LuaLaTeX + LuaMPlib)
In-Reply-To: <CAFzmAm2dCFYqygu5ZTCyiPqVv+f55q6G13wO9q74bo+d-G5Hgg@mail.gmail.com>
References: <CAFP+xF+tk0GqzG3dLZis-fC9wNH5sOQxDEOivqovuTTWzMNRpw@mail.gmail.com>
 <CAFP+xFKSUx5FQnuXrfxhJYiNZwT8MujQiYo_P88+Kkf2oiR-=g@mail.gmail.com>
 <CAFzmAm2dCFYqygu5ZTCyiPqVv+f55q6G13wO9q74bo+d-G5Hgg@mail.gmail.com>
Message-ID: <CAFP+xFJ1PsKrU8VCOPZE8T08ksVTYWx90UiF9OPt0tyFF=FgOw@mail.gmail.com>

>
> Please download and unzip:
>
>   https://github.com/lualatex/luamplib/releases/download/v2.
> 12.0/luamplib.tds.zip
>
> Then grab luamplib.{sty,lua} and drop them into current working directory.
>

Placing luamplib.{sty,lua} in the current working directory works fine, but
I've tried replacing luamplib.{sty,lua} in the TeX Live 2017 directory (so
that the feature would be available globally), and it does not seem to
impact the output.  Is there an "update" command needed to "refresh" LuaTeX?

Troy
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20170605/ff9a7050/attachment.html>

From rpspringuel at gmail.com  Tue Jun  6 21:02:42 2017
From: rpspringuel at gmail.com (Br. Samuel Springuel)
Date: Tue, 6 Jun 2017 15:02:42 -0400
Subject: [luatex] Strange behavior for io.popen
Message-ID: <176ba1d4-a68c-262a-f1b9-960a817a3f82@gmail.com>

In working with the TeXLive 2017 pretest, we (the Gregorio developers) 
came across what appears to be a bug in io.popen: it's passing the 
statement `all commands are permitted` to the sh instance that it was 
creating, resulting in an `all: command not found` error.  After some 
considerable testing (see conversation here: 
https://github.com/gregorio-project/gregorio/issues/1362), we isolated 
the problem to the `--shell-escape` switch.  If the simple document 
below is compiled *without* the switch, it is behaves as expected and is 
able to retrieve the gregorio version number (gregorio is on the list of 
commands permitted without shell-escape in texmf.cnf for TeXLive 2017). 
When compiled with the switch, however, the error crops up and the 
document reads `l is nil`.


```
\documentclass{article}
\begin{document}
\directlua{
     f = io.popen('gregorio --version', 'r')
     if f then
         l = f:read('*l')
         if l then
             tex.print('got '..l)
         else
             tex.print('l is nil')
         end
     else
         tex.print('f is nil')
     end
}
\end{document}
```

Besides the original Ubuntu 16.04 system this was seen on, we've also 
been able to confirm it on Gentoo, Mac 10.10 (Yosemite), and Windows 10 
and so believe the problem to be platform independent.

-- 
?????????????????????????
Br. Samuel, OSB
St. Anselm?s Abbey
Washington, DC
(R. Padraic Springuel)

PAX ? ???????

From d.p.carlisle at gmail.com  Tue Jun  6 22:57:46 2017
From: d.p.carlisle at gmail.com (David Carlisle)
Date: Tue, 6 Jun 2017 21:57:46 +0100
Subject: [luatex] Strange behavior for io.popen
In-Reply-To: <176ba1d4-a68c-262a-f1b9-960a817a3f82@gmail.com>
References: <176ba1d4-a68c-262a-f1b9-960a817a3f82@gmail.com>
Message-ID: <CAEW6iOgD+qouP=pFwMHGGZRup=KCn5us0VVQfYAkjKxF4TYtGA@mail.gmail.com>

On 6 June 2017 at 20:02, Br. Samuel Springuel <rpspringuel at gmail.com> wrote:

>
> Besides the original Ubuntu 16.04 system this was seen on, we've also been
> able to confirm it on Gentoo, Mac 10.10 (Yosemite), and Windows 10 and so
> believe the problem to be platform independent.
>
>
same in cygwin, here's a plain tex example

\directlua{
 f = io.popen('cd', 'r')
}
\bye

which produces


This is LuaTeX, Version 1.0.5 (TeX Live 2017)
 system commands enabled.
(./file.tex)
warning  (pdf backend): no pages of output.
Transcript written on file.log.
/bin/sh: all: command not found
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20170606/a36e061b/attachment.html>

From dirk.laurie at gmail.com  Wed Jun  7 07:20:38 2017
From: dirk.laurie at gmail.com (Dirk Laurie)
Date: Wed, 7 Jun 2017 07:20:38 +0200
Subject: [luatex] Strange behavior for io.popen
In-Reply-To: <CAEW6iOgD+qouP=pFwMHGGZRup=KCn5us0VVQfYAkjKxF4TYtGA@mail.gmail.com>
References: <176ba1d4-a68c-262a-f1b9-960a817a3f82@gmail.com>
 <CAEW6iOgD+qouP=pFwMHGGZRup=KCn5us0VVQfYAkjKxF4TYtGA@mail.gmail.com>
Message-ID: <CABcj=tnE0EDFS0v+jgSiZ3dNby_Oer1q7RMpAU-LMNsCUnSKmg@mail.gmail.com>

2017-06-06 22:57 GMT+02:00 David Carlisle <d.p.carlisle at gmail.com>:
>
>
> On 6 June 2017 at 20:02, Br. Samuel Springuel <rpspringuel at gmail.com> wrote:
>>
>>
>> Besides the original Ubuntu 16.04 system this was seen on, we've also been
>> able to confirm it on Gentoo, Mac 10.10 (Yosemite), and Windows 10 and so
>> believe the problem to be platform independent.
>>
>
> same in cygwin, here's a plain tex example
>
> \directlua{
>  f = io.popen('cd', 'r')
> }
> \bye
>
> which produces
>
>
> This is LuaTeX, Version 1.0.5 (TeX Live 2017)
>  system commands enabled.
> (./file.tex)
> warning  (pdf backend): no pages of output.
> Transcript written on file.log.
> /bin/sh: all: command not found

'cd' is not a program that can be started in a separated process,
it is a shell builtin command. Do you get the same with 'ls'?

From luigi.scarso at gmail.com  Wed Jun  7 07:49:20 2017
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 7 Jun 2017 07:49:20 +0200
Subject: [luatex] Strange behavior for io.popen
In-Reply-To: <CAEW6iOgD+qouP=pFwMHGGZRup=KCn5us0VVQfYAkjKxF4TYtGA@mail.gmail.com>
References: <176ba1d4-a68c-262a-f1b9-960a817a3f82@gmail.com>
 <CAEW6iOgD+qouP=pFwMHGGZRup=KCn5us0VVQfYAkjKxF4TYtGA@mail.gmail.com>
Message-ID: <CAG5iGsChgAbUD44uhRL7NhD84GerCzhchWkFoUpzUumJmGXWYA@mail.gmail.com>

On Tue, Jun 6, 2017 at 10:57 PM, David Carlisle <d.p.carlisle at gmail.com> wrote:
>
>
> On 6 June 2017 at 20:02, Br. Samuel Springuel <rpspringuel at gmail.com> wrote:
>>
>>
>> Besides the original Ubuntu 16.04 system this was seen on, we've also been
>> able to confirm it on Gentoo, Mac 10.10 (Yosemite), and Windows 10 and so
>> believe the problem to be platform independent.
>>
>
> same in cygwin, here's a plain tex example
>
> \directlua{
>  f = io.popen('cd', 'r')
> }
> \bye
>
> which produces
>
>
> This is LuaTeX, Version 1.0.5 (TeX Live 2017)
>  system commands enabled.
> (./file.tex)
> warning  (pdf backend): no pages of output.
> Transcript written on file.log.
> /bin/sh: all: command not found
>
>

yes, seen.
You can temporary put
io.popen = io.saved_popen
I will fix it asap.



-- 
luigi

From jfbu at free.fr  Wed Jun  7 08:46:28 2017
From: jfbu at free.fr (jfbu)
Date: Wed, 7 Jun 2017 08:46:28 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
Message-ID: <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>


> In other words, the issue is a non-issue not worth the time several
> respected LuaTex experts are putting into it.

Hi list,

should I conclude that the LuaTeX experts are not the least
bit interested into understanding which compilation flags
were modified and resulted in a texlua twice slower 
on macOS 10.9.5 with TeXLive 2017 release than it was
with TeXLive 2016 for the same machine?

should I conclude it is _my fault_ to have reported this
FACT at the initial message of this thread?

did I receive appropriate answers when Hans Hagen
only reaction was to tell that my code (which
I said explicitely was NOT MY CODE) was crap and
could be sped up 99%, which was NOT my question?
NOT MY CODE, NOT MY ALGORITHM, NOT MY BINARY.

It was the first ever time I ever ran texlua. Next time
you run some software on your machine and find that
between version 2016 and version 2017 its execution
speed has increased 100% maybe you will consider that
the experts of this software "put some time into understanding
the cause",

Jean-Fran?ois




From jfbu at free.fr  Wed Jun  7 08:50:20 2017
From: jfbu at free.fr (jfbu)
Date: Wed, 7 Jun 2017 08:50:20 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
Message-ID: <283250A5-753F-4562-A4E1-948D1BFC4921@free.fr>



> between version 2016 and version 2017 its execution
> speed has increased 100% maybe you will consider that

execution time... although it could sort of make sens
with speed as well.


From luigi.scarso at gmail.com  Wed Jun  7 09:23:43 2017
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 7 Jun 2017 09:23:43 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
Message-ID: <CAG5iGsA=pPDp0svumXQkA7HXJYHWF594Jb-RN2ByUpC=K=Bf0w@mail.gmail.com>

On Wed, Jun 7, 2017 at 8:46 AM, jfbu <jfbu at free.fr> wrote:
>
> should I conclude that the LuaTeX experts are not the least
> bit interested into understanding which compilation flagsThe crucial point is that the same code has very different time of execution on a specific
platform, which should exclude that the problem i

> were modified and resulted in a texlua twice slower
> on macOS 10.9.5 with TeXLive 2017 release than it was
> with TeXLive 2016 for the same machine?
We care about these facts. Usually we test under linux & windows,
and the results are usually confirmed  also for macos.
We have not noticed slowdown.
>
> should I conclude it is _my fault_ to have reported this
> FACT at the initial message of this thread?
no, it's ok, we can keep track that there could be  a problem with
x86_64-darwinlegacy.  The next step is how to compile a
x86_64-darwinlegacy binary with the same optimization flags that I use
for luatex under x86_64-linux
(as already said, these flags can change in texlive, as happened for i386-linux)


>
> did I receive appropriate answers when Hans Hagen
> only reaction was to tell that my code (which
> I said explicitely was NOT MY CODE) was crap and
> could be sped up 99%, which was NOT my question?
> NOT MY CODE, NOT MY ALGORITHM, NOT MY BINARY.
hm no, the point of Hans is more general, not directly tied to this
case: better to  optimize
lua code, because is very  easy to quickly write  slow lua code.
This case is different, and it's not important if  it's good or bad code.



-- 
luigi

From pragma at wxs.nl  Wed Jun  7 09:58:51 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Wed, 7 Jun 2017 09:58:51 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
Message-ID: <2548412a-4c72-4085-6268-1a43d76f1f6b@wxs.nl>

On 6/7/2017 8:46 AM, jfbu wrote:
> 
>> In other words, the issue is a non-issue not worth the time several
>> respected LuaTex experts are putting into it.
> 
> Hi list,
> 
> should I conclude that the LuaTeX experts are not the least
> bit interested into understanding which compilation flags
> were modified and resulted in a texlua twice slower
> on macOS 10.9.5 with TeXLive 2017 release than it was
> with TeXLive 2016 for the same machine?

indeed, as these experts are not going to check compilation other than 
on their own machines ... compilation elsewhere is 'derived work'

(and fwiw, we'd observed 50% slower linux 32 bit versions versions a 
month ago at BT and were only mildly puzzled .. and those were all 
experts running 64 bit, so there was no reasson for panick)

> should I conclude it is _my fault_ to have reported this
> FACT at the initial message of this thread?
> 
> did I receive appropriate answers when Hans Hagen
> only reaction was to tell that my code (which
> I said explicitely was NOT MY CODE) was crap and
> could be sped up 99%, which was NOT my question?
> NOT MY CODE, NOT MY ALGORITHM, NOT MY BINARY.

i never said it was crap, i only said that (and i'm talking of years of 
using luatex) it often more pays of to optimize code (which in this case 
was possible, and normally is even fun to do) than to squeeze out some 
more from compilation (and even more if you're bound to a specific binary)

i don't see why yuou should get pissed about this ... i'm pretty sure 
that henry (whose code it was and who knows tex/lua very well) is 
interested in possible speed ups (if it were important at all)

in this case the 50% slow down was a compilation issue but normally 
we're talking of 5% fluctuations (in which case optimizing can pay of)

also, there have been answers about possible causes but as tex live 2017 
is frozen one has to live with what's there (or update in a few months 
when updates become available)

in fact, what bothers me more is that one lets people look into this 
(and therefore waste their time) while in fact the choice is then 
something python and tex (if i understood well) and lua was just a side 
track

(it's like users asking for a feature and then not testing it due to 
lack of time or whatever)

> It was the first ever time I ever ran texlua. Next time
> you run some software on your machine and find that
> between version 2016 and version 2017 its execution
> speed has increased 100% maybe you will consider that
> the experts of this software "put some time into understanding
> the cause",
it is no secret that there are speed differences between compilations, 
and if you mean with 'experts' those who develop luatex, indeed we're 
not that much interested because we compile for windows and linux and if 
that's okay, it's out of our hands and up to those who compile 
themselves and / or distributors and you cannot expect us to spent time 
on that

(for us the benchmark compilations are those on the context garden 
compile farm and you can bet that when there is a slow binary there 
we'll hear about it)

(btw, in the early days, cpu cache was a bottleneck)

(i've reported several times about speed related issues and luatex in 
the last decade but probably not in places and journals that you read)

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From d.p.carlisle at gmail.com  Wed Jun  7 10:03:45 2017
From: d.p.carlisle at gmail.com (David Carlisle)
Date: Wed, 7 Jun 2017 09:03:45 +0100
Subject: [luatex] Strange behavior for io.popen
In-Reply-To: <CABcj=tnE0EDFS0v+jgSiZ3dNby_Oer1q7RMpAU-LMNsCUnSKmg@mail.gmail.com>
References: <176ba1d4-a68c-262a-f1b9-960a817a3f82@gmail.com>
 <CAEW6iOgD+qouP=pFwMHGGZRup=KCn5us0VVQfYAkjKxF4TYtGA@mail.gmail.com>
 <CABcj=tnE0EDFS0v+jgSiZ3dNby_Oer1q7RMpAU-LMNsCUnSKmg@mail.gmail.com>
Message-ID: <CAEW6iOix6BQ+BYPEJTQ3fhiUbaR2AKr+tANpO5jO3=nkHKt6HA@mail.gmail.com>

On 7 June 2017 at 06:20, Dirk Laurie <dirk.laurie at gmail.com> wrote:

>
>
> 'cd' is not a program that can be started in a separated process,
> it is a shell builtin command. Do you get the same with 'ls'?
>

ah true, I was trying to think of a command name available also in windows,
so same test would work there:-)
As Luigi has confirmed you get it for any command.

David
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20170607/cd03bead/attachment.html>

From pragma at wxs.nl  Wed Jun  7 10:43:25 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Wed, 7 Jun 2017 10:43:25 +0200
Subject: [luatex] Strange behavior for io.popen
In-Reply-To: <CAEW6iOix6BQ+BYPEJTQ3fhiUbaR2AKr+tANpO5jO3=nkHKt6HA@mail.gmail.com>
References: <176ba1d4-a68c-262a-f1b9-960a817a3f82@gmail.com>
 <CAEW6iOgD+qouP=pFwMHGGZRup=KCn5us0VVQfYAkjKxF4TYtGA@mail.gmail.com>
 <CABcj=tnE0EDFS0v+jgSiZ3dNby_Oer1q7RMpAU-LMNsCUnSKmg@mail.gmail.com>
 <CAEW6iOix6BQ+BYPEJTQ3fhiUbaR2AKr+tANpO5jO3=nkHKt6HA@mail.gmail.com>
Message-ID: <22936c44-888f-a745-cebf-cf29a0891811@wxs.nl>

On 6/7/2017 10:03 AM, David Carlisle wrote:
> 
> 
> On 7 June 2017 at 06:20, Dirk Laurie <dirk.laurie at gmail.com 
> <mailto:dirk.laurie at gmail.com>> wrote:
> 
> 
> 
>     'cd' is not a program that can be started in a separated process,
>     it is a shell builtin command. Do you get the same with 'ls'?
> 
> 
> ah true, I was trying to think of a command name available also in 
> windows, so same test would work there:-)
> As Luigi has confirmed you get it for any command.
it relates to a check for what commands are permitted in shell mode .. 
will be fixed in a next update

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From H.vanderMeer at uva.nl  Wed Jun  7 10:46:46 2017
From: H.vanderMeer at uva.nl (Meer, Hans van der)
Date: Wed, 7 Jun 2017 08:46:46 +0000
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <2548412a-4c72-4085-6268-1a43d76f1f6b@wxs.nl>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
 <2548412a-4c72-4085-6268-1a43d76f1f6b@wxs.nl>
Message-ID: <121E67F5-BA1C-4842-8D87-A11C8852DB90@uva.nl>

I feel obliged to make a few remarks concerning the direction this discussion has taken.

My first point is the acrid tone I think I hear in the reaction "Hi list, should I conclude...etc". Please refrain. Although the developers of texlua may make mistakes (they are human after all, isn't it?) I am convinced of their devotion to the project and have experienced that more than once. They deserve our support, respect and gratitude. So please, let us not converse in a tone that in my opinion sounds unnecessary offending.

That said, in asserting the cause of a perceived slowdown in the processing of ones input, much care has to be taken in pointing at the culprit. I can speak from a certain experience, having made programs from 1965 onwards on several machines/operating systems and in several programming languages. Many things count here: compilation settings yes, but also changes in the opersting system (updates are not always for the better), machine load, the specific input data, in the case of user originated luacode execution the algorithm chosen with respect to these data, the implementation of that code. 
Before pointing a finger I have learned to first do some (documented) experiments and present these to the developers. That will help them to pinpoint the problem that might be there. Doing so we will all benefit.

Please note that I make these remarks to have all of us in the (Con)Text/Lua community happily working together.
Best wishes

Hans van der Meer




> On 7 Jun 2017, at 09:58, Hans Hagen <pragma at wxs.nl> wrote:
> 
> On 6/7/2017 8:46 AM, jfbu wrote:
>>> In other words, the issue is a non-issue not worth the time several
>>> respected LuaTex experts are putting into it.
>> Hi list,
>> should I conclude that the LuaTeX experts are not the least
>> bit interested into understanding which compilation flags
>> were modified and resulted in a texlua twice slower
>> on macOS 10.9.5 with TeXLive 2017 release than it was
>> with TeXLive 2016 for the same machine?
> 
> indeed, as these experts are not going to check compilation other than on their own machines ... compilation elsewhere is 'derived work'
> 
> (and fwiw, we'd observed 50% slower linux 32 bit versions versions a month ago at BT and were only mildly puzzled .. and those were all experts running 64 bit, so there was no reasson for panick)
> 
>> should I conclude it is _my fault_ to have reported this
>> FACT at the initial message of this thread?
>> did I receive appropriate answers when Hans Hagen
>> only reaction was to tell that my code (which
>> I said explicitely was NOT MY CODE) was crap and
>> could be sped up 99%, which was NOT my question?
>> NOT MY CODE, NOT MY ALGORITHM, NOT MY BINARY.
> 
> i never said it was crap, i only said that (and i'm talking of years of using luatex) it often more pays of to optimize code (which in this case was possible, and normally is even fun to do) than to squeeze out some more from compilation (and even more if you're bound to a specific binary)
> 
> i don't see why yuou should get pissed about this ... i'm pretty sure that henry (whose code it was and who knows tex/lua very well) is interested in possible speed ups (if it were important at all)
> 
> in this case the 50% slow down was a compilation issue but normally we're talking of 5% fluctuations (in which case optimizing can pay of)
> 
> also, there have been answers about possible causes but as tex live 2017 is frozen one has to live with what's there (or update in a few months when updates become available)
> 
> in fact, what bothers me more is that one lets people look into this (and therefore waste their time) while in fact the choice is then something python and tex (if i understood well) and lua was just a side track
> 
> (it's like users asking for a feature and then not testing it due to lack of time or whatever)
> 
>> It was the first ever time I ever ran texlua. Next time
>> you run some software on your machine and find that
>> between version 2016 and version 2017 its execution
>> speed has increased 100% maybe you will consider that
>> the experts of this software "put some time into understanding
>> the cause",
> it is no secret that there are speed differences between compilations, and if you mean with 'experts' those who develop luatex, indeed we're not that much interested because we compile for windows and linux and if that's okay, it's out of our hands and up to those who compile themselves and / or distributors and you cannot expect us to spent time on that
> 
> (for us the benchmark compilations are those on the context garden compile farm and you can bet that when there is a slow binary there we'll hear about it)
> 
> (btw, in the early days, cpu cache was a bottleneck)
> 
> (i've reported several times about speed related issues and luatex in the last decade but probably not in places and journals that you read)
> 
> Hans
> 
> -----------------------------------------------------------------
>                                          Hans Hagen | PRAGMA ADE
>              Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
>       tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
> -----------------------------------------------------------------



From kakuto at fuk.kindai.ac.jp  Wed Jun  7 11:01:33 2017
From: kakuto at fuk.kindai.ac.jp (Akira Kakuto)
Date: Wed, 7 Jun 2017 18:01:33 +0900
Subject: [luatex]  Strange behavior for io.popen
Message-ID: <1C6539294772472198A7643FE4A54693@CJ3001517A>

Hi Hans,

> it relates to a check for what commands are permitted
> in shell mode .. will be fixed in a next update

I installed a fix in TeX Live SVN, r44518, unfortunately after
the release of TL17, since I think Luigi still can't write.

Best,
Akira


From jfbu at free.fr  Wed Jun  7 12:15:41 2017
From: jfbu at free.fr (jfbu)
Date: Wed, 7 Jun 2017 12:15:41 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <121E67F5-BA1C-4842-8D87-A11C8852DB90@uva.nl>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
 <2548412a-4c72-4085-6268-1a43d76f1f6b@wxs.nl>
 <121E67F5-BA1C-4842-8D87-A11C8852DB90@uva.nl>
Message-ID: <A5AE287D-0C25-4CB2-89FF-80F821D41DF9@free.fr>

Hi Hans vdM,

> Before pointing a finger I have learned to first do some (documented) experiments and present these to the developers. That will help them to pinpoint the problem that might be there. Doing so we will all benefit.

If you read the thread from my original post you will see that finger-pointing was not initiated by me.

Anyone being told he can accelerate by a factor 100 its code if only he had known how to proceed to start with, and that it is not even his code, which he only reported it as benchmark for comparisons, on which he already has spent some time, is not likely to feel particularly happy.

This being said it is not my intention to prolong ad nauseam and appear as troller here and that will be my last intervention,

Regards 

Jean-Fran?ois



From pragma at wxs.nl  Wed Jun  7 13:43:51 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Wed, 7 Jun 2017 13:43:51 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <A5AE287D-0C25-4CB2-89FF-80F821D41DF9@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
 <2548412a-4c72-4085-6268-1a43d76f1f6b@wxs.nl>
 <121E67F5-BA1C-4842-8D87-A11C8852DB90@uva.nl>
 <A5AE287D-0C25-4CB2-89FF-80F821D41DF9@free.fr>
Message-ID: <91557c2f-751f-1408-a0fc-bbce3eee8b79@wxs.nl>

On 6/7/2017 12:15 PM, jfbu wrote:

> Anyone being told he can accelerate by a factor 100 its code if only he had known how to proceed to start with, and that it is not even his code, which he only reported it as benchmark for comparisons, on which he already has spent some time, is not likely to feel particularly happy.

the remark about speed up was a reaction to you prefering tex to be 
competitive in speed (nowhere there is was a reference to "how to 
procees to start with") ... but i'll not waste any more time on this as 
it looks like you want to read things in a special way

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From preining at logic.at  Wed Jun  7 15:05:07 2017
From: preining at logic.at (Norbert Preining)
Date: Wed, 07 Jun 2017 22:05:07 +0900
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
Message-ID: <3C3FC3D8-4D19-449B-ADCD-61E9DAFC8F05@logic.at>

Please calm down

Mojca explained you that the legacy binaries are built with very old gcc, and it is easy to get unoptimized code and big delays

We are all volunteers, feel free to try yourself different compilers, different libc, different optimizations, and report the result.

Why should we do the work?

At the end it is darwinlegacy and most people should upgrade anyway.

Calm down, don't do finger pointing, and relax. Nobody hates you, we are just all humans having our own live...

Norbert


On June 7, 2017 3:46:28 PM GMT+09:00, jfbu <jfbu at free.fr> wrote:
>
>> In other words, the issue is a non-issue not worth the time several
>> respected LuaTex experts are putting into it.
>
>Hi list,
>
>should I conclude that the LuaTeX experts are not the least
>bit interested into understanding which compilation flags
>were modified and resulted in a texlua twice slower 
>on macOS 10.9.5 with TeXLive 2017 release than it was
>with TeXLive 2016 for the same machine?
>
>should I conclude it is _my fault_ to have reported this
>FACT at the initial message of this thread?
>
>did I receive appropriate answers when Hans Hagen
>only reaction was to tell that my code (which
>I said explicitely was NOT MY CODE) was crap and
>could be sped up 99%, which was NOT my question?
>NOT MY CODE, NOT MY ALGORITHM, NOT MY BINARY.
>
>It was the first ever time I ever ran texlua. Next time
>you run some software on your machine and find that
>between version 2016 and version 2017 its execution
>speed has increased 100% maybe you will consider that
>the experts of this software "put some time into understanding
>the cause",
>
>Jean-Fran?ois

--
PREINING Norbert + TeX Live & Debian Developer + http://www.preining.info
GPG: 0x860CDC13 fp: F7D8 A928 26E3 16A1 9FA0 ACF0 6CAC A448 860C DC13


From karl at freefriends.org  Wed Jun  7 23:44:40 2017
From: karl at freefriends.org (Karl Berry)
Date: Wed, 7 Jun 2017 21:44:40 GMT
Subject: [luatex] Strange behavior for io.popen
In-Reply-To: <CABcj=tnE0EDFS0v+jgSiZ3dNby_Oer1q7RMpAU-LMNsCUnSKmg@mail.gmail.com>
Message-ID: <201706072144.v57LieOs022935@freefriends.org>

    'cd' is not a program that can be started in a separated process,

True, but unless something highly unusual is being done,
popen("command") runs sh -c "command", not a direct exec(2) or
similar. (On Unix. Windows is different, obviously.)

So shell builtins can be passed. Same with os.execute -> system(3).  --karl

From mojca.miklavec.lists at gmail.com  Thu Jun  8 07:12:00 2017
From: mojca.miklavec.lists at gmail.com (Mojca Miklavec)
Date: Thu, 8 Jun 2017 07:12:00 +0200
Subject: [luatex] slower texlua at LuaTeX 1.0.4 (TL 2017) ?
In-Reply-To: <2548412a-4c72-4085-6268-1a43d76f1f6b@wxs.nl>
References: <1F6B778A-CB18-49AC-B400-F5958B5D6E3B@free.fr>
 <C673EA71-B2E2-449F-8575-F1E9810EB6D4@gundla.ch>
 <CABcj=tkTS+UaJ5yZ_9w5EZXOLBmunSmzMyAegDXphKwpw8muaA@mail.gmail.com>
 <2DA3DCB7-B5A3-4FEC-8E57-C6168FEED805@gundla.ch>
 <CABcj=tmT74X-3whQ3=CG4xUiywGZTaSu9tPkg62LKXC9heUXYw@mail.gmail.com>
 <5D32184F-BE7F-4A06-B55D-40EF627CB9A0@free.fr>
 <2548412a-4c72-4085-6268-1a43d76f1f6b@wxs.nl>
Message-ID: <CALBOmsZL2htTMmC6iBuswmV1=+y+F4hFdmdE1jGBPBFE903dHA@mail.gmail.com>

On 7 June 2017 at 09:58, Hans Hagen wrote:
> (for us the benchmark compilations are those on the context garden compile
> farm and you can bet that when there is a slow binary there we'll hear about
> it)

Except that in this case the binary has been compiled on the same
machine, with the same compiler and with the same environmental
variables as the luatex binary that's being used by every Mac user of
the ConTeXt distribution. The only difference is that the TL binary
was compiled from TL sources, while the one from our distribution was
compiled from the LuaTeX repository.

My numbers (on ancient hardware):

- ConTeXt distro before I updated it:
    real 0m33.331s
    user 0m32.000s
- ConTeXt distro at the moment:
    real 0m37.047s
    user 0m33.107s
- TeX Live:
    real 1m8.008s
    user 1m5.411s

I forgot to check which version of LuaTeX I had installed previously,
but current LuaTeX binary and the one in TeX Live both present
themselves with

    This is LuaTeX, Version 1.0.4 (TeX Live 2017)

I find that puzzling.

Mojca

From bd at bdtechconcepts.com  Sat Jun 10 02:31:11 2017
From: bd at bdtechconcepts.com (Brian Dunn)
Date: Fri, 9 Jun 2017 19:31:11 -0500
Subject: [luatex] io.lines() and TeXLive 2017
Message-ID: <20170609193111.5b644e79@mach1>


I haven't see this reported yet:

With TeXLive 2016, executing the following program test.lua prints the
contents of the file test.txt using each of two methods.

With TeXLive 2017, the second method fails.


File test.lua:
---
#!/usr/bin/env texlua

print ("First Method")
local sfile = io.open("test.txt")
for line in sfile:lines() do
	print (line)
end

io.close(sfile)

print ("Second Method")
io.input("test.txt")
for line in io.lines() do
	print (line)
end
---


File test.txt:
---
This is a test.
Another line.
---


Brian

-- 
Brian Dunn
BD Tech Concepts LLC
http://www.BDTechConcepts.com
bd at BDTechConcepts.com

http://www.linkedin.com/in/bdtechconcepts/

From kakuto at fuk.kindai.ac.jp  Sat Jun 10 11:03:22 2017
From: kakuto at fuk.kindai.ac.jp (Akira Kakuto)
Date: Sat, 10 Jun 2017 18:03:22 +0900
Subject: [luatex]  io.lines() and TeXLive 2017
Message-ID: <2C1C8BF0FCD54F399A67F78CB26F85E6@CJ3001517A>

>  print ("Second Method")

It was simplified as

print ("Second Method")
-- io.input("test.txt")
for line in io.lines("test.txt") do
    print (line)
end

The compatible mode is

print ("Second Method")
io.input("test.txt")
for line in io.saved_lines("test.txt") do
    print (line)
end

However, this does not work, unfortunately, because
of a typo in luatex-core.lua, which is easy
to fix, but maybe too late for TL 17.

Thanks,
Akira


From kakuto at fuk.kindai.ac.jp  Sat Jun 10 11:17:56 2017
From: kakuto at fuk.kindai.ac.jp (Akira Kakuto)
Date: Sat, 10 Jun 2017 18:17:56 +0900
Subject: [luatex] io.lines() and TeXLive 2017
Message-ID: <DFAE6D0ACE704A1EA88F604DEF7D9280@CJ3001517A>

Sorry,
for line in io.saved_lines("test.txt") do
should be
for line in io.saved_lines() do

Akira


From d.p.carlisle at gmail.com  Sat Jun 10 22:21:33 2017
From: d.p.carlisle at gmail.com (David Carlisle)
Date: Sat, 10 Jun 2017 21:21:33 +0100
Subject: [luatex] luatex with unexpected locale
Message-ID: <CAEW6iOg7aK0GQAvtfNMmU1g2RwewF71cuf3vWQLY5EpPh7+dDQ@mail.gmail.com>

 LANG=a_b luatex

produces the error

Unable to read environment locale:exit now.

and any supplied file is ignored

presumably from here in luaint.w

        env_locale = setlocale (LC_ALL, "");
    if (!env_locale) {
      fprintf(stderr,"Unable to read environment locale:exit now.\n");


this came up on stackexchange with a user with locale including
LANG=en_DE.utf8
(German English?)

https://tex.stackexchange.com/questions/374303/luatex-error-unable-to-read-environment-localeexit-now



I'm not sure if luatex could be made to work if LANG is set to an
unknown value (eg just act as if it was C)?? but if not, could the
error message be a bit more informative? "Unable to read" doesn't seem
to suggest "set to wrong value"


David

From luigi.scarso at gmail.com  Sun Jun 11 07:52:14 2017
From: luigi.scarso at gmail.com (luigi scarso)
Date: Sun, 11 Jun 2017 07:52:14 +0200
Subject: [luatex] luatex with unexpected locale
In-Reply-To: <CAEW6iOg7aK0GQAvtfNMmU1g2RwewF71cuf3vWQLY5EpPh7+dDQ@mail.gmail.com>
References: <CAEW6iOg7aK0GQAvtfNMmU1g2RwewF71cuf3vWQLY5EpPh7+dDQ@mail.gmail.com>
Message-ID: <CAG5iGsBMzEyL19F9ha7FWSiOfveTQiXa730X-WxypMaXg9SEZg@mail.gmail.com>

On Sat, Jun 10, 2017 at 10:21 PM, David Carlisle <d.p.carlisle at gmail.com> wrote:
>  LANG=a_b luatex
>
> produces the error
>
> Unable to read environment locale:exit now.
>
> and any supplied file is ignored
>
> presumably from here in luaint.w
>
>         env_locale = setlocale (LC_ALL, "");
>     if (!env_locale) {
>       fprintf(stderr,"Unable to read environment locale:exit now.\n");
>
>
> this came up on stackexchange with a user with locale including
> LANG=en_DE.utf8
> (German English?)
>
> https://tex.stackexchange.com/questions/374303/luatex-error-unable-to-read-environment-localeexit-now
>
>
>
> I'm not sure if luatex could be made to work if LANG is set to an
> unknown value (eg just act as if it was C)??

no, exit is the better way.

>but if not, could the
> error message be a bit more informative? "Unable to read" doesn't seem
> to suggest "set to wrong value"

I will see, but there can be cases where the locale is not wrong but
it's not loaded into the system. Unable to read covers both the situations.


-- 
luigi

From luatex at nililand.de  Wed Jun 14 10:39:42 2017
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 14 Jun 2017 10:39:42 +0200
Subject: [luatex] Doesn't hyphenationbounds work for first word of a
	paragraph?
Message-ID: <pdl9ssjk3bya$.dlg@nililand.de>

When I compile this plain tex example with luatex:

\hsize=2em
abc \hbox to 1em{}sentence.

\hyphenationbounds=1
abc \hbox to 1em{}sentence. 

\noindent\hbox to 1em{}sentence.

\bye

then hyphenationbounds=1 suppresses the hyphenation for the first
"\hbox to 1em{}sentence." but not in the second case where the word
is at the start of a paragraph. 

Is this to be expected or a bug?

(This is LuaTeX, Version 1.0.4 (TeX Live 2017/W32TeX) )

-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


