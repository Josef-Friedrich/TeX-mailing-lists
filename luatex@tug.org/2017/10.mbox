From david.shourabiporcel at gmail.com  Wed Oct  4 16:11:07 2017
From: david.shourabiporcel at gmail.com (David Shourabi Porcel)
Date: Wed, 4 Oct 2017 16:11:07 +0200
Subject: [luatex] Loading PK fonts in Lua
Message-ID: <CAFjD7YMZNViTe_Q-cywtdTJ8-fXrq-F_C2U_szMiCXO_2hgmTw@mail.gmail.com>

Hello,

I am dealing with a TFM-PK font pair which I would like to load in
Lua. The following code doesn't work, however:

function define_font(name, size)
    metrics = font.read_tfm("font.tfm", size)

    metrics.type = "real"
    metrics.format = "type3"
    metrics.fullname = "font.600pk"
    metrics.filename = "font.600pk"
    metrics.embedding = "full"

    return metrics
end
callback.register("define_font", define_font)

LuaTeX complains:
   warning  (file font) (type 3): font font at 216 not found

That is, the metrics file is found and loaded, but the bitmap file is
not. What am I doing wrong?

As far as I could understand from the manual, map files should not be
needed (support for them might be removed in the future, anyway).

Thank you,

David

From luatex at nililand.de  Wed Oct  4 17:25:55 2017
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 4 Oct 2017 17:25:55 +0200
Subject: [luatex] Loading PK fonts in Lua
References: <CAFjD7YMZNViTe_Q-cywtdTJ8-fXrq-F_C2U_szMiCXO_2hgmTw@mail.gmail.com>
Message-ID: <75yq2kqhak1t.dlg@nililand.de>

Am Wed, 4 Oct 2017 16:11:07 +0200 schrieb David Shourabi Porcel:

> Hello,
> 
> I am dealing with a TFM-PK font pair which I would like to load in
> Lua. The following code doesn't work, however:
> 
> function define_font(name, size)
>     metrics = font.read_tfm("font.tfm", size)
> 
>     metrics.type = "real"
>     metrics.format = "type3"
>     metrics.fullname = "font.600pk"
>     metrics.filename = "font.600pk"
>     metrics.embedding = "full"
> 
>     return metrics
> end
> callback.register("define_font", define_font)
> 
> LuaTeX complains:
>    warning  (file font) (type 3): font font at 216 not found
> 
> That is, the metrics file is found and loaded, but the bitmap file is
> not. What am I doing wrong?

You didn't provide a complete example, so I can't test. But the "at
216" sounds as if you are using to use the font in a different
(smaller) size. 

Why are you trying to load the font in lua instead of loading it
normally in the tex file?
 
> As far as I could understand from the manual, map files should not be
> needed (support for them might be removed in the future, anyway).

map-files were never needed for pk-fonts.

-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From reinhard.kotucha at web.de  Wed Oct  4 22:29:20 2017
From: reinhard.kotucha at web.de (Reinhard Kotucha)
Date: Wed, 4 Oct 2017 22:29:20 +0200
Subject: [luatex] Loading PK fonts in Lua
In-Reply-To: <CAFjD7YMZNViTe_Q-cywtdTJ8-fXrq-F_C2U_szMiCXO_2hgmTw@mail.gmail.com>
References: <CAFjD7YMZNViTe_Q-cywtdTJ8-fXrq-F_C2U_szMiCXO_2hgmTw@mail.gmail.com>
Message-ID: <22997.17568.349106.379866@zaphod.ms25.net>

On 2017-10-04 at 16:11:07 +0200, David Shourabi Porcel wrote:

 > As far as I could understand from the manual, map files should not
 > be needed (support for them might be removed in the future,
 > anyway).

David, which manual sais that support for map files might be removed
in the future?

Regards,
  Reinhard

-- 
------------------------------------------------------------------
Reinhard Kotucha                            Phone: +49-511-3373112
Marschnerstr. 25
D-30167 Hannover                    mailto:reinhard.kotucha at web.de
------------------------------------------------------------------

From david.shourabiporcel at gmail.com  Thu Oct  5 02:54:45 2017
From: david.shourabiporcel at gmail.com (David Shourabi Porcel)
Date: Thu, 5 Oct 2017 02:54:45 +0200
Subject: [luatex] Was: Loading PK fonts in Lua
Message-ID: <CAFjD7YPT2mmS5sib=aA46UtuUgqNr002THD9jgOpvqdofwC_6w@mail.gmail.com>

Sorry, I forgot to subscribe to the list.

> You didn't provide a complete example, so I can't test. But the "at
> 216" sounds as if you are using to use the font in a different
> (smaller) size.

Even without the at clause, the backend still doesn't find the PK. The
number is indeed related to the size requested with \font, but also to
\pdfpkresolution.

The extension (i.e. font.216pk) matches the size the backend is
looking for. I have also tried an extension without number, still
didn't work.

> Why are you trying to load the font in lua instead of loading it
> normally in the tex file?

Because I already had the font loading system in Lua. It didn't work
the plain TeX way, so I thought I had to tinker with Lua (just as with
OpenType fonts).

> David, which manual sais that support for map files might be removed
> in the future?

Quoting the manual:

If no special care is needed, LuaTeX currently falls back to the
mapfile-based solution used by pdfTeX and dvips. This behaviour might
silently be removed in the future, in which case the related
primitives and Lua functions will become no-ops.

Reading it a second time, it seems to refer to the fallback behaviour,
though. My bad.

From tschaka-doung at email.de  Fri Oct  6 17:30:38 2017
From: tschaka-doung at email.de (Craig Parker-Feldmann)
Date: Fri, 6 Oct 2017 17:30:38 +0200
Subject: [luatex] Using Lua to filter a macro argument
Message-ID: <trinity-27731253-b36b-4c0e-a046-fbc4d249605b-1507303838262@3c-app-webde-bs46>

The following example uses the Lua ?string.gsub? function.
I can imagine many of the LaTeX packages of the past could be replaced by processing things with Lua.
What I want to know is: am I going about this in a sensible way? Is using the ?string.gsub? function a good idea? I am aware of the LPEG library, but, to be honest, learning it is pretty daunting. I am also unsure as to which strategy I would use to implement the percent character in a pattern expression.
Feedback please.
 
----- CUT HERE -----
% Implements \directlua.
% Takes a TeX stream, and runs it through the
% equivalent of the *NIX ?sed? utility in conjunction with
% the ?gsub? function.
% Searches for the string ?beta? and replaces it with the
% string ?BANANA?.
%
\def \massageZtring#1{%
  \directlua0{
    local myZtring = "#1"
    local BasketA, BasketB = string.gsub (myZtring,
      "beta", "BANANA")
    tex.print (BasketA)
  }%
}% End of \massageZtring
%
The following paragraph has been run through a Lua filter.\par
 
\massageZtring {alpha beta gamma}\par
----- CUT HERE -----


From listas at tex-tipografia.com  Fri Oct  6 19:08:26 2017
From: listas at tex-tipografia.com (Javier Bezos)
Date: Fri, 06 Oct 2017 19:08:26 +0200
Subject: [luatex] Using Lua to filter a macro argument
In-Reply-To: <trinity-27731253-b36b-4c0e-a046-fbc4d249605b-1507303838262@3c-app-webde-bs46>
References: <trinity-27731253-b36b-4c0e-a046-fbc4d249605b-1507303838262@3c-app-webde-bs46>
Message-ID: <59D7B88A.8070004@tex-tipografia.com>

El 06/10/2017 17:30, Craig Parker-Feldmann escribi?:

> What I want to know is: am I going about this in a sensible way? Is
> using the ?string.gsub? function a good idea?

I think there's no reason not to use it.

> I am aware of the LPEG library, but, to be honest, learning it is pretty
> daunting.

You can have a look at the re library:

http://www.inf.puc-rio.br/~roberto/lpeg/re.html

Javier


From david.shourabiporcel at gmail.com  Sat Oct  7 17:54:31 2017
From: david.shourabiporcel at gmail.com (David Shourabi Porcel)
Date: Sat, 7 Oct 2017 17:54:31 +0200
Subject: [luatex] Using Lua to filter a macro argument
In-Reply-To: <trinity-27731253-b36b-4c0e-a046-fbc4d249605b-1507303838262@3c-app-webde-bs46>
References: <trinity-27731253-b36b-4c0e-a046-fbc4d249605b-1507303838262@3c-app-webde-bs46>
Message-ID: <CAFjD7YNCiOXZ1s_PzQ5qyKDeAB=K9uReE=s9jU7j62kKVk+3AQ@mail.gmail.com>

On Fri, Oct 6, 2017 at 5:30 PM, Craig Parker-Feldmann
<tschaka-doung at email.de> wrote:
> What I want to know is: am I going about this in a sensible way?

The use case you presented is definitely easier to implement in Lua
than in TeX, or at least more straightforward. However, you should
consider if you want to support other engines, in which case having a
dedicated Lua implementation would only make sense if it were faster.

> I am also unsure as to which strategy I would use to implement the percent character in a pattern expression.

That's one of the several problems of embedding Lua code in TeX. The
usual solution is to split off the bulk of the Lua code to a separate
module and retain only the minimum in \directlua (namely require and
the function call). Sometimes it's feasible to use \luafunction, which
avoids any Lua parsing, passing arguments through registers.

You should also consider using \luaescapestring to pass strings to
Lua; without it, TeX token sequences will be passed as-is, which can
raise Lua errors.

Regards,
David

From david.shourabiporcel at gmail.com  Sat Oct  7 23:00:23 2017
From: david.shourabiporcel at gmail.com (David Shourabi Porcel)
Date: Sat, 7 Oct 2017 23:00:23 +0200
Subject: [luatex] Loading Type 1 fonts
Message-ID: <CAFjD7YMvMinXEc-pGsechtL7OT=La3nJtL2YJ0WAJ5tKWtUKVQ@mail.gmail.com>

Hello,

I would like to load Type 1 fonts. AFAICT, that means:

 1)  opening the PFB with fontloader.open
 2)  adding metrics with fontloader.apply_afmfile on the font file handle
 3)  populating a table suitable for TeX (font.define)

However, with a naive implementation of step 3 (almost a copy of the
OpenType loader), I am getting absurd metrics.

On the matter:

 -  a paper from Hans, "Fonts out of ConTeXt", mentions that AFMs are
parsed directly instead of going the (lossy) AFM->TFM route
 -  this loader[1] from Patrick Gundlach has some special handling for
PFBs, which suggests that step 3 indeed requires a dedicated
implementation and not just a coopy of the True/OpenType loader
 -  luaotfload's history shows there was AFM support. It was removed
because it was merged to LuaTeX's fontloader library

However, they don't shed much light on the subject. Could you give me
some clues? Something like the example TrueType loader in the wiki[2]
would be particularly helpful.

Thank you,

David

1: https://gist.github.com/pgundlach/354808/492857e7bd58dcf0a7027fe3d92a57927e212340

2: http://wiki.luatex.org/index.php/Use_a_TrueType_font

From patrick at gundla.ch  Mon Oct  9 08:55:31 2017
From: patrick at gundla.ch (Patrick Gundlach)
Date: Mon, 9 Oct 2017 08:55:31 +0200
Subject: [luatex] Loading Type 1 fonts
In-Reply-To: <CAFjD7YMvMinXEc-pGsechtL7OT=La3nJtL2YJ0WAJ5tKWtUKVQ@mail.gmail.com>
References: <CAFjD7YMvMinXEc-pGsechtL7OT=La3nJtL2YJ0WAJ5tKWtUKVQ@mail.gmail.com>
Message-ID: <E71582AD-830B-466F-ACAD-BE6D5D12A050@gundla.ch>

Hello David,


> 1)  opening the PFB with fontloader.open
> 2)  adding metrics with fontloader.apply_afmfile on the font file handle
> 3)  populating a table suitable for TeX (font.define)
> 

1: correct
2: you don't need this. The font loader loads the afm file automatically. 
3: correct.

you have already linked to my github gist, here is another link with english comments

https://github.com/speedata/publisher/blob/develop/src/lua/fonts/fontloader.lua#L120

Although this is a very simple font loader, it is used in production. So I can assure, it works fine.


Patrick




From david.shourabiporcel at gmail.com  Mon Oct  9 22:58:14 2017
From: david.shourabiporcel at gmail.com (David Shourabi Porcel)
Date: Mon, 9 Oct 2017 22:58:14 +0200
Subject: [luatex] Loading Type 1 fonts
In-Reply-To: <E71582AD-830B-466F-ACAD-BE6D5D12A050@gundla.ch>
References: <CAFjD7YMvMinXEc-pGsechtL7OT=La3nJtL2YJ0WAJ5tKWtUKVQ@mail.gmail.com>
 <E71582AD-830B-466F-ACAD-BE6D5D12A050@gundla.ch>
Message-ID: <CAFjD7YOeD1ay8nFhh8M+qdKEqhgG9yNnq+axbBudXJguq63wLw@mail.gmail.com>

Thank you, Patrick. I've got it working now.

In case anyone is interested, the background is explained in this
TeX.SE question[1]. I would be thankful for any clue on the matter.

Regards,

David


1: https://tex.stackexchange.com/questions/395028/is-there-a-difference-between-the-type-1-and-opentype-versions-of-metatype1-font

From chbuschmann at mac.com  Tue Oct 10 22:32:56 2017
From: chbuschmann at mac.com (Carl-Henrik Buschmann)
Date: Tue, 10 Oct 2017 22:32:56 +0200
Subject: [luatex] Segment fault: 11
Message-ID: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>

Hi there,

I?m coming from this tex.stackexchange <https://tex.stackexchange.com/questions/395539/problems-compiling-under-tex-live-2017?noredirect=1#comment983792_395539> talk. 

Summarized:

> Trying to recompile my old master thesis which under TeX Live 2015 and 2016 compiled just fine (I have a new computer that doesn't have said versions) but under TeX Live 2017 grinds to a halt. 
> 
> The compiler stops at:
> 
> $[][]$\TU/TeXGyreHeros(0)/m/n/8 From Weitz-mann via
> 
> and I have no idea why. I cannot see anything out of the ordinary in the code and as far as I know other latex stuff compiles just fine under my current setup. 
> 
> Any idea what to look for?
> 
> The whole log can be found here.
> 
> I'm using the tufte-latex book class via lualatex and biblatex.

I?ve attached a sort of MWE. The problem is at line 177. With it in I get Segmentation fault: 11. If I remove this line the document complies just fine. Any idea what?s going on?





-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20171010/700325f5/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: segment test.tex
Type: application/octet-stream
Size: 10932 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20171010/700325f5/attachment.obj>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://tug.org/pipermail/luatex/attachments/20171010/700325f5/attachment-0001.html>

From herbs at wideopenwest.com  Wed Oct 11 00:02:49 2017
From: herbs at wideopenwest.com (Herbert Schulz)
Date: Tue, 10 Oct 2017 17:02:49 -0500
Subject: [luatex] Segment fault: 11
In-Reply-To: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
Message-ID: <79FD5BC8-CB87-4C65-8DA9-264ED23A78E2@wideopenwest.com>

> On Oct 10, 2017, at 3:32 PM, Carl-Henrik Buschmann <chbuschmann at mac.com> wrote:
> 
> Hi there,
> 
> I?m coming from this tex.stackexchange talk. 
> 
> Summarized:
> 
>> Trying to recompile my old master thesis which under TeX Live 2015 and 2016 compiled just fine (I have a new computer that doesn't have said versions) but under TeX Live 2017 grinds to a halt. 
>> 
>> The compiler stops at:
>> 
>> $[][]$\TU/TeXGyreHeros(0)/m/n/8 From Weitz-mann via
>> 
>> and I have no idea why. I cannot see anything out of the ordinary in the code and as far as I know other latex stuff compiles just fine under my current setup. 
>> 
>> Any idea what to look for?
>> 
>> The whole log can be found here.
>> 
>> I'm using the tufte-latex book class via lualatex and biblatex.
> 
> I?ve attached a sort of MWE. The problem is at line 177. With it in I get Segmentation fault: 11. If I remove this line the document complies just fine. Any idea what?s going on?
> 
> 
> 
> 
> 
> <segment test.tex>

Howdy,

There are missing files so I can't compile this document. However the error message you give,

$[][]$\TU/TeXGyreHeros(0)/m/n/8 From Weitz-mann via

can't be from this document since I can't find the name Weitzmann anywhere in what you supply.

Good Luck,

Herb Schulz
(herbs at wideopenwest dot com)



From d.p.carlisle at gmail.com  Wed Oct 11 00:04:17 2017
From: d.p.carlisle at gmail.com (David Carlisle)
Date: Tue, 10 Oct 2017 23:04:17 +0100
Subject: [luatex] Segment fault: 11
In-Reply-To: <79FD5BC8-CB87-4C65-8DA9-264ED23A78E2@wideopenwest.com>
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
 <79FD5BC8-CB87-4C65-8DA9-264ED23A78E2@wideopenwest.com>
Message-ID: <CAEW6iOh084dusLSAwULsj92DbqZvWu0Q+imwFRuVW1Yji9Nb6A@mail.gmail.com>

The document posted has no missing files (and segfaults) when i run it?

On 10 October 2017 at 23:02, Herbert Schulz <herbs at wideopenwest.com> wrote:
>> On Oct 10, 2017, at 3:32 PM, Carl-Henrik Buschmann <chbuschmann at mac.com> wrote:
>>
>> Hi there,
>>
>> I?m coming from this tex.stackexchange talk.
>>
>> Summarized:
>>
>>> Trying to recompile my old master thesis which under TeX Live 2015 and 2016 compiled just fine (I have a new computer that doesn't have said versions) but under TeX Live 2017 grinds to a halt.
>>>
>>> The compiler stops at:
>>>
>>> $[][]$\TU/TeXGyreHeros(0)/m/n/8 From Weitz-mann via
>>>
>>> and I have no idea why. I cannot see anything out of the ordinary in the code and as far as I know other latex stuff compiles just fine under my current setup.
>>>
>>> Any idea what to look for?
>>>
>>> The whole log can be found here.
>>>
>>> I'm using the tufte-latex book class via lualatex and biblatex.
>>
>> I?ve attached a sort of MWE. The problem is at line 177. With it in I get Segmentation fault: 11. If I remove this line the document complies just fine. Any idea what?s going on?
>>
>>
>>
>>
>>
>> <segment test.tex>
>
> Howdy,
>
> There are missing files so I can't compile this document. However the error message you give,
>
> $[][]$\TU/TeXGyreHeros(0)/m/n/8 From Weitz-mann via
>
> can't be from this document since I can't find the name Weitzmann anywhere in what you supply.
>
> Good Luck,
>
> Herb Schulz
> (herbs at wideopenwest dot com)
>
>


From d.p.carlisle at gmail.com  Wed Oct 11 00:17:10 2017
From: d.p.carlisle at gmail.com (David Carlisle)
Date: Tue, 10 Oct 2017 23:17:10 +0100
Subject: [luatex] Segment fault: 11
In-Reply-To: <CAEW6iOh084dusLSAwULsj92DbqZvWu0Q+imwFRuVW1Yji9Nb6A@mail.gmail.com>
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
 <79FD5BC8-CB87-4C65-8DA9-264ED23A78E2@wideopenwest.com>
 <CAEW6iOh084dusLSAwULsj92DbqZvWu0Q+imwFRuVW1Yji9Nb6A@mail.gmail.com>
Message-ID: <CAEW6iOhvvW3_X4=zBfOf_kHQ7hdL67b4qLof6Tz4Vi+xC6F-Fw@mail.gmail.com>

a smaller test file (still latex:-) segfaults for me in texlive 2017 cygwin



On 10 October 2017 at 23:04, David Carlisle <d.p.carlisle at gmail.com> wrote:
> The document posted has no missing files (and segfaults) when i run it?
>
> On 10 October 2017 at 23:02, Herbert Schulz <herbs at wideopenwest.com> wrote:
>>> On Oct 10, 2017, at 3:32 PM, Carl-Henrik Buschmann <chbuschmann at mac.com> wrote:
>>>
>>> Hi there,
>>>
>>> I?m coming from this tex.stackexchange talk.
>>>
>>> Summarized:
>>>
>>>> Trying to recompile my old master thesis which under TeX Live 2015 and 2016 compiled just fine (I have a new computer that doesn't have said versions) but under TeX Live 2017 grinds to a halt.
>>>>
>>>> The compiler stops at:
>>>>
>>>> $[][]$\TU/TeXGyreHeros(0)/m/n/8 From Weitz-mann via
>>>>
>>>> and I have no idea why. I cannot see anything out of the ordinary in the code and as far as I know other latex stuff compiles just fine under my current setup.
>>>>
>>>> Any idea what to look for?
>>>>
>>>> The whole log can be found here.
>>>>
>>>> I'm using the tufte-latex book class via lualatex and biblatex.
>>>
>>> I?ve attached a sort of MWE. The problem is at line 177. With it in I get Segmentation fault: 11. If I remove this line the document complies just fine. Any idea what?s going on?
>>>
>>>
>>>
>>>
>>>
>>> <segment test.tex>
>>
>> Howdy,
>>
>> There are missing files so I can't compile this document. However the error message you give,
>>
>> $[][]$\TU/TeXGyreHeros(0)/m/n/8 From Weitz-mann via
>>
>> can't be from this document since I can't find the name Weitzmann anywhere in what you supply.
>>
>> Good Luck,
>>
>> Herb Schulz
>> (herbs at wideopenwest dot com)
>>
>>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: seg.tex
Type: application/x-tex
Size: 603 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20171010/2d5d88f1/attachment-0001.tex>

From luatex at nililand.de  Wed Oct 11 00:18:40 2017
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 11 Oct 2017 00:18:40 +0200
Subject: [luatex] Segment fault: 11
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
Message-ID: <dluot2imchy7$.dlg@nililand.de>

Am Tue, 10 Oct 2017 22:32:56 +0200 schrieb Carl-Henrik Buschmann:

> I?ve attached a sort of MWE. The problem is at line 177. With it
> in I get Segmentation fault: 11. If I remove this line the
> document complies just fine. Any idea what?s going on?

I shortened it to 

\documentclass{book}
  \RequirePackage{fontspec}
  \setmainfont[Renderer=Basic]{TeX Gyre Pagella}

\begin{document}

\textbf{P} displaces the non-\textit{ic5} pitches in a triad, i.e
moves the third between minor and major.
For the sake of examples, we assume the first chord in the
transformation is \(I\); ergo, in Schenkerian 
\({I}\Leftrightarrow{i}\).

\end{document}


There is something with Renderer=Basic that luatex doesn't like. But
I haven't now the time to dig deeper.



-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From d.p.carlisle at gmail.com  Wed Oct 11 00:52:01 2017
From: d.p.carlisle at gmail.com (David Carlisle)
Date: Tue, 10 Oct 2017 23:52:01 +0100
Subject: [luatex] Segment fault: 11
In-Reply-To: <dluot2imchy7$.dlg@nililand.de>
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
 <dluot2imchy7$.dlg@nililand.de>
Message-ID: <CAEW6iOhRvcV8B35rRHdrCGT2GPTRaULq=A5OqiEFOeRP=gd-Pg@mail.gmail.com>

plain tex version (and no math)
-------------- next part --------------
A non-text attachment was scrubbed...
Name: segp.tex
Type: application/x-tex
Size: 308 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20171010/11aa6ff5/attachment.tex>

From luigi.scarso at gmail.com  Wed Oct 11 07:48:07 2017
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 11 Oct 2017 07:48:07 +0200
Subject: [luatex] Segment fault: 11
In-Reply-To: <CAEW6iOhRvcV8B35rRHdrCGT2GPTRaULq=A5OqiEFOeRP=gd-Pg@mail.gmail.com>
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
 <dluot2imchy7$.dlg@nililand.de>
 <CAEW6iOhRvcV8B35rRHdrCGT2GPTRaULq=A5OqiEFOeRP=gd-Pg@mail.gmail.com>
Message-ID: <CAG5iGsDPYJT_uwBms5nipu2GQ9v38ZyoSU86kvqB6Dgzc+dajw@mail.gmail.com>

On Wed, Oct 11, 2017 at 12:52 AM, David Carlisle <d.p.carlisle at gmail.com> wrote:
> plain tex version (and no math)

ok, thank you  for the report.
I will see it today

-- 
luigi

From luigi.scarso at gmail.com  Wed Oct 11 10:21:21 2017
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 11 Oct 2017 10:21:21 +0200
Subject: [luatex] Segment fault: 11
In-Reply-To: <CAG5iGsDPYJT_uwBms5nipu2GQ9v38ZyoSU86kvqB6Dgzc+dajw@mail.gmail.com>
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
 <dluot2imchy7$.dlg@nililand.de>
 <CAEW6iOhRvcV8B35rRHdrCGT2GPTRaULq=A5OqiEFOeRP=gd-Pg@mail.gmail.com>
 <CAG5iGsDPYJT_uwBms5nipu2GQ9v38ZyoSU86kvqB6Dgzc+dajw@mail.gmail.com>
Message-ID: <CAG5iGsBbg35wMVT-3sCdB=EdZb_JDe_56cFki52wZGSCB=uhjQ@mail.gmail.com>

On Wed, Oct 11, 2017 at 7:48 AM, luigi scarso <luigi.scarso at gmail.com> wrote:
> On Wed, Oct 11, 2017 at 12:52 AM, David Carlisle <d.p.carlisle at gmail.com> wrote:
>> plain tex version (and no math)
>
> ok, thank you  for the report.
> I will see it today

must be something related to luaotfload.sty,
because
$>mtxrun --script plain segp.tex
is ok
Also context is ok


-- 
luigi

From patrick at gundla.ch  Wed Oct 11 14:52:37 2017
From: patrick at gundla.ch (Patrick Gundlach)
Date: Wed, 11 Oct 2017 14:52:37 +0200
Subject: [luatex] LuaTeX as a Library
In-Reply-To: <067EB947-2812-4343-995A-BE2337A54464@mac.com>
References: <197B88C2-0F55-4C77-926F-763E4A5D3AEA@mac.com>
 <CAG5iGsCMBPSzchNRP=KYaSAkOLM3KS4S0aV7xuAbmxYzrvrTVA@mail.gmail.com>
 <067EB947-2812-4343-995A-BE2337A54464@mac.com>
Message-ID: <485944B0-120E-474D-AED6-2FA0E992F8A1@gundla.ch>

I know it is an old mail....

> Am 26.02.2016 um 19:09 schrieb Robert Krug <destiny6 at mac.com>:

Hello Robert,

did you get any further with your experiments? Is there any news here? I'd be really interested in playing around with a shared LuaTeX (Mac, but also other systems as well).

Patrick




From Nicolas.Holzschuch at inria.fr  Wed Oct 11 15:06:52 2017
From: Nicolas.Holzschuch at inria.fr (Nicolas Holzschuch)
Date: Wed, 11 Oct 2017 15:06:52 +0200
Subject: [luatex] LuaTeX as a Library
In-Reply-To: <485944B0-120E-474D-AED6-2FA0E992F8A1@gundla.ch>
References: <197B88C2-0F55-4C77-926F-763E4A5D3AEA@mac.com>
 <CAG5iGsCMBPSzchNRP=KYaSAkOLM3KS4S0aV7xuAbmxYzrvrTVA@mail.gmail.com>
 <067EB947-2812-4343-995A-BE2337A54464@mac.com>
 <485944B0-120E-474D-AED6-2FA0E992F8A1@gundla.ch>
Message-ID: <37EE882C-4BE2-4380-9379-2B317AACF393@inria.fr>

Hi Patrick, 

> On 11 Oct 2017, at 14:52, Patrick Gundlach <patrick at gundla.ch> wrote:
> 
> I know it is an old mail....
> 
>> Am 26.02.2016 um 19:09 schrieb Robert Krug <destiny6 at mac.com>:
> 
> Hello Robert,
> 
> did you get any further with your experiments? Is there any news here? I'd be really interested in playing around with a shared LuaTeX (Mac, but also other systems as well).

I do not have access to the old e-mail, so: What was the question here? 

I happen to have a lib_luatex.dylib that I made for my own consumption (to run Luatex on iOS, if you want to know). 
(it's still a work in progress)


Nicolas Holzschuch

From patrick at gundla.ch  Wed Oct 11 15:19:03 2017
From: patrick at gundla.ch (Patrick Gundlach)
Date: Wed, 11 Oct 2017 15:19:03 +0200
Subject: [luatex] LuaTeX as a Library
In-Reply-To: <37EE882C-4BE2-4380-9379-2B317AACF393@inria.fr>
References: <197B88C2-0F55-4C77-926F-763E4A5D3AEA@mac.com>
 <CAG5iGsCMBPSzchNRP=KYaSAkOLM3KS4S0aV7xuAbmxYzrvrTVA@mail.gmail.com>
 <067EB947-2812-4343-995A-BE2337A54464@mac.com>
 <485944B0-120E-474D-AED6-2FA0E992F8A1@gundla.ch>
 <37EE882C-4BE2-4380-9379-2B317AACF393@inria.fr>
Message-ID: <F5F00317-B4CF-4742-B4D1-E4A00A173A2C@gundla.ch>

Hello Nicolas,

of course I should have quoted the email...

The question was about building a shared library (.so, .dylib, .dll - I hope I've got the correct term) of LuaTeX. For my experiments I'd only need a Mac (latest OS, 64 bit) version.


Here is the original mail:

http://tug.org/pipermail/luatex/2016-February/005698.html


Patrick




From luatex at nililand.de  Wed Oct 11 20:39:20 2017
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 11 Oct 2017 20:39:20 +0200
Subject: [luatex] Segment fault: 11
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
 <dluot2imchy7$.dlg@nililand.de>
 <CAEW6iOhRvcV8B35rRHdrCGT2GPTRaULq=A5OqiEFOeRP=gd-Pg@mail.gmail.com>
 <CAG5iGsDPYJT_uwBms5nipu2GQ9v38ZyoSU86kvqB6Dgzc+dajw@mail.gmail.com>
 <CAG5iGsBbg35wMVT-3sCdB=EdZb_JDe_56cFki52wZGSCB=uhjQ@mail.gmail.com>
Message-ID: <tlusx15enzxu.dlg@nililand.de>

Am Wed, 11 Oct 2017 10:21:21 +0200 schrieb luigi scarso:

> must be something related to luaotfload.sty,
> because
> $>mtxrun --script plain segp.tex
> is ok
> Also context is ok

Looks so. But it is quite unclear what in luaotfload is the problem.
I tried with a dev-luatex and the newest reference fontloader from
context and still get the crash. 

Perhaps it is not so much luaotfload doing something wrong but
context adding some code that avoids the problem. 

In any case: it is related to kern and the hyphen/font switch. The
following only doesn't crash if one change for font \i +kern to
-kern. Also it seems to be related to otf-fonts, at least I couldn't
find a ttf that breaks -- but this could be by accident.

\input luaotfload.sty 

\font \i   = {name:texgyreheros:mode=base;+kern;}  at 10pt

\font \r   = {name:texgyreheros:mode=base;-kern;}  at 12pt

\r
aaa-{\i iiii xrmoi} 

\bye


-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From destiny6 at mac.com  Wed Oct 11 23:50:37 2017
From: destiny6 at mac.com (Robert Krug)
Date: Wed, 11 Oct 2017 16:50:37 -0500
Subject: [luatex] LuaTeX as a Library
In-Reply-To: <485944B0-120E-474D-AED6-2FA0E992F8A1@gundla.ch>
References: <197B88C2-0F55-4C77-926F-763E4A5D3AEA@mac.com>
 <CAG5iGsCMBPSzchNRP=KYaSAkOLM3KS4S0aV7xuAbmxYzrvrTVA@mail.gmail.com>
 <067EB947-2812-4343-995A-BE2337A54464@mac.com>
 <485944B0-120E-474D-AED6-2FA0E992F8A1@gundla.ch>
Message-ID: <79A51544-B0EB-4735-801C-5EDF8FD28AF6@mac.com>

Greetings,

Patrick:

I have not gotten any further, but a couple of days ago I decided to try again
with the latest LuaTeX, so this is a timely prompt to actually do so.  I am not
really much of a programmer, so Nicolas Holzschuch, for instance, may have
a much better start than I do.  However, this is something I would like to see,
and will get back to it in the next couple of days.

Nicholas:

Is your lib_luatex.dylib using LuaTeX 1.0 or later? Is it in a state where you would
be willing to share it?

Robert

> On Oct 11, 2017, at 07:52, Patrick Gundlach <patrick at gundla.ch> wrote:
> 
> I know it is an old mail....
> 
>> Am 26.02.2016 um 19:09 schrieb Robert Krug <destiny6 at mac.com>:
> 
> Hello Robert,
> 
> did you get any further with your experiments? Is there any news here? I'd be really interested in playing around with a shared LuaTeX (Mac, but also other systems as well).
> 
> Patrick
> 
> 



From pragma at wxs.nl  Thu Oct 12 08:44:11 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Thu, 12 Oct 2017 08:44:11 +0200
Subject: [luatex] Segment fault: 11
In-Reply-To: <tlusx15enzxu.dlg@nililand.de>
References: <D702A314-A8CD-482B-AA44-1B19EEE294FD@mac.com>
 <dluot2imchy7$.dlg@nililand.de>
 <CAEW6iOhRvcV8B35rRHdrCGT2GPTRaULq=A5OqiEFOeRP=gd-Pg@mail.gmail.com>
 <CAG5iGsDPYJT_uwBms5nipu2GQ9v38ZyoSU86kvqB6Dgzc+dajw@mail.gmail.com>
 <CAG5iGsBbg35wMVT-3sCdB=EdZb_JDe_56cFki52wZGSCB=uhjQ@mail.gmail.com>
 <tlusx15enzxu.dlg@nililand.de>
Message-ID: <22878bde-f515-edd2-5c1d-df3305b92c38@wxs.nl>

On 10/11/2017 8:39 PM, Ulrike Fischer wrote:
> Am Wed, 11 Oct 2017 10:21:21 +0200 schrieb luigi scarso:
> 
>> must be something related to luaotfload.sty,
>> because
>> $>mtxrun --script plain segp.tex
>> is ok
>> Also context is ok
> 
> Looks so. But it is quite unclear what in luaotfload is the problem.
> I tried with a dev-luatex and the newest reference fontloader from
> context and still get the crash.
> 
> Perhaps it is not so much luaotfload doing something wrong but
> context adding some code that avoids the problem.
> 
> In any case: it is related to kern and the hyphen/font switch. The
> following only doesn't crash if one change for font \i +kern to
> -kern. Also it seems to be related to otf-fonts, at least I couldn't
> find a ttf that breaks -- but this could be by accident.
> 
> \input luaotfload.sty
> 
> \font \i   = {name:texgyreheros:mode=base;+kern;}  at 10pt
> 
> \font \r   = {name:texgyreheros:mode=base;-kern;}  at 12pt
> 
> \r
> aaa-{\i iiii xrmoi}

it's probably not related to the context part as there is a loop in

do_handle_kerning

which is not something in the font loader does but something plugged in 
later

(you can probably check it by disabling that call)

Hans


-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From Nicolas.Holzschuch at inria.fr  Thu Oct 12 09:23:38 2017
From: Nicolas.Holzschuch at inria.fr (Nicolas Holzschuch)
Date: Thu, 12 Oct 2017 09:23:38 +0200
Subject: [luatex] LuaTeX as a Library
In-Reply-To: <79A51544-B0EB-4735-801C-5EDF8FD28AF6@mac.com>
References: <197B88C2-0F55-4C77-926F-763E4A5D3AEA@mac.com>
 <CAG5iGsCMBPSzchNRP=KYaSAkOLM3KS4S0aV7xuAbmxYzrvrTVA@mail.gmail.com>
 <067EB947-2812-4343-995A-BE2337A54464@mac.com>
 <485944B0-120E-474D-AED6-2FA0E992F8A1@gundla.ch>
 <79A51544-B0EB-4735-801C-5EDF8FD28AF6@mac.com>
Message-ID: <4CEC46B0-30B5-4782-A1CD-7ED987B40C71@inria.fr>

Greetings, 

> On 11 Oct 2017, at 23:50, Robert Krug <destiny6 at mac.com> wrote:
> 
> Greetings,
> 
> Patrick:
> 
> I have not gotten any further, but a couple of days ago I decided to try again
> with the latest LuaTeX, so this is a timely prompt to actually do so.  I am not
> really much of a programmer, so Nicolas Holzschuch, for instance, may have
> a much better start than I do.  However, this is something I would like to see,
> and will get back to it in the next couple of days.
> 
> Nicholas:
> 
> Is your lib_luatex.dylib using LuaTeX 1.0 or later? Is it in a state where you would
> be willing to share it?

I am willing to share it. I am open to suggestions as to what would be the best format for release; I could copy my entire texlive/texk directory to a github repository (quick easy fix for now, problems for maintainance down the road). You people might have more clever suggestions. I am working on both pdftex and luatex. 

Also, some of the changes are related to cross-compiling, but I don't think that is going to cause problems. 

Right now, my biggest issue is memory management. If you call luatex as a shell command, all memory is released on exit, and reinitialized when you restart. If it's in a library, memory allocated on the first call stays allocated for the second call. So on the second call, luatex has several variables and trees already allocated, resulting in assert() failed.

TL;DR: I have a library that can call luatex exactly once. I am working on the uexit() function so it frees everything that has been allocated. 

Nicolas 


> 
> Robert
> 
>> On Oct 11, 2017, at 07:52, Patrick Gundlach <patrick at gundla.ch> wrote:
>> 
>> I know it is an old mail....
>> 
>>> Am 26.02.2016 um 19:09 schrieb Robert Krug <destiny6 at mac.com>:
>> 
>> Hello Robert,
>> 
>> did you get any further with your experiments? Is there any news here? I'd be really interested in playing around with a shared LuaTeX (Mac, but also other systems as well).
>> 
>> Patrick
>> 
>> 
> 



From listas at tex-tipografia.com  Fri Oct 27 16:41:52 2017
From: listas at tex-tipografia.com (Javier Bezos)
Date: Fri, 27 Oct 2017 16:41:52 +0200
Subject: [luatex] Inserting a "dummy" node
Message-ID: <59F345B0.3050102@tex-tipografia.com>

Is there a "canonical" way to insert a "dummy" node passing some
data to the list, so that it can be used when processing it?

I'm writing a new feature for babel, and while I've discarded
this approach (an attribute is clearly better), I'm still
wondering if there is a preferred method. I thought a user
whatsit was the solution, but if I've understood correctly,
it cannot be added by TeX (only by lua).

Javier

From pragma at wxs.nl  Fri Oct 27 19:48:53 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Fri, 27 Oct 2017 19:48:53 +0200
Subject: [luatex] Inserting a "dummy" node
In-Reply-To: <59F345B0.3050102@tex-tipografia.com>
References: <59F345B0.3050102@tex-tipografia.com>
Message-ID: <813801b9-f5e1-eda5-67c9-8bd509601555@wxs.nl>

On 10/27/2017 4:41 PM, Javier Bezos wrote:
> Is there a "canonical" way to insert a "dummy" node passing some
> data to the list, so that it can be used when processing it?
> 
> I'm writing a new feature for babel, and while I've discarded
> this approach (an attribute is clearly better), I'm still
> wondering if there is a preferred method. I thought a user
> whatsit was the solution, but if I've understood correctly,
> it cannot be added by TeX (only by lua).
there are user nodes that you can inject

     \def\dummynode#1{\directlua{
         local n = node.new("whatsit",node.subtype("user_defined"))
         n.type = 100
         n.value = #1
         node.write(n)
     }}%

     foo\dummynode{123}bar


-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From listas at tex-tipografia.com  Sat Oct 28 09:20:34 2017
From: listas at tex-tipografia.com (Javier Bezos)
Date: Sat, 28 Oct 2017 09:20:34 +0200
Subject: [luatex] Inserting a "dummy" node
In-Reply-To: <813801b9-f5e1-eda5-67c9-8bd509601555@wxs.nl>
References: <59F345B0.3050102@tex-tipografia.com>
 <813801b9-f5e1-eda5-67c9-8bd509601555@wxs.nl>
Message-ID: <59F42FC2.1010708@tex-tipografia.com>

Hans,

> there are user nodes that you can inject
>
>      \def\dummynode#1{\directlua{
>          local n = node.new("whatsit",node.subtype("user_defined"))
>          n.type = 100
>          n.value = #1
>          node.write(n)
>      }}%
>
>      foo\dummynode{123}bar

Thanks, this is what I was looking for, but is not node.write
experimental? Or has it come to stay?

Javier

From pragma at wxs.nl  Sat Oct 28 12:09:26 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Sat, 28 Oct 2017 12:09:26 +0200
Subject: [luatex] Inserting a "dummy" node
In-Reply-To: <59F42FC2.1010708@tex-tipografia.com>
References: <59F345B0.3050102@tex-tipografia.com>
 <813801b9-f5e1-eda5-67c9-8bd509601555@wxs.nl>
 <59F42FC2.1010708@tex-tipografia.com>
Message-ID: <f5341259-76f5-3534-1720-827d0b3719b2@wxs.nl>

On 10/28/2017 9:20 AM, Javier Bezos wrote:
> Hans,
> 
>> there are user nodes that you can inject
>>
>> ???? \def\dummynode#1{\directlua{
>> ???????? local n = node.new("whatsit",node.subtype("user_defined"))
>> ???????? n.type = 100
>> ???????? n.value = #1
>> ???????? node.write(n)
>> ???? }}%
>>
>> ???? foo\dummynode{123}bar
> 
> Thanks, this is what I was looking for, but is not node.write
> experimental? Or has it come to stay?
it has been around for quite a while now and (as i use it it will stay)

the only thing to keep in mind is that it can only be issued when in 
horizontal mode (you get an error otherwise) bnut that is no big deal

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From listas at tex-tipografia.com  Sun Oct 29 07:39:43 2017
From: listas at tex-tipografia.com (Javier Bezos)
Date: Sun, 29 Oct 2017 07:39:43 +0100
Subject: [luatex] Inserting a "dummy" node
In-Reply-To: <f5341259-76f5-3534-1720-827d0b3719b2@wxs.nl>
References: <59F345B0.3050102@tex-tipografia.com>
 <813801b9-f5e1-eda5-67c9-8bd509601555@wxs.nl>
 <59F42FC2.1010708@tex-tipografia.com>
 <f5341259-76f5-3534-1720-827d0b3719b2@wxs.nl>
Message-ID: <59F577AF.1070600@tex-tipografia.com>


>> Thanks, this is what I was looking for, but is not node.write
>> experimental? Or has it come to stay?

> it has been around for quite a while now and (as i use it it will stay)

Since you are using it, it's clear I may, too ;-).

Javier

From pragma at wxs.nl  Sun Oct 29 10:03:43 2017
From: pragma at wxs.nl (Hans Hagen)
Date: Sun, 29 Oct 2017 10:03:43 +0100
Subject: [luatex] Inserting a "dummy" node
In-Reply-To: <59F577AF.1070600@tex-tipografia.com>
References: <59F345B0.3050102@tex-tipografia.com>
 <813801b9-f5e1-eda5-67c9-8bd509601555@wxs.nl>
 <59F42FC2.1010708@tex-tipografia.com>
 <f5341259-76f5-3534-1720-827d0b3719b2@wxs.nl>
 <59F577AF.1070600@tex-tipografia.com>
Message-ID: <f9cf5f4f-c4c7-b270-6135-6ac8ec3fbb57@wxs.nl>

On 10/29/2017 7:39 AM, Javier Bezos wrote:
> 
>>> Thanks, this is what I was looking for, but is not node.write
>>> experimental? Or has it come to stay?
> 
>> it has been around for quite a while now and (as i use it it will stay)
> 
> Since you are using it, it's clear I may, too ;-).
apart from consistency fixes all documented interfaces between tex and 
lua present in 1.0 will stay (of course 2 might differ but that's along 
way to go)

the backend part is different as there we need to adapt occassionaly and 
some obscure (or obsolete) things might go away but that be announced 
and/or mentioned in the manual

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

