From andreas.matthias at gmail.com  Tue Mar  9 22:59:42 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Tue, 9 Mar 2021 22:59:42 +0100
Subject: [luatex] Segfault: pdfe.getstring()
Message-ID: <CAHp59H1VJ9TYE_-sURdkmzbrN0QwoU0JpRhfQ0deH6C1a8Vu2A@mail.gmail.com>

I get a segfault with pdfe.getstring(). To replicate this issue run:

  # lualatex foo.tex
  # texlua foo.lua

File 'foo.tex':

\documentclass{article}
\usepackage{hyperref}
\begin{document}
\href{https://www.ctan.org}{CTAN}
\end{document}

File 'foo.lua':

doc = pdfe.open('foo.pdf')
annot = pdfe.getpage(doc, 1).Annots[1]
uri = pdfe.getstring(annot.A, "URI", true)
print(uri)

I'm running:
This is LuaTeX, Version 1.12.0 (TeX Live 2020)

Best Regards
Andreas

From luigi.scarso at gmail.com  Wed Mar 10 08:25:47 2021
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 10 Mar 2021 08:25:47 +0100
Subject: [luatex] Segfault: pdfe.getstring()
In-Reply-To: <CAHp59H1VJ9TYE_-sURdkmzbrN0QwoU0JpRhfQ0deH6C1a8Vu2A@mail.gmail.com>
References: <CAHp59H1VJ9TYE_-sURdkmzbrN0QwoU0JpRhfQ0deH6C1a8Vu2A@mail.gmail.com>
Message-ID: <CAG5iGsAXDphvw_tiJ3PmDpOfUOLQmGTJYkDkstUbQ31ptEOuvA@mail.gmail.com>

On Wed, Mar 10, 2021 at 3:06 AM Andreas Matthias <andreas.matthias at gmail.com>
wrote:

> I get a segfault with pdfe.getstring(). To replicate this issue run:
>
>   # lualatex foo.tex
>   # texlua foo.lua
>
> File 'foo.tex':
>
> \documentclass{article}
> \usepackage{hyperref}
> \begin{document}
> \href{https://www.ctan.org}{CTAN}
> \end{document}
>
> File 'foo.lua':
>
> doc = pdfe.open('foo.pdf')
> annot = pdfe.getpage(doc, 1).Annots[1]
> uri = pdfe.getstring(annot.A, "URI", true)
> print(uri)
>
> I'm running:
> This is LuaTeX, Version 1.12.0 (TeX Live 2020)
>
> Best Regards
> Andreas
>

confirmed for 1.12.0, but 1.13.0 seems to  be ok.

-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210310/5494171d/attachment.html>

From andreas.matthias at gmail.com  Wed Mar 17 17:30:38 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 17 Mar 2021 17:30:38 +0100
Subject: [luatex] UTF-16 with pdfe.getstring()
Message-ID: <CAHp59H24R7MMsbs9N_+hA+pj-QR9C8MWMsOi2j_gHx1Vfy-uNA@mail.gmail.com>

I'm having a hard time with pdfe.getstring(). What am I supposed to do if it
returns an UTF-16 encoded string? How to convert it to UTF-8?

Here is what I'm actually trying to do: I'm reading the /Contents of a
Text-Annotation
with pdfe.getstring(). The returned string happens to be UTF-16
encoded. Now I want to
use this string to create a pdf_annot whatsit. Of course this doesn't work:

This is LuaTeX, Version 1.13.0 (TeX Live 2021/dev)
 restricted system commands enabled.
(./test.tex
! String contains an invalid utf-8 sequence.
l.17 }

I've attached an example to replicate this issue.

Andreas
-------------- next part --------------
A non-text attachment was scrubbed...
Name: test.tex
Type: text/x-tex
Size: 477 bytes
Desc: not available
URL: <https://tug.org/pipermail/luatex/attachments/20210317/6ba3095a/attachment.bin>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: foo.pdf
Type: application/pdf
Size: 5750 bytes
Desc: not available
URL: <https://tug.org/pipermail/luatex/attachments/20210317/6ba3095a/attachment.pdf>

From j.hagen at xs4all.nl  Thu Mar 18 02:18:03 2021
From: j.hagen at xs4all.nl (Hans Hagen)
Date: Thu, 18 Mar 2021 02:18:03 +0100
Subject: [luatex] UTF-16 with pdfe.getstring()
In-Reply-To: <CAHp59H24R7MMsbs9N_+hA+pj-QR9C8MWMsOi2j_gHx1Vfy-uNA@mail.gmail.com>
References: <CAHp59H24R7MMsbs9N_+hA+pj-QR9C8MWMsOi2j_gHx1Vfy-uNA@mail.gmail.com>
Message-ID: <dc97cba0-976d-65e0-222c-606b244fbb69@xs4all.nl>

On 3/17/2021 5:30 PM, Andreas Matthias wrote:
> I'm having a hard time with pdfe.getstring(). What am I supposed to do if it
> returns an UTF-16 encoded string? How to convert it to UTF-8?
> 
> Here is what I'm actually trying to do: I'm reading the /Contents of a
> Text-Annotation
> with pdfe.getstring(). The returned string happens to be UTF-16
> encoded. Now I want to
> use this string to create a pdf_annot whatsit. Of course this doesn't work:
> 
> This is LuaTeX, Version 1.13.0 (TeX Live 2021/dev)
>   restricted system commands enabled.
> (./test.tex
> ! String contains an invalid utf-8 sequence.
> l.17 }
> 
> I've attached an example to replicate this issue.
   contents = annot.Contents
   local t = { }
   for c in string.gmatch(contents,".") do
       t[#t+1] = string.format("%02X",string.byte(c))
   end
   contents = table.concat(t)
   local str = '/Subtype/Text/Contents <' .. contents .. '>'


-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From andreas.matthias at gmail.com  Thu Mar 18 16:02:21 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Thu, 18 Mar 2021 16:02:21 +0100
Subject: [luatex] UTF-16 with pdfe.getstring()
In-Reply-To: <dc97cba0-976d-65e0-222c-606b244fbb69@xs4all.nl>
References: <CAHp59H24R7MMsbs9N_+hA+pj-QR9C8MWMsOi2j_gHx1Vfy-uNA@mail.gmail.com>
 <dc97cba0-976d-65e0-222c-606b244fbb69@xs4all.nl>
Message-ID: <CAHp59H1nLV90Uj6MDSGztYEp9Q-YDLsyz=CsNPN+6L4ATE2pUA@mail.gmail.com>

Hans Hagen wrote:
>
> On 3/17/2021 5:30 PM, Andreas Matthias wrote:
> > I'm having a hard time with pdfe.getstring(). What am I supposed to do if it
> > returns an UTF-16 encoded string? How to convert it to UTF-8?
>
>    contents = annot.Contents
>    local t = { }
>    for c in string.gmatch(contents,".") do
>        t[#t+1] = string.format("%02X",string.byte(c))
>    end
>    contents = table.concat(t)
>    local str = '/Subtype/Text/Contents <' .. contents .. '>'

Thank you!

I was pondering on using a unicode library and didn't even think about
hex encoding.
But conversion to hex is definitely much easier and doesn't require
any third party
library.

Andreas

From lahcim8 at gmail.com  Thu Mar 18 18:37:16 2021
From: lahcim8 at gmail.com (=?utf-8?q?Michal_Vlas=C3=A1k?=)
Date: Thu, 18 Mar 2021 18:37:16 +0100
Subject: [luatex] LuaTeX manual miscompiled on CTAN and in TeX Live
Message-ID: <CA0NR1WYKD61.32WGUWWXS1THA@phobos>

Hello,

the LuaTeX manual PDF (version: February 14, 2021) as included on CTAN
[1] and in TeX Live [2] is missing the luaharfbuzz reference. ConTeXt's
grey placeholder is present instead. The older version (January 30,
2021) as present in the LuaTeX SVN repository [3] is fine in this
regard. (The version present in ConTeXt is missing the chapter about
HarfBuzz entirely, but I believe this is intentional.)

I am sorry if this isn't the right place or time for the report, but I
am not sure how the is manual propagated and TeX Live freeze is near.

Michal Vlas?k

[1] http://mirrors.ctan.org/systems/doc/luatex/luatex.pdf
[2] https://tug.org/svn/texlive/trunk/Master/texmf-dist/doc/luatex/base/luatex.pdf?view=co
[3] https://serveur-svn.lri.fr/svn/modhel/luatex/trunk/manual/luatex.pdf


From luigi.scarso at gmail.com  Thu Mar 18 20:08:17 2021
From: luigi.scarso at gmail.com (luigi scarso)
Date: Thu, 18 Mar 2021 20:08:17 +0100
Subject: [luatex] LuaTeX manual miscompiled on CTAN and in TeX Live
In-Reply-To: <CA0NR1WYKD61.32WGUWWXS1THA@phobos>
References: <CA0NR1WYKD61.32WGUWWXS1THA@phobos>
Message-ID: <CAG5iGsCA=d4P9sUQbLbTY=FGn+o3b2+0BTSTmnhg8t8ZKVzQRw@mail.gmail.com>

Il Gio 18 Mar 2021, 20:05 Michal Vlas?k <lahcim8 at gmail.com> ha scritto:

> Hello,
>
> the LuaTeX manual PDF (version: February 14, 2021) as included on CTAN
> [1] and in TeX Live [2] is missing the luaharfbuzz reference. ConTeXt's
> grey placeholder is present instead. The older version (January 30,
> 2021) as present in the LuaTeX SVN repository [3] is fine in this
> regard. (The version present in ConTeXt is missing the chapter about
> HarfBuzz entirely, but I believe this is intentional.)
>
> I am sorry if this isn't the right place or time for the report, but I
> am not sure how the is manual propagated and TeX Live freeze is near.
>
> Michal Vlas?k
>
> [1] http://mirrors.ctan.org/systems/doc/luatex/luatex.pdf
> [2]
> https://tug.org/svn/texlive/trunk/Master/texmf-dist/doc/luatex/base/luatex.pdf?view=co
> [3] https://serveur-svn.lri.fr/svn/modhel/luatex/trunk/manual/luatex.pdf
>


Ok, I will check  it later.

>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210318/99341633/attachment.html>

From luigi.scarso at gmail.com  Thu Mar 18 20:35:54 2021
From: luigi.scarso at gmail.com (luigi scarso)
Date: Thu, 18 Mar 2021 20:35:54 +0100
Subject: [luatex] LuaTeX manual miscompiled on CTAN and in TeX Live
In-Reply-To: <CAG5iGsCA=d4P9sUQbLbTY=FGn+o3b2+0BTSTmnhg8t8ZKVzQRw@mail.gmail.com>
References: <CA0NR1WYKD61.32WGUWWXS1THA@phobos>
 <CAG5iGsCA=d4P9sUQbLbTY=FGn+o3b2+0BTSTmnhg8t8ZKVzQRw@mail.gmail.com>
Message-ID: <CAG5iGsCKvNkEb6F1rdaCQtwOmR8Zz5tS_6L42EO8Fkvcbr7rug@mail.gmail.com>

On Thu, Mar 18, 2021 at 8:08 PM luigi scarso <luigi.scarso at gmail.com> wrote:

>
>
> Il Gio 18 Mar 2021, 20:05 Michal Vlas?k <lahcim8 at gmail.com> ha scritto:
>
>> Hello,
>>
>> the LuaTeX manual PDF (version: February 14, 2021) as included on CTAN
>> [1] and in TeX Live [2] is missing the luaharfbuzz reference. ConTeXt's
>> grey placeholder is present instead. The older version (January 30,
>> 2021) as present in the LuaTeX SVN repository [3] is fine in this
>> regard. (The version present in ConTeXt is missing the chapter about
>> HarfBuzz entirely, but I believe this is intentional.)
>>
>>
my fault, almost for sure.
Fixed in experimental and texlive repo.

-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210318/e9322ed6/attachment.html>

From P.Taylor at Hellenic-Institute.Uk  Fri Mar 19 10:21:33 2021
From: P.Taylor at Hellenic-Institute.Uk (Philip Taylor)
Date: Fri, 19 Mar 2021 09:21:33 +0000
Subject: [luatex] Ligatures
Message-ID: <c8b1c98d-ee7c-aa68-0fc9-0c3c239731c2@Hellenic-Institute.Uk>

I asked a question on the XeTeX list concerning support for coloured 
fonts yesterday, and it was suggested that LuaTeX might provide a 
solution to my problem.? Indeed it does, but it introduces a new one ? 
while LuaTeX appears perfectly happy to form (for example) an "fi" 
ligature from the separate letters "f" & "i" in the font Minion Pro, it 
does not do the same with the font Adobe Caslon Pro, whether or not 
"+liga"and/or "+dlig" is specified, nor with the font Garamond and 
probably others.? The following is my test-bed, which produces correct 
ligatures using XeTeX but not using LuaTeX or LuaHbTeX.? Can anyone 
advise, please ?? UNIV: TeX Live 2021 (pre-test), Windows 7 64-bit.

/Philip Taylor
/--------
\ifcsname directlua\endcsname \input luaotfload.sty \fi


\font \bodyfont = "Minion Pro"

\centerline {\bodyfont Minion is a fit subject}

\font \bodyfont = "Adobe Caslon Pro"

\centerline {\bodyfont Caslon is a fit subject}

\font \bodyfont = "Adobe Caslon Pro:+liga;+dlig"

\centerline {\bodyfont Caslon is a fit subject}

\end


//
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210319/a25e3dd6/attachment.html>

From j.hagen at xs4all.nl  Fri Mar 19 10:48:28 2021
From: j.hagen at xs4all.nl (Hans Hagen)
Date: Fri, 19 Mar 2021 10:48:28 +0100
Subject: [luatex] Ligatures
In-Reply-To: <c8b1c98d-ee7c-aa68-0fc9-0c3c239731c2@Hellenic-Institute.Uk>
References: <c8b1c98d-ee7c-aa68-0fc9-0c3c239731c2@Hellenic-Institute.Uk>
Message-ID: <97ccdc81-62e1-1bcb-2af3-3655e367fabb@xs4all.nl>

On 3/19/2021 10:21 AM, Philip Taylor wrote:
> I asked a question on the XeTeX list concerning support for coloured 
> fonts yesterday, and it was suggested that LuaTeX might provide a 
> solution to my problem.? Indeed it does, but it introduces a new one ? 
> while LuaTeX appears perfectly happy to form (for example) an "fi" 
> ligature from the separate letters "f" & "i" in the font Minion Pro, it 
> does not do the same with the font Adobe Caslon Pro, whether or not 
> "+liga"and/or "+dlig" is specified, nor with the font Garamond and 
> probably others.? The following is my test-bed, which produces correct 
> ligatures using XeTeX but not using LuaTeX or LuaHbTeX.? Can anyone 
> advise, please ?? UNIV: TeX Live 2021 (pre-test), Windows 7 64-bit.
> 
> /Philip Taylor
> /--------
> \ifcsname directlua\endcsname \input luaotfload.sty \fi
> 
> 
> \font \bodyfont = "Minion Pro"
> 
> \centerline {\bodyfont Minion is a fit subject}
> 
> \font \bodyfont = "Adobe Caslon Pro"
> 
> \centerline {\bodyfont Caslon is a fit subject}
> 
> \font \bodyfont = "Adobe Caslon Pro:+liga;+dlig"
> 
> \centerline {\bodyfont Caslon is a fit subject}

it looks ok here; the font no dflt script so you need to activate the 
latn script for ligatures to work

Hans


-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From P.Taylor at Hellenic-Institute.Uk  Fri Mar 19 11:09:35 2021
From: P.Taylor at Hellenic-Institute.Uk (Philip Taylor)
Date: Fri, 19 Mar 2021 10:09:35 +0000
Subject: [luatex] Ligatures
In-Reply-To: <97ccdc81-62e1-1bcb-2af3-3655e367fabb@xs4all.nl>
References: <c8b1c98d-ee7c-aa68-0fc9-0c3c239731c2@Hellenic-Institute.Uk>
 <97ccdc81-62e1-1bcb-2af3-3655e367fabb@xs4all.nl>
Message-ID: <e2141276-22cb-e534-6adb-39dd653f17df@Hellenic-Institute.Uk>

Hans Hagen wrote:

> it looks ok here; the font no dflt script so you need to activate the 
> latn script for ligatures to work

Thank you Hans, but I am suprised that it looked OK at your end.? At 
this end, and following your suggestion, all of the lines in the 
following example now display the correct ligatures, but in my earlier 
example, with no 'script=latn', only the first (Adobe Minion Pro) 
produced ligatures.? Are you able to explain why LuaTeX does the right 
thing with Adobe Minion Pro in the absence of a 'script=latn' but does 
not with the other three fonts tried ?

/Philip Taylor
--------
/


\ifcsname directlua\endcsname \input luaotfload.sty \fi

\font \bodyfont = "Minion Pro"
\centerline {\bodyfont Minion is a genuinely fit subject}
\font \bodyfont = "Adobe Caslon Pro:script=latn"
\centerline {\bodyfont Caslon is a genuinely fit subject}
\font \bodyfont = "Adobe Garamond Pro:script=latn"
\centerline {\bodyfont Garamond is a genuinely fit subject}
\font \bodyfont = "Garamond Premier Pro:script=latn"
\centerline {\bodyfont Garamond is a genuinely fit subject}

\end
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210319/d4301472/attachment-0001.html>

From Herbert.Voss at fu-berlin.de  Fri Mar 19 11:14:53 2021
From: Herbert.Voss at fu-berlin.de (Herbert Voss)
Date: Fri, 19 Mar 2021 11:14:53 +0100
Subject: [luatex] Ligatures
In-Reply-To: <e2141276-22cb-e534-6adb-39dd653f17df@Hellenic-Institute.Uk>
References: <c8b1c98d-ee7c-aa68-0fc9-0c3c239731c2@Hellenic-Institute.Uk>
 <97ccdc81-62e1-1bcb-2af3-3655e367fabb@xs4all.nl>
 <e2141276-22cb-e534-6adb-39dd653f17df@Hellenic-Institute.Uk>
Message-ID: <202f26e6-70f2-0ea4-37b3-907483258ec8@fu-berlin.de>



Am 19.03.21 um 11:09 schrieb Philip Taylor:
> Hans Hagen wrote:
>
>> it looks ok here; the font no dflt script so you need to activate the 
>> latn script for ligatures to work
>
> Thank you Hans, but I am suprised that it looked OK at your end. At 
> this end, and following your suggestion, all of the lines in the 
> following example now display the correct ligatures, but in my earlier 
> example, with no 'script=latn', only the first (Adobe Minion Pro) 
> produced ligatures.? Are you able to explain why LuaTeX does the right 
> thing with Adobe Minion Pro in the absence of a 'script=latn' but does 
> not with the other three fonts tried ?


bash-3.2$ otfinfo -s MinionPro-Regular.otf
DFLT??? ??? Default
cyrl??? ??? Cyrillic
cyrl.SRB??? Cyrillic/Serbian
grek??? ??? Greek
latn??? ??? Latin
latn.AZE??? Latin/Azeri
latn.CRT??? Latin/Crimean Tatar
latn.DEU??? Latin/German
latn.MOL??? Latin/Moldavian
latn.ROM??? Latin/Romanian
latn.TRK??? Latin/Turkish


bash-3.2$ otfinfo -s ACaslonPro-Regular.otf
latn??? ??? Latin
latn.MOL??? Latin/Moldavian
latn.ROM??? Latin/Romanian
latn.TUR??? Latin/Turkish



Herbert

From j.hagen at xs4all.nl  Fri Mar 19 12:41:17 2021
From: j.hagen at xs4all.nl (Hans Hagen)
Date: Fri, 19 Mar 2021 12:41:17 +0100
Subject: [luatex] Ligatures
In-Reply-To: <e2141276-22cb-e534-6adb-39dd653f17df@Hellenic-Institute.Uk>
References: <c8b1c98d-ee7c-aa68-0fc9-0c3c239731c2@Hellenic-Institute.Uk>
 <97ccdc81-62e1-1bcb-2af3-3655e367fabb@xs4all.nl>
 <e2141276-22cb-e534-6adb-39dd653f17df@Hellenic-Institute.Uk>
Message-ID: <8ea1a705-5b42-8bf1-f2fc-107eec9f0434@xs4all.nl>

On 3/19/2021 11:09 AM, Philip Taylor wrote:
> Hans Hagen wrote:
> 
>> it looks ok here; the font no dflt script so you need to activate the 
>> latn script for ligatures to work
> 
> Thank you Hans, but I am suprised that it looked OK at your end.? At 
> this end, and following your suggestion, all of the lines in the 
> following example now display the correct ligatures, but in my earlier 
> example, with no 'script=latn', only the first (Adobe Minion Pro) 
> produced ligatures.? Are you able to explain why LuaTeX does the right 
> thing with Adobe Minion Pro in the absence of a 'script=latn' but does 
> not with the other three fonts tried ?
because there is a dflt/dflt script/language entry in the features table 
of those fonts and features are driven by script/language combinations 
(while the other font has latn/dflt ... it could be  that you'd have to 
set latn/eng because not all latin scripts might like these ligatures)

(i can't speak for plain/latex but context uses different heuristics 
when dealing with these issues which can be why its users observe 
different results)

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From P.Taylor at Hellenic-Institute.Uk  Fri Mar 19 13:20:14 2021
From: P.Taylor at Hellenic-Institute.Uk (Philip Taylor)
Date: Fri, 19 Mar 2021 12:20:14 +0000
Subject: [luatex] Ligatures
In-Reply-To: <8ea1a705-5b42-8bf1-f2fc-107eec9f0434@xs4all.nl>
References: <c8b1c98d-ee7c-aa68-0fc9-0c3c239731c2@Hellenic-Institute.Uk>
 <97ccdc81-62e1-1bcb-2af3-3655e367fabb@xs4all.nl>
 <e2141276-22cb-e534-6adb-39dd653f17df@Hellenic-Institute.Uk>
 <8ea1a705-5b42-8bf1-f2fc-107eec9f0434@xs4all.nl>
Message-ID: <149d1c9e-9c43-2e76-46a6-4332307bcea9@Hellenic-Institute.Uk>

Hans Hagen wrote:

> because there is a dflt/dflt script/language entry in the features 
> table of those fonts and features are driven by script/language 
> combinations (while the other font has latn/dflt ... it could be that 
> you'd have to set latn/eng because not all latin scripts might like 
> these ligatures)

Herbert Voss wrote:

> bash-3.2$ otfinfo -s MinionPro-Regular.otf
> DFLT??? ??? Default
> cyrl??? ??? Cyrillic
> cyrl.SRB??? Cyrillic/Serbian
> grek??? ??? Greek
> latn??? ??? Latin
> latn.AZE??? Latin/Azeri
> latn.CRT??? Latin/Crimean Tatar
> latn.DEU??? Latin/German
> latn.MOL??? Latin/Moldavian
> latn.ROM??? Latin/Romanian
> latn.TRK??? Latin/Turkish
>
>
> bash-3.2$ otfinfo -s ACaslonPro-Regular.otf
> latn??? ??? Latin
> latn.MOL??? Latin/Moldavian
> latn.ROM??? Latin/Romanian
> latn.TUR??? Latin/Turkish

My thanks to you both.? I don't pretend for one second to understand the 
OTFinfo outputs at the moment, but I will go away and study them and see 
what I can learn ...
/--
** Phil (Philip Taylor)
/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210319/043eeb73/attachment.html>

From andreas.matthias at gmail.com  Wed Mar 24 12:44:40 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 24 Mar 2021 12:44:40 +0100
Subject: [luatex] Accessing external Lua libraries
Message-ID: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>

To access external Lua libraries I have the following settings in texmf.cnf:

   LUAROCKS_PATH = ~/.luarocks/share/lua/5.3
   LUAROCKS_CPATH= ~/.luarocks/lib/lua/5.3

   LUAINPUTS = <default_path_here>//;$LUAROCKS_PATH//
   CLUAINPUTS = <default_path_here>//;$LUAROCKS_CPATH//

Now I have access to files like:

   ~/.luarocks/share/lua/5.3/?.lua
   ~/.luarocks/lib/lua/5.3/?.so

But unfortunately I do not get access to `init.lua` files, i.e.:

   ~/.luarocks/share/lua/5.3/?/init.lua

What should I do to access these files?

In addition I have a sneaking suspicion that

   \directlua{
       print(package.path)
   }

displays the content of the environment variable $LUA_PATH, but not the
path that is actually accessible to luatex when using kpse settings.
This is confusing.

Andreas

From luigi.scarso at gmail.com  Wed Mar 24 14:31:23 2021
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 24 Mar 2021 14:31:23 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
Message-ID: <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>

On Wed, Mar 24, 2021 at 12:45 PM Andreas Matthias <
andreas.matthias at gmail.com> wrote:

> To access external Lua libraries I have the following settings in
> texmf.cnf:
>
>    LUAROCKS_PATH = ~/.luarocks/share/lua/5.3
>    LUAROCKS_CPATH= ~/.luarocks/lib/lua/5.3
>
>    LUAINPUTS = <default_path_here>//;$LUAROCKS_PATH//
>    CLUAINPUTS = <default_path_here>//;$LUAROCKS_CPATH//
>
> Now I have access to files like:
>
>    ~/.luarocks/share/lua/5.3/?.lua
>    ~/.luarocks/lib/lua/5.3/?.so
>
> But unfortunately I do not get access to `init.lua` files, i.e.:
>
>    ~/.luarocks/share/lua/5.3/?/init.lua
>
> What should I do to access these files?
>
> In addition I have a sneaking suspicion that
>
>    \directlua{
>        print(package.path)
>    }
>
> displays the content of the environment variable $LUA_PATH, but not the
> path that is actually accessible to luatex when using kpse settings.
>


You can run luatex --kpathsea-debug=-1
to check what kpse is doing.
-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210324/caeaf4e8/attachment.html>

From andreas.matthias at gmail.com  Wed Mar 24 15:44:03 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 24 Mar 2021 15:44:03 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
Message-ID: <CAHp59H2HjFzpggqzTqmeHVcgM-gSAFHP9Pf8zniLNoae-z6Deg@mail.gmail.com>

On Wed, Mar 24, 2021 at 2:32 PM luigi scarso <luigi.scarso at gmail.com> wrote:
>
> You can run luatex --kpathsea-debug=-1
> to check what kpse is doing.

Well, I can see how TEXMF... variables are expanded, but nothing about
LUAINPUTS.
Do I have to compile luatex with certain compiler flags to make this work?

Andreas

From luigi.scarso at gmail.com  Wed Mar 24 16:00:07 2021
From: luigi.scarso at gmail.com (luigi scarso)
Date: Wed, 24 Mar 2021 16:00:07 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CAHp59H2HjFzpggqzTqmeHVcgM-gSAFHP9Pf8zniLNoae-z6Deg@mail.gmail.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
 <CAHp59H2HjFzpggqzTqmeHVcgM-gSAFHP9Pf8zniLNoae-z6Deg@mail.gmail.com>
Message-ID: <CAG5iGsATcgD3U0qGZkxOOF5pKotMYG_Qzv64JeKyf+141MADVg@mail.gmail.com>

On Wed, Mar 24, 2021 at 3:44 PM Andreas Matthias <andreas.matthias at gmail.com>
wrote:

> On Wed, Mar 24, 2021 at 2:32 PM luigi scarso <luigi.scarso at gmail.com>
> wrote:
> >
> > You can run luatex --kpathsea-debug=-1
> > to check what kpse is doing.
>
> Well, I can see how TEXMF... variables are expanded, but nothing about
> LUAINPUTS.
> Do I have to compile luatex with certain compiler flags to make this work?
>

hm no... Have you seen
4.2.3      Loading libraries
in  luatex.pdf ?

-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210324/155f37e4/attachment.html>

From andreas.matthias at gmail.com  Wed Mar 24 17:00:49 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 24 Mar 2021 17:00:49 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CAG5iGsATcgD3U0qGZkxOOF5pKotMYG_Qzv64JeKyf+141MADVg@mail.gmail.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
 <CAHp59H2HjFzpggqzTqmeHVcgM-gSAFHP9Pf8zniLNoae-z6Deg@mail.gmail.com>
 <CAG5iGsATcgD3U0qGZkxOOF5pKotMYG_Qzv64JeKyf+141MADVg@mail.gmail.com>
Message-ID: <CAHp59H1p-JAqSkiVbfQvijnLxw7R3n8DyPeetWm7F45AURzPng@mail.gmail.com>

On Wed, Mar 24, 2021 at 4:00 PM luigi scarso <luigi.scarso at gmail.com> wrote:
>
> On Wed, Mar 24, 2021 at 3:44 PM Andreas Matthias <andreas.matthias at gmail.com> wrote:
>>
>> On Wed, Mar 24, 2021 at 2:32 PM luigi scarso <luigi.scarso at gmail.com> wrote:
>> >
>> > You can run luatex --kpathsea-debug=-1
>> > to check what kpse is doing.
>>
>> Well, I can see how TEXMF... variables are expanded, but nothing about
>> LUAINPUTS.
>> Do I have to compile luatex with certain compiler flags to make this work?
>
> hm no... Have you seen
> 4.2.3      Loading libraries
> in  luatex.pdf ?

Ok, my fault. I saw that kpse library was loaded with plain luatex and
misinterpreted this.
Unfortunately, I do not really understand how package.searchers is
working. I'll try
to catch up on this.

Anyway, I'm more concerned about my first question in the original
email concerning
"init.lua" files: I'd like to load a library with e.g.

   require ('foobar')

when this statement refers to a file ".../foobar/init.lua", not "foobar.lua".
How can I achieve this? I'm sorry if this question is related to my
lack of understanding
of the topic above.

Andreas

From faheem at faheem.info  Wed Mar 24 17:52:36 2021
From: faheem at faheem.info (Faheem Mitha)
Date: Wed, 24 Mar 2021 22:22:36 +0530 (IST)
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
Message-ID: <1616604759-2602837.6364261.f12OGqbkT054550@rs166.luxsci.com>


Hi Luigi,

See below.

On Wed, 24 Mar 2021, luigi scarso wrote:

> On Wed, Mar 24, 2021 at 12:45 PM Andreas Matthias <andreas.matthias at gmail.com> wrote:
>       To access external Lua libraries I have the following settings in texmf.cnf:
>
>       ? ?LUAROCKS_PATH = ~/.luarocks/share/lua/5.3
>       ? ?LUAROCKS_CPATH= ~/.luarocks/lib/lua/5.3
>
>       ? ?LUAINPUTS = <default_path_here>//;$LUAROCKS_PATH//
>       ? ?CLUAINPUTS = <default_path_here>//;$LUAROCKS_CPATH//
>
>       Now I have access to files like:
>
>       ? ?~/.luarocks/share/lua/5.3/?.lua
>       ? ?~/.luarocks/lib/lua/5.3/?.so
>
>       But unfortunately I do not get access to `init.lua` files, i.e.:
>
>       ? ?~/.luarocks/share/lua/5.3/?/init.lua
>
>       What should I do to access these files?
>
>       In addition I have a sneaking suspicion that
>
>       ? ?\directlua{
>       ? ? ? ?print(package.path)
>       ? ?}
>
>       displays the content of the environment variable $LUA_PATH, but not the
>       path that is actually accessible to luatex when using kpse settings.

I'm not completely sure I understand what your issue is, but you might 
find https://ctan.org/pkg/luapackageloader of interest if you aren't 
familiar with it already. The strategy it uses is described somewhere in 
the LuaTeX manual I think, though right now I can't remember exactly 
where.

Regards, Faheem Mitha

> You can run luatex --kpathsea-debug=-1
> to check what kpse?is?doing.
> --
> luigi
> 
>

From faheem at faheem.info  Wed Mar 24 17:58:50 2021
From: faheem at faheem.info (Faheem Mitha)
Date: Wed, 24 Mar 2021 22:28:50 +0530 (IST)
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <1616604759-2602837.6364261.f12OGqbkT054550@rs166.luxsci.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
 <1616604759-2602837.6364261.f12OGqbkT054550@rs166.luxsci.com>
Message-ID: <1616605132-2195356.82661555.f12OGwoU7064803@rs166.luxsci.com>


On Wed, 24 Mar 2021, Faheem Mitha wrote:

> I'm not completely sure I understand what your issue is, but you might find 
> https://ctan.org/pkg/luapackageloader of interest if you aren't familiar with 
> it already. The strategy it uses is described somewhere in the LuaTeX manual 
> I think, though right now I can't remember exactly where.

I forgot to say that I use

package.cpath="/usr/local/lib/lua/5.3/?.so;/usr/lib/x86_64-linux-gnu/lua/5.3/?.so;/usr/lib/lua/5.3/?.so;/usr/local/lib/lua/5.3/loadall.so;./?.so"..package.cpath

package.path="/usr/local/share/lua/5.3/?.lua;/usr/local/share/lua/5.3/?/init.lua;/usr/local/lib/lua/5.3/?.lua;/usr/local/lib/lua/5.3/?/init.lua;/usr/share/lua/5.3/?.lua;/usr/share/lua/5.3/?/init.lua;./?.lua"..package.path

in my Lua files for use with LuaTeX, in conjunction with luapackageloader, 
and it seems to work. Though I can't remember whether I specifically 
needed to load an init.lua.

Hope this helps.

Regards, Faheem Mitha



From andreas.matthias at gmail.com  Wed Mar 24 19:41:40 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 24 Mar 2021 19:41:40 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <1616604759-2602837.6364261.f12OGqbkT054550@rs166.luxsci.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
 <1616604759-2602837.6364261.f12OGqbkT054550@rs166.luxsci.com>
Message-ID: <CAHp59H2dKj-pTK2t6ApSTLj_U39ZRX7Me8PU9=tpwKKxF8CdAQ@mail.gmail.com>

On Wed, Mar 24, 2021 at 5:53 PM Faheem Mitha <faheem at faheem.info> wrote:
>
> On Wed, 24 Mar 2021, luigi scarso wrote:
>
> > On Wed, Mar 24, 2021 at 12:45 PM Andreas Matthias <andreas.matthias at gmail.com> wrote:
> >       To access external Lua libraries I have the following settings in texmf.cnf:
> >
> >          LUAROCKS_PATH = ~/.luarocks/share/lua/5.3
> >          LUAROCKS_CPATH= ~/.luarocks/lib/lua/5.3
> >
> >          LUAINPUTS = <default_path_here>//;$LUAROCKS_PATH//
> >          CLUAINPUTS = <default_path_here>//;$LUAROCKS_CPATH//
> >
> >       Now I have access to files like:
> >
> >          ~/.luarocks/share/lua/5.3/?.lua
> >          ~/.luarocks/lib/lua/5.3/?.so
> >
> >       But unfortunately I do not get access to `init.lua` files, i.e.:
> >
> >          ~/.luarocks/share/lua/5.3/?/init.lua
> >
> >       What should I do to access these files?
>
> I'm not completely sure I understand what your issue is, but you might
> find https://ctan.org/pkg/luapackageloader of interest if you aren't
> familiar with it already. The strategy it uses is described somewhere in
> the LuaTeX manual I think, though right now I can't remember exactly
> where.

Hmm..., I cannot load any module that uses an 'init.lua' file. I gave
luapackageloader.sty a try but it didn't work either.

What happens if you are loading such a module? There are many
modules in luarocks which are based on init.lua files.

Andras

From faheem at faheem.info  Wed Mar 24 19:57:57 2021
From: faheem at faheem.info (Faheem Mitha)
Date: Thu, 25 Mar 2021 00:27:57 +0530 (IST)
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CAHp59H2dKj-pTK2t6ApSTLj_U39ZRX7Me8PU9=tpwKKxF8CdAQ@mail.gmail.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
 <1616604759-2602837.6364261.f12OGqbkT054550@rs166.luxsci.com>
 <CAHp59H2dKj-pTK2t6ApSTLj_U39ZRX7Me8PU9=tpwKKxF8CdAQ@mail.gmail.com>
Message-ID: <1616612279-3291063.68152407.f12OIvvFM026933@rs166.luxsci.com>


On Wed, 24 Mar 2021, Andreas Matthias wrote:

> Hmm..., I cannot load any module that uses an 'init.lua' file. I gave
> luapackageloader.sty a try but it didn't work either.
>
> What happens if you are loading such a module? There are many
> modules in luarocks which are based on init.lua files.

Can you give me a few examples of such modules? Preferably those that are 
packaged for Debian. Because I mostly avoid using luarocks. Debian tends 
to package the bigger and better known Lua modules, like penlight.

Regards, Faheem Mitha

From andreas.matthias at gmail.com  Wed Mar 24 20:18:00 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 24 Mar 2021 20:18:00 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <1616612279-3291063.68152407.f12OIvvFM026933@rs166.luxsci.com>
References: <CAHp59H0cBdL0B4HQTfegD9KcWRZgTEaQrwrPXYWjOrDHQd_Rcg@mail.gmail.com>
 <CAG5iGsBZmBraQTdrRFLrV+OH7QAhqhp9YAmwPxAgdsAfOOWo_Q@mail.gmail.com>
 <1616604759-2602837.6364261.f12OGqbkT054550@rs166.luxsci.com>
 <CAHp59H2dKj-pTK2t6ApSTLj_U39ZRX7Me8PU9=tpwKKxF8CdAQ@mail.gmail.com>
 <1616612279-3291063.68152407.f12OIvvFM026933@rs166.luxsci.com>
Message-ID: <CAHp59H02koBd+1LEd1V4YbUq_NVgX3096sY20m8Ny6uqaXHXeQ@mail.gmail.com>

On Wed, Mar 24, 2021 at 7:58 PM Faheem Mitha <faheem at faheem.info> wrote:
>
> On Wed, 24 Mar 2021, Andreas Matthias wrote:
>
> > Hmm..., I cannot load any module that uses an 'init.lua' file. I gave
> > luapackageloader.sty a try but it didn't work either.
> >
> > What happens if you are loading such a module? There are many
> > modules in luarocks which are based on init.lua files.
>
> Can you give me a few examples of such modules? Preferably those that are
> packaged for Debian. Because I mostly avoid using luarocks. Debian tends
> to package the bigger and better known Lua modules, like penlight.

I was trying to load lua-busted. I installed it via luarocks, but it
is available
in Debian as well.

Andreas

From lahcim8 at gmail.com  Wed Mar 24 21:17:28 2021
From: lahcim8 at gmail.com (=?utf-8?q?Michal_Vlas=C3=A1k?=)
Date: Wed, 24 Mar 2021 21:17:28 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <1616605132-2195356.82661555.f12OGwoU7064803@rs166.luxsci.com>
Message-ID: <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>

On Wed Mar 24, 2021 at 5:58 PM CET, Faheem Mitha wrote:
>
> On Wed, 24 Mar 2021, Faheem Mitha wrote:
>
> > I'm not completely sure I understand what your issue is, but you might find 
> > https://ctan.org/pkg/luapackageloader of interest if you aren't familiar with 
> > it already. The strategy it uses is described somewhere in the LuaTeX manual 
> > I think, though right now I can't remember exactly where.
>
> I forgot to say that I use
>
> package.cpath="/usr/local/lib/lua/5.3/?.so;/usr/lib/x86_64-linux-gnu/lua/5.3/?.so;/usr/lib/lua/5.3/?.so;/usr/local/lib/lua/5.3/loadall.so;./?.so"..package.cpath
>
> package.path="/usr/local/share/lua/5.3/?.lua;/usr/local/share/lua/5.3/?/init.lua;/usr/local/lib/lua/5.3/?.lua;/usr/local/lib/lua/5.3/?/init.lua;/usr/share/lua/5.3/?.lua;/usr/share/lua/5.3/?/init.lua;./?.lua"..package.path
>
> in my Lua files for use with LuaTeX, in conjunction with
> luapackageloader,
> and it seems to work. Though I can't remember whether I specifically
> needed to load an init.lua.
>
> Hope this helps.
>
> Regards, Faheem Mitha

Andreas, what Faheem suggests should work for you: use luapackage and
set package.path/packge.cpath to what you want. You should see section
6.3 "Modules" of https://www.lua.org/manual/5.3/manual.html and also the
source code of luapackageloader (luapackageloader.lua) to understand how
this works. Also you may have to disable some security precautions
(--shell-escape and no --safer).

Something like this should hopefully work for your setup:

```
\input luapackageloader.sty

\bgroup
\catcode`~=12
\catcode`\%=12
\directlua{
local luarocks_path = kpse.expand_path("~/.luarocks/share/lua/5.3")
local luarocks_cpath = kpse.expand_path("~/.luarocks/lib/lua/5.3")

package.path  = package.path  .. string.format(";%s/?.lua;%s/?/init.lua", luarocks_path, luarocks_path)
package.cpath = package.cpath .. string.format(";%s/?.so;%s/?/init.so", luarocks_cpath, luarocks_cpath)

module = require("module")
}
\egroup

\bye
```

Note that this appends to existing paths as you saw them earlier and
expects the ~/.luarocks directories to exist.

Michal


From andreas.matthias at gmail.com  Wed Mar 24 22:31:27 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 24 Mar 2021 22:31:27 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
References: <1616605132-2195356.82661555.f12OGwoU7064803@rs166.luxsci.com>
 <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
Message-ID: <CAHp59H29Cs5rOKM6gRmu_Jy8EjyMVPR7uahoO=TspqfqGg1bPg@mail.gmail.com>

On Wed, Mar 24, 2021 at 9:33 PM Michal Vlas?k <lahcim8 at gmail.com> wrote:
>
> Andreas, what Faheem suggests should work for you: use luapackage and
> set package.path/packge.cpath to what you want. You should see section
> 6.3 "Modules" of https://www.lua.org/manual/5.3/manual.html and also the
> source code of luapackageloader (luapackageloader.lua) to understand how
> this works. Also you may have to disable some security precautions
> (--shell-escape and no --safer).

Oh, this is embarrassing... You are right. It's actually working with
luapackageloader.
I just forgot to use --shell-escape.

To sum up (and I hope this is correct): Setting LUAINPUTS and CLUAINPUTS in
texmf.cnf is not enough to load _all_ kind of modules/libraries. It
suffice to load
files like 'foobar.lua' or 'foobar.so'. But to load files like
'foobar/init.lua' one needs
luapackageloader.

Andreas


From andreas.matthias at gmail.com  Wed Mar 24 23:22:52 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 24 Mar 2021 23:22:52 +0100
Subject: [luatex] [EXT] Re:  Accessing external Lua libraries
In-Reply-To: <18093734-b633-5483-f778-25b9e3d604a5@Rhul.Ac.Uk>
References: <1616605132-2195356.82661555.f12OGwoU7064803@rs166.luxsci.com>
 <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
 <CAHp59H29Cs5rOKM6gRmu_Jy8EjyMVPR7uahoO=TspqfqGg1bPg@mail.gmail.com>
 <18093734-b633-5483-f778-25b9e3d604a5@Rhul.Ac.Uk>
Message-ID: <CAHp59H2vgdmc=HtkjWa=e3pPQYGoaXGDYkF4V78z_0KRwqXPWA@mail.gmail.com>

On Wed, Mar 24, 2021 at 10:50 PM Philip Taylor <P.Taylor at rhul.ac.uk> wrote:
>
> Andreas Matthias wrote:
>
> Setting LUAINPUTS and CLUAINPUTS in texmf.cnf is not enough
> to load _all_ kind of modules/libraries. It suffice[s] to
> load files like 'foobar.lua' or 'foobar.so'. But to load files
> like 'foobar/init.lua' one needs luapackageloader.
>
> For the benefit of those (such as myself) who are less familiar with Lua conventions than yourself, Andreas, could you explain which of the two possible criteria is the crucial one ?  Is it (a) that the file lives in a sub-directory such as "foobar", or (b) that the file is called "init.lua" and not (e.g.,) "foobar.lua" ?  Or I suppose (c), both of the preceding.

I think both are common. At least both are mentioned in

   Programming in Lua (3. edition)
   ?15.4 Submodules and Packages

I don't know why kpathsea doesn't handle both. Hmm... maybe:
This section didn't exist in the first edition of the book. Don't
know about the second. Maybe the adjustments for lua in kpathsea
date back earlier?

Andreas


From P.Taylor at Rhul.Ac.Uk  Wed Mar 24 22:50:25 2021
From: P.Taylor at Rhul.Ac.Uk (Philip Taylor)
Date: Wed, 24 Mar 2021 21:50:25 +0000
Subject: [luatex] [EXT] Re:  Accessing external Lua libraries
In-Reply-To: <CAHp59H29Cs5rOKM6gRmu_Jy8EjyMVPR7uahoO=TspqfqGg1bPg@mail.gmail.com>
References: <1616605132-2195356.82661555.f12OGwoU7064803@rs166.luxsci.com>
 <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
 <CAHp59H29Cs5rOKM6gRmu_Jy8EjyMVPR7uahoO=TspqfqGg1bPg@mail.gmail.com>
Message-ID: <18093734-b633-5483-f778-25b9e3d604a5@Rhul.Ac.Uk>

Andreas Matthias wrote:

Setting LUAINPUTS and CLUAINPUTS in texmf.cnf is not enough
to load _all_ kind of modules/libraries. It suffice[s] to
load files like 'foobar.lua' or 'foobar.so'. But to load files
like 'foobar/init.lua' one needs luapackageloader.

For the benefit of those (such as myself) who are less familiar with Lua conventions than yourself, Andreas, could you explain which of the two possible criteria is the crucial one ?  Is it (a) that the file lives in a sub-directory such as "foobar", or (b) that the file is called "init.lua" and not (e.g.,) "foobar.lua" ?  Or I suppose (c), both of the preceding.
--
Philip Taylor



This email, its contents and any attachments are intended solely for the addressee and may contain confidential information. In certain circumstances, it may also be subject to legal privilege. Any unauthorised use, disclosure, or copying is not permitted. If you have received this email in error, please notify us and immediately and permanently delete it. Any views or opinions expressed in personal emails are solely those of the author and do not necessarily represent those of Royal Holloway, University of London. It is your responsibility to ensure that this email and any attachments are virus free.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210324/e0426eb3/attachment-0001.html>

From P.Taylor at Rhul.Ac.Uk  Thu Mar 25 09:21:47 2021
From: P.Taylor at Rhul.Ac.Uk (Philip Taylor)
Date: Thu, 25 Mar 2021 08:21:47 +0000
Subject: [luatex] [EXT] Re: Accessing external Lua libraries
In-Reply-To: <CAHp59H2vgdmc=HtkjWa=e3pPQYGoaXGDYkF4V78z_0KRwqXPWA@mail.gmail.com>
References: <1616605132-2195356.82661555.f12OGwoU7064803@rs166.luxsci.com>
 <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
 <CAHp59H29Cs5rOKM6gRmu_Jy8EjyMVPR7uahoO=TspqfqGg1bPg@mail.gmail.com>
 <18093734-b633-5483-f778-25b9e3d604a5@Rhul.Ac.Uk>
 <CAHp59H2vgdmc=HtkjWa=e3pPQYGoaXGDYkF4V78z_0KRwqXPWA@mail.gmail.com>
Message-ID: <dad56c8e-1718-238c-0c3d-227f22dba8d9@Rhul.Ac.Uk>

Andreas Matthias wrote:

I think both are common. At least both are mentioned in


   Programming in Lua (3. edition)
   ?15.4 Submodules and Packages

I don't know why kpathsea doesn't handle both. Hmm... maybe:
This section didn't exist in the first edition of the book. Don't
know about the second. Maybe the adjustments for lua in kpathsea
date back earlier?


Ah, thank you Andreas, OK, understood.
--
Philip Taylor

This email, its contents and any attachments are intended solely for the addressee and may contain confidential information. In certain circumstances, it may also be subject to legal privilege. Any unauthorised use, disclosure, or copying is not permitted. If you have received this email in error, please notify us and immediately and permanently delete it. Any views or opinions expressed in personal emails are solely those of the author and do not necessarily represent those of Royal Holloway, University of London. It is your responsibility to ensure that this email and any attachments are virus free.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210325/ec848ac4/attachment.html>

From lahcim8 at gmail.com  Thu Mar 25 11:51:26 2021
From: lahcim8 at gmail.com (=?utf-8?q?Michal_Vlas=C3=A1k?=)
Date: Thu, 25 Mar 2021 11:51:26 +0100
Subject: [luatex] [EXT] Re:  Accessing external Lua libraries
In-Reply-To: <CAHp59H2vgdmc=HtkjWa=e3pPQYGoaXGDYkF4V78z_0KRwqXPWA@mail.gmail.com>
Message-ID: <CA6DI5BR90QP.1XCOM30T6OQ1@phobos>

On Wed Mar 24, 2021 at 11:22 PM CET, Andreas Matthias wrote:
> On Wed, Mar 24, 2021 at 10:50 PM Philip Taylor <P.Taylor at rhul.ac.uk>
> wrote:
> >
> > Andreas Matthias wrote:
> >
> > Setting LUAINPUTS and CLUAINPUTS in texmf.cnf is not enough
> > to load _all_ kind of modules/libraries. It suffice[s] to
> > load files like 'foobar.lua' or 'foobar.so'. But to load files
> > like 'foobar/init.lua' one needs luapackageloader.
> >
> > For the benefit of those (such as myself) who are less familiar with Lua conventions than yourself, Andreas, could you explain which of the two possible criteria is the crucial one ?  Is it (a) that the file lives in a sub-directory such as "foobar", or (b) that the file is called "init.lua" and not (e.g.,) "foobar.lua" ?  Or I suppose (c), both of the preceding.
>
> I think both are common. At least both are mentioned in
>
> Programming in Lua (3. edition)
> ?15.4 Submodules and Packages
>
> I don't know why kpathsea doesn't handle both. Hmm... maybe:
> This section didn't exist in the first edition of the book. Don't
> know about the second. Maybe the adjustments for lua in kpathsea
> date back earlier?
>
> Andreas

Well, at least as I understand it, kpathsea is designed to search for
files with more or less unique file names, while Lua path search is
based on "path patterns".

After kpathsea is ordered to find a file (e.g. "foobar" of type "lua")
and it sees that it doesn't have a suffix it tries all the suffixes it
knows. These are defined in tex-file.c:

#define LUA_SUFFIXES \
  ".lua", ".luatex", ".luc", ".luctex", ".texlua", ".texluc", ".tlu"

After adding equivalent of Lua's "?/init.lua" (which across platforms is
probably a suffix of 'DIR_SEP_STRING "init.lua"') Lua like path
searching for modules seems to work even in kpathsea. However surely
there are assumptions in the code that suffix does not contain directory
separtors and this will break in non simplistic cases. (Like in database
lookups). Maybe this can be fixed.

But I don't think it's worth to make these changes:

1) Both CTAN and TeX Live strongly prefer unique file names and I don't
think they would like many "init.lua" files.

2) Lua path searching for files outside of TEXMF trees can be achieved
using luapackageloader or custom path searcher.

Michal


From faheem at faheem.info  Thu Mar 25 13:12:38 2021
From: faheem at faheem.info (Faheem Mitha)
Date: Thu, 25 Mar 2021 17:42:38 +0530 (IST)
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
References: <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
Message-ID: <1616674360-3943011.62957134.f12PCCcju051844@rs166.luxsci.com>


On Wed, 24 Mar 2021, Michal Vlas?k wrote:

> Andreas, what Faheem suggests should work for you: use luapackage and
> set package.path/packge.cpath to what you want. You should see section
> 6.3 "Modules" of https://www.lua.org/manual/5.3/manual.html and also the
> source code of luapackageloader (luapackageloader.lua) to understand how
> this works. Also you may have to disable some security precautions
> (--shell-escape and no --safer).
>
> Something like this should hopefully work for your setup:
>
> ```
> \input luapackageloader.sty
>
> \bgroup
> \catcode`~=12
> \catcode`\%=12
> \directlua{
> local luarocks_path = kpse.expand_path("~/.luarocks/share/lua/5.3")
> local luarocks_cpath = kpse.expand_path("~/.luarocks/lib/lua/5.3")
>
> package.path  = package.path  .. string.format(";%s/?.lua;%s/?/init.lua", luarocks_path, luarocks_path)
> package.cpath = package.cpath .. string.format(";%s/?.so;%s/?/init.so", luarocks_cpath, luarocks_cpath)
>
> module = require("module")
> }
> \egroup
>
> \bye
> ```
>
> Note that this appends to existing paths as you saw them earlier and
> expects the ~/.luarocks directories to exist.
>
> Michal

I only have a sketchy idea about these things. I discovered 
luapackageloader by accident some time ago. Before I was using it, I had 
no idea how to load external packages. package.path and package.cpath just 
ignored whatever I added to them.

So, a couple of questions.

First, is it necessary to add stuff to the search path at the TeX end 
(kpse or whatever)? My experience is that adding stuff at the Lua end 
suffices for my needs. But of course my experience does not cover all use 
cases, and I think I've avoided using luarocks.

Second, is there some reason not to include the functionality of 
luapackageloader by default in LuaTeX? Then the Lua paths would work as 
expected. It might still make sense to have the functionality as a 
separate package, in case people wanted to disable that functionality for 
some reason. Though I can't imagine why they would want to.

I originally became aware of LuaTeX around 2012, but at that time I could 
not figure out a way to load external packages, though since I don't 
recall asking for help at the time, I probably did not pursue it very 
hard. But if this had worked out of the box for me then (and as stated I 
can't see any reason why it shouldn't), I would have started using LuaTeX 
much earlier.

Regards, Faheem Mitha

From j.hagen at xs4all.nl  Thu Mar 25 13:31:29 2021
From: j.hagen at xs4all.nl (Hans Hagen)
Date: Thu, 25 Mar 2021 13:31:29 +0100
Subject: [luatex] Accessing external Lua libraries
In-Reply-To: <1616674360-3943011.62957134.f12PCCcju051844@rs166.luxsci.com>
References: <CA5UWZDL2HKI.AM9QTAI6AAAS@phobos>
 <1616674360-3943011.62957134.f12PCCcju051844@rs166.luxsci.com>
Message-ID: <a615bd34-eef2-5781-07a1-42ff958d6870@xs4all.nl>

On 3/25/2021 1:12 PM, Faheem Mitha wrote:

> So, a couple of questions.
> 
> First, is it necessary to add stuff to the search path at the TeX end 
> (kpse or whatever)? My experience is that adding stuff at the Lua end 
> suffices for my needs. But of course my experience does not cover all 
> use cases, and I think I've avoided using luarocks.

you also need to match the lua version (irr luarocks is overkill and can 
interfere badly)

> Second, is there some reason not to include the functionality of 
> luapackageloader by default in LuaTeX? Then the Lua paths would work as 
> expected. It might still make sense to have the functionality as a 
> separate package, in case people wanted to disable that functionality 
> for some reason. Though I can't imagine why they would want to.

see below ... demands differand we don't impose a strategy

> I originally became aware of LuaTeX around 2012, but at that time I 
> could not figure out a way to load external packages, though since I 
> don't recall asking for help at the time, I probably did not pursue it 
> very hard. But if this had worked out of the box for me then (and as 
> stated I can't see any reason why it shouldn't), I would have started 
> using LuaTeX much earlier.
it has always been possible to load libraries, luatex has some 
protection against loading but that's real low level inhibition

dealing with this is upto the macro package because tex has rules about 
where it looks for files and might want to limit choices for all kind of 
reasons (like security or interference); there is a long tradition of 
dealing with files of any kind in tds and that's not going to change; 
much in tex that has to do with files also relates to long term stability

so, for stability you might want to put lua files and binary modules in 
the tex binary tree but lua files can be put elsewhere too; maybe you 
want some specific version over some other; maybe you don't want 
interference with what other programs put in the lua lookup paths; you 
hav eto match the lua version in luatex anyway; there is no universal 
approach to this

there is no need to change anything as a macro package can put whatever 
loader it wants on top of what is already there; of course it also 
depends on what paths are defined in the configuration file (when you 
use kpse); if it doesn't work then it's probably because no one bothered 
  to deal with it (which is an indication of something hardly being 
used) so you can try to get support for your approach in the macro 
package that you use

Hans

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From andreas.matthias at gmail.com  Thu Mar 25 13:31:27 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Thu, 25 Mar 2021 13:31:27 +0100
Subject: [luatex] [EXT] Re: Accessing external Lua libraries
In-Reply-To: <CA6DI5BR90QP.1XCOM30T6OQ1@phobos>
References: <CAHp59H2vgdmc=HtkjWa=e3pPQYGoaXGDYkF4V78z_0KRwqXPWA@mail.gmail.com>
 <CA6DI5BR90QP.1XCOM30T6OQ1@phobos>
Message-ID: <CAHp59H0pC-bE0JGU74CWMVcBVDXjwmviy_hYX83+nGWq3s5Ltw@mail.gmail.com>

Michal Vlas?k wrote:
>
> After adding equivalent of Lua's "?/init.lua" (which across platforms is
> probably a suffix of 'DIR_SEP_STRING "init.lua"') Lua like path
> searching for modules seems to work even in kpathsea. However surely
> there are assumptions in the code that suffix does not contain directory
> separtors and this will break in non simplistic cases. (Like in database
> lookups). Maybe this can be fixed.
>
> But I don't think it's worth to make these changes:

Yes, this makes perfect sense once you understand what's going on.
But imho it's not at all easy to grasp it. Maybe loading an external
library is something that a normal user does not do. But if they
try it, they might come the same cumbersome way as I did:

1) I set {C}LUAINPUTS in texmf.cnf, tested it, and was happy that
I could use external lua libraries/modules. (I didn't know about
luapackageloader back then, and didn't understand package.searchers[].)

2) Later on I realized that I could only load some libraries
but not all. This was weird.

3) Then I realized that it depends on the internal structure of a
module: 'module.lua' vs. 'module/init.lua'.

4) Now, this was the moment I could start asking questions eventually.
Before that I just knew that "something was not working".


Please don't get me wrong. I don't want to complain. I just want to
point out how easy it is to misunderstand the meaning of {C}LUAINPUTS.

Andreas


From luigi.scarso at gmail.com  Sun Mar 28 19:52:39 2021
From: luigi.scarso at gmail.com (luigi scarso)
Date: Sun, 28 Mar 2021 19:52:39 +0200
Subject: [luatex] Luatex 1.13.0 announcement.
In-Reply-To: <CAG5iGsDQKjZyxE1mwZFhOBbq55Z3ykPUbiy+sJ5D97kMfbDvqw@mail.gmail.com>
References: <CAG5iGsDQKjZyxE1mwZFhOBbq55Z3ykPUbiy+sJ5D97kMfbDvqw@mail.gmail.com>
Message-ID: <CAG5iGsA-K7MEA+SC2T++txXOLyH5PmfYvFSeWeyQJL=o35T16w@mail.gmail.com>

==============================================================
LuaTeX 1.13.0 2021-03-12
==============================================================

This is the release for TeX live 2021.
Callback for nesting level used in tracingmacros.
It is is a variant of \tracingstacklevels
by Petr Olsak implemented in pdftex and xetex.
Two TeX January 2021 DEK buglet fixes (H.Hagen)
Mark math glyphs as protected (in order to prevent processing
as text in base mode).
Removed width/ic compensation for traditional math code path.
When restricted system commands is enabled  os.setenv has no effect.
Minor clean-up and bugs fixed (see ChangeLog)


-- 
luigi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210328/bb7e870c/attachment.html>

From andreas.matthias at gmail.com  Wed Mar 31 16:53:54 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 31 Mar 2021 16:53:54 +0200
Subject: [luatex] Iteration over the dictionary of a stream
Message-ID: <CAHp59H1C9PSkVY7bd02fM86GFo2YXiA7agcnj+JFpznTUWL5KQ@mail.gmail.com>

How do you iterate over the dictionary of a stream? The documentation
says ["The dictionary you can access in the usual way ..."] so I tried
to use pdfe.dictionarytotable() but this didn't work.

\directlua{%
  local doc = pdfe.open('test.pdf')
  local stream =  doc.Pages[1].Contents

  % this works
  print(stream.Length)

  % this doesn't
  for k, v in pairs(pdfe.dictionarytotable(stream)) do
    print(k, v)
  end
}
\bye

Andreas

From P.Taylor at Rhul.Ac.Uk  Wed Mar 31 17:09:58 2021
From: P.Taylor at Rhul.Ac.Uk (Philip Taylor)
Date: Wed, 31 Mar 2021 16:09:58 +0100
Subject: [luatex] [EXT]  Iteration over the dictionary of a stream
In-Reply-To: <CAHp59H1C9PSkVY7bd02fM86GFo2YXiA7agcnj+JFpznTUWL5KQ@mail.gmail.com>
References: <CAHp59H1C9PSkVY7bd02fM86GFo2YXiA7agcnj+JFpznTUWL5KQ@mail.gmail.com>
Message-ID: <3ff415c3-1100-af1e-7351-3974928a869e@Rhul.Ac.Uk>

Andreas Matthias wrote:

How do you iterate over the dictionary of a stream?


I know less than nothing about Lua, but the following at least compiles.  It may provide a clue.

% !TeX Program=LuaTeX


\directlua

 {%

   local doc = pdfe.open ('Hoi-An TA menu.pdf')

   local stream = doc.Pages [1].Contents


   % this works

   print (stream.Length)


   % this doesn't

   for k, v in pairs (pdfe.dictionarytotable (doc.Pages [1])) do

   print (k, v)

   end

  }


\bye

--
Philip Taylor


This email, its contents and any attachments are intended solely for the addressee and may contain confidential information. In certain circumstances, it may also be subject to legal privilege. Any unauthorised use, disclosure, or copying is not permitted. If you have received this email in error, please notify us and immediately and permanently delete it. Any views or opinions expressed in personal emails are solely those of the author and do not necessarily represent those of Royal Holloway, University of London. It is your responsibility to ensure that this email and any attachments are virus free.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210331/63f39065/attachment.html>

From andreas.matthias at gmail.com  Wed Mar 31 17:41:48 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 31 Mar 2021 17:41:48 +0200
Subject: [luatex] [EXT]  Iteration over the dictionary of a stream
In-Reply-To: <3ff415c3-1100-af1e-7351-3974928a869e@Rhul.Ac.Uk>
References: <CAHp59H1C9PSkVY7bd02fM86GFo2YXiA7agcnj+JFpznTUWL5KQ@mail.gmail.com>
 <3ff415c3-1100-af1e-7351-3974928a869e@Rhul.Ac.Uk>
Message-ID: <CAHp59H2M6zrvHPRktgf+dsbmbPjLsO-RhqWAiPiuAjxr_RRqzA@mail.gmail.com>

On Wed, Mar 31, 2021 at 5:10 PM Philip Taylor <P.Taylor at rhul.ac.uk> wrote:
>
>    for k, v in pairs (pdfe.dictionarytotable (doc.Pages [1])) do

Here, you are iterating over a /Page dictionary (doc.Pages[1]), which
is a real dictionary.
No issues when iterating over real dictionaries with pdfe.dictionarytotable().

But the /Contents entry of this dictionary refers to a stream. And the
first part of
a stream object is a dictionary. But you cannot use pdfe.dictionarytotable() in
this case.

Andreas

From P.Taylor at Hellenic-Institute.Uk  Wed Mar 31 18:02:17 2021
From: P.Taylor at Hellenic-Institute.Uk (Philip Taylor)
Date: Wed, 31 Mar 2021 17:02:17 +0100
Subject: [luatex] [EXT] Iteration over the dictionary of a stream
In-Reply-To: <CAHp59H2M6zrvHPRktgf+dsbmbPjLsO-RhqWAiPiuAjxr_RRqzA@mail.gmail.com>
References: <CAHp59H1C9PSkVY7bd02fM86GFo2YXiA7agcnj+JFpznTUWL5KQ@mail.gmail.com>
 <3ff415c3-1100-af1e-7351-3974928a869e@Rhul.Ac.Uk>
 <CAHp59H2M6zrvHPRktgf+dsbmbPjLsO-RhqWAiPiuAjxr_RRqzA@mail.gmail.com>
Message-ID: <32fe015b-2576-2080-a821-4f49be704706@Hellenic-Institute.Uk>

Andreas Matthias wrote:

> Here, you are iterating over a /Page dictionary (doc.Pages[1]), which
> is a real dictionary.
> No issues when iterating over real dictionaries with pdfe.dictionarytotable().
>
> But the /Contents entry of this dictionary refers to a stream. And the
> first part of a stream object is a dictionary. But you cannot use
> pdfe.dictionarytotable() in this case.

OK, understood.? In that case, is there a Lua selector for? 'the first 
part of a stream object', and if so, do you need to explicit deploy it ?
-- 
/Philip Taylor/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://tug.org/pipermail/luatex/attachments/20210331/65335d35/attachment.html>

From j.hagen at xs4all.nl  Wed Mar 31 18:52:28 2021
From: j.hagen at xs4all.nl (Hans Hagen)
Date: Wed, 31 Mar 2021 18:52:28 +0200
Subject: [luatex] [EXT] Iteration over the dictionary of a stream
In-Reply-To: <CAHp59H2M6zrvHPRktgf+dsbmbPjLsO-RhqWAiPiuAjxr_RRqzA@mail.gmail.com>
References: <CAHp59H1C9PSkVY7bd02fM86GFo2YXiA7agcnj+JFpznTUWL5KQ@mail.gmail.com>
 <3ff415c3-1100-af1e-7351-3974928a869e@Rhul.Ac.Uk>
 <CAHp59H2M6zrvHPRktgf+dsbmbPjLsO-RhqWAiPiuAjxr_RRqzA@mail.gmail.com>
Message-ID: <4ec3f639-fecc-8bf6-c394-a85d23065858@xs4all.nl>

On 3/31/2021 5:41 PM, Andreas Matthias wrote:
> On Wed, Mar 31, 2021 at 5:10 PM Philip Taylor <P.Taylor at rhul.ac.uk> wrote:
>>
>>     for k, v in pairs (pdfe.dictionarytotable (doc.Pages [1])) do
> 
> Here, you are iterating over a /Page dictionary (doc.Pages[1]), which
> is a real dictionary.
> No issues when iterating over real dictionaries with pdfe.dictionarytotable().
> 
> But the /Contents entry of this dictionary refers to a stream. And the
> first part of
> a stream object is a dictionary. But you cannot use pdfe.dictionarytotable() in
> this case.
    local doc = pdfe.open ('h.pdf')
    local page = doc.Pages[1]
    local a = pdfe.dictionarytotable(page)
    print("page",a)
    local b = a.Contents
    print("contents",b[1],b[2],b[3])
    local c, d, e = pdfe.getfromreference(b[2])
    print("stream",c,d,e)
    local f = pdfe.dictionarytotable(e)
    print("whatever",f)

a stream object is a referenced object with a stream and a dictionary

-----------------------------------------------------------------
                                           Hans Hagen | PRAGMA ADE
               Ridderstraat 27 | 8061 GH Hasselt | The Netherlands
        tel: 038 477 53 69 | www.pragma-ade.nl | www.pragma-pod.nl
-----------------------------------------------------------------

From andreas.matthias at gmail.com  Wed Mar 31 21:13:44 2021
From: andreas.matthias at gmail.com (Andreas Matthias)
Date: Wed, 31 Mar 2021 21:13:44 +0200
Subject: [luatex] [EXT] Iteration over the dictionary of a stream
In-Reply-To: <4ec3f639-fecc-8bf6-c394-a85d23065858@xs4all.nl>
References: <CAHp59H1C9PSkVY7bd02fM86GFo2YXiA7agcnj+JFpznTUWL5KQ@mail.gmail.com>
 <3ff415c3-1100-af1e-7351-3974928a869e@Rhul.Ac.Uk>
 <CAHp59H2M6zrvHPRktgf+dsbmbPjLsO-RhqWAiPiuAjxr_RRqzA@mail.gmail.com>
 <4ec3f639-fecc-8bf6-c394-a85d23065858@xs4all.nl>
Message-ID: <CAHp59H22ezn41jo=ROyeFsRFvYLeeeL0pfrsjSao1vu5eWM1=A@mail.gmail.com>

Hans Hagen wrote:
>
>     local doc = pdfe.open ('h.pdf')
>     local page = doc.Pages[1]
>     local a = pdfe.dictionarytotable(page)
>     print("page",a)
>     local b = a.Contents
>     print("contents",b[1],b[2],b[3])
>     local c, d, e = pdfe.getfromreference(b[2])
>     print("stream",c,d,e)
>     local f = pdfe.dictionarytotable(e)
>     print("whatever",f)
>
> a stream object is a referenced object with a stream and a dictionary

Thank you, this helped a lot. It seemed to be trickier than I thought it would
be. But it also revealed that I had some other flaws in my code, because
I did not respect reference correctly. I was always wondering why one would
need getfromreference() at all. Now I know better. Thanks.

Andreas

