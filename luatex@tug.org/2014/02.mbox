From Herbert.Voss at FU-Berlin.DE  Sun Feb  2 20:16:06 2014
From: Herbert.Voss at FU-Berlin.DE (Herbert Voss)
Date: Sun, 2 Feb 2014 20:16:06 +0100
Subject: [luatex] writing and reading a file
Message-ID: <52EE9976.1080406@FU-Berlin.DE>

Hello all,

I have a problem with the following example. It creates the
external data file "tmp.data" with the \directlua call. This
file is then read by \addplot. You can choose any kind of
values, e.g. 4000, 500, or whatever instead of the 5000 steps,
\addplot is missing some of the rightmost data.

For a second run, comment the \directlua call (the data file
is already created by the preceding run). The output is now
correct.

I suppose that the data file is closed too late.
But I am not sure.

Herbert


\documentclass[tikz,border=10pt]{standalone}
\usepackage{pgfplots}
\usepackage{luacode}
\begin{luacode}
function weierstrass(x0, x1, n, a, b, epsilon)
  local dx = (x1-x0)/n
  local x = x0
  local out=assert(io.open("tmp.data","w"))
  local y,k,dy
  while (x <= x1) do
    y = 0
    k = 0
    repeat
       dy = math.pow(a,k)*math.cos(math.pow(b,k)*math.pi*x)
       y = y + dy
       k = k + 1
    until (math.abs(dy) < epsilon)
    out:write( x, " ", y ,"\string\n")
    x = x + dx
  end
  out.close()
end
\end{luacode}
\begin{document}

\directlua{weierstrass(-2, 2, 5000, 0.3 ,5 ,1.e-12)}

\begin{tikzpicture}
\begin{axis}[axis lines=middle]
   \addplot [thick] table {tmp.data};
\end{axis}
\end{tikzpicture}

\end{document}

From joseph.wright at morningstar2.co.uk  Sun Feb  2 20:28:26 2014
From: joseph.wright at morningstar2.co.uk (Joseph Wright)
Date: Sun, 2 Feb 2014 19:28:26 +0000
Subject: [luatex] writing and reading a file
In-Reply-To: <52EE9976.1080406@FU-Berlin.DE>
References: <52EE9976.1080406@FU-Berlin.DE>
Message-ID: <52EE9C5A.6050406@morningstar2.co.uk>

On 02/02/2014 19:16, Herbert Voss wrote:
> Hello all,
>
> I have a problem with the following example. It creates the
> external data file "tmp.data" with the \directlua call. This
> file is then read by \addplot. You can choose any kind of
> values, e.g. 4000, 500, or whatever instead of the 5000 steps,
> \addplot is missing some of the rightmost data.
>
> For a second run, comment the \directlua call (the data file
> is already created by the preceding run). The output is now
> correct.
>
> I suppose that the data file is closed too late.
> But I am not sure.
>
> Herbert

You can certainly see that the file is not 'right' at the appropriate 
place: adding a marker (undefined) control sequence just after the 
\directlua line (or indeed after the plot), the final line of the data 
file is

     1.9607999999998 1.1218274062469
-- 
Joseph Wright

From philipp.gesang at alumni.uni-heidelberg.de  Sun Feb  2 20:38:26 2014
From: philipp.gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Sun, 2 Feb 2014 20:38:26 +0100
Subject: [luatex] writing and reading a file
In-Reply-To: <52EE9976.1080406@FU-Berlin.DE>
References: <52EE9976.1080406@FU-Berlin.DE>
Message-ID: <20140202193826.GA5066@acheron>

Hi Herbert!

???<date: 2014-02-02, Sunday>???<from: Herbert Voss>???

> I have a problem with the following example. It creates the
> external data file "tmp.data" with the \directlua call. This
> file is then read by \addplot. You can choose any kind of
> values, e.g. 4000, 500, or whatever instead of the 5000 steps,
> \addplot is missing some of the rightmost data.
> 
> For a second run, comment the \directlua call (the data file
> is already created by the preceding run). The output is now
> correct.
> 
> I suppose that the data file is closed too late.
> But I am not sure.
> 
> \documentclass[tikz,border=10pt]{standalone}
> \usepackage{pgfplots}
> \usepackage{luacode}
> \begin{luacode}
> function weierstrass(x0, x1, n, a, b, epsilon)
>   local dx = (x1-x0)/n
>   local x = x0
>   local out=assert(io.open("tmp.data","w"))
>   local y,k,dy
>   while (x <= x1) do
>     y = 0
>     k = 0
>     repeat
>        dy = math.pow(a,k)*math.cos(math.pow(b,k)*math.pi*x)
>        y = y + dy
>        k = k + 1
>     until (math.abs(dy) < epsilon)
>     out:write( x, " ", y ,"\string\n")
>     x = x + dx
>   end
>   out.close()

   out:close()

The close() function must be called with the file as the first
argument. out.close() means calling it with no argument; use
out:close() or out.close(out) instead.

http://www.lua.org/manual/5.2/manual.html#pdf-io.close

Best,
Philipp




> end
> \end{luacode}
> \begin{document}
> 
> \directlua{weierstrass(-2, 2, 5000, 0.3 ,5 ,1.e-12)}
> 
> \begin{tikzpicture}
> \begin{axis}[axis lines=middle]
>    \addplot [thick] table {tmp.data};
> \end{axis}
> \end{tikzpicture}
> 
> \end{document}
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 490 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20140202/29cd3e39/attachment.bin>

From Herbert.Voss at FU-Berlin.DE  Sun Feb  2 21:52:25 2014
From: Herbert.Voss at FU-Berlin.DE (Herbert Voss)
Date: Sun, 2 Feb 2014 21:52:25 +0100
Subject: [luatex] writing and reading a file
In-Reply-To: <20140202193826.GA5066@acheron>
References: <52EE9976.1080406@FU-Berlin.DE> <20140202193826.GA5066@acheron>
Message-ID: <52EEB009.1040509@FU-Berlin.DE>

Am 02.02.2014 20:38, schrieb Philipp Gesang:

>>    out.close()
>
>     out:close()
>
> The close() function must be called with the file as the first
> argument. out.close() means calling it with no argument; use
> out:close() or out.close(out) instead.

Oh no, what a shame!!! I was puzzeled 20 minutes with this problem,
looked 10 times over the code and didn't realize the dot ...

thanks

Herbert


From dirk.laurie at gmail.com  Mon Feb  3 09:09:58 2014
From: dirk.laurie at gmail.com (Dirk Laurie)
Date: Mon, 3 Feb 2014 10:09:58 +0200
Subject: [luatex] writing and reading a file
In-Reply-To: <52EEB009.1040509@FU-Berlin.DE>
References: <52EE9976.1080406@FU-Berlin.DE> <20140202193826.GA5066@acheron>
 <52EEB009.1040509@FU-Berlin.DE>
Message-ID: <CABcj=t=nxNeB1D+c=UR9Y9tkFo5RkWjyiYYLZwk_9Dd3iTDaYw@mail.gmail.com>

2014-02-02 Herbert Voss <Herbert.Voss at fu-berlin.de>:
> Am 02.02.2014 20:38, schrieb Philipp Gesang:
>>>    out.close()
>>     out:close()
...
> Oh no, what a shame!!! I was puzzeled 20 minutes with this problem,
> looked 10 times over the code and didn't realize the dot ...

This is one of the most common mistakes I make too.

There are two palliatives (I can't call them cures).

First:
Make it a habit to put whitespace after every `:`.  It is a good habit anyway,
and the error is more visible.

Second:
~~~
require "paranoid"
~~~
where `paranoid.lua` is the attached file.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: paranoid.lua
Type: text/x-lua
Size: 540 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20140203/78bf9cc8/attachment.bin>

From wl at gnu.org  Wed Feb  5 15:06:27 2014
From: wl at gnu.org (Werner LEMBERG)
Date: Wed, 5 Feb 2014 15:06:27 +0100
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
Message-ID: <20140205.150627.432587200.wl@gnu.org>


[TeXLive SVN rev 32872]

Compiling a document with lualatex I see this:

  ! LuaTeX error ...texmf-dist/tex/luatex/luaotfload/luaotfload-database.lua:1422:
   attempt to index local 'english_names' (a nil value).
  <to be read again>
  relax
  l.100 \fontencoding\encodingdefault\selectfont

Just to be sure I've removed all luatex stuff from my .texlive2013
directory and repeated the command, but the problem remains.


    Werner

From Herbert.Voss at FU-Berlin.DE  Wed Feb  5 15:37:29 2014
From: Herbert.Voss at FU-Berlin.DE (Herbert Voss)
Date: Wed, 5 Feb 2014 15:37:29 +0100
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
In-Reply-To: <20140205.150627.432587200.wl@gnu.org>
References: <20140205.150627.432587200.wl@gnu.org>
Message-ID: <52F24CA9.1080103@FU-Berlin.DE>

Am 05.02.2014 15:06, schrieb Werner LEMBERG:
>
> [TeXLive SVN rev 32872]
>
> Compiling a document with lualatex I see this:
>
>    ! LuaTeX error ...texmf-dist/tex/luatex/luaotfload/luaotfload-database.lua:1422:
>     attempt to index local 'english_names' (a nil value).
>    <to be read again>
>    relax
>    l.100 \fontencoding\encodingdefault\selectfont
>
> Just to be sure I've removed all luatex stuff from my .texlive2013
> directory and repeated the command, but the problem remains.

>

rebuild the database: luaotfload-tool -u -vvv

Herbert

From wl at gnu.org  Wed Feb  5 16:01:46 2014
From: wl at gnu.org (Werner LEMBERG)
Date: Wed, 5 Feb 2014 16:01:46 +0100
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
In-Reply-To: <52F24CA9.1080103@FU-Berlin.DE>
References: <20140205.150627.432587200.wl@gnu.org>
 <52F24CA9.1080103@FU-Berlin.DE>
Message-ID: <20140205.160146.475792508.wl@gnu.org>

> rebuild the database: luaotfload-tool -u -vvv

luaotfload | util : Setting log level
luaotfload | util : Task completed successfully
luaotfload | db : Updating the font names database.
luaotfload | db : Font names database not found, generating new one.
luaotfload | db : This can take several minutes; please be patient.
luaotfload | db : Updating the font names database.
luaotfload | db : Blacklisting 8 files and directories.
luaotfload | db : Whitelisting 0 files.
luaotfload | db : Scanning TEXMF fonts...
luaotfload | db : Initiating scan of 450 directories.
luaotfload | db : Loading font /home/wl/texmf/fonts/truetype/chinese/avkv.ttf...

texmf-dist/tex/luatex/luaotfload/luaotfload-database.lua:1422:
  attempt to index local 'english_names' (a nil value)


So the error remains.


    Werner

From luatex at nililand.de  Wed Feb  5 16:16:45 2014
From: luatex at nililand.de (Ulrike Fischer)
Date: Wed, 5 Feb 2014 16:16:45 +0100
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
References: <20140205.150627.432587200.wl@gnu.org>
 <52F24CA9.1080103@FU-Berlin.DE> <20140205.160146.475792508.wl@gnu.org>
Message-ID: <k6qcy6y3lg66$.dlg@nililand.de>

Am Wed, 5 Feb 2014 16:01:46 +0100 schrieb Werner LEMBERG:

>> rebuild the database: luaotfload-tool -u -vvv
> 
> luaotfload | util : Setting log level
> luaotfload | util : Task completed successfully
> luaotfload | db : Updating the font names database.
> luaotfload | db : Font names database not found, generating new one.
> luaotfload | db : This can take several minutes; please be patient.
> luaotfload | db : Updating the font names database.
> luaotfload | db : Blacklisting 8 files and directories.
> luaotfload | db : Whitelisting 0 files.
> luaotfload | db : Scanning TEXMF fonts...
> luaotfload | db : Initiating scan of 450 directories.
> luaotfload | db : Loading font /home/wl/texmf/fonts/truetype/chinese/avkv.ttf...
> 
> texmf-dist/tex/luatex/luaotfload/luaotfload-database.lua:1422:
>   attempt to index local 'english_names' (a nil value)
> 
> 
> So the error remains.

Delete the old database(s) in the cache-folder and then retry to
build it. 


-- 
Ulrike Fischer 
http://www.troubleshooting-tex.de/


From r.f.wolpert at gmail.com  Wed Feb  5 16:49:35 2014
From: r.f.wolpert at gmail.com (Rembrandt Wolpert)
Date: Wed, 5 Feb 2014 09:49:35 -0600
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
In-Reply-To: <20140205.160146.475792508.wl@gnu.org>
References: <20140205.150627.432587200.wl@gnu.org>
 <52F24CA9.1080103@FU-Berlin.DE> <20140205.160146.475792508.wl@gnu.org>
Message-ID: <52F25D8F.50106@gmail.com>

Maybe you have an "unreadable" font? I had the same problem on OSX with
the font ??e?o?????a???e??????u?.ttf (yes, no English, no Chinese) in the
/Library/Fonts folder. Moving it out of search-reach and rebuilding the
database  (and then having isolated the offending font keeping it out of
the way) did the trick.

Rembrandt

On 2/5/14 9:01 AM, Werner LEMBERG wrote:
>> rebuild the database: luaotfload-tool -u -vvv
> 
> luaotfload | util : Setting log level
> luaotfload | util : Task completed successfully
> luaotfload | db : Updating the font names database.
> luaotfload | db : Font names database not found, generating new one.
> luaotfload | db : This can take several minutes; please be patient.
> luaotfload | db : Updating the font names database.
> luaotfload | db : Blacklisting 8 files and directories.
> luaotfload | db : Whitelisting 0 files.
> luaotfload | db : Scanning TEXMF fonts...
> luaotfload | db : Initiating scan of 450 directories.
> luaotfload | db : Loading font /home/wl/texmf/fonts/truetype/chinese/avkv.ttf...
> 
> texmf-dist/tex/luatex/luaotfload/luaotfload-database.lua:1422:
>   attempt to index local 'english_names' (a nil value)
> 
> 
> So the error remains.
> 
> 
>     Werner
> 

-- 
????? ?????
 - ?? (1249-1293)

From wl at gnu.org  Wed Feb  5 18:07:03 2014
From: wl at gnu.org (Werner LEMBERG)
Date: Wed, 5 Feb 2014 18:07:03 +0100
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
In-Reply-To: <k6qcy6y3lg66$.dlg@nililand.de>
References: <52F24CA9.1080103@FU-Berlin.DE>
 <20140205.160146.475792508.wl@gnu.org>
 <k6qcy6y3lg66$.dlg@nililand.de>
Message-ID: <20140205.180703.168313094.wl@gnu.org>


> Delete the old database(s) in the cache-folder and then retry to
> build it.

I've explicitly mentioned in my first mail that I've removed
everything related to luatex from `.texlive2013'...

> Maybe you have an "unreadable" font? I had the same problem on OSX
> with the font ??e?o?????a???e??????u?.ttf (yes, no English, no Chinese)
> in the /Library/Fonts folder. Moving it out of search-reach and
> rebuilding the database (and then having isolated the offending font
> keeping it out of the way) did the trick.

The problem wasn't unreadable fonts.  It's rather the fact that
luaotfload is apparently not able to handle old Chinese fonts, for
example `avkv.ttf'.  This font has an invalid PostScript font name
`????^P' (the ^P is a control character)[1], and I guess this is
the very problem.  Moving away the directory with those fonts, the
call succeeds.  Additionally, this font has a `OS/2' table with
version 0, which is unusual also, together with more peculiarities.

Who is responsible for this program?  Neither --version nor --help
gives any contact (which is also a bug IMHO).  Since my lua knowledge
is zero, I can't debug this by myself.


    Werner

[1] According to the specs, only characters from a special ASCII
    subset are allowed.


From wl at gnu.org  Wed Feb  5 19:23:30 2014
From: wl at gnu.org (Werner LEMBERG)
Date: Wed, 5 Feb 2014 19:23:30 +0100
Subject: [luatex] [tex-live] luaotfload-database.lua error with TeXLive
	SVN
In-Reply-To: <u0iu2uywlpzz.dlg@nililand.de>
References: <k6qcy6y3lg66$.dlg@nililand.de>
 <20140205.180703.168313094.wl@gnu.org>
 <u0iu2uywlpzz.dlg@nililand.de>
Message-ID: <20140205.192330.01405606.wl@gnu.org>


>> I've explicitly mentioned in my first mail that I've removed
>> everything related to luatex from `.texlive2013'...
>
> In my texlive the cache is not in .texlive2013 but in texmf-var.

Ah, ok.  This is Windows vs. Unix ? I have `texmf-var' in the
`.texlive2013' directory.

>> It's rather the fact that luaotfload is apparently not able to
>> handle old Chinese fonts, for example `avkv.ttf'.  [...]
>
> You can also blacklist problematic fonts.

Certainly, but this is a sub-optimal solution, I reckon.  Note that
older versions of luaotfload did *not* cause a problem; the problem
has been introduced recently

>> Who is responsible for this program?  Neither --version nor --help
>> gives any contact (which is also a bug IMHO).
>
> luaotfload has a documentation that you get with the standard
> texdoc.  It mentions names and a webpage.

I know that, thanks.  But again, this is sub-optimal.  Contrary to the
issue with the Chinese fonts this should be rather easy to fix :-)


     Werner


From philipp.gesang at alumni.uni-heidelberg.de  Wed Feb  5 21:34:47 2014
From: philipp.gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Wed, 5 Feb 2014 21:34:47 +0100
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
In-Reply-To: <20140205.180703.168313094.wl@gnu.org>
References: <52F24CA9.1080103@FU-Berlin.DE>
 <20140205.160146.475792508.wl@gnu.org>
 <k6qcy6y3lg66$.dlg@nililand.de>
 <20140205.180703.168313094.wl@gnu.org>
Message-ID: <20140205203447.GA844@acheron>

Dear Werner,

thanks for reporting!

???<date: 2014-02-05, Wednesday>???<from: Werner LEMBERG>???
> > Maybe you have an "unreadable" font? I had the same problem on OSX
> > with the font ??e?o?????a???e??????u?.ttf (yes, no English, no Chinese)
> > in the /Library/Fonts folder. Moving it out of search-reach and
> > rebuilding the database (and then having isolated the offending font
> > keeping it out of the way) did the trick.

Please file a bug report in cases like this. Werner is absolutely
correct in that Luaotfload shouldn?t trip over buggy names.

> The problem wasn't unreadable fonts.  It's rather the fact that
> luaotfload is apparently not able to handle old Chinese fonts.

From the capitalization ?old Chinese? I infer that you are
referring to old font files, not fonts for some ancient variety
of some Chinese script ;-) I?m afraid Luaotfload can only process
what the fontloader library of Luatex manages to extract from a
font. Fonts without a names table (no ?English (US)" tag) will
always be problematic; if even the ps name is borked you?re
probably going to have to use the file name to load the font.

That crash?s on me, though. Sorry. I?ve already pushed a patch
and backported it to the 2.4 branch. A new release of Luaotfload
will reach CTAN soon. Direct link to release page:

      https://github.com/lualatex/luaotfload/releases/edit/v2.4-fix-3

>                                                                for
> example `avkv.ttf'.  This font has an invalid PostScript font name
> `????^P' (the ^P is a control character)[1], and I guess this is
> the very problem.  Moving away the directory with those fonts, the
> call succeeds.  Additionally, this font has a `OS/2' table with
> version 0, which is unusual also, together with more peculiarities.

If the license allows, could you please send me copy of that file
off list? I can?t even get fontforge to make a font without an US
English names table, so I can?t run any tests myself.

> Who is responsible for this program?  Neither --version nor --help
> gives any contact (which is also a bug IMHO).

The manpage for luaotfload-tool(1) has the contact link
(<https://github.com/lualatex/>), also see the pdf manual
(luaotfload.pdf in the TL texmf). It?s not a bug that that
information isn?t also part of the --version output but I?m going
to add it anyways.

Best regards,
Philipp

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 490 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20140205/b109f44e/attachment-0001.bin>

From reinhard.kotucha at web.de  Thu Feb  6 01:24:40 2014
From: reinhard.kotucha at web.de (Reinhard Kotucha)
Date: Thu, 6 Feb 2014 01:24:40 +0100
Subject: [luatex] luaotfload-database.lua error with TeXLive SVN
In-Reply-To: <20140205.180703.168313094.wl@gnu.org>
References: <52F24CA9.1080103@FU-Berlin.DE>
 <20140205.160146.475792508.wl@gnu.org>
 <k6qcy6y3lg66$.dlg@nililand.de>
 <20140205.180703.168313094.wl@gnu.org>
Message-ID: <21234.54856.372277.582242@zaphod.ms25.net>

On 2014-02-05 at 18:07:03 +0100, Werner LEMBERG wrote:

 > Who is responsible for this program?  Neither --version nor --help
 > gives any contact (which is also a bug IMHO).

Hi Werner,
the answer to this question might be interesting to others too, so
I'll try to answer it more generally.

The easiest way to find out who is responsible for a particular
package is to look at

  http://ctan.org

and use the search facilities.  CTAN provides data from the TeX
Catalogue, unfortunately except email addresses.  The advantage of
CTAN is that it mentiones the *current* maintainer(s).  If someone
encounters a problem with an older release it's not helpful to contact
inactive maintainers.

Since the CTAN team rejects everything which isn't accompanied with a
clear license statement for more than a decade, we can assume that one
of the files listed by

   texdoc -l <package name>

contains the information you are looking for.

There might be other ways to find out who's responsible for a
particular package but IMO CTAN is the best choice.  Just because it's
up-to-date with regard to *current* maintainers.

It's a pity that email addresses are not provided by CTAN.  They still
exist in the Catalogue XML database.  Robin told me that they are not
exposed to the internet anymore because someone (obviously a troll)
complained.  IMO it's ridiculous but legal aspects can't be ignored.

A possible solution could be to extend the CTAN upload interface by a
button which allows package authors to confirm that they agree that
their email address is exposed to the web.  I'm sure that $\infty - 1$
authors agree.

Another solution could be to expose email addresses unconditionally if
they appear in at least one of the uploaded files.  It shouldn't be
too difficult to look for email addresses with grep -r.  With
pdftotext even the content of PDF files can be passed to grep.

I'm not a lawyer but I suppose that legal problems can only arise if,
and only if, the files in a particular package don't contain any email
address.

It's amazing to see what a single troll can destroy.

Regards,
  Reinhard

-- 
----------------------------------------------------------------------------
Reinhard Kotucha                                      Phone: +49-511-3373112
Marschnerstr. 25
D-30167 Hannover                              mailto:reinhard.kotucha at web.de
----------------------------------------------------------------------------
Microsoft isn't the answer. Microsoft is the question, and the answer is NO.
----------------------------------------------------------------------------

From joseph.wright at morningstar2.co.uk  Thu Feb  6 14:06:54 2014
From: joseph.wright at morningstar2.co.uk (Joseph Wright)
Date: Thu, 6 Feb 2014 13:06:54 +0000
Subject: [luatex] \uppercase and \lowercase
Message-ID: <52F388EE.9080605@morningstar2.co.uk>

Hello all,

Looking over the current LuaTeX manual, and with some case-changing
issues in mind, I came across the statement:

> The future semantics of \uppercase and \lowercase are still under
> consideration, no changes have taken place yet.

I wonder what the implications here are: is there anything more definite
on it available?
--
Joseph Wright

From joseph.wright at morningstar2.co.uk  Fri Feb  7 09:54:59 2014
From: joseph.wright at morningstar2.co.uk (Joseph Wright)
Date: Fri, 7 Feb 2014 08:54:59 +0000
Subject: [luatex] Using the token_filter callback only for 'some tokens'
Message-ID: <52F49F63.5040505@morningstar2.co.uk>

Hello all,

I'm currently fiddling around with changing the case of (TeX) tokens in
Lua. Doing a UTF-8 case change on 'text' is easy enough once you get the
idea of using the unicode library it gives the 'wrong' result for
something like

  abc\foo

That can be avoided by doing a TeX loop to only pass on 'letters' to Lua
or by not passing on control words, but I'm looking to solve the problem
at the Lua end.

The idea of using the token_filter callback was suggested
(http://chat.stackexchange.com/transcript/message/13635878#13635878).
However, I don't see how to apply the callback to only the argument
rather than to 'all tokens'. For example, trying something like

\input luatexbase.sty %
\directlua{%
  local upper = unicode.utf8.upper
  local char = unicode.utf8.char
  mytokens = function()
    local t = token.get_next()
    if t[3] == 0 and t[1] == 11 then
      print(upper(char(t[2])), t[1], t[3])
    end
    return t
  end
}
\def\test#1{%
  \directlua{luatexbase.add_to_callback
    ("token_filter", mytokens,  "mytokens")}%
  #1%
  \directlua{luatexbase.remove_from_callback
    ("token_filter", "mytokens")}%
}

Before
\test{during}
after
\bye

Shows that as I guess I'd expect the filter is active until the end of
the line to remove it. In a real case that would clearly not work. I'm
doubtless missing something obvious here: what's the correct approach?
(I'm using luatexbase as this seems a little easier than the rather
callback.register, but if there is a solution with the latter I'll be
interested too.)
-- 
Joseph Wright

From khaledhosny at eglug.org  Fri Feb  7 10:02:18 2014
From: khaledhosny at eglug.org (Khaled Hosny)
Date: Fri, 7 Feb 2014 11:02:18 +0200
Subject: [luatex] Using the token_filter callback only for 'some tokens'
In-Reply-To: <52F49F63.5040505@morningstar2.co.uk>
References: <52F49F63.5040505@morningstar2.co.uk>
Message-ID: <20140207090218.GA28731@khaled-laptop>

On Fri, Feb 07, 2014 at 08:54:59AM +0000, Joseph Wright wrote:
> what's the correct approach?

Personally, I?d just work on node lists before font layout is done (so
that they are char nodes) and use attributes to mark what nodes I?m
interested in from the TeX side. This way I don?t need to worry about
macro expansion at all, and I can control where to apply the case
transformation without enabling/disabling the callback all the time.

Regards,
Khaled

From joseph.wright at morningstar2.co.uk  Fri Feb  7 10:09:44 2014
From: joseph.wright at morningstar2.co.uk (Joseph Wright)
Date: Fri, 7 Feb 2014 09:09:44 +0000
Subject: [luatex] Using the token_filter callback only for 'some tokens'
In-Reply-To: <20140207090218.GA28731@khaled-laptop>
References: <52F49F63.5040505@morningstar2.co.uk>
 <20140207090218.GA28731@khaled-laptop>
Message-ID: <52F4A2D8.6000602@morningstar2.co.uk>

On 07/02/2014 09:02, Khaled Hosny wrote:
> On Fri, Feb 07, 2014 at 08:54:59AM +0000, Joseph Wright wrote:
>> what's the correct approach?
> 
> Personally, I?d just work on node lists before font layout is done (so
> that they are char nodes) and use attributes to mark what nodes I?m
> interested in from the TeX side. This way I don?t need to worry about
> macro expansion at all, and I can control where to apply the case
> transformation without enabling/disabling the callback all the time.
> 
> Regards,
> Khaled

To be clear, that's using the properties of the font not the character,
yes (so at the TeX end the characters are unchanged)? Does that work
reliably for all fonts (most obviously CM)?

I guess my worry is that this is not transparent to the 'user': they've
asked the case to change but if they examine the TeX material it's not
actually happened.
-- 
Joseph Wright


From joseph.wright at morningstar2.co.uk  Fri Feb  7 22:21:28 2014
From: joseph.wright at morningstar2.co.uk (Joseph Wright)
Date: Fri, 7 Feb 2014 21:21:28 +0000
Subject: [luatex] \readline issue
Message-ID: <52F54E58.70609@morningstar2.co.uk>

Hello all,

Reading in some UTF-8 input, I stumbled across some unexpected 
behaviour. With the demo file

\iffalse ??\fi
\newread\tmpread
\openin\tmpread \jobname %
\read\tmpread to \temp
\show\temp
\edef\temp{\detokenize\expandafter{\temp}}
\show\temp
\closein\tmpread
\openin\tmpread \jobname %
\readline\tmpread to \temp
\show\temp
\bye

runnign with LuaTeX (Version beta-0.76.0-2013061817 (rev 4627)) I get 
the terminal output

 > \temp=macro:
->\iffalse ??\fi .
l.5 \show\temp

?
 > \temp=macro:
->\iffalse ??\fi .
l.7 \show\temp

?
 > \temp=macro:
->\iffalse ????\fi
.
l.11 \show\temp

while for XeTeX I get the more expected:

 > \temp=macro:
->\iffalse ??\fi .
l.5 \show\temp

?
 > \temp=macro:
->\iffalse ??\fi .
l.7 \show\temp

?
 > \temp=macro:
->\iffalse ??\fi^^M.
l.11 \show\temp

Clearly something is up with the symbols: is this expected or a bug? 
(It's not restricted to the micro symbol, btw.)
--
Joseph Wright

From taco at elvenkind.com  Mon Feb 10 14:18:51 2014
From: taco at elvenkind.com (Taco Hoekwater)
Date: Mon, 10 Feb 2014 14:18:51 +0100
Subject: [luatex] \readline issue
In-Reply-To: <52F54E58.70609@morningstar2.co.uk>
References: <52F54E58.70609@morningstar2.co.uk>
Message-ID: <52F8D1BB.4000709@elvenkind.com>

Hi,

On 02/07/2014 10:21 PM, Joseph Wright wrote:
> Hello all,
>
> Reading in some UTF-8 input, I stumbled across some unexpected
> behaviour. With the demo file
>  > \temp=macro:
> ->\iffalse ????\fi
> .
> l.11 \show\temp
>
 > ...
> Clearly something is up with the symbols: is this expected or a bug?
> (It's not restricted to the micro symbol, btw.)

That was a bug: \readline was not unicode-aware yet. Fix will be in
the next release.

Best wishes,
Taco



From reinhard.kotucha at web.de  Fri Feb 21 01:55:54 2014
From: reinhard.kotucha at web.de (Reinhard Kotucha)
Date: Fri, 21 Feb 2014 01:55:54 +0100
Subject: [luatex] pdf.catalog argument
Message-ID: <21254.42010.360023.475749@zaphod.ms25.net>

Hi,
according to the documentation, the argument of pdf.catalog should be
a string.

When I say

  local meta=string.format('/Metadata %d 0 R', xmpobj)

where xmpobj is the return value of pdf.obj(), then

  tex.print('\\pdfcatalog{'..meta..'}')

works as expected but

  pdf.catalog(meta)

fails:

  ! LuaTeX error [string "\directlua "]:24: attempt to call field 'catalog' (a string value)
  stack traceback:
     [string "\directlua "]:24: in function 'xmp_2'
     [string "\directlua "]:1: in main chunk.

You can use the attached file in order to reproduce the problem.  It
contains two functions.  Change the argument of \directlua in order to
switch between them.

-------------- next part --------------
A non-text attachment was scrubbed...
Name: pdf_catalog.tex
Type: application/x-latex
Size: 1020 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20140221/5c25da3b/attachment.latex>
-------------- next part --------------

Regards,
  Reinhard
     
-- 
----------------------------------------------------------------------------
Reinhard Kotucha                                      Phone: +49-511-3373112
Marschnerstr. 25
D-30167 Hannover                              mailto:reinhard.kotucha at web.de
----------------------------------------------------------------------------
Microsoft isn't the answer. Microsoft is the question, and the answer is NO.
----------------------------------------------------------------------------

From valius.kria at gmail.com  Sat Feb 22 23:27:08 2014
From: valius.kria at gmail.com (=?UTF-8?Q?Valentinas_Kriau=C4=8Diukas?=)
Date: Sun, 23 Feb 2014 00:27:08 +0200
Subject: [luatex] \pdf@escapestring is non-injective
Message-ID: <CALXNvfVhesgWUfDp3EKy=RzGAH=nK2iin=p68wDW_vGOykmghA@mail.gmail.com>

Hi all,

I do not know if it is a bug, so write to this list.

While compiling one Russian text with unicode arguments of \bibitem
and \cite commands, I received warnings about duplicate destinations,
like

> LuaTeX warning (ext4): destination with the same identifier (name{cite.11 at -1})
> has been already used, duplicate ignored

Digging deeper, I found that \pdf at escapestring function is not
injective; that is, it produces the same output for distinct
arguments; for example
\pdf at escapestring {cite.1?1 at -1}
and
\pdf at escapestring {cite.1?1 at -1}
both return
cite.11 at -1

This produces the same destination marks for different bibliography
items and \cite links (also made using this function) goes to wrong
places.

I am running
> This is LuaTeX, Version beta-0.76.0-2013070106 (rev 4627)
from debian sid (texlive 2013.20140215-1)

Valentinas



From mico.loretan at mac.com  Tue Feb 25 21:45:32 2014
From: mico.loretan at mac.com (Mico Loretan)
Date: Tue, 25 Feb 2014 21:45:32 +0100
Subject: [luatex] question about loading an external lua library into
	Lua(La)TeX
Message-ID: <614EC37F-6962-4D9E-9DCF-6B01436E184A@mac.com>

Dear all,

The "lbn" library by Luiz Henrique de Figueiredo is described as a "fast integer-only arbitrary precision library"; see http://www.tecgraf.puc-rio.br/~lhf/ftp/lua/#lbn for a link to the source. I downloaded the tar.gz file and managed to compile the package's code into a lua library file called "bn.so", using either Lua 5.2.3 or LuaTeX 0.76 as the "Lua executable". Running the little test program that comes with the package, either via "lua test.lua" or via "luatex test.lua", also works without a hitch.

I would like to be able to use this library in a Lua(La)TeX document. Consider the following MWE:

    % !TEX TS-program = lualatex
    \documentclass{article}
    \usepackage{luacode} % for 'luacode' environment
    \begin{luacode}
    require "bn" -- load 'bn' library
    \end{luacode}
    \begin{document}
    Hello World.
    \end{document}

Unfortunately, things aren't going smoothly. Here are some excerpts from the log file:


    This is LuaTeX, Version beta-0.76.0-2013061817 (rev 4627)  (format=lualatex 2014.2.8)  25 FEB 2014 21:31
    ...
    (/usr/local/texlive/2013/texmf-dist/tex/lualatex/luacode/luacode.sty
    Package: luacode 2012/01/23 v1.2a lua-in-tex helpers (mpg)
    ...
     (/usr/local/texlive/2013/texmf-dist/tex/luatex/luatexbase/mcb.lua)
    Lua module: luatexbase-mcb 2013/05/11 0.6 register several functions in a callback
    ))
    \luacode at lines=\toks14
    \luacode at table@soft=\luatexcatcodetable13
    )
    ! LuaTeX error error loading module 'bn' from file './bn.so':
    	dlopen(./bn.so, 6): Symbol not found: _luaL_checklstring
      Referenced from: /Users/mico/Documents/tex/bn.so
      Expected in: flat namespace
     in /Users/mico/Documents/tex/bn.so
    stack traceback:
    	[C]: in ?
    	[C]: in ?
    	[C]: in function 'require'
    	[string "\directlua "]:1: in main chunk.
    \luacode at dbg@exec ...code at maybe@printdbg {#1} #1 }
                                                      
    l.6 \end{luacode}



Again, let me stress that the library "bn" seems to work fine when accessed from the package's test file, viz., test.lua. It's only when the library is being accessed from inside the "luacode" environment that things go off track. Is there some way to fix this?

Thanks, Mico





From Philipp.Gesang at alumni.uni-heidelberg.de  Tue Feb 25 22:14:19 2014
From: Philipp.Gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Tue, 25 Feb 2014 22:14:19 +0100
Subject: [luatex] question about loading an external lua library into
 Lua(La)TeX
In-Reply-To: <614EC37F-6962-4D9E-9DCF-6B01436E184A@mac.com>
References: <614EC37F-6962-4D9E-9DCF-6B01436E184A@mac.com>
Message-ID: <20140225211419.GA6621@acheron>

Hi Mico!

???<date: 2014-02-25, Tuesday>???<from: Mico Loretan>???
>     % !TEX TS-program = lualatex
>     \documentclass{article}
>     \usepackage{luacode} % for 'luacode' environment
>     \begin{luacode}
>     require "bn" -- load 'bn' library
>     \end{luacode}
>     \begin{document}
>     Hello World.
>     \end{document}

Your example runs fine here with Luatex beta-0.78.3 (rev
4804), nothing suspicious to be found in the log either.

> Again, let me stress that the library "bn" seems to work fine
> when accessed from the package's test file, viz., test.lua. It's
> only when the library is being accessed from inside the "luacode"
> environment that things go off track. Is there some way to fix
> this?

I doubt the luacode package has anything to do with this. Try
these lines for the plain format:

  \directlua {
    local bn = require "bn"
    print (">>", bn)
  }
  \bye

This should print the table reference. If it fails as well then
packages aren?t to blame.

Best,
Philipp

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 490 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20140225/8a9bdd27/attachment.bin>

From patrick at gundla.ch  Wed Feb 26 08:07:37 2014
From: patrick at gundla.ch (Patrick Gundlach)
Date: Wed, 26 Feb 2014 08:07:37 +0100
Subject: [luatex] question about loading an external lua library into
	Lua(La)TeX
In-Reply-To: <614EC37F-6962-4D9E-9DCF-6B01436E184A@mac.com>
References: <614EC37F-6962-4D9E-9DCF-6B01436E184A@mac.com>
Message-ID: <18C2C829-0F69-4CD0-9868-35982728281F@gundla.ch>


Am 25.02.2014 um 21:45 schrieb Mico Loretan <mico.loretan at mac.com>:

> 
> Unfortunately, things aren't going smoothly. Here are some excerpts from the log file:

[...]

perhaps this is similar to

http://tracker.luatex.org/view.php?id=555

?

Patrick





From Herbert.Voss at FU-Berlin.DE  Wed Feb 26 09:10:25 2014
From: Herbert.Voss at FU-Berlin.DE (Herbert Voss)
Date: Wed, 26 Feb 2014 09:10:25 +0100
Subject: [luatex] question about loading an external lua library into
 Lua(La)TeX
In-Reply-To: <614EC37F-6962-4D9E-9DCF-6B01436E184A@mac.com>
References: <614EC37F-6962-4D9E-9DCF-6B01436E184A@mac.com>
Message-ID: <530DA171.7090909@FU-Berlin.DE>

Am 25.02.2014 21:45, schrieb Mico Loretan:

> The "lbn" library by Luiz Henrique de Figueiredo is described as a "fast integer-only arbitrary precision library"; see http://www.tecgraf.puc-rio.br/~lhf/ftp/lua/#lbn for a link to the source. I downloaded the tar.gz file and managed to compile the package's code into a lua library file called "bn.so", using either Lua 5.2.3 or LuaTeX 0.76 as the "Lua executable". Running the little test program that comes with the package, either via "lua test.lua" or via "luatex test.lua", also works without a hitch.
>
> I would like to be able to use this library in a Lua(La)TeX document. Consider the following MWE:
>
>      % !TEX TS-program = lualatex
>      \documentclass{article}
>      \usepackage{luacode} % for 'luacode' environment
>      \begin{luacode}
>      require "bn" -- load 'bn' library
>      \end{luacode}
>      \begin{document}
>      Hello World.
>      \end{document}
>
> Unfortunately, things aren't going smoothly. Here are some excerpts from the log file:
>
>
>      This is LuaTeX, Version beta-0.76.0-2013061817 (rev 4627)  (format=lualatex 2014.2.8)  25 FEB 2014 21:31
>      ...
>      (/usr/local/texlive/2013/texmf-dist/tex/lualatex/luacode/luacode.sty
>      Package: luacode 2012/01/23 v1.2a lua-in-tex helpers (mpg)

no problem here with an up-to-date TL2013:

  *File List*
  article.cls    2007/10/19 v1.4h Standard LaTeX document class
   size10.clo    2007/10/19 v1.4h Standard LaTeX file (size option)
  luacode.sty    2012/01/23 v1.2a lua-in-tex helpers (mpg)
ifluatex.sty    2010/03/01 v1.3 Provides the ifluatex switch (HO)
luatexbase.sty    2013/05/11 v0.6 Resource management for the LuaTeX 
macro progr
ammer
   luatex.sty    2010/03/09 v0.4 LuaTeX basic definition package (HO)
infwarerr.sty    2010/04/08 v1.3 Providing info/warning/error messages (HO)
     etex.sty    1998/03/26 v2.0 eTeX basic definition package (PEB)
luatex-loader.sty    2010/03/09 v0.4 Lua module loader (HO)
luatexbase-compat.sty    2011/05/24 v0.4 Compatibility tools for LuaTeX
luatexbase-modutils.sty    2013/05/11 v0.6 Module utilities for LuaTeX
luatexbase-loader.sty    2013/05/11 v0.6 Lua module loader for LuaTeX
luatexbase-regs.sty    2011/05/24 v0.4 Registers allocation for LuaTeX
luatexbase-attr.sty    2013/05/11 v0.6 Attributes allocation for LuaTeX
luatexbase-cctb.sty    2013/05/11 v0.6 Catcodetable allocation for LuaTeX
luatexbase-mcb.sty    2013/05/11 v0.6 Callback management for LuaTeX
  ***********

Herbert



From mico.loretan at mac.com  Wed Feb 26 19:50:03 2014
From: mico.loretan at mac.com (Mico Loretan)
Date: Wed, 26 Feb 2014 19:50:03 +0100
Subject: [luatex] question about loading an external lua library into
	Lua(La)TeX
In-Reply-To: <mailman.11.1393412402.2920.luatex@tug.org>
References: <mailman.11.1393412402.2920.luatex@tug.org>
Message-ID: <AE58AE13-AAB5-4E04-AE00-933687F91411@mac.com>


> 
> Message: 3
> Date: Wed, 26 Feb 2014 08:07:37 +0100
> From: Patrick Gundlach <patrick at gundla.ch>
> To: "LuaTeX discussion." <luatex at tug.org>
> Subject: Re: [luatex] question about loading an external lua library
> 	into	Lua(La)TeX
> Message-ID: <18C2C829-0F69-4CD0-9868-35982728281F at gundla.ch>
> Content-Type: text/plain; charset="us-ascii"
> 
> 
> [...]
> 
> perhaps this is similar to
> 
> http://tracker.luatex.org/view.php?id=555
> 
> ?
> 
> Patrick
> 

Hmm, your bug report definitely could well be a productive lead. The error message you posted looks to be quite similar to what I've gotten. For what it's worth, I have a fully updated MacTeX2013 distribution that runs on a (by now nearly seven year old) MacBook that can't run anything newer than MacOS X 10.7.5.

Mico


From philipp.gesang at alumni.uni-heidelberg.de  Wed Feb 26 22:23:01 2014
From: philipp.gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Wed, 26 Feb 2014 22:23:01 +0100
Subject: [luatex] [lpeg] increase MAXRULES
Message-ID: <20140226212301.GA9166@acheron>

Good evening!

The reStructuredText module [1] is built around an Lpeg parser
with 225 rules. Currently (version 0.78.3), the value of MAXRULES
in lpeg.h is 200 (the default) which is too few for the module.
Others have reported similar problems in non-TeX contexts [2].

Could MAXRULES be increased to something above, say 400? That
would make module usable again and there would be enough
breathing room for further additions.

Thanks,
Philipp

[1] https://bitbucket.org/phg/context-rst
[2] http://lua-users.org/lists/lua-l/2013-09/msg00028.html

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 490 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20140226/e7dd20c4/attachment.bin>

From dirk.laurie at gmail.com  Thu Feb 27 07:06:34 2014
From: dirk.laurie at gmail.com (Dirk Laurie)
Date: Thu, 27 Feb 2014 08:06:34 +0200
Subject: [luatex] [lpeg] increase MAXRULES
In-Reply-To: <20140226212301.GA9166@acheron>
References: <20140226212301.GA9166@acheron>
Message-ID: <CABcj=t=PS+RykoApX0cQiC1AFJZg8omKmUVNipF_gJFZG9gF4w@mail.gmail.com>

2014-02-26 23:23 GMT+02:00 Philipp Gesang
<philipp.gesang at alumni.uni-heidelberg.de>:

> The reStructuredText module [1] is built around an Lpeg parser
> with 225 rules. Currently (version 0.78.3), the value of MAXRULES
> in lpeg.h is 200 (the default) which is too few for the module.
> Others have reported similar problems in non-TeX contexts [2].
>
> Could MAXRULES be increased to something above, say 400? That
> would make module usable again and there would be enough
> breathing room for further additions.

Somewhere in that lua-l thread 1024 was suggested, why stop at 400?
LPeg is currently at version 0.12, which no longer has lpeg.h.
MAXRULES is now defined in lptypes.h.


From philipp.gesang at alumni.uni-heidelberg.de  Thu Feb 27 07:49:13 2014
From: philipp.gesang at alumni.uni-heidelberg.de (Philipp Gesang)
Date: Thu, 27 Feb 2014 07:49:13 +0100
Subject: [luatex] [lpeg] increase MAXRULES
In-Reply-To: <CABcj=t=PS+RykoApX0cQiC1AFJZg8omKmUVNipF_gJFZG9gF4w@mail.gmail.com>
References: <20140226212301.GA9166@acheron>
 <CABcj=t=PS+RykoApX0cQiC1AFJZg8omKmUVNipF_gJFZG9gF4w@mail.gmail.com>
Message-ID: <20140227064913.GA1602@acheron>

???<date: 2014-02-27, Thursday>???<from: Dirk Laurie>???

> 2014-02-26 23:23 GMT+02:00 Philipp Gesang
> <philipp.gesang at alumni.uni-heidelberg.de>:
> 
> > The reStructuredText module [1] is built around an Lpeg parser
> > with 225 rules. Currently (version 0.78.3), the value of MAXRULES
> > in lpeg.h is 200 (the default) which is too few for the module.
> > Others have reported similar problems in non-TeX contexts [2].
> >
> > Could MAXRULES be increased to something above, say 400? That
> > would make module usable again and there would be enough
> > breathing room for further additions.
> 
> Somewhere in that lua-l thread 1024 was suggested, why stop at 400?

Do greater values affect performance in some way, or just memory?

> LPeg is currently at version 0.12, which no longer has lpeg.h.
> MAXRULES is now defined in lptypes.h.

The lpeg.h in Luatex is a combination of multiple Lpeg v 0.12
header files:

    https://foundry.supelec.fr/scm/viewvc.php/trunk/source/texk/web2c/luatexdir/luapeg/lpeg.h?view=markup&revision=4770&root=luatex

Best,
Philipp

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 490 bytes
Desc: not available
URL: <http://tug.org/pipermail/luatex/attachments/20140227/3743fbb8/attachment.bin>

From dirk.laurie at gmail.com  Thu Feb 27 09:35:56 2014
From: dirk.laurie at gmail.com (Dirk Laurie)
Date: Thu, 27 Feb 2014 10:35:56 +0200
Subject: [luatex] [lpeg] increase MAXRULES
In-Reply-To: <20140227064913.GA1602@acheron>
References: <20140226212301.GA9166@acheron>
 <CABcj=t=PS+RykoApX0cQiC1AFJZg8omKmUVNipF_gJFZG9gF4w@mail.gmail.com>
 <20140227064913.GA1602@acheron>
Message-ID: <CABcj=tkSsfQbyKj82NK-=asdUEVvFjAs+xQK7B+KYZdv-nm5gw@mail.gmail.com>

2014-02-27 8:49 GMT+02:00 Philipp Gesang
<philipp.gesang at alumni.uni-heidelberg.de>:
> ???<date: 2014-02-27, Thursday>???<from: Dirk Laurie>???
>> 2014-02-26 23:23 GMT+02:00 Philipp Gesang

>> > Could MAXRULES be increased to something above, say 400? That
>> > would make module usable again and there would be enough
>> > breathing room for further additions.

>> Somewhere in that lua-l thread 1024 was suggested, why stop at 400?

> Do greater values affect performance in some way, or just memory?

MAXRULES is the length of two arrays of type `int`. It can't possibly impact
performance to reserve more , and the memory overhead is minimal.

Of course, actually using that many rules could hit performance hard.



